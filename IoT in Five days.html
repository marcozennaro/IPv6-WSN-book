<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.4-dev">
<meta name="description" content="an introduction to Internet of Things, IPv6, 6LowPan and Contiki with lots of hands on experiments.">
<meta name="author" content="Antonio Li침치n Colina, Alvaro Vives, Antoine Bagula, Marco Zennaro and Ermanno Pietrosemoli">
<title>Internet of Things (IoT) in 5 days</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/*! normalize.css v2.1.2 | MIT License | git.io/normalize */
/* ========================================================================== HTML5 display definitions ========================================================================== */
/** Correct `block` display not defined in IE 8/9. */
article, aside, details, figcaption, figure, footer, header, hgroup, main, nav, section, summary {
    display: block;
}

/** Correct `inline-block` display not defined in IE 8/9. */
audio, canvas, video {
    display: inline-block;
}

/** Prevent modern browsers from displaying `audio` without controls. Remove excess height in iOS 5 devices. */
audio:not([controls]) {
    display: none;
    height: 0;
}

/** Address `[hidden]` styling not present in IE 8/9. Hide the `template` element in IE, Safari, and Firefox < 22. */
[hidden], template {
    display: none;
}

script {
    display: none !important;
}

/* ========================================================================== Base ========================================================================== */
/** 1. Set default font family to sans-serif. 2. Prevent iOS text size adjust after orientation change, without disabling user zoom. */
html {
    font-family: sans-serif; /* 1 */
    -ms-text-size-adjust: 100%; /* 2 */
    -webkit-text-size-adjust: 100%; /* 2 */
}

/** Remove default margin. */
body {
    margin: 0;
}

/* ========================================================================== Links ========================================================================== */
/** Remove the gray background color from active links in IE 10. */
a {
    background: transparent;
}

/** Address `outline` inconsistency between Chrome and other browsers. */
a:focus {
    outline: thin dotted;
}

/** Improve readability when focused and also mouse hovered in all browsers. */
a:active, a:hover {
    outline: 0;
}

/* ========================================================================== Typography ========================================================================== */
/** Address variable `h1` font-size and margin within `section` and `article` contexts in Firefox 4+, Safari 5, and Chrome. */
h1 {
    font-size: 2em;
    margin: 0.67em 0;
}

/** Address styling not present in IE 8/9, Safari 5, and Chrome. */
abbr[title] {
    border-bottom: 1px dotted;
}

/** Address style set to `bolder` in Firefox 4+, Safari 5, and Chrome. */
b, strong {
    font-weight: bold;
}

/** Address styling not present in Safari 5 and Chrome. */
dfn {
    font-style: italic;
}

/** Address differences between Firefox and other browsers. */
hr {
    -moz-box-sizing: content-box;
    box-sizing: content-box;
    height: 0;
}

/** Address styling not present in IE 8/9. */
mark {
    background: #ff0;
    color: #000;
}

/** Correct font family set oddly in Safari 5 and Chrome. */
code, kbd, pre, samp {
    font-family: monospace, serif;
    font-size: 1em;
}

/** Improve readability of pre-formatted text in all browsers. */
pre {
    white-space: pre-wrap;
}

/** Set consistent quote types. */
q {
    quotes: "\201C" "\201D" "\2018" "\2019";
}

/** Address inconsistent and variable font size in all browsers. */
small {
    font-size: 80%;
}

/** Prevent `sub` and `sup` affecting `line-height` in all browsers. */
sub, sup {
    font-size: 75%;
    line-height: 0;
    position: relative;
    vertical-align: baseline;
}

sup {
    top: -0.5em;
}

sub {
    bottom: -0.25em;
}

/* ========================================================================== Embedded content ========================================================================== */
/** Remove border when inside `a` element in IE 8/9. */
img {
    border: 0;
}

/** Correct overflow displayed oddly in IE 9. */
svg:not(:root) {
    overflow: hidden;
}

/* ========================================================================== Figures ========================================================================== */
/** Address margin not present in IE 8/9 and Safari 5. */
figure {
    margin: 0;
}

/* ========================================================================== Forms ========================================================================== */
/** Define consistent border, margin, and padding. */
fieldset {
    border: 1px solid #c0c0c0;
    margin: 0 2px;
    padding: 0.35em 0.625em 0.75em;
}

/** 1. Correct `color` not being inherited in IE 8/9. 2. Remove padding so people aren't caught out if they zero out fieldsets. */
legend {
    border: 0; /* 1 */
    padding: 0; /* 2 */
}

/** 1. Correct font family not being inherited in all browsers. 2. Correct font size not being inherited in all browsers. 3. Address margins set differently in Firefox 4+, Safari 5, and Chrome. */
button, input, select, textarea {
    font-family: inherit; /* 1 */
    font-size: 100%; /* 2 */
    margin: 0; /* 3 */
}

/** Address Firefox 4+ setting `line-height` on `input` using `!important` in the UA stylesheet. */
button, input {
    line-height: normal;
}

/** Address inconsistent `text-transform` inheritance for `button` and `select`. All other form control elements do not inherit `text-transform` values. Correct `button` style inheritance in Chrome, Safari 5+, and IE 8+. Correct `select` style inheritance in Firefox 4+ and Opera. */
button, select {
    text-transform: none;
}

/** 1. Avoid the WebKit bug in Android 4.0.* where (2) destroys native `audio` and `video` controls. 2. Correct inability to style clickable `input` types in iOS. 3. Improve usability and consistency of cursor style between image-type `input` and others. */
button, html input[type="button"], input[type="reset"], input[type="submit"] {
    -webkit-appearance: button; /* 2 */
    cursor: pointer; /* 3 */
}

/** Re-set default cursor for disabled elements. */
button[disabled], html input[disabled] {
    cursor: default;
}

/** 1. Address box sizing set to `content-box` in IE 8/9. 2. Remove excess padding in IE 8/9. */
input[type="checkbox"], input[type="radio"] {
    box-sizing: border-box; /* 1 */
    padding: 0; /* 2 */
}

/** 1. Address `appearance` set to `searchfield` in Safari 5 and Chrome. 2. Address `box-sizing` set to `border-box` in Safari 5 and Chrome (include `-moz` to future-proof). */
input[type="search"] {
    -webkit-appearance: textfield; /* 1 */
    -moz-box-sizing: content-box;
    -webkit-box-sizing: content-box; /* 2 */
    box-sizing: content-box;
}

/** Remove inner padding and search cancel button in Safari 5 and Chrome on OS X. */
input[type="search"]::-webkit-search-cancel-button, input[type="search"]::-webkit-search-decoration {
    -webkit-appearance: none;
}

/** Remove inner padding and border in Firefox 4+. */
button::-moz-focus-inner, input::-moz-focus-inner {
    border: 0;
    padding: 0;
}

/** 1. Remove default vertical scrollbar in IE 8/9. 2. Improve readability and alignment in all browsers. */
textarea {
    overflow: auto; /* 1 */
    vertical-align: top; /* 2 */
}

/* ========================================================================== Tables ========================================================================== */
/** Remove most spacing between table cells. */
table {
    border-collapse: collapse;
    border-spacing: 0;
}

meta.foundation-mq-small {
    font-family: "only screen and (min-width: 768px)";
    width: 768px;
}

meta.foundation-mq-medium {
    font-family: "only screen and (min-width:1280px)";
    width: 1280px;
}

meta.foundation-mq-large {
    font-family: "only screen and (min-width:1440px)";
    width: 1440px;
}

*, *:before, *:after {
    -moz-box-sizing: border-box;
    -webkit-box-sizing: border-box;
    box-sizing: border-box;
}

html, body {
    font-size: 100%;
}

body {
    background: white;
    color: rgba(0, 0, 0, 0.8);
    padding: 0;
    margin: 0;
    font-family: "Noto Serif", "DejaVu Serif", serif;
    font-weight: normal;
    font-style: normal;
    line-height: 1;
    position: relative;
    cursor: auto;
}

a:hover {
    cursor: pointer;
}

img, object, embed {
    max-width: 100%;
    height: auto;
}

object, embed {
    height: 100%;
}

img {
    -ms-interpolation-mode: bicubic;
}

#map_canvas img, #map_canvas embed, #map_canvas object, .map_canvas img, .map_canvas embed, .map_canvas object {
    max-width: none !important;
}

.left {
    float: left !important;
}

.right {
    float: right !important;
}

.text-left {
    text-align: left !important;
}

.text-right {
    text-align: right !important;
}

.text-center {
    text-align: center !important;
}

.text-justify {
    text-align: justify !important;
}

.hide {
    display: none;
}

.antialiased, body {
    -webkit-font-smoothing: antialiased;
}

img {
    display: inline-block;
    vertical-align: middle;
}

textarea {
    height: auto;
    min-height: 50px;
}

select {
    width: 100%;
}

p.lead, .paragraph.lead > p, #preamble > .sectionbody > .paragraph:first-of-type p {
    font-size: 1.21875em;
    line-height: 1.6;
}

.subheader, .admonitionblock td.content > .title, .audioblock > .title, .exampleblock > .title, .imageblock > .title, .listingblock > .title, .literalblock > .title, .stemblock > .title, .openblock > .title, .paragraph > .title, .quoteblock > .title, table.tableblock > .title, .verseblock > .title, .videoblock > .title, .dlist > .title, .olist > .title, .ulist > .title, .qlist > .title, .hdlist > .title {
    line-height: 1.45;
    color: #da4552;
    font-weight: normal;
    margin-top: 0;
    margin-bottom: 0.25em;
}

/* Typography resets */
div, dl, dt, dd, ul, ol, li, h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6, pre, form, p, blockquote, th, td {
    margin: 0;
    padding: 0;
    direction: ltr;
}

/* Default Link Styles */
a {
    color: #2156a5;
    text-decoration: underline;
    line-height: inherit;
}

a:hover, a:focus {
    color: #1d4b8f;
}

a img {
    border: none;
}

/* Default paragraph styles */
p {
    font-family: inherit;
    font-weight: normal;
    font-size: 1em;
    line-height: 1.6;
    margin-bottom: 1.25em;
    text-rendering: optimizeLegibility;
}

p aside {
    font-size: 0.875em;
    line-height: 1.35;
    font-style: italic;
}

/* Default header styles */
h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6 {
    font-family: "Open Sans", "DejaVu Sans", sans-serif;
    font-weight: 300;
    font-style: normal;
    color: #da4552;
    text-rendering: optimizeLegibility;
    margin-top: 1em;
    margin-bottom: 0.5em;
    line-height: 1.0125em;
}

h1 small, h2 small, h3 small, #toctitle small, .sidebarblock > .content > .title small, h4 small, h5 small, h6 small {
    font-size: 60%;
    color: #e99b8f;
    line-height: 0;
}

h1 {
    font-size: 2.125em;
}

h2 {
    font-size: 1.6875em;
}

h3, #toctitle, .sidebarblock > .content > .title {
    font-size: 1.375em;
}

h4 {
    font-size: 1.125em;
}

h5 {
    font-size: 1.125em;
}

h6 {
    font-size: 1em;
}

hr {
    border: solid #ddddd8;
    border-width: 1px 0 0;
    clear: both;
    margin: 1.25em 0 1.1875em;
    height: 0;
}

/* Helpful Typography Defaults */
em, i {
    font-style: italic;
    line-height: inherit;
}

strong, b {
    font-weight: bold;
    line-height: inherit;
}

small {
    font-size: 60%;
    line-height: inherit;
}

code {
    font-family: "Droid Sans Mono", "DejaVu Sans Mono", "Monospace", monospace;
    font-weight: normal;
    color: rgba(0, 0, 0, 0.9);
}

/* Lists */
ul, ol, dl {
    font-size: 1em;
    line-height: 1.6;
    margin-bottom: 1.25em;
    list-style-position: outside;
    font-family: inherit;
}

ul, ol {
    margin-left: 1.5em;
}

ul.no-bullet, ol.no-bullet {
    margin-left: 1.5em;
}

/* Unordered Lists */
ul li ul, ul li ol {
    margin-left: 1.25em;
    margin-bottom: 0;
    font-size: 1em; /* Override nested font-size change */
}

ul.square li ul, ul.circle li ul, ul.disc li ul {
    list-style: inherit;
}

ul.square {
    list-style-type: square;
}

ul.circle {
    list-style-type: circle;
}

ul.disc {
    list-style-type: disc;
}

ul.no-bullet {
    list-style: none;
}

/* Ordered Lists */
ol li ul, ol li ol {
    margin-left: 1.25em;
    margin-bottom: 0;
}

/* Definition Lists */
dl dt {
    margin-bottom: 0.3125em;
    font-weight: bold;
}

dl dd {
    margin-bottom: 1.25em;
}

/* Abbreviations */
abbr, acronym {
    text-transform: uppercase;
    font-size: 90%;
    color: rgba(0, 0, 0, 0.8);
    border-bottom: 1px dotted #dddddd;
    cursor: help;
}

abbr {
    text-transform: none;
}

/* Blockquotes */
blockquote {
    margin: 0 0 1.25em;
    padding: 0.5625em 1.25em 0 1.1875em;
    border-left: 1px solid #dddddd;
}

blockquote cite {
    display: block;
    font-size: 0.9375em;
    color: rgba(0, 0, 0, 0.6);
}

blockquote cite:before {
    content: "\2014 \0020";
}

blockquote cite a, blockquote cite a:visited {
    color: rgba(0, 0, 0, 0.6);
}

blockquote, blockquote p {
    line-height: 1.6;
    color: rgba(0, 0, 0, 0.85);
}

/* Microformats */
.vcard {
    display: inline-block;
    margin: 0 0 1.25em 0;
    border: 1px solid #dddddd;
    padding: 0.625em 0.75em;
}

.vcard li {
    margin: 0;
    display: block;
}

.vcard .fn {
    font-weight: bold;
    font-size: 0.9375em;
}

.vevent .summary {
    font-weight: bold;
}

.vevent abbr {
    cursor: auto;
    text-decoration: none;
    font-weight: bold;
    border: none;
    padding: 0 0.0625em;
}

@media only screen and (min-width: 768px) {
    h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6 {
        line-height: 1.2;
    }

    h1 {
        font-size: 2.75em;
    }

    h2 {
        font-size: 2.3125em;
    }

    h3, #toctitle, .sidebarblock > .content > .title {
        font-size: 1.6875em;
    }

    h4 {
        font-size: 1.4375em;
    }
}

/* Tables */
table {
    background: white;
    margin-bottom: 1.25em;
    border: solid 1px #dedede;
}

table thead, table tfoot {
    background: #f7f8f7;
    font-weight: bold;
}

table thead tr th, table thead tr td, table tfoot tr th, table tfoot tr td {
    padding: 0.5em 0.625em 0.625em;
    font-size: inherit;
    color: rgba(0, 0, 0, 0.8);
    text-align: left;
}

table tr th, table tr td {
    padding: 0.5625em 0.625em;
    font-size: inherit;
    color: rgba(0, 0, 0, 0.8);
}

table tr.even, table tr.alt, table tr:nth-of-type(even) {
    background: #f8f8f7;
}

table thead tr th, table tfoot tr th, table tbody tr td, table tr td, table tfoot tr td {
    display: table-cell;
    line-height: 1.6;
}

h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6 {
    line-height: 1.2;
    word-spacing: -0.05em;
}

h1 strong, h2 strong, h3 strong, #toctitle strong, .sidebarblock > .content > .title strong, h4 strong, h5 strong, h6 strong {
    font-weight: 400;
}

.clearfix:before, .clearfix:after, .float-group:before, .float-group:after {
    content: " ";
    display: table;
}

.clearfix:after, .float-group:after {
    clear: both;
}

*:not(pre) > code {
    font-size: 0.9375em;
    font-style: normal !important;
    letter-spacing: 0;
    padding: 0.1em 0.5ex;
    word-spacing: -0.15em;
    background-color: #f7f7f8;
    -webkit-border-radius: 4px;
    border-radius: 4px;
    line-height: 1.45;
    text-rendering: optimizeSpeed;
}

pre, pre > code {
    line-height: 1.45;
    color: rgba(0, 0, 0, 0.9);
    font-family: "Droid Sans Mono", "DejaVu Sans Mono", "Monospace", monospace;
    font-weight: normal;
    text-rendering: optimizeSpeed;
}

.keyseq {
    color: rgba(51, 51, 51, 0.8);
}

kbd {
    display: inline-block;
    color: rgba(0, 0, 0, 0.8);
    font-size: 0.75em;
    line-height: 1.4;
    background-color: #f7f7f7;
    border: 1px solid #ccc;
    -webkit-border-radius: 3px;
    border-radius: 3px;
    -webkit-box-shadow: 0 1px 0 rgba(0, 0, 0, 0.2), 0 0 0 0.1em white inset;
    box-shadow: 0 1px 0 rgba(0, 0, 0, 0.2), 0 0 0 0.1em white inset;
    margin: -0.15em 0.15em 0 0.15em;
    padding: 0.2em 0.6em 0.2em 0.5em;
    vertical-align: middle;
    white-space: nowrap;
}

.keyseq kbd:first-child {
    margin-left: 0;
}

.keyseq kbd:last-child {
    margin-right: 0;
}

.menuseq, .menu {
    color: rgba(0, 0, 0, 0.8);
}

b.button:before, b.button:after {
    position: relative;
    top: -1px;
    font-weight: normal;
}

b.button:before {
    content: "[";
    padding: 0 3px 0 2px;
}

b.button:after {
    content: "]";
    padding: 0 2px 0 3px;
}

p a > code:hover {
    color: rgba(0, 0, 0, 0.9);
}

#header, #content, #footnotes, #footer {
    width: 100%;
    margin-left: auto;
    margin-right: auto;
    margin-top: 0;
    margin-bottom: 0;
    max-width: 62.5em;
    *zoom: 1;
    position: relative;
    padding-left: 0.9375em;
    padding-right: 0.9375em;
}

#header:before, #header:after, #content:before, #content:after, #footnotes:before, #footnotes:after, #footer:before, #footer:after {
    content: " ";
    display: table;
}

#header:after, #content:after, #footnotes:after, #footer:after {
    clear: both;
}

#content {
    margin-top: 1.25em;
}

#content:before {
    content: none;
}

#header > h1:first-child {
    color: rgba(0, 0, 0, 0.85);
    margin-top: 2.25rem;
    margin-bottom: 0;
}

#header > h1:first-child + #toc {
    margin-top: 8px;
    border-top: 1px solid #ddddd8;
}

#header > h1:only-child, body.toc2 #header > h1:nth-last-child(2) {
    border-bottom: 1px solid #ddddd8;
    padding-bottom: 8px;
}

#header .details {
    border-bottom: 1px solid #ddddd8;
    line-height: 1.45;
    padding-top: 0.25em;
    padding-bottom: 0.25em;
    padding-left: 0.25em;
    color: rgba(0, 0, 0, 0.6);
    display: -ms-flexbox;
    display: -webkit-flex;
    display: flex;
    -ms-flex-flow: row wrap;
    -webkit-flex-flow: row wrap;
    flex-flow: row wrap;
}

#header .details span:first-child {
    margin-left: -0.125em;
}

#header .details span.email a {
    color: rgba(0, 0, 0, 0.85);
}

#header .details br {
    display: none;
}

#header .details br + span:before {
    content: "\00a0\2013\00a0";
}

#header .details br + span.author:before {
    content: "\00a0\22c5\00a0";
    color: rgba(0, 0, 0, 0.85);
}

#header .details br + span#revremark:before {
    content: "\00a0|\00a0";
}

#header #revnumber {
    text-transform: capitalize;
}

#header #revnumber:after {
    content: "\00a0";
}

#content > h1:first-child:not([class]) {
    color: rgba(0, 0, 0, 0.85);
    border-bottom: 1px solid #ddddd8;
    padding-bottom: 8px;
    margin-top: 0;
    padding-top: 1rem;
    margin-bottom: 1.25rem;
}

#toc {
    border-bottom: 1px solid #efefed;
    padding-bottom: 0.5em;
}

#toc > ul {
    margin-left: 0.125em;
}

#toc ul.sectlevel0 > li > a {
    font-style: italic;
}

#toc ul.sectlevel0 ul.sectlevel1 {
    margin: 0.5em 0;
}

#toc ul {
    font-family: "Open Sans", "DejaVu Sans", sans-serif;
    list-style-type: none;
}

#toc a {
    text-decoration: none;
}

#toc a:active {
    text-decoration: underline;
}

#toctitle {
    color: #7a2518;
    font-size: 1.2em;
}

@media only screen and (min-width: 768px) {
    #toctitle {
        font-size: 1.375em;
    }

    body.toc2 {
        padding-left: 15em;
        padding-right: 0;
    }

    #toc.toc2 {
        margin-top: 0 !important;
        background-color: #f8f8f7;
        position: fixed;
        width: 15em;
        left: 0;
        top: 0;
        border-right: 1px solid #efefed;
        border-top-width: 0 !important;
        border-bottom-width: 0 !important;
        z-index: 1000;
        padding: 1.25em 1em;
        height: 100%;
        overflow: auto;
    }

    #toc.toc2 #toctitle {
        margin-top: 0;
        font-size: 1.2em;
    }

    #toc.toc2 > ul {
        font-size: 0.9em;
        margin-bottom: 0;
    }

    #toc.toc2 ul ul {
        margin-left: 0;
        padding-left: 1em;
    }

    #toc.toc2 ul.sectlevel0 ul.sectlevel1 {
        padding-left: 0;
        margin-top: 0.5em;
        margin-bottom: 0.5em;
    }

    body.toc2.toc-right {
        padding-left: 0;
        padding-right: 15em;
    }

    body.toc2.toc-right #toc.toc2 {
        border-right-width: 0;
        border-left: 1px solid #efefed;
        left: auto;
        right: 0;
    }
}

@media only screen and (min-width: 1280px) {
    body.toc2 {
        padding-left: 20em;
        padding-right: 0;
    }

    #toc.toc2 {
        width: 20em;
    }

    #toc.toc2 #toctitle {
        font-size: 1.375em;
    }

    #toc.toc2 > ul {
        font-size: 0.95em;
    }

    #toc.toc2 ul ul {
        padding-left: 1.25em;
    }

    body.toc2.toc-right {
        padding-left: 0;
        padding-right: 20em;
    }
}

#content #toc {
    border-style: solid;
    border-width: 1px;
    border-color: #e0e0dc;
    margin-bottom: 1.25em;
    padding: 1.25em;
    background: #f8f8f7;
    -webkit-border-radius: 4px;
    border-radius: 4px;
}

#content #toc > :first-child {
    margin-top: 0;
}

#content #toc > :last-child {
    margin-bottom: 0;
}

#footer {
    max-width: 100%;
    background-color: rgba(0, 0, 0, 0.8);
    padding: 1.25em;
}

#footer-text {
    color: rgba(255, 255, 255, 0.8);
    line-height: 1.44;
}

.sect1 {
    padding-bottom: 0.625em;
}

@media only screen and (min-width: 768px) {
    .sect1 {
        padding-bottom: 1.25em;
    }
}

.sect1 + .sect1 {
    border-top: 1px solid #efefed;
}

#content h1 > a.anchor, h2 > a.anchor, h3 > a.anchor, #toctitle > a.anchor, .sidebarblock > .content > .title > a.anchor, h4 > a.anchor, h5 > a.anchor, h6 > a.anchor {
    position: absolute;
    z-index: 1001;
    width: 1.5ex;
    margin-left: -1.5ex;
    display: block;
    text-decoration: none !important;
    visibility: hidden;
    text-align: center;
    font-weight: normal;
}

#content h1 > a.anchor:before, h2 > a.anchor:before, h3 > a.anchor:before, #toctitle > a.anchor:before, .sidebarblock > .content > .title > a.anchor:before, h4 > a.anchor:before, h5 > a.anchor:before, h6 > a.anchor:before {
    content: "\00A7";
    font-size: 0.85em;
    display: block;
    padding-top: 0.1em;
}

#content h1:hover > a.anchor, #content h1 > a.anchor:hover, h2:hover > a.anchor, h2 > a.anchor:hover, h3:hover > a.anchor, #toctitle:hover > a.anchor, .sidebarblock > .content > .title:hover > a.anchor, h3 > a.anchor:hover, #toctitle > a.anchor:hover, .sidebarblock > .content > .title > a.anchor:hover, h4:hover > a.anchor, h4 > a.anchor:hover, h5:hover > a.anchor, h5 > a.anchor:hover, h6:hover > a.anchor, h6 > a.anchor:hover {
    visibility: visible;
}

#content h1 > a.link, h2 > a.link, h3 > a.link, #toctitle > a.link, .sidebarblock > .content > .title > a.link, h4 > a.link, h5 > a.link, h6 > a.link {
    color: #da4552;
    text-decoration: none;
}

#content h1 > a.link:hover, h2 > a.link:hover, h3 > a.link:hover, #toctitle > a.link:hover, .sidebarblock > .content > .title > a.link:hover, h4 > a.link:hover, h5 > a.link:hover, h6 > a.link:hover {
    color: #a53221;
}

.audioblock, .imageblock, .literalblock, .listingblock, .stemblock, .videoblock {
    margin-bottom: 1.25em;
}

.admonitionblock td.content > .title, .audioblock > .title, .exampleblock > .title, .imageblock > .title, .listingblock > .title, .literalblock > .title, .stemblock > .title, .openblock > .title, .paragraph > .title, .quoteblock > .title, table.tableblock > .title, .verseblock > .title, .videoblock > .title, .dlist > .title, .olist > .title, .ulist > .title, .qlist > .title, .hdlist > .title {
    text-rendering: optimizeLegibility;
    text-align: left;
    font-family: "Noto Serif", "DejaVu Serif", serif;
    font-size: 1rem;
    font-style: italic;
}

table.tableblock > caption.title {
    white-space: nowrap;
    overflow: visible;
    max-width: 0;
}

.paragraph.lead > p, #preamble > .sectionbody > .paragraph:first-of-type p {
    color: rgba(0, 0, 0, 0.85);
}

table.tableblock #preamble > .sectionbody > .paragraph:first-of-type p {
    font-size: inherit;
}

.admonitionblock > table {
    border-collapse: separate;
    border: 0;
    background: none;
    width: 100%;
}

.admonitionblock > table td.icon {
    text-align: center;
    width: 80px;
}

.admonitionblock > table td.icon img {
    max-width: none;
}

.admonitionblock > table td.icon .title {
    font-weight: bold;
    font-family: "Open Sans", "DejaVu Sans", sans-serif;
    text-transform: uppercase;
}

.admonitionblock > table td.content {
    padding-left: 1.125em;
    padding-right: 1.25em;
    border-left: 1px solid #ddddd8;
    color: rgba(0, 0, 0, 0.6);
}

.admonitionblock > table td.content > :last-child > :last-child {
    margin-bottom: 0;
}

.exampleblock > .content {
    border-style: solid;
    border-width: 1px;
    border-color: #e6e6e6;
    margin-bottom: 1.25em;
    padding: 1.25em;
    background: white;
    -webkit-border-radius: 4px;
    border-radius: 4px;
}

.exampleblock > .content > :first-child {
    margin-top: 0;
}

.exampleblock > .content > :last-child {
    margin-bottom: 0;
}

.sidebarblock {
    border-style: solid;
    border-width: 1px;
    border-color: #e0e0dc;
    margin-bottom: 1.25em;
    padding: 1.25em;
    background: #f8f8f7;
    -webkit-border-radius: 4px;
    border-radius: 4px;
}

.sidebarblock > :first-child {
    margin-top: 0;
}

.sidebarblock > :last-child {
    margin-bottom: 0;
}

.sidebarblock > .content > .title {
    color: #7a2518;
    margin-top: 0;
    text-align: center;
}

.exampleblock > .content > :last-child > :last-child, .exampleblock > .content .olist > ol > li:last-child > :last-child, .exampleblock > .content .ulist > ul > li:last-child > :last-child, .exampleblock > .content .qlist > ol > li:last-child > :last-child, .sidebarblock > .content > :last-child > :last-child, .sidebarblock > .content .olist > ol > li:last-child > :last-child, .sidebarblock > .content .ulist > ul > li:last-child > :last-child, .sidebarblock > .content .qlist > ol > li:last-child > :last-child {
    margin-bottom: 0;
}

.literalblock pre, .listingblock pre:not(.highlight), .listingblock pre[class="highlight"], .listingblock pre[class^="highlight "], .listingblock pre.CodeRay, .listingblock pre.prettyprint {
    background: #f7f7f8;
}

.sidebarblock .literalblock pre, .sidebarblock .listingblock pre:not(.highlight), .sidebarblock .listingblock pre[class="highlight"], .sidebarblock .listingblock pre[class^="highlight "], .sidebarblock .listingblock pre.CodeRay, .sidebarblock .listingblock pre.prettyprint {
    background: #f2f1f1;
}

.literalblock pre, .literalblock pre[class], .listingblock pre, .listingblock pre[class] {
    -webkit-border-radius: 4px;
    border-radius: 4px;
    word-wrap: break-word;
    padding: 1em;
    font-size: 0.8125em;
}

.literalblock pre.nowrap, .literalblock pre[class].nowrap, .listingblock pre.nowrap, .listingblock pre[class].nowrap {
    overflow-x: auto;
    white-space: pre;
    word-wrap: normal;
}

@media only screen and (min-width: 768px) {
    .literalblock pre, .literalblock pre[class], .listingblock pre, .listingblock pre[class] {
        font-size: 0.90625em;
    }
}

@media only screen and (min-width: 1280px) {
    .literalblock pre, .literalblock pre[class], .listingblock pre, .listingblock pre[class] {
        font-size: 1em;
    }
}

.literalblock.output pre {
    color: #f7f7f8;
    background-color: rgba(0, 0, 0, 0.9);
}

.listingblock pre.highlightjs {
    padding: 0;
}

.listingblock pre.highlightjs > code {
    padding: 1em;
    -webkit-border-radius: 4px;
    border-radius: 4px;
}

.listingblock pre.prettyprint {
    border-width: 0;
}

.listingblock > .content {
    position: relative;
}

.listingblock code[data-lang]:before {
    display: none;
    content: attr(data-lang);
    position: absolute;
    font-size: 0.75em;
    top: 0.425rem;
    right: 0.5rem;
    line-height: 1;
    text-transform: uppercase;
    color: #999;
}

.listingblock:hover code[data-lang]:before {
    display: block;
}

.listingblock.terminal pre .command:before {
    content: attr(data-prompt);
    padding-right: 0.5em;
    color: #999;
}

.listingblock.terminal pre .command:not([data-prompt]):before {
    content: "$";
}

table.pyhltable {
    border-collapse: separate;
    border: 0;
    margin-bottom: 0;
    background: none;
}

table.pyhltable td {
    vertical-align: top;
    padding-top: 0;
    padding-bottom: 0;
}

table.pyhltable td.code {
    padding-left: .75em;
    padding-right: 0;
}

pre.pygments .lineno, table.pyhltable td:not(.code) {
    color: #999;
    padding-left: 0;
    padding-right: .5em;
    border-right: 1px solid #ddddd8;
}

pre.pygments .lineno {
    display: inline-block;
    margin-right: .25em;
}

table.pyhltable .linenodiv {
    background: none !important;
    padding-right: 0 !important;
}

.quoteblock {
    margin: 0 1em 1.25em 1.5em;
    display: table;
}

.quoteblock > .title {
    margin-left: -1.5em;
    margin-bottom: 0.75em;
}

.quoteblock blockquote, .quoteblock blockquote p {
    color: rgba(0, 0, 0, 0.85);
    font-size: 1.15rem;
    line-height: 1.75;
    word-spacing: 0.1em;
    letter-spacing: 0;
    font-style: italic;
    text-align: justify;
}

.quoteblock blockquote {
    margin: 0;
    padding: 0;
    border: 0;
}

.quoteblock blockquote:before {
    content: "\201c";
    float: left;
    font-size: 2.75em;
    font-weight: bold;
    line-height: 0.6em;
    margin-left: -0.6em;
    color: #7a2518;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
}

.quoteblock blockquote > .paragraph:last-child p {
    margin-bottom: 0;
}

.quoteblock .attribution {
    margin-top: 0.5em;
    margin-right: 0.5ex;
    text-align: right;
}

.quoteblock .quoteblock {
    margin-left: 0;
    margin-right: 0;
    padding: 0.5em 0;
    border-left: 3px solid rgba(0, 0, 0, 0.6);
}

.quoteblock .quoteblock blockquote {
    padding: 0 0 0 0.75em;
}

.quoteblock .quoteblock blockquote:before {
    display: none;
}

.verseblock {
    margin: 0 1em 1.25em 1em;
}

.verseblock pre {
    font-family: "Open Sans", "DejaVu Sans", sans;
    font-size: 1.15rem;
    color: rgba(0, 0, 0, 0.85);
    font-weight: 300;
    text-rendering: optimizeLegibility;
}

.verseblock pre strong {
    font-weight: 400;
}

.verseblock .attribution {
    margin-top: 1.25rem;
    margin-left: 0.5ex;
}

.quoteblock .attribution, .verseblock .attribution {
    font-size: 0.9375em;
    line-height: 1.45;
    font-style: italic;
}

.quoteblock .attribution br, .verseblock .attribution br {
    display: none;
}

.quoteblock .attribution cite, .verseblock .attribution cite {
    display: block;
    letter-spacing: -0.05em;
    color: rgba(0, 0, 0, 0.6);
}

.quoteblock.abstract {
    margin: 0 0 1.25em 0;
    display: block;
}

.quoteblock.abstract blockquote, .quoteblock.abstract blockquote p {
    text-align: left;
    word-spacing: 0;
}

.quoteblock.abstract blockquote:before, .quoteblock.abstract blockquote p:first-of-type:before {
    display: none;
}

table.tableblock {
    max-width: 100%;
    border-collapse: separate;
}

table.tableblock td > .paragraph:last-child p > p:last-child, table.tableblock th > p:last-child, table.tableblock td > p:last-child {
    margin-bottom: 0;
}

table.spread {
    width: 100%;
}

table.tableblock, th.tableblock, td.tableblock {
    border: 0 solid #dedede;
}

table.grid-all th.tableblock, table.grid-all td.tableblock {
    border-width: 0 1px 1px 0;
}

table.grid-all tfoot > tr > th.tableblock, table.grid-all tfoot > tr > td.tableblock {
    border-width: 1px 1px 0 0;
}

table.grid-cols th.tableblock, table.grid-cols td.tableblock {
    border-width: 0 1px 0 0;
}

table.grid-all * > tr > .tableblock:last-child, table.grid-cols * > tr > .tableblock:last-child {
    border-right-width: 0;
}

table.grid-rows th.tableblock, table.grid-rows td.tableblock {
    border-width: 0 0 1px 0;
}

table.grid-all tbody > tr:last-child > th.tableblock, table.grid-all tbody > tr:last-child > td.tableblock, table.grid-all thead:last-child > tr > th.tableblock, table.grid-rows tbody > tr:last-child > th.tableblock, table.grid-rows tbody > tr:last-child > td.tableblock, table.grid-rows thead:last-child > tr > th.tableblock {
    border-bottom-width: 0;
}

table.grid-rows tfoot > tr > th.tableblock, table.grid-rows tfoot > tr > td.tableblock {
    border-width: 1px 0 0 0;
}

table.frame-all {
    border-width: 1px;
}

table.frame-sides {
    border-width: 0 1px;
}

table.frame-topbot {
    border-width: 1px 0;
}

th.halign-left, td.halign-left {
    text-align: left;
}

th.halign-right, td.halign-right {
    text-align: right;
}

th.halign-center, td.halign-center {
    text-align: center;
}

th.valign-top, td.valign-top {
    vertical-align: top;
}

th.valign-bottom, td.valign-bottom {
    vertical-align: bottom;
}

th.valign-middle, td.valign-middle {
    vertical-align: middle;
}

table thead th, table tfoot th {
    font-weight: bold;
}

tbody tr th {
    display: table-cell;
    line-height: 1.6;
    background: #f7f8f7;
}

tbody tr th, tbody tr th p, tfoot tr th, tfoot tr th p {
    color: rgba(0, 0, 0, 0.8);
    font-weight: bold;
}

p.tableblock > code:only-child {
    background: none;
    padding: 0;
}

p.tableblock {
    font-size: 1em;
}

td > div.verse {
    white-space: pre;
}

ol {
    margin-left: 1.75em;
}

ul li ol {
    margin-left: 1.5em;
}

dl dd {
    margin-left: 1.125em;
}

dl dd:last-child, dl dd:last-child > :last-child {
    margin-bottom: 0;
}

ol > li p, ul > li p, ul dd, ol dd, .olist .olist, .ulist .ulist, .ulist .olist, .olist .ulist {
    margin-bottom: 0.625em;
}

ul.unstyled, ol.unnumbered, ul.checklist, ul.none {
    list-style-type: none;
}

ul.unstyled, ol.unnumbered, ul.checklist {
    margin-left: 0.625em;
}

ul.checklist li > p:first-child > .fa-check-square-o:first-child, ul.checklist li > p:first-child > input[type="checkbox"]:first-child {
    margin-right: 0.25em;
}

ul.checklist li > p:first-child > input[type="checkbox"]:first-child {
    position: relative;
    top: 1px;
}

ul.inline {
    margin: 0 auto 0.625em auto;
    margin-left: -1.375em;
    margin-right: 0;
    padding: 0;
    list-style: none;
    overflow: hidden;
}

ul.inline > li {
    list-style: none;
    float: left;
    margin-left: 1.375em;
    display: block;
}

ul.inline > li > * {
    display: block;
}

.unstyled dl dt {
    font-weight: normal;
    font-style: normal;
}

ol.arabic {
    list-style-type: decimal;
}

ol.decimal {
    list-style-type: decimal-leading-zero;
}

ol.loweralpha {
    list-style-type: lower-alpha;
}

ol.upperalpha {
    list-style-type: upper-alpha;
}

ol.lowerroman {
    list-style-type: lower-roman;
}

ol.upperroman {
    list-style-type: upper-roman;
}

ol.lowergreek {
    list-style-type: lower-greek;
}

.hdlist > table, .colist > table {
    border: 0;
    background: none;
}

.hdlist > table > tbody > tr, .colist > table > tbody > tr {
    background: none;
}

td.hdlist1 {
    padding-right: .75em;
    font-weight: bold;
}

td.hdlist1, td.hdlist2 {
    vertical-align: top;
}

.literalblock + .colist, .listingblock + .colist {
    margin-top: -0.5em;
}

.colist > table tr > td:first-of-type {
    padding: 0 0.75em;
    line-height: 1;
}

.colist > table tr > td:last-of-type {
    padding: 0.25em 0;
}

.thumb, .th {
    line-height: 0;
    display: inline-block;
    border: solid 4px white;
    -webkit-box-shadow: 0 0 0 1px #dddddd;
    box-shadow: 0 0 0 1px #dddddd;
}

.imageblock.left, .imageblock[style*="float: left"] {
    margin: 0.25em 0.625em 1.25em 0;
}

.imageblock.right, .imageblock[style*="float: right"] {
    margin: 0.25em 0 1.25em 0.625em;
}

.imageblock > .title {
    margin-bottom: 0;
}

.imageblock.thumb, .imageblock.th {
    border-width: 6px;
}

.imageblock.thumb > .title, .imageblock.th > .title {
    padding: 0 0.125em;
}

.image.left, .image.right {
    margin-top: 0.25em;
    margin-bottom: 0.25em;
    display: inline-block;
    line-height: 0;
}

.image.left {
    margin-right: 0.625em;
}

.image.right {
    margin-left: 0.625em;
}

a.image {
    text-decoration: none;
}

span.footnote, span.footnoteref {
    vertical-align: super;
    font-size: 0.875em;
}

span.footnote a, span.footnoteref a {
    text-decoration: none;
}

span.footnote a:active, span.footnoteref a:active {
    text-decoration: underline;
}

#footnotes {
    padding-top: 0.75em;
    padding-bottom: 0.75em;
    margin-bottom: 0.625em;
}

#footnotes hr {
    width: 20%;
    min-width: 6.25em;
    margin: -.25em 0 .75em 0;
    border-width: 1px 0 0 0;
}

#footnotes .footnote {
    padding: 0 0.375em;
    line-height: 1.3;
    font-size: 0.875em;
    margin-left: 1.2em;
    text-indent: -1.2em;
    margin-bottom: .2em;
}

#footnotes .footnote a:first-of-type {
    font-weight: bold;
    text-decoration: none;
}

#footnotes .footnote:last-of-type {
    margin-bottom: 0;
}

#content #footnotes {
    margin-top: -0.625em;
    margin-bottom: 0;
    padding: 0.75em 0;
}

.gist .file-data > table {
    border: 0;
    background: #fff;
    width: 100%;
    margin-bottom: 0;
}

.gist .file-data > table td.line-data {
    width: 99%;
}

div.unbreakable {
    page-break-inside: avoid;
}

.big {
    font-size: larger;
}

.small {
    font-size: smaller;
}

.underline {
    text-decoration: underline;
}

.overline {
    text-decoration: overline;
}

.line-through {
    text-decoration: line-through;
}

.aqua {
    color: #00bfbf;
}

.aqua-background {
    background-color: #00fafa;
}

.black {
    color: black;
}

.black-background {
    background-color: black;
}

.blue {
    color: #0000bf;
}

.blue-background {
    background-color: #0000fa;
}

.fuchsia {
    color: #bf00bf;
}

.fuchsia-background {
    background-color: #fa00fa;
}

.gray {
    color: #606060;
}

.gray-background {
    background-color: #7d7d7d;
}

.green {
    color: #006000;
}

.green-background {
    background-color: #007d00;
}

.lime {
    color: #00bf00;
}

.lime-background {
    background-color: #00fa00;
}

.maroon {
    color: #600000;
}

.maroon-background {
    background-color: #7d0000;
}

.navy {
    color: #000060;
}

.navy-background {
    background-color: #00007d;
}

.olive {
    color: #606000;
}

.olive-background {
    background-color: #7d7d00;
}

.purple {
    color: #600060;
}

.purple-background {
    background-color: #7d007d;
}

.red {
    color: #bf0000;
}

.red-background {
    background-color: #fa0000;
}

.silver {
    color: #909090;
}

.silver-background {
    background-color: #bcbcbc;
}

.teal {
    color: #006060;
}

.teal-background {
    background-color: #007d7d;
}

.white {
    color: #bfbfbf;
}

.white-background {
    background-color: #fafafa;
}

.yellow {
    color: #bfbf00;
}

.yellow-background {
    background-color: #fafa00;
}

span.icon > .fa {
    cursor: default;
}

.admonitionblock td.icon [class^="fa icon-"] {
    font-size: 2.5em;
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
    cursor: default;
}

.admonitionblock td.icon .icon-note:before {
    content: "\f05a";
    color: #19407c;
}

.admonitionblock td.icon .icon-tip:before {
    content: "\f0eb";
    text-shadow: 1px 1px 2px rgba(155, 155, 0, 0.8);
    color: #111;
}

.admonitionblock td.icon .icon-warning:before {
    content: "\f071";
    color: #bf6900;
}

.admonitionblock td.icon .icon-caution:before {
    content: "\f06d";
    color: #bf3400;
}

.admonitionblock td.icon .icon-important:before {
    content: "\f06a";
    color: #bf0000;
}

.conum[data-value] {
    display: inline-block;
    color: #fff !important;
    background-color: rgba(0, 0, 0, 0.8);
    -webkit-border-radius: 100px;
    border-radius: 100px;
    text-align: center;
    font-size: 0.75em;
    width: 1.67em;
    height: 1.67em;
    line-height: 1.67em;
    font-family: "Open Sans", "DejaVu Sans", sans-serif;
    font-style: normal;
    font-weight: bold;
}

.conum[data-value] * {
    color: #fff !important;
}

.conum[data-value] + b {
    display: none;
}

.conum[data-value]:after {
    content: attr(data-value);
}

pre .conum[data-value] {
    position: relative;
    top: -0.125em;
}

b.conum * {
    color: inherit !important;
}

.conum:not([data-value]):empty {
    display: none;
}

h1, h2 {
    letter-spacing: -0.01em;
}

dt, th.tableblock, td.content {
    text-rendering: optimizeLegibility;
}

p, td.content {
    letter-spacing: -0.01em;
}

p strong, td.content strong {
    letter-spacing: -0.005em;
}

p, blockquote, dt, td.content {
    font-size: 1.0625rem;
}

p {
    margin-bottom: 1.25rem;
}

.sidebarblock p, .sidebarblock dt, .sidebarblock td.content, p.tableblock {
    font-size: 1em;
}

.exampleblock > .content {
    background-color: #fffef7;
    border-color: #e0e0dc;
    -webkit-box-shadow: 0 1px 4px #e0e0dc;
    box-shadow: 0 1px 4px #e0e0dc;
}

.print-only {
    display: none !important;
}

@media print {
    @page {
        margin: 1.25cm 0.75cm;
    }

    * {
        -webkit-box-shadow: none !important;
        box-shadow: none !important;
        text-shadow: none !important;
    }

    a {
        color: inherit !important;
        text-decoration: underline !important;
    }

    a.bare, a[href^="#"], a[href^="mailto:"] {
        text-decoration: none !important;
    }

    a[href^="http:"]:not(.bare):after, a[href^="https:"]:not(.bare):after, a[href^="mailto:"]:not(.bare):after {
        content: "(" attr(href) ")";
        display: inline-block;
        font-size: 0.875em;
        padding-left: 0.25em;
    }

    abbr[title]:after {
        content: " (" attr(title) ")";
    }

    pre, blockquote, tr, img {
        page-break-inside: avoid;
    }

    thead {
        display: table-header-group;
    }

    img {
        max-width: 100% !important;
    }

    p, blockquote, dt, td.content {
        font-size: 1em;
        orphans: 3;
        widows: 3;
    }

    h2, h3, #toctitle, .sidebarblock > .content > .title, #toctitle, .sidebarblock > .content > .title {
        page-break-after: avoid;
    }

    #toc, .sidebarblock, .exampleblock > .content {
        background: none !important;
    }

    #toc {
        border-bottom: 1px solid #ddddd8 !important;
        padding-bottom: 0 !important;
    }

    .sect1 {
        padding-bottom: 0 !important;
    }

    .sect1 + .sect1 {
        border: 0 !important;
    }

    #header > h1:first-child {
        margin-top: 1.25rem;
    }

    body.book #header {
        text-align: center;
    }

    body.book #header > h1:first-child {
        border: 0 !important;
        margin: 2.5em 0 1em 0;
    }

    body.book #header .details {
        border: 0 !important;
        display: block;
        padding: 0 !important;
    }

    body.book #header .details span:first-child {
        margin-left: 0 !important;
    }

    body.book #header .details br {
        display: block;
    }

    body.book #header .details br + span:before {
        content: none !important;
    }

    body.book #toc {
        border: 0 !important;
        text-align: left !important;
        padding: 0 !important;
        margin: 0 !important;
    }

    body.book #toc, body.book #preamble, body.book h1.sect0, body.book .sect1 > h2 {
        page-break-before: always;
    }

    .listingblock code[data-lang]:before {
        display: block;
    }

    #footer {
        background: none !important;
        padding: 0 0.9375em;
    }

    #footer-text {
        color: rgba(0, 0, 0, 0.6) !important;
        font-size: 0.9em;
    }

    .hide-on-print {
        display: none !important;
    }

    .print-only {
        display: block !important;
    }

    .hide-for-print {
        display: none !important;
    }

    .show-for-print {
        display: inherit !important;
    }
}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.4.0/css/font-awesome.min.css">
</head>
<body class="book toc2 toc-left">
<div id="header">
<h1>Internet of Things (IoT) in 5 days</h1>
<div class="details">
<span id="author" class="author">Antonio Li침치n Colina, Alvaro Vives, Antoine Bagula, Marco Zennaro and Ermanno Pietrosemoli</span><br>
<span id="revnumber">version 1.0,</span>
<span id="revdate">2015</span>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#trueabout-the-release">About the Release</a></li>
<li><a href="#trueabout-the-book">About the Book</a></li>
<li><a href="#truethe-internet-of-things-iot">The Internet of Things (IoT)</a></li>
<li><a href="#trueintroduction-to-ipv6">Introduction to IPv6</a>
<ul class="sectlevel2">
<li><a href="#truea-little-bit-of-history">A little bit of History</a></li>
<li><a href="#trueipv6-concepts">IPv6 Concepts</a>
<ul class="sectlevel3">
<li><a href="#trueipv6-packet">IPv6 packet</a></li>
<li><a href="#trueipv6-addressing">IPv6 addressing</a></li>
<li><a href="#trueipv6-network-prefix">IPv6 network prefix</a></li>
</ul>
</li>
<li><a href="#truewhat-is-ipv6-used-for">What is IPv6 used for?</a></li>
<li><a href="#truenetwork-example">Network Example</a></li>
<li><a href="#trueshort-intro-to-wireshark">Short intro to Wireshark</a></li>
<li><a href="#trueipv6-exercises">IPv6 Exercises</a></li>
<li><a href="#trueaddressing-exercises">Addressing Exercises</a></li>
<li><a href="#trueconnecting-our-ipv6-network-to-the-internet">Connecting our IPv6 Network to the Internet</a></li>
</ul>
</li>
<li><a href="#trueintroduction-to-6lowpan">Introduction to 6LoWPAN</a>
<ul class="sectlevel3">
<li><a href="#trueoverview-of-lowpans">Overview of LoWPANs</a></li>
<li><a href="#trueabout-the-use-of-ip-on-lowpans">About the use of IP on LoWPANs</a></li>
<li><a href="#true6lowpan">6LoWPAN</a></li>
<li><a href="#trueipv6-interface-identifier-iid">IPv6 Interface Identifier (IID)</a></li>
<li><a href="#trueheader-compression">Header Compression</a></li>
<li><a href="#truendp-optimization">NDP optimization</a></li>
</ul>
</li>
<li><a href="#trueintroduction-to-contiki">Introduction to Contiki</a>
<ul class="sectlevel2">
<li><a href="#trueinstall-contiki">Install Contiki</a>
<ul class="sectlevel3">
<li><a href="#truefresh-contiki-installation">Fresh Contiki Installation</a>
<ul class="sectlevel4">
<li><a href="#trueinstall-the-toolchain-and-required-libraries">Install the toolchain and required libraries</a></li>
<li><a href="#trueget-contiki-on-your-machine">Get Contiki on your machine</a></li>
</ul>
</li>
<li><a href="#trueusing-a-virtualized-environment">Using a virtualized environment</a>
<ul class="sectlevel4">
<li><a href="#trueinstant-contiki-virtual-machine">Instant Contiki Virtual Machine</a></li>
<li><a href="#trueofficial-iot-in-five-days-virtual-machine">Official "IoT in five days" Virtual Machine</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#truetest-contiki-installation">Test Contiki installation</a></li>
<li><a href="#truecontiki-structure">Contiki structure</a></li>
<li><a href="#truerun-contiki-on-real-hardware">Run Contiki on real hardware</a>
<ul class="sectlevel3">
<li><a href="#truezolertia-zoul-module-and-the-re-mote-development-platform">Zolertia Zoul module and the RE-Mote development platform</a></li>
<li><a href="#truezolertia-z1-mote">Zolertia Z1 mote</a></li>
<li><a href="#truewhat-are-the-differences-between-the-re-mote-and-the-z1-platforms">What are the differences between the RE-Mote and the Z1 platforms?</a></li>
</ul>
</li>
<li><a href="#truestart-with-contiki">Start with Contiki!</a>
<ul class="sectlevel3">
<li><a href="#truehello-world-explained">Hello world explained</a></li>
<li><a href="#truemakefile-explained">Makefile explained</a></li>
<li><a href="#truetest-the-leds-and-button">Test the LEDs and Button</a></li>
<li><a href="#truetimers">Timers</a></li>
<li><a href="#trueprocesses-in-contiki">Processes in Contiki</a></li>
<li><a href="#truesensors">Sensors</a>
<ul class="sectlevel4">
<li><a href="#trueanalogue-sensors">Analogue Sensors</a></li>
<li><a href="#truedigital-sensors">Digital Sensors</a></li>
<li><a href="#trueon-board-sensors-and-adc">On-board sensors and ADC</a></li>
</ul>
</li>
<li><a href="#truegeneral-input-output-pins-gpio">General input/output pins (GPIO)</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#truewireless-with-contiki">Wireless with Contiki</a>
<ul class="sectlevel2">
<li><a href="#trueaddressing-and-radio-frequency-basics">Addressing and Radio Frequency basics</a>
<ul class="sectlevel3">
<li><a href="#truedevice-addressing">Device addressing</a>
<ul class="sectlevel4">
<li><a href="#truere-mote-addresses">RE-Mote addresses</a></li>
<li><a href="#truez1-mote-addresses">Z1 mote addresses</a></li>
</ul>
</li>
<li><a href="#trueset-the-bandwidth-and-channel">Set the bandwidth and channel</a>
<ul class="sectlevel4">
<li><a href="#trueworking-at-2-4-ghz">Working at 2.4 GHz</a></li>
<li><a href="#trueworking-at-863-950-mhz">Working at 863-950 MHz</a></li>
</ul>
</li>
<li><a href="#trueset-the-transmission-power">Set the transmission power</a>
<ul class="sectlevel4">
<li><a href="#truechanging-the-transmission-power-for-the-z1-cc2420-and-the-re-mote-cc2538">Changing the transmission power for the Z1 (CC2420) and the RE-Mote (CC2538)</a></li>
<li><a href="#truechanging-the-transmission-power-for-the-re-mote-cc1200">Changing the transmission power for the RE-Mote (CC1200)</a></li>
</ul>
</li>
<li><a href="#truechecking-the-wireless-link">Checking the wireless link</a></li>
</ul>
</li>
<li><a href="#trueconfigure-the-mac-layer">Configure the MAC layer</a>
<ul class="sectlevel3">
<li><a href="#truemac-driver">MAC driver</a></li>
<li><a href="#truerdc-driver">RDC driver</a></li>
<li><a href="#trueframer-driver">Framer driver</a></li>
</ul>
</li>
<li><a href="#trueipv6-and-routing">IPv6 and Routing</a>
<ul class="sectlevel3">
<li><a href="#trueipv6">IPv6</a></li>
<li><a href="#truerpl">RPL</a></li>
</ul>
</li>
<li><a href="#trueset-up-a-wireless-sniffer">Set up a wireless sniffer</a></li>
<li><a href="#trueudp-on-ipv6-and-the-border-router">UDP on IPv6 and the Border Router</a>
<ul class="sectlevel3">
<li><a href="#truethe-udp-api">The UDP API</a></li>
<li><a href="#trueudp-link-local-multicast-example">UDP Link-Local multicast example</a></li>
<li><a href="#truethe-border-router">The Border Router</a></li>
<li><a href="#truehands-on-connecting-an-ipv6-udp-network-to-our-host">Hands on: connecting an IPv6 UDP network to our host</a>
<ul class="sectlevel4">
<li><a href="#truerunning-the-udp-server-mqtt-forwarder">Running the UDP server MQTT forwarder</a></li>
<li><a href="#truerunning-the-udp-server-ifttt-forwarder">Running the UDP server IFTTT forwarder</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#truetcp-on-ipv6">TCP on IPv6</a>
<ul class="sectlevel3">
<li><a href="#truethe-tcp-api">The TCP API</a></li>
<li><a href="#truehands-on-tcp-example">Hands on: TCP example</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#truecoap-mqtt-and-http">CoAP, MQTT and HTTP</a>
<ul class="sectlevel2">
<li><a href="#truecoap-example">CoAP example</a>
<ul class="sectlevel3">
<li><a href="#truecoap-api">CoAP API</a></li>
<li><a href="#truehands-on-coap-server-and-copper">Hands on: CoAP server and Copper</a></li>
</ul>
</li>
<li><a href="#truemqtt-example">MQTT example</a>
<ul class="sectlevel3">
<li><a href="#truemqtt-api">MQTT API</a></li>
<li><a href="#truehands-on-mqtt-example">Hands on: MQTT example</a></li>
</ul>
</li>
<li><a href="#truehands-on-connecting-to-a-real-world-iot-platform-http-based">Hands on: connecting to a real world IoT platform (HTTP-based)</a></li>
<li><a href="#trueubidots-ipv6-example-in-native-contiki">Ubidots IPv6 example in native Contiki</a></li>
</ul>
</li>
<li><a href="#trueacronyms">ACRONYMS</a></li>
<li><a href="#truebibliography">Bibliography</a></li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="trueabout-the-release"><a class="anchor" href="#trueabout-the-release"></a>About the Release</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This "IoT in five days" release version correspond to:</p>
</div>
<div class="paragraph">
<p><strong>Version</strong>: 1.1</p>
</div>
<div class="paragraph">
<p><strong>Date</strong>: 24th June 2016</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/i/license.jpg" alt="license.jpg">
</div>
</div>
<div class="paragraph">
<p>This book and sources are distributed under the terms of the Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">(CC BY-NC-SA 4.0)</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="trueabout-the-book"><a class="anchor" href="#trueabout-the-book"></a>About the Book</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The "IoT in five days" book is in active development by a joint effort from both academia and industrial collaborators, acknowledging that the Internet of Things of the future will be built on top of scalable and mature protocols, such as IPv6, 6LoWPAN and IEEE 802.15.4.  Open Source Operating Systems as Contiki, with more than 10 years of history and actively supported by universities and research centers, have been paving the Internet of Things road since the early beginnings of Wireless Sensor Networks and M2M communication, enabling the new IoT paradigm.</p>
</div>
<div class="paragraph">
<p>The content of the book are Open Source as well, feedback and contribution is more than welcome!  Please engage visiting  <a href="https://github.com/marcozennaro/IPv6-WSN-book">IoT in five days GitHub repository</a></p>
</div>
<div class="paragraph">
<p>The book has been developed in asciidoc, and it can be compiled from its sources to produce HTML, PDF, eBook and others formats.</p>
</div>
<div class="paragraph">
<p>The following are the authors who contributed to this book:</p>
</div>
<div class="paragraph">
<p><strong>Antonio Li침치n</strong> defines himself as <em>"an engineer at day, maker at night"</em> (he would do both for free).
He has more than 8 years of experience,having worked in over than 20 projects of in Wireless Sensor Networks (WSN), Internet of Things (IoT) applications and embedded firmware development; employed at Zolertia as both senior R+D engineer and CTO, buf if you ask him he just <em>"makes things blink and chat"</em>.  In his free time he&#8217;s normally
engaged in Coursera, collecting hardware platforms, dwelling in hackathons or preaching about GIT.  He has a Master at the University of Los Andes (Colombia), has worked in European Projects related to Smart Cities, Internet of Things and Security, and currently is a prominent contributor in severals Open Source communities, like the one focusing on Contiki.</p>
</div>
<div class="paragraph">
<p><strong>Alvaro Vives</strong> loves technology, problem solving, learning and teaching. Doing these things he has become a consultant, a network and systems engineer, and a trainer. As a consultant, he has worked on projects in several countries, at ISPs, content providers, public organizations and enterprises. As a trainer, since 2006 has lectured at more than 46 workshops in 18 countries directed to ISPs, content providers, public organizations, enterprises as well as in events like LACNIC/LACNOG, SANOG, WALC, and ESNOG. As network and systems administrator he has been in charge of production networks and services in several companies using different technologies from a variety of vendors. At present, he is working with WSN and IoT as a consequence of the convergence of IPv6 and IoT.</p>
</div>
<div class="paragraph">
<p><strong>Antoine Bagula</strong> obtained his doctoral degree in 2006 from the KTH-Royal Institute of Technology in Sweden. He held lecturing positions at StellenboschUniversity (SUN) and the University of Cape Town (UCT) before joining the Computer Science department at the University of the Western Cape in January 2014. Since 2006, He has been a frequent consultant of the UNESCO through its International Centre for Theoretical Physics in Trieste, Italy, the World Bank and other international organizations on different telecommunication projects. His research interest lies on the Internet-of-Things, Big Data and Cloud Computing, Network security and Network protocols for
wireless, wired and hybrid networks.</p>
</div>
<div class="paragraph">
<p><strong>Marco Zennaro</strong> received his M.Sc. degree in Electronic Engineering from University of Trieste in Italy. He defended his PhD thesis on Wireless Sensor Networks for Development: Potentials and Open Issues at KTH-Royal Institute of Technology, Stockholm, Sweden.
His research interest is in ICT4D, the use of ICT for development. In particular, he is interested in Wireless Networks and in Wireless Sensor Networks in developing countries. He has been giving lectures on Wireless technologies in more than 20 countries.  He is coauthor of the book Wireless Networking for the Developing World.</p>
</div>
<div class="paragraph">
<p><strong>Ermanno Pietrosemoli</strong> is currently a researcher at the Telecommunications/ICT for Development Lab of the International Centre for Theoretical Physics in Trieste, Italy, and President of Fundaci칩n Escuela Latinoamericana de Redes, EsLaRed, a non-profit organization that promotes ICT in Latin America through training and development projects. EsLaRed was awarded the 2008 Jonathan B.Postel Service Award by the Internet Society.</p>
</div>
<div class="paragraph">
<p>Ermanno has been deploying wireless data communication networks focusing on low cost technology, participating in the planning and building of wireless data networks in Argentina, Colombia, Ecuador, Italy, Lesotho, Malawi, Mexico, Micronesia, Morocco, Mozambique, Nicaragua, Peru, Trinidad, U.S.A., Venezuela and Zambia. He has presented in many conferences, published several papers related to wireless data communication, and is coauthor and technical reviewer of the (freely available) book <a href="http://wndw.net">Wireless Networking for the Developing World</a>. Ermanno holds a Master뗩 degree from Stanford University and was Professor of Telecommunications at Universidad de los Andes in Venezuela from 1970 to 2000.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="truethe-internet-of-things-iot"><a class="anchor" href="#truethe-internet-of-things-iot"></a>The Internet of Things (IoT)</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Building upon a complex network connecting billions of devices and
humans into a multi-technology, multi-protocol and multi-platform
infrastructure, the Internet-of-Things (IoT) main vision is to create
an intelligent world where the physical, the digital and the virtual are
converging to create smart environments that provide more intelligence
to the energy, health, transport, cities, industry, buildings and many
other areas of our daily life.</p>
</div>
<div class="paragraph">
<p>The expectation is that of interconnecting millions
of islands of smart networks enabling access to the information not only
라nytime and 라nywhere but also using 라nything and 라nyone ideally
through any 랋ath, 랉etwork and 라ny service. This will be achieved
by having the objects that we manipulate daily to be outfitted with
sensing, identification and positioning devices and endowed with an IP
address to become smart objects, capable of communicating with not only
other smart objects but also with humans with the expectation of
reaching areas that we could never reach without the advances made in
the sensing, identification and positioning technologies.</p>
</div>
<div class="paragraph">
<p>While being globally discoverable and queried, these smart objects can similarly
discover and interact with external entities by querying humans,
computers and other smart objects. The smart objects can also obtain
intelligence by making or enabling context related decisions taking
advantage of the available communication channels to provide information
about themselves while also accessing information that has been aggregated by
other smart objects.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/0/image001.jpg" alt="image001.jpg">
</div>
<div class="title">Figure 1. Internet-connected devices and the future evolution (Source: Cisco, 2011)</div>
</div>
<div class="paragraph">
<p>As revealed by Figure 1, the IoT is the new essential infrastructure
which is predicted to connect 50 billion of smart objects in 2020 when
the world population will reach 7.6 billion. As suggested by the ITU,
such essential infrastructure will be built around a multi-layered
architecture where the smart objects will be used to deliver different
services through the four main layers depicted by Figure 2: a device
layer, a network layer, a support layer and the application layer.</p>
</div>
<div class="paragraph">
<p>In the device layer lie devices (sensors, actuators, RFID devices) and
gateways used to collect the sensor readings for further processing
while the network layer provides the necessary transport and networking
capabilities for routing the IoT data to processing places. The support
layer is a middleware layer that serves to hide the
complexity of the lower layers to the application layer and provide
specific and generic services such as storage in different forms
(database management systems and/or cloud computing systems) and many
other services such as translation.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/0/image002.jpg" alt="image002.jpg">
</div>
<div class="title">Figure 2. IoT Layered Architecture (Source: ITU-T)</div>
</div>
<div class="paragraph">
<p>As depicted in Figure 3, the IoT can be perceived as an infrastructure
driving a number of applications services which are enabled by a number
of technologies. Its application services expand across many domains
such as smart cities, smart transport, smart buildings, smart energy,
smart industry and smart health while it is enabled by different
technologies such as sensing, nanoeletronics, wireless sensor network
(WSN), radio frequency identification (RFID), localization, storage and
cloud. The IoT systems and applications are designed to provide
security, privacy, safety, integrity, trust, dependability,
transparency, anonymity and are bound by ethics constraints.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/0/image003.jpg" alt="image003.jpg">
</div>
<div class="title">Figure 3. IoT 3_Dimensional View (Source: [IoT])</div>
</div>
<div class="paragraph">
<p>Experts say we are heading towards what can be called a "ubiquitous
network society", one in which networks and networked devices are
omnipresent. RFID and wireless sensors promise a world of networked and
interconnected devices that provide relevant content and information
whatever the location of the user. Everything from tires to toothbrushes
will be in communications range, heralding the dawn of a new era, one
in which today뗩 Internet (of data and people) gives way to tomorrow뗩
Internet of Things.</p>
</div>
<div class="paragraph">
<p>At the dawn of the Internet revolution, users were
amazed at the possibility of contacting people and information across
the world and across time zones. The next step in this technological
revolution (connecting people any-time, anywhere) is to connect
inanimate objects to a communication network. This vision underlying the
Internet of things will allow the information to be accessed not only "anytime" and "anywhere" but also
by "anything". This will be facilitated by using WSNs and RFID tags
to extend the communication and monitoring potential of the network of
networks, as well as the introduction of computing power in everyday items
such as razors, shoes and packaging.</p>
</div>
<div class="paragraph">
<p>WSNs are an early form of ubiquitous information and communication networks. They are one of
building blocks of the Internet of things.</p>
</div>
<div class="paragraph">
<p><strong>Wireless Sensor Networks</strong></p>
</div>
<div class="paragraph">
<p>A Wireless Sensor Network (WSN) is a self-configuring network of small
sensor nodes (so-called motes) communicating among them using radio
signals, and deployed in quantity to sense the physical world.
Sensor nodes are essentially small computers with extremely basic
functionality. They consist of a processing unit with limited
computational power and limited memory, a radio communication device,
a power source and one or more sensors.</p>
</div>
<div class="paragraph">
<p>Motes come in different sizes and shapes, depending on their foreseen use. They can be very small, if
they are to be deployed in big numbers and need to have little visual
impact. They can have a rechargeable battery power source if they are to
be used in a lab. The integration of these tiny, ubiquitous electronic
devices in the most diverse scenarios ensures a wide range of
applications. Some of the application areas are environmental
monitoring, agriculture, health and security.</p>
</div>
<div class="paragraph">
<p>In a typical application, a WSN is scattered in a region where it is meant to collect data through
its sensor nodes. These networks provide a bridge between the physical
world and the virtual world. They promise unprecedented abilities to
observe and understand large scale, real-world phenomena at a fine
spatio-temporal resolution. This is so because one deploys sensor nodes
in large numbers directly in the
field, where the experiments take place. All motes are composed of five
main elements as shown below:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Processor: the task of this unit is to process locally sensed
information and information sensed by other devices. At present the
processors are limited in terms of computational power, but given
Moore뗩 law, future devices will come in smaller sizes, will be more
powerful and consume less energy. The processor can run in different
modes: sleep is used most of the time to save power, idle is used when
data can arrive from other motes, and active is used when data is sensed
or sent to / received from other motes.</p>
</li>
<li>
<p>Power source: motes are meant to be deployed in various environments,
including remote and hostile regions so they must use little power.
Sensor nodes typically have little energy storage, so networking
protocols must emphasize power conservation. They also must have
built-in mechanisms that allow the end user the option
of prolonging network lifetime at the cost of lower throughput. Sensor
nodes may be equipped with effective power scavenging methods, such as
solar cells, so they may be left unattended for months, or years. Common
sources of power are rechargeable batteries, solar panels and
capacitors.</p>
</li>
<li>
<p>Memory: it is used to store both programs (instructions executed by
the processor) and data (raw and processed sensor measurements).</p>
</li>
<li>
<p>Radio: WSN devices include a low-rate, short-range wireless radio.
Typical rates are 10-100 kbps, and range is less than 100 meters. Radio
communication is often the most power-intensive task, so it is a must to incorporate energy-efficient techniques such as wake-up modes.
Sophisticated algorithms and protocols are employed to address the
issues of lifetime maximization, robustness and fault tolerance.</p>
</li>
<li>
<p>Sensors: sensor networks may consist of many different types of
sensors capable of monitoring a wide variety of ambient conditions.
Table 1 classifies the three main categories of sensors based on
field-readiness and scalability. While scalability reveals if the
sensors are small and inexpensive enough to scale up to many distributed
systems, the field-readiness describes the sensor&#8217;s engineering
efficiency with relation to field deployment. In terms of the
engineering efficiency, Table 1 reveals high field-readiness for most
physical sensors and for a few chemical sensors since most
chemical sensors lie in the medium and low levels, while biological sensors
have low field-readiness.</p>
</li>
</ol>
</div>
<table class="tableblock frame-topbot grid-all spread">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Sensor Category</th>
<th class="tableblock halign-left valign-top">Parameter</th>
<th class="tableblock halign-left valign-top">Field-Readiness</th>
<th class="tableblock halign-left valign-top">Scalability</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Physical</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Temperature</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">High</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">High</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Moisture Content</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">High</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">High</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Flow rate, Flow velocity</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">High</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Med-High</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Pressure</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">High</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">High</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Light Transmission (Turb)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">High</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">High</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Chemical</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Dissolved Oxygen</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">High</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">High</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Electrical Conductivity</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">High</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">High</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">pH</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">High</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">High</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Oxydation Reduction Potential</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Medium</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">High</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Major Ionic Species (Cl-, Na+)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Low-Medium</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">High</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nutrientsa (Nitrate, Ammonium)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Low-Medium</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Low-High</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Heavy metals</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Low</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Low</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Small Organic Compounds</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Low</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Low</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Large Organic Compounds</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Low</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Low</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Biological</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Microorganisms</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Low</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Low</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Biologically active contaminants</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Low</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Low</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Common applications include the sensing of temperature, humidity, light,
pressure, noise levels, acceleration, soil moisture, etc. Due to
bandwidth and power constraints, devices primarily support
low-data-units with limited computational power and limited rate of
sensing. Some applications require multi-mode sensing, so each device
may have several sensors on board.</p>
</div>
<div class="paragraph">
<p>Following is a short description of the technical characteristics of
WSNs that make this technology attractive.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Wireless Networking</strong>: motes communicate with each other via radio in
order to exchange and process data collected by their sensing unit. In
some cases, they can use other nodes as relays, in which case the
network is said to be multi-hop. If nodes communicate only directly with
each other or with the gateway, the network is said to be single-hop.
Wireless connectivity allows to retrieve data in real-time from locations
that are difficult to access. It also makes the monitoring system less
intrusive in places where wires would disturb the normal operation of
the environment to monitor. It reduces the costs of installation: it has
been estimated that wireless technology could eliminate up to 80 % of
this cost.</p>
</li>
<li>
<p><strong>Self-organization</strong>: motes organize themselves into an ad-hoc network,
which means they do not need any pre-existing infrastructure. In WSNs,
each mote is programmed to run a discovery of its neighborhood, to
recognize which are the nodes that it can hear and talk to over its
radio. The capacity of organizing spontaneously in a network makes them
easy to deploy, expand and maintain, as well as resilient to the failure
of individual points.</p>
</li>
<li>
<p><strong>Low-power</strong>: WSNs can be installed in remote locations where power
sources are not available. They must therefore rely on power given by
batteries or obtained by energy harvesting techniques such as solar
panels. In order to run for several months of years, motes must use
low-power radios and processors and implement power efficient schemes.
The processor must go to sleep mode as long as possible, and the
Medium-Access layer must be designed accordingly. Thanks to these
techniques, WSNs allow for long-lasting deployments in remote locations.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Applications of Wireless Sensor Networks</strong></p>
</div>
<div class="paragraph">
<p>The integration of these tiny, ubiquitous electronic devices in the most
diverse scenarios ensures a wide range of applications. Some of the most
common application areas are environmental monitoring, agriculture,
health and security. In a typical application, a WSN  include:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Tracking the movement of animals. A large sensor network has been
deployed to study the effect of micro climate factors in habitat
selection of sea birds on Great Duck Island in Maine, USA. Researchers
placed their sensors in burrows and used heat to detect the presence of
nesting birds, providing invaluable data to biological
researchers. The deployment was heterogeneous in that it employed burrow
nodes and weather nodes.</p>
</li>
<li>
<p>Forest fire detection. Since sensor nodes can be strategically
deployed in a forest, sensor nodes can relay the exact origin of the
fire to the end users before the fire is spread uncontrollable.
Researchers from the University of California, Berkeley, demonstrated
the feasibility of sensor network technology in a fire environment
with their FireBug application.</p>
</li>
<li>
<p>Flood detection. An example is the ALERT system deployed in the US. It
uses sensors that detect rainfall, water level and weather conditions.
These sensors supply information to a centralized database system.</p>
</li>
<li>
<p>Geophysical research. A group of researchers from Harvard deployed a
sensor network on an active volcano in South America to monitor seismic
activity and similar conditions related to volcanic eruptions.</p>
</li>
<li>
<p>Agricultural applications of WSN include precision agriculture and
monitoring conditions that affect crops and livestock. Many of the
problems in managing farms to maximize production while achieving
environmental
goals can only be solved with appropriate data. WSN can also be used in
retail control, particularly in goods that require being maintained
under controlled conditions (temperature, humidity, light intensity, etc) [SusAgri].</p>
</li>
<li>
<p>An application of WSN in security is predictive maintenance. BP뗩 Loch
Rannoch project developed a commercial system to be used in refineries.
This system monitors critical rotating machinery to evaluate operation
conditions and report when wear and tear is detected. Thus one can
understand how a machine is wearing and perform predictive maintenance.
Sensor networks can be used to detect chemical agents in the air and
water. They can also help to identify the type, concentration and
location of pollutants.</p>
</li>
<li>
<p>An example of the use of WSN in health applications is the Bi-Fi,
embedded system architecture for patient monitoring in hospitals and
out-patient care. It has been conceived at UCLA and is based on the
SunSPOT architecture by Sun. The motes measure high-rate biological data
such as neural signals, pulse oximetry and electrocardiographs. The data
is then interpreted, filtered, and transmitted by the motes to enable
early warnings.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Roles in a Wireless Sensor Network</strong></p>
</div>
<div class="paragraph">
<p>Nodes in a WSN can play different roles.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Sensor nodes are used to sense their surroundings and transmit the
sensor readings to a sink node, also called "base station". They are
typically equipped with different kinds of sensors. A mote is endowed
with on-board processing, communication capabilities and sensing
capabilities.</p>
</li>
<li>
<p>Sink nodes or "base stations" are tasked to collect
the sensor readings of the other nodes and pass these readings to a
gateway to which they are directly connected for further
processing/analysis. A sink node is endowed with minimal on-board
processing and communication capabilities but does not have sensing
capabilities.</p>
</li>
<li>
<p>Actuators are devices which are used to control the environment, based
on triggers revealed by the sensor readings or by other inputs. An actuator may have the same configuration as a mote but it
is also endowed with controlling capabilities, for example to switch a light on
under low luminosity.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Gateways often connected to sink nodes and are usually
fed by a stable power supply since they consume considerable energy. These entities are normal computing
devices such as laptops, notebooks, desktops, mobile phones or other
emerging devices which are able to store, process and route the sensor
readings to the processing place. However, they may not be endowed with
sensing capabilities. Being range-limited, sensor motes require
multi-hop communication capabilities to allow: 1) spanning distances much larger than the transmission range
of a single node through localized communication between neighbor nodes
2) adaptation to network changes, for example, by routing around a
failed node using a different path in order to improve performance and
3) using less transmitter power as a result of the shorter distance to be spanned by each node.
They are deployed
in three forms : (1) Sensor node used to sense the environment (2) Relay
node used as relay for the sensor readings received from other nodes
and (3) Sink node also often called base station which is connected to a
gateway (laptop, tablet, iPod, Smart phone, desktop) with higher energy budget
capable of either processing the sensor readings locally or to transmit
these readings to remote processing places.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="trueintroduction-to-ipv6"><a class="anchor" href="#trueintroduction-to-ipv6"></a>Introduction to IPv6</h2>
<div class="sectionbody">
<div class="paragraph">
<p>IPv6 stands for Internet Protocol version 6, so the importance of IPv6 is implicit in its name, it뗩 as important as the Internet!
The Internet Protocol (IP from now on) was intended as a solution to the need to interconnect different data networks, and has become the 띿e facto standard for all kinds of digital communications. Nowadays  IP is present in most devices that are able to send and receive digital information, not only the Internet.</p>
</div>
<div class="paragraph">
<p>IP is standardized by the IETF (Internet Engineering Task Force), the organization in charge of all the Internet standards, guaranteeing the interoperability among software from different vendors. The fact that IP is a standard is of vital importance, because today everything is getting connected to the Internet using IP. All common Operating Systems and networking libraries support IP to send and receive data.
As part of this "everything-connected-to-Internet" is the IoT, so now you know why you are reading this chapter about IPv6, the last version of the Internet Protocol. In other words, today, the easiest way to send and receive data is by means of the standards used in the Internet, including IP.</p>
</div>
<div class="paragraph">
<p>The objectives of this chapter are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Briefly describe the history of the Internet Protocol.</p>
</li>
<li>
<p>Find out what IPv6 is used for.</p>
</li>
<li>
<p>Get the IPv6 related concepts needed to understand the rest of the book.</p>
</li>
<li>
<p>Provide a practical overview of IPv6, including addresses and a glimpse of how an IPv6 network looks like.</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="truea-little-bit-of-history"><a class="anchor" href="#truea-little-bit-of-history"></a>A little bit of History</h3>
<div class="paragraph">
<p>ARPAnet was the first attempt of the US Department of Defense (DoD) to devise a decentralized network more resilient to an attack, while able to interconnect completely different systems. ARPAnet was created in the seventies, but it was in 1983 when a brand new protocol stack was introduced, TCP/IP. The first widely used network protocol version was IPv4 (Internet Protocol version 4) which paved the way to the civilian Internet. Initially only research centers and universities were connected, supported by the NSF (National Science Foundation), and commercial applications where not allowed, but when the network started growing exponentially the NSF decided to transfer its operation and funding to private operators, lifting the restrictions to commercial traffic. While the main applications were email and file transfer, it was with the development of the World Wide Web based on the HTML protocol and specifically with the MOSAIC graphic interface browser and its successors that the traffic really exploded and the Internet began to be used by the masses. As a consequence there was a rapid depletion in the number of IP addresses available under IPv4, which was not designed to scale to these levels.</p>
</div>
<div class="paragraph">
<p>In order to allow for more addresses, you need a longer IP address space (greater number of bits to specify the address), which means a new architecture, which means changes to most of the routing and network software. After examining a number of proposals, the IETF settled on IPv6, described in the January 1995 RFC (Request for Comment, the official IETF documentation naming) 1752, sometimes also referred to as the Next Generation Internet Protocol, or IPng. The IETF updated the IPv6 standard in 1998 with the current definition covered in RFC 2460. By 2004, IPv6 was widely available from industry and supported by most new network equipment. Today IPv6 coexists with IPv4 in the Internet and the amount of IPv6 traffic is quickly growing as more and more ISPs and content providers have started supporting IPv6.</p>
</div>
<div class="paragraph">
<p>As you can see, the history of IP and Internet are almost the same, and because of this the growth of Internet is been hampered by the limitations of IPv4, and has led to the development of a new version of IP, IPv6, as the protocol to be used to interconnect all sorts of devices to send and/or receive information. There are even some technologies that are being developed only with IPv6 in mind, a good example in the context of the IoT is 6LowPAN.</p>
</div>
<div class="paragraph">
<p>From now on we will only center on IPv6. If you know something about IPv4, then you have half the way done, if not, don뗪 worry we will cover the main concepts briefly and gently.</p>
</div>
</div>
<div class="sect2">
<h3 id="trueipv6-concepts"><a class="anchor" href="#trueipv6-concepts"></a>IPv6 Concepts</h3>
<div class="paragraph">
<p>We will cover the the minimum you need to know about the last version of the Internet Protocol to understand why it뗩 so useful for the IoT and how it뗩 related with other protocols like 6LowPAN discussed later. We  will assume that you are familiar with  bits, bytes, networking stack, network layer, packets, IP header, etc. You should understand that IPv6 is a different protocol, non-compatible with IPv4.</p>
</div>
<div class="paragraph">
<p>In the following figure we represent the layered model used in the Internet.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/1/image001.png" alt="image001.png">
</div>
<div class="title">Figure 4. Internet Protocol stack</div>
</div>
<div class="paragraph">
<p>IPv6 sits in layer 3, called network layer. The pieces of data handled by layer 3 are called packets. Devices connected to the Internet can be hosts or routers. A host can be a PC, a laptop or a sensor board, sending and/or receiving data packets. Hosts will be the source or destination of the packets. Routers instead are in charge of packet forwarding, and are responsible of choosing the next router that will forward them towards the final destination. Internet is composed of a lot of interconnected routers, which receive data packets in one interface and send then as quick as possible using another interface towards another forwarding router.</p>
</div>
<div class="sect3">
<h4 id="trueipv6-packet"><a class="anchor" href="#trueipv6-packet"></a>IPv6 packet</h4>
<div class="paragraph">
<p>The first thing you should know is what an IPv6 packet looks like. In the layered model we saw before, each layer introduces its own information in the packet, and this information is intended for, and can only be processed by the same layer in another IP device. This "conversation" between layers at the same level on different devices must follow a protocol.</p>
</div>
<div class="paragraph">
<p>The Internet layers are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Application</strong>: Here resides the software developed by programmers, that will use network services offered by the network stack. An example is the web browser that opens a network connection towards a web server. Another example is the web server software that runs in a server somewhere in the Internet waiting to answer request from client&#8217;s browsers. Examples of application protocols are HTTP and DNS.</p>
</li>
<li>
<p><strong>Transport</strong>: Is a layer above the network layer that offers additional to it, for example, retransmission of lost packets or guaranteeing that the packets are received in the same order they were sent. This layer will be the one that shows a "network service" to the application layer, a service they can use to send or receive data. TCP and UDP are the most common transport protocols used in Internet.</p>
</li>
<li>
<p><strong>Network</strong>: This is the layer in charge of the correct delivery of the data received from the transport layer to its destination, as well as the reception of the received data from the link layer at the data destination. Internet uses only one protocol in this layer, namely IP. Source and destination are identified by means of the IP addresses.</p>
</li>
<li>
<p><strong>Link</strong>: Link layer is in charge of sending and receiving frames, a collection of bytes sent from the network layer, in the realm of a local area network or LAN. It specifies the mecanism used to share the medim among diffrent nodes. This layer has its own addresses, which depend on the technology deployed.</p>
</li>
<li>
<p><strong>Physical</strong>: This layer is in charge of the details of the electromagnetic signal, codifications, etc. needed for the digital information to go from one node to another. All physical media are included, both wired and wireless.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The following figure illustrates the idea that each of the layers described receive some bytes from the layer above and adds some specific information pertaining that layer to be processed in the receiving host. In the figure data originating at the application layer is sent to the physical layer of another node.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/1/image009.png" alt="image009.png">
</div>
<div class="title">Figure 5. Data flow in the protocol stack</div>
</div>
<div class="paragraph">
<p>The bytes sent and received in the IP packet follow a standard format. The following figure shows the basic IPv6 header:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/1/image002.png" alt="image002.png">
</div>
<div class="title">Figure 6. IPv6 Header</div>
</div>
<div class="paragraph">
<p>First you have the <strong>basic IPv6 header</strong> with a fixed size of 40 bytes, followed by upper layer data and optionally by some extension headers, which will be described later. As you can see there are several fields in the packet header, providing some improvements as compared with IPv4 header:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The number of fields has been reduced from 12 to 8.</p>
</li>
<li>
<p>The basic IPv6 header has a fixed size of 40 bytes and is aligned with 64 bits, allowing a faster hardware-based packet forwarding on routers.</p>
</li>
<li>
<p>The size of addresses increased from 32 to 128 bits.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The most important fields are the source and destination addresses. As you already know, every IP device has a unique IP address that identifies it in the Internet. This IP address is used by routers to take their forwarding decisions.</p>
</div>
<div class="paragraph">
<p>IPv6 header has 128 bits for each IPv6 address, this allows for 2<sup>128</sup> addresses (approximately 3.4칑10<sup>38</sup>,i.e., 3.4 followed by 38 zeroes), whereas IPv4 uses 32 bits to encode each of the 2<sup>32</sup> addresses (4,294,967,296) allowed.</p>
</div>
<div class="paragraph">
<p>We have seen the basic IPv6 header, and mentioned the <strong>extension headers</strong>. To keep the basic header simple and of a fixed size, additional features are added to IPv6 by means of extension headers.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/1/image003.png" alt="image003.png">
</div>
<div class="title">Figure 7. IPv6 Extension headers</div>
</div>
<div class="paragraph">
<p>Several extension headers have been defined, as you can see in the previous figure, and they have to follow the order shown. Extensions headers:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Provide flexibility, for example, to enable security by ciphering the data in the packet.</p>
</li>
<li>
<p>Optimize the processing of the packet, because with the exception of the hop by hop header, extensions are processed only by end nodes, (source and final destination of the packet), not by every router in the path.</p>
</li>
<li>
<p>They are located as a "chain of headers" starting always in the basic IPv6 header, that use the field next header to point to the following extension header.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="trueipv6-addressing"><a class="anchor" href="#trueipv6-addressing"></a>IPv6 addressing</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The use of 128 bits for addresses brings some benefits:</p>
<div class="ulist">
<ul>
<li>
<p>Provides many more addresses, to satisfy current and future needs, with ample space for innovation.</p>
</li>
<li>
<p>Simplifies address auto-configuration mechanisms.</p>
</li>
<li>
<p>Easier address management/delegation.</p>
</li>
<li>
<p>Room for more levels of hierarchy and for route aggregation.</p>
</li>
<li>
<p>Ability to do end-to-end IPsec.</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>IPv6 addresses are classified into the following categories (which also exist in IPv4):</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Unicast</strong> (one-to-one): used to send a packet from the source to a single destination. They are the commonest ones and we will talk more about them and their sub-classes.</p>
</li>
<li>
<p><strong>Multicast</strong> (one-to-many): used to send a packet from the source to several destinations. This is possible by means of multicast routing that enable packets to replicate in some places.</p>
</li>
<li>
<p><strong>Anycast</strong> (one-to-nearest): used to send a packet from the source to the nearest destination from a set of them.</p>
</li>
<li>
<p><strong>Reserved</strong>: Addresses or groups of them for special uses, for example addresses to be used on documentation and examples.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Before entering into more detail about IPv6 addresses and the types of unicast addresses, let&#8217;s see how do they look like and what are the notation rules. You need to have them clear because probably the first problem you will find in practice when using IPv6 is how to write an address.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/1/image010.png" alt="image010.png">
</div>
<div class="title">Figure 8. IPv6 address</div>
</div>
<div class="paragraph">
<p><strong>IPv6 addresses notation rules</strong> are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>8 Groups of 16 bits separated by :.</p>
</li>
<li>
<p>Hexadecimal notation of each nibble (4 bits).</p>
</li>
<li>
<p>Non case sensitive.</p>
</li>
<li>
<p>Network Prefixes (group of addresses) are written Prefix / Prefix Length, i.e., prefix length indicate the number of bits of the address that are common for the group.</p>
</li>
<li>
<p>Leftmost zeroes within each group can be eliminated.</p>
</li>
<li>
<p>One or more all-zero-groups can be substituted by ::. This can be done only once.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The first three  rules tell you the basis of IPv6 address notation. They use hexadecimal notation, i.e., numbers are represented by sixteen symbols between 0 and F. You will have eight groups of four hexadecimal symbols, each group separated by a colon ":".
The last two rules are for address notation compression, we will see how this works in the following.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s see some examples:</p>
</div>
<div class="paragraph">
<p>1) If we represent all the address bits we have the preferred form, for example: <code>2001:0db8:4004:0010:0000:0000:6543:0ffd</code></p>
</div>
<div class="paragraph">
<p>2) If we use squared brackets around the address we have the literal form of the address: <code>[2001:0db8:4004:0010:0000:0000:6543:0ffd]</code></p>
</div>
<div class="paragraph">
<p>3) If we apply the fourth rule, allowing compression within each group by eliminating leftmost zeroes, we have: <code>2001:db8:4004:10:0:0:6543:ffd</code></p>
</div>
<div class="paragraph">
<p>4) If we apply the fifth rule, allowing compression of one or more consecutive groups of zeroes using "::", we have: <code>2001:db8:4004:10::6543:ffd</code></p>
</div>
<div class="paragraph">
<p>Care should be taken when compressing and decompressing IPv6 addresses. The process should be reversible. It&#8217;s very common to have some mistakes. For example, the following address <code>2001:db8:A:0:0:12:0:80</code> could be compressed even more using "::". we have two options:</p>
</div>
<div class="paragraph">
<p>a) <code>2001:db8:A::12:0:80</code>
b) <code>2001:db8:A:0:0:12::80</code></p>
</div>
<div class="paragraph">
<p>Both are correct IPv6 addresses. But the address <code>2001:db8:A::12::80</code> is wrong, since it does not follow the last compression rule we saw above. The problem with this badly compressed address is that we can&#8217;t be sure how to expand it, its ambiguous. We can&#8217;t know if it expands to <code>2001:db8:A:0:12:0:0:80</code> or to <code>2001:db8:A:0:0:12:0:80</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="trueipv6-network-prefix"><a class="anchor" href="#trueipv6-network-prefix"></a>IPv6 network prefix</h4>
<div class="paragraph">
<p>Last but not least you have to understand the concept of a <strong>network prefix</strong>, that indicates some fixed bits and some non-defined bits that could be used to create new sub-prefixes or to define complete IPv6 addresses assigned to hosts.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s see some examples:</p>
</div>
<div class="paragraph">
<p>1) The network prefix <code>2001:db8:1::/48</code> (the compressed form of <code>2001:0db8:0001:0000:0000:0000:0000:0000</code>) indicates that the first 48 bits will always be the same (<code>2001:0db8:0001</code>) but that we can play with the other 80 bits, for example, to obtain two smaller prefixes: <code>2001:db8:1:a::/64</code> and <code>2001:db8:1:b::/64</code>.</p>
</div>
<div class="paragraph">
<p>2) If we take one of the smaller prefixes defined above, <code>2001:db8:1:b::/64</code>, where the first 64 bits are fixed we have the rightmost 64 bits to assign, for example, to an IPv6 interface in a host: <code>2001:db8:1:b:1:2:3:4</code>.
This last example allow us to introduce a basic concept in IPv6: * A /64 prefix is always used in a LAN (Local Area Network) <strong>. *The rightmost 64 bits, are called the interface identifier (IID) because they uniquely identify a host&#8217;s interface in the local network defined by the /64 prefix</strong>. The following figure illustrates this statement:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/1/image004.png" alt="image004.png">
</div>
<div class="title">Figure 9. Network and Interface ID</div>
</div>
<div class="paragraph">
<p>Now that you have seen your first IPv6 addresses we can enter into more detail about two types of addresses you will find when you start working with IPv6: reserved and unicast.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The <strong>unspecified address</strong>, used as a placeholder when no address is available: <code>0:0:0:0:0:0:0:0</code> (::/128)</p>
</li>
<li>
<p>The <strong>loopback address</strong>, is used by a node to send an IPv6 packet to itself: <code>0:0:0:0:0:0:0:1</code> (::1/128)</p>
</li>
<li>
<p><strong>Documentation Prefix</strong>: <code>2001:db8::/32</code>. This prefix is reserved to be used in examples and documentation, you have already seen it in this chapter.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>As specified in [RFC6890] IANA maintains a registry of special purpose IPv6 addresses [IANA-IPV6-SPEC].</p>
</div>
<div class="paragraph">
<p>The following are some other types of unicast addresses [RFC4291]:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Link-local</strong>: Link-local addresses are always present in an IPv6 interface that is connected to a network. They all start with the prefix <code>FE80::/10</code> and can be used to communicate with other hosts on the same local network, i.e., all hosts connected to the same switch. They cannot be used to communicate with other networks, i.e., to send or receive packets through a router.</p>
</li>
<li>
<p><strong>ULA</strong> (Unique Local Address) [RFC4193]: All ULA addresses start with the prefix FC00::/7, which in practice means that you could see <code>FC00::/8</code> or <code>FD00::/8</code>. Intended for local communications, usually inside a single site, they are not expected to be routable on the global Internet butused only inside a more limited environment.</p>
</li>
<li>
<p><strong>Global Unicast</strong>: Equivalent to the IPv4 public addresses, they are unique in the whole Internet and can be used to send a packet from one site to any destination in Internet.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="truewhat-is-ipv6-used-for"><a class="anchor" href="#truewhat-is-ipv6-used-for"></a>What is IPv6 used for?</h3>
<div class="paragraph">
<p>As we have seen IPv6 has some features that facilitates things like global addressing and host&#8217;s address autoconfiguration.
Because IPv6 provides as many addresses as we may need for some hundreds of years, we can put a global unicast IPv6 address on almost anything we may think of. This brings back the initial Internet paradigm that every IP device could communicate with every IP device. This end-to-end communication allows bidirectional communication all over the Internet and between any IP device, which could result in collaborative applications and new ways of storing, sending and accessing the information.</p>
</div>
<div class="paragraph">
<p>In the context of this book we can, for example, contemplate IPv6 sensors all around the world collecting, sending and being accessed from different places to create a world-wide mesh of physical values measured, stored and processed.</p>
</div>
<div class="paragraph">
<p>The availability of a huge amount of addresses has allowed a new mechanism called <strong>stateless address autoconfiguration</strong> (SLAAC) that didn&#8217;t exist with IPv4. Here is a brief summary of different ways to configure an address on an IPv6 interface:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Statically</strong>: You can decide which address you will give to your IP device and then manually configure it into the device using any kind of interface: web, command line, etc. Normally you also have to configure other network parameters like the gateway to use to send packets out of your network.</p>
</li>
<li>
<p><strong>DHCPv6</strong> (Dynamic Host Configuration Protocol for IPv6) [RFC3315]: A porting of the similar mechanism already available in IPv4. You need to configure a dedicated server that after a brief negotiation with the device assigns an IP address to it. DHCPv6 allows IP devices to be configured automatically, this is why it is named stateful address autoconfiguration, because the DHCPv6 server maintains a state of assigned addresses.</p>
</li>
<li>
<p><strong>SLAAC</strong>: Stateless address autoconfiguration [RFC4862] is a new mechanism introduced with IPv6 that allows to configure automatically all network parameters on an IP device using the router that gives connectivity to a network.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The advantage of SLAAC is that it simplifies the configuration of "dumb" devices, like sensors, cameras or any other device with low processing power. You don&#8217;t need to use any interface in the IP device to configure anything, just "plug and net". It also simplifies the network infrastructure needed to build a basic IPv6 network, because you don&#8217;t need additional device/server, you use the same router you need to send packets outside your network to configure the IP devices.
We are not going to enter into details, but you just need to know that in a LAN (Local Area Network), connected to Internet by means of a router, this router is in charge of sending all the configuration information needed to its hosts using an RA (Router Advertisement) message. The router will send RAs periodically, but in order to expedite the process a host can send an RS (Router Solicitation) message when its interface gets connected to the network. The router will send an RA immediately in response to the RS.</p>
</div>
<div class="paragraph">
<p>The following figure show the packet exchange between a host that has just connected to a local network and some IPv6 destination in the Internet:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/1/image005.png" alt="image005.png">
</div>
<div class="title">Figure 10. Packet exchange in IPv6</div>
</div>
<div class="paragraph">
<p>1) R1 is the router that gives connectivity to the host in the LAN and is periodically sending RAs.</p>
</div>
<div class="paragraph">
<p>2) Both R1 and Host have a link-local address in their interfaces connected to the host&#8217;s LAN, this address is configured automatically when the interface is ready. Our host creates it&#8217;s link-local address by combining the 64 leftmost bits of the link-local&#8217;s prefix (<code>fe80::/64</code>) and the 64 rightmost bits of a locally generated IID (<code>:3432:7ff1:c001:c2a1</code>). These link-local addresses can be used in the LAN to exchange packets, but not to send packets outside the LAN.</p>
</div>
<div class="paragraph">
<p>3) The hosts needs two basic things to be able to send packets to other networks: a global IPv6 address and the address of a gateway, i.e., a router to which send the packets it wants to get routed outside its network.</p>
</div>
<div class="paragraph">
<p>4) Although R1 is sending RAs periodically (usually every several seconds) when the host get connected and has configured its link-local address, it sends an RS to which R1 responds immediately with an RA containing two things:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>A <strong>global prefix of length 64 bits</strong> that is intended for SLAAC. The host takes the received prefix and adds to it a locally generated IID, usually the same one used for link-local address. This way a global IPv6 address is configured in the host and now can communicate with the IPv6 Internet</p>
</li>
<li>
<p>Implicitly included is the <strong>link-local address of R1</strong>, because it is the source address of the RA. Our host can use this address to configure the <strong>default gateway</strong>, the place to which send the packets by default, to reach an IPv6 host somewhere in Internet.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>5) Once both the gateway and global IPv6 address are configured, the host can receive or send information. In the figure it has something to send (Tx Data) to a host in Internet, so it creates an IPv6 packet with the destination address of the recipient host and as source address the just autoconfigured global address, which is sent to its gateway, R1&#8217;s link-local address. The destination host can answer with some data (Rx Data).</p>
</div>
</div>
<div class="sect2">
<h3 id="truenetwork-example"><a class="anchor" href="#truenetwork-example"></a>Network Example</h3>
<div class="paragraph">
<p>Following we show how a simple IPv6 network looks like, displaying IPv6 addresses for all the networking devices.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/1/image006.png" alt="image006.png">
</div>
<div class="title">Figure 11. Simple IPv6 network</div>
</div>
<div class="paragraph">
<p>We have four hosts, (sensors, or other devices), and we want to put a pair of them in two different places, for example two floors in a building. We are dealing with four IP devices but you can have up to 2<sup>64</sup> (18,446,744,073,709,551,616) devices connected on the same LAN.</p>
</div>
<div class="paragraph">
<p>We create two LANs with a router on each one, both routers connected to a central router (R1) that provides connectivity to Internet. LAN1 is served by R2 (with link-local address <code>fe80::2c:f3f4:1214:a</code> on that LAN) and uses the prefix <code>2001:db8:1:2::/64</code> announced by SLAAC. LAN2 is served by R3 (with link-local address <code>fe80::1b:fff4:3344:b</code> on that LAN) and uses the prefix <code>2001:db8:1:3::/64</code> announced by SLAAC.</p>
</div>
<div class="paragraph">
<p>All hosts have both a link-local IPv6 address and a global IPv6 address autoconfigured using the prefix provided by the corresponding router by means of RAs. In addition, remember that each host also configures the gateway using the link-local address used by the router for the RA. Link-local address can be used for communication among hosts inside a LAN, but for communicating with hosts in other LANs or any other network outside its own LAN a global IPv6 address is needed.</p>
</div>
</div>
<div class="sect2">
<h3 id="trueshort-intro-to-wireshark"><a class="anchor" href="#trueshort-intro-to-wireshark"></a>Short intro to Wireshark</h3>
<div class="sidebarblock">
<div class="content">
<div class="title">What is Wireshark?</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/1/image007.png" alt="image007.png">
</div>
<div class="title">Figure 12. Wireshark logo</div>
</div>
<div class="paragraph">
<p><strong>Wireshark</strong> is a free and open-source packet analyzer, which allows packet traces to be sniffed, captured, and analyzed.</p>
</div>
<div class="paragraph">
<p>A packet trace is a record of traffic at some location on the network, as if a snapshot was taken of all the bits that passed across a particular wire. The packet trace records a timestamp for each packet, along with the bits that make up the packet, from the low-layer headers to the higher-layer contents.</p>
</div>
<div class="paragraph">
<p>Wireshark runs on most operating systems, including Windows, MAC and Linux. It provides a graphical user interface that shows the sequence of packets and the meaning of the bits when interpreted as protocol headers and data. The packets are color-coded to convey their meaning, and Wireshark includes various ways to filter and analyze them to let you investigate different aspects of behavior. It is widely used to troubleshoot networks.</p>
</div>
<div class="paragraph">
<p>A common usage scenario is when a person wants to troubleshoot network problems or look at the internal workings of a network protocol. A user could, for example, see exactly what happens when he or she opens up a website or sets up a wireless sensor network.  It is also possible to filter and search for given packet attributes, which facilitates the debugging process.</p>
</div>
<div class="paragraph">
<p>More information and installation instructions are available at <a href="https://www.wireshark.org/">Wireshark site</a>.</p>
</div>
</div>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/1/image016.png" alt="image016.png">
</div>
<div class="title">Figure 13. Wireshark Screenshot</div>
</div>
<div class="paragraph">
<p>When you open Wireshark, there are four main areas, from top to bottom: menus and filters, list of captured packets, detailed information about the selected packet, including its full content in hexadecimal and ASCII. Online directly links you to the  Wiresharks site, where you can find a handy user guide and information on the security of Wireshark. Under Files, you뗣l find Open, which lets you open previously captured files,, and Sample Captures. You can download any of the sample captures through this website, and study the data. This will help you understand what kind of packets Wireshark can capture.</p>
</div>
<div class="paragraph">
<p>The Capture section let you choose your Interface from the available ones. It뗣l also show you which ones are active. Clicking details will show you some pretty generic information about that interface.</p>
</div>
<div class="paragraph">
<p>Under Start, you can choose one or more interfaces to check out. Capture Options allows you to customize what information you see during a capture. Here you can choose a filter, a capture file, and more. Under Capture Help, you can read up on how to capture, and you can check info on Network Media about which interfaces work on which platforms.</p>
</div>
<div class="paragraph">
<p>Let뗩 select an interface and click Start. To stop a capture, press the red square in the top toolbar. If you want to start a new capture, hit the green triangle which looks like a shark fin next to it. Now that you have got a finished capture, you can click File, and save, open, or merge the capture. You can print it, you can quit the program, and you can export your packet capture in a variety of ways.</p>
</div>
<div class="paragraph">
<p>You can find a certain packet, copy packets, mark (highlight) any specific packet or all the packets. Another interesting thing you can do under Edit, is resetting the time value. You뗣l notice that the time is in seconds incrementing. You can reset it from the packet you뗬e clicked on. You can add a comment to a packet, configure profiles and preferences.</p>
</div>
<div class="paragraph">
<p>When we select a packet from the list of captured ones, Wireshark shows detailed information of the different protocols used by that packet, for example Ethernet:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/1/image017.png" alt="image017.png">
</div>
<div class="title">Figure 14. Ethernet packet</div>
</div>
<div class="paragraph">
<p>Or IPv6, where we can see the fields we mentioned before: Version, Traffic class, flowlabel, payload length, next header, etc.:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/1/image018.png" alt="image018.png">
</div>
<div class="title">Figure 15. IPv6 packet</div>
</div>
<div class="paragraph">
<p>There are two methods to apply filters to the list of captured packets:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Write a filter expression on the specific box and then apply it. Protocols can be specified (ip,ipv6, icmp, icmpv6), fields of a protocol (ipv6.dst, ipv6.src) and even complex expressions can be created using operators like AND (&amp;&amp;), OR (||) or the negation (|).</p>
</li>
</ul>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/1/image019.png" alt="image019.png">
</div>
<div class="title">Figure 16. Wireshark Filter</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Another option to create filters is to right click in one filed of a captured packet, in the list of captured packets. There will appear a menu option "Apply as filter", with several options on how to use that field.</p>
</li>
</ul>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/1/image020.png" alt="image020.png">
</div>
<div class="title">Figure 17. Wireshark Captured packets</div>
</div>
<div class="paragraph">
<p>Another useful and interesting option of Wireshark is the possibility to see statistics about the captured traffic. If we have applied filters, the statistics will be about the filtered traffic. Just go to the Statistics menu and select, for example, Protocol Hierarchy:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/1/image021.png" alt="image021.png">
</div>
<div class="title">Figure 18. Wireshark statistics</div>
</div>
<div class="paragraph">
<p>Other interesting options are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Conversation List &#8594; IPv6</p>
</li>
<li>
<p>Statistics &#8594; Endpoint List &#8594; IPv6</p>
</li>
<li>
<p>Statistics &#8594; IO Graph</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This last option allow to create graphs with different lines for different types of traffic and save the image:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/1/image022.png" alt="image022.png">
</div>
<div class="title">Figure 19. Wireshark charts</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you are using Ubuntu probably you would not be able to run wireshark as non-root user (if you miss this installation option).  Type the following to enable non-root:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">sudo dpkg-reconfigure wireshark-common
$ sudo usermod -a -G wireshark $USER
$ gnome-session-quit --logout --no-prompt</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="trueipv6-exercises"><a class="anchor" href="#trueipv6-exercises"></a>IPv6 Exercises</h3>
<div class="paragraph">
<p>Let&#8217;s test your IPv6 knowledge with the following exercises:</p>
</div>
<div class="paragraph">
<p>1) What is the size of IPv4 and IPv6 addresses?</p>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>32-bits, 128-bits</p>
</li>
<li>
<p>32-bits, 64-bits</p>
</li>
<li>
<p>32-bits, 112-bits</p>
</li>
<li>
<p>32-bits, 96-bits</p>
</li>
<li>
<p>none of these</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>2) Which of the following is a valid IPv6 address notation rule?</p>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Zeroes on the right inside a group of 16 bits can be eliminated</p>
</li>
<li>
<p>The address is divided in 5 groups of 16 bits separated by ":"</p>
</li>
<li>
<p>The address is divided in 8 groups of 16 bits separated by "."</p>
</li>
<li>
<p>One or more groups of all zeroes could be substituted by "::"</p>
</li>
<li>
<p>Decimal notation is used grouping bits in 4 (nibbles)</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>3) Interface Identifiers (IID) or the rightmost bits of an IPv6 address used on a LAN will be 64 bits long.</p>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>True</p>
</li>
<li>
<p>False</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>4) Which of the following is a correct IPv6 address?</p>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p><code>2001:db8:A:B:C:D::1</code></p>
</li>
<li>
<p><code>2001:db8:000A:B00::1:3:2:F</code></p>
</li>
<li>
<p><code>2001:db8:G1A:A:FF3E::D</code></p>
</li>
<li>
<p><code>2001:0db8::F:A::B</code></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>5) Which ones of the following sub-prefixes belong to the prefix <code>2001:db8:0A00::/48</code>? (Choose all that apply)</p>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p><code>2001:db9:0A00:0200::/56</code></p>
</li>
<li>
<p><code>2001:db8:0A00:A10::/64</code></p>
</li>
<li>
<p><code>2001:db8:0A:F:E::/64</code></p>
</li>
<li>
<p><code>2001:db8:0A00::/64</code></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>6) IPv6 has a basic header with more fields than IPv4 header</p>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>True</p>
</li>
<li>
<p>False</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>7) Extension headers can be added in any order</p>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>True</p>
</li>
<li>
<p>False</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>8) Autoconfiguration of IP devices is the same in IPv4 and IPv6</p>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>True</p>
</li>
<li>
<p>False</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>9) Which one is not an option for configuring an IPv6 address in an interface?</p>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>DHCPv6</p>
</li>
<li>
<p>Fixed address configured by vendor</p>
</li>
<li>
<p>Manually</p>
</li>
<li>
<p>SLAAC (Stateless Address Autoconfiguration)</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>10) Which packets are used by SLAAC to autoconfigure an IPv6 host?</p>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>NS/NA (Neighbor Solicitation / Neighbor Advertisement)</p>
</li>
<li>
<p>RS/RA (Router Solicitation / Router Advertisement)</p>
</li>
<li>
<p>Redirect messages</p>
</li>
<li>
<p>NS / RA (Neighbor Solicitation / Router Advertisement)</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="trueaddressing-exercises"><a class="anchor" href="#trueaddressing-exercises"></a>Addressing Exercises</h3>
<div class="paragraph">
<p>A) Use the two compression rules for the utmost compression of the following addresses:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>2001:0db8:00A0:7200:0fe0:000B:0000:0005</code></p>
</li>
<li>
<p><code>2001:0db8::DEFE:0000:C000</code></p>
</li>
<li>
<p><code>2001:db8:DAC0:0FED:0000:0000:0B00:12</code></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>B)  Apply maximum decompression (representing all the 32 nibbles in hexadecimal) to the following addresses:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>2001:db8:0:50::A:123</code></p>
</li>
<li>
<p><code>2001:db8:5::1</code></p>
</li>
<li>
<p><code>2001:db8:C00::222:0CC0</code></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>C) You receive the following IPv6 prefix for your network: <code>2001:db8:A:0100::/56</code>, shown in the following figure:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/1/image008.png" alt="image008.png">
</div>
<div class="title">Figure 20. LAN Example</div>
</div>
<div class="paragraph">
<p>Please determine:</p>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>IPv6 prefix for LAN1, a /64 prefix taken from the /56 you have.</p>
</li>
<li>
<p>IPv6 prefix for LAN2, a /64 prefix taken from the /56 you have.</p>
</li>
<li>
<p>IPv6 prefix for LAN3, a /64 prefix taken from the /56 you have.</p>
</li>
<li>
<p>A global IPv6 address using the LAN1 prefix for H1 host (added to the link-local address already used).</p>
</li>
<li>
<p>A global IPv6 address using the LAN2 prefix for H2 host (added to the link-local address already used).</p>
</li>
<li>
<p>A global IPv6 address using the LAN3 prefix for H3 host (added to the link-local address already used).</p>
</li>
</ol>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Hint: To divide the /56 prefix into /64 prefixes, you have to change the value of the bits 57 to 64, i.e., the XY values in <code>2001:db8:A:01XY::/64</code>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="trueconnecting-our-ipv6-network-to-the-internet"><a class="anchor" href="#trueconnecting-our-ipv6-network-to-the-internet"></a>Connecting our IPv6 Network to the Internet</h3>
<div class="paragraph">
<p>As said in the introduction of this book, network communications is one of the four basic elements of an IoT system. We already have seen that IPv6 brings the possibility of giving an IP address to almost anything we can think of, and can do this making it easy to autoconfoigure network parameters on our devices.</p>
</div>
<div class="paragraph">
<p>Once we have all our "things" connected using IPv6, they can use it to communicate among them locally or with any other "thing" on the IPv6 Internet. In this chapter we will <strong>focus on the Internet side of the communication of the "things"</strong> composing the Internet of Things.</p>
</div>
<div class="paragraph">
<p>As we will see in this book, the capability of connecting our devices to the Internet allows new possibilities and services. For example, we can connect our wireless sensors networks to a centralized repository, where all the sensed information can be processed and stored for historical records, which will uncover underlying patterns and maybe predict future events. This basic idea is what nowadays is called "Big Data" and has a whole set of its own concepts and techniques.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/1/image011.png" alt="image011.png">
</div>
<div class="title">Figure 21. IPv6 Connectivity</div>
</div>
<div class="paragraph">
<p>Getting back to the network connectivity domain, our objective is to connect IoT devices to the Internet using IPv6, allowing communication with other IoT devices, collecting servers or even with people.</p>
</div>
<div class="paragraph">
<p>Related with the IPv6 connectivity to Internet is an important idea: <strong>communication between IoT devices and the IPv6 Internet could be bidirectional</strong>. This is important to remark because with IPv4, connectivity is oftentimes designed as a one direction channel between a client and a server. This changes with IPv6.</p>
</div>
<div class="paragraph">
<p>Having a bidirectional communication with the IoT devices allows useful possibilities, because its not just that the device can send information to somewhere in the Internet, but that anybody in the Internet could be able to send information, requests or commands to the IoT device. This can be used in different scenarios:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Management</strong>: To manage the IoT device performing some status tests, updating some parameters/configuration/firmware remotely allowing for a better and efficient use of the hardware platform and improving the infrastructure security.</p>
</li>
<li>
<p><strong>Control</strong>: Send commands or control actuators to make the IoT device perform an action.</p>
</li>
<li>
<p><strong>Communication</strong>: Send information to the IoT device, that can be displayed using some kind of interface.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>IIPv6 is still being deployed all over the different networks that compose the Internet, which means that different scenarios can be found when deciding how to connect our network to the IPv6 Internet. Following are the three most common scenarios, in preferred order, being  Native IPv6 connectivity the best choice.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Native IPv6 Connectivity</strong>: This scenario applies when both the ISP providing connectivity to the Internet and the router(s) and networks devices used in our network support of IPv6. Native IPv6 means that the IPv6 packets will flow without being changed or tunnelled anywhere in its path from origin to destination. It is common to find what is called dual-stack networks, where both native IPv6 and native IPv4 are being used at the same time in the same interfaces and devices. This native IPv6 scenario covers both cases: IPv6-only and dual-stack.</p>
</li>
</ul>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/1/image012.png" alt="image012.png">
</div>
<div class="title">Figure 22. Native IPv6</div>
</div>
<div class="paragraph">
<p>As seen in the figure, our IoT devices cloud is connected to a router (R2) that provides them a prefix creating a LAN (LAN2). The router that provides connectivity to the IPv6 Internet (R1) will also be in charge of autoconfiguring IPv6 devices in LAN1 (including R2), by sending RAs (Router Advertisements) as detailed when SLAAC was explained.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>No IPv6 connectivity</strong>: In this scenario we face a common problem nowadays, the lack of IPv6 connectivity from an ISP. Although we have IPv6 support on the router that connects our network to Internet, the ISP supports only IPv4. The solution is to use one of the so called IPv6 Transition Mechanism. The most simple and useful in this case would be the 6in4 tunnel, based on creating a point-to-point static tunnel that encapsulates IPv6 packets into IPv4.</p>
</li>
</ul>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/1/image013.png" alt="image013.png">
</div>
<div class="title">Figure 23. IPv4 tunneled IPv6</div>
</div>
<div class="paragraph">
<p>The figure shows this solution created by making a tunnel from R1 to a "remote tunnel end point" where the IPv4 meets the IPv6 Internet. This will be a router having connectivity to both the IPv4 and IPv6 Internet. The native IPv6 traffic from our networks (LAN1 and LAN2) will reach R1, which will take the whole IPv6 packet with its data, and put it inside a new IPv4 packet with the IPv4 destination address corresponding to the tunnel end router. The tunnel end router will grab the IPv6 packet and convey it as native IPv6 traffic into the IPv6 Internet. Similar encapsulation is applied with the IPv6 traffic sent over Ipv4 from the IPv6 Internet to our networks</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>No IPv6 connectivity and no IPv6 capable router</strong>: This scenario covers the case where there is no IPv6 connectivity from the ISP, nor IPv6 support on the router connecting our network to the Internet. As seen before, to solve the lack of IPv6 connectivity from the ISP we can use a 6in4 tunnel, but in this scenario we also have to face the lack of IPv6 support on the router which prevents the creation of the tunnel. The solution is to add a new router that supports both IPv6 and IPv4, and create a 6in4 tunnel from this router to a tunnel end router somewhere on the IPv4 Internet.</p>
</li>
</ul>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/1/image014.png" alt="image014.png">
</div>
<div class="title">Figure 24. Local router does not support IPv6</div>
</div>
<div class="paragraph">
<p>In this scenario a new router (R3) is added to create a 6in4 tunnel towards the tunnel end router, which also serves as an IPv6 gateway to our networks, sending RAs to autoconfigure IPv6 devices in LAN1. The encapsulation/decapsulation process will work exactly the same as in the previous scenario. The main difference here is that the 6in4 tunnel needs a public IPv4 address, so R3 will need to have a public IPv4 besides the IPv6 address. This is easy to get in routers connected to ISPs, but not so common inside our network where we might have only private addresses using NAT.</p>
</div>
<div class="paragraph">
<p>The scenarios showed above are based on a good infrastructure, where we have at least two routers and a couple of LANs. All three scenarios could be simplified into a just one router scenario shown in the following figure:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/1/image015.png" alt="image015.png">
</div>
<div class="title">Figure 25. Simplified Scenario</div>
</div>
<div class="paragraph">
<p>Considerations about lack of IPv6 connectivity from the ISP and IPv6 support on the router are the same as in the previous case, although for the latter the solution is to change the R1 router by one that supports also IPv6.</p>
</div>
<div class="paragraph">
<p>The last case is common because IoT or WSN could be deployed anywhere, including in remote networks connected using some sort of wireless technology. In this scenario there are severe restrictions on the number of devices, power consumption, etc. For example, a cloud of sensors could be deployed in the country to sense temperature and moisture, all of them getting connectivity through just one router connected using an IPv6 mobile phone network (GPRS, 3G or LTE).</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="trueintroduction-to-6lowpan"><a class="anchor" href="#trueintroduction-to-6lowpan"></a>Introduction to 6LoWPAN</h2>
<div class="sectionbody">
<div class="paragraph">
<p>One of the drivers of the IoT, where anything can be connected, is the use of wireless technologies to create a communication channel to send and receive information.
This wide adoption of wireless technologies allows increasing the number of connected devices but results in limitations in terms of cost, battery life, power consumption, and communication distance for the devices. New technologies and protocols should tackle a new environment, usually called Low power and Lossy networks (LLNs), with the following characteristics:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Significantly more devices than those on current local area networks.</p>
</li>
<li>
<p>Severely limited code and ram space in devices.</p>
</li>
<li>
<p>Networks with limited communications distance (range), power and processing resources.</p>
</li>
<li>
<p>All elements should work together to optimize energy consumption and bandwidth usage.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Another factor that is being widely adopted within IoT is the use of IP as the network protocol. The use of IP provides several advantages, because it is an open standard that is widely available, allowing for easy and cheap adoption, good interoperability and easy application layer development. The use of a common standard like an end-to-end IP-based solution avoids the problem of non-interoperable networks.</p>
</div>
<div class="paragraph">
<p>For wireless communication technology, the IEEE 802.15.4 standard [IEEE802.15.4] is very promising for the lower (link and physical) layers, although others are also being considered as good options like Low Power WiFi, Bluetooth &#174; Low Energy, DECT Ultra Low Energy, ITU-T G.9959 networks, and NFC (Near Field Communication).</p>
</div>
<div class="paragraph">
<p>One component of the IoT that has received significant support from vendors and standardization organizations is that of WSN (Wireless Sensor Networks).</p>
</div>
<div class="paragraph">
<p>The IETF has different working groups (WGs) developing standards to be used by WSN:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>6lowpan</strong>: IPv6 over Low-power Wireless Personal Area Networks [sixlowpan], defines the standards for IPv6 communication over the IEEE 802.15.4 wireless communication technology. 6lowpan acts as an adaptation layer between the standard IPv6 world and the low power and lossy wireless communications medium offered by IEEE 802.15.4. Note that this standard is only defined with IPv6 in mind, no IPv4 support is available.</p>
</li>
<li>
<p><strong>roll</strong>: Routing Over Low power and Lossy networks [roll]. LLNs have specific routing requirements that could not be satisfied with existing routing protocols. This WG focuses on routing solutions for a subset of all possible application areas of LLNs (industrial, connected home, building and urban sensor networks), and protocols are designed to satisfy their application-specific routing requirements. Here again the WG focuses only on the IPv6 routing architectural framework.</p>
</li>
<li>
<p><strong>6lo</strong>: IPv6 over Networks of Resource-constrained Nodes [sixlo]. This WG deals with IPv6 connectivity over constrained node networks. It extends the work of the 6lowpan WG, defining IPv6-over-foo adaptation layer specifications using 6LoWPAN for link layer in constrained node networks.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>As seen, 6LoWPAN is the basis of the work carried out in standardization at IETF to communicate constrained resources nodes in LLNs using IPv6. The work on 6LoWPAN has been completed and is being further complemented by the roll WG to satisfy routing needs and the 6lo WG to extend the 6lowpan standards to any other link layer technology.
Following are more details about 6LoWPAN, as the first step into the IPv6 based WSN/IoT.
6LoWPAN and related standards are concerned about providing IP connectivity to devices, irrelevantly of the upper layers, except for the UDP transport layer protocol that is specifically considered.</p>
</div>
<div class="sect3">
<h4 id="trueoverview-of-lowpans"><a class="anchor" href="#trueoverview-of-lowpans"></a>Overview of LoWPANs</h4>
<div class="paragraph">
<p>Low-power and lossy networks (LLNs) is the term commonly used to refer to networks made of highly constrained nodes (limited CPU, memory, power) interconnected by a variety of "lossy" links (low-power radio links).  They are characterized by low speed, low performance, low cost, and unstable connectivity.</p>
</div>
<div class="paragraph">
<p>A LoWPAN is a particular instance of an LLN, formed by devices complying with the IEEE 802.15.4 standard.</p>
</div>
<div class="paragraph">
<p>The typical characteristics of devices in a LoWPAN are:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Limited Processing Capability</strong>: Different types and clock speeds processors, starting at 8-bits.</p>
</li>
<li>
<p><strong>Small Memory Capacity</strong>: From few kilobytes of RAM with a few dozen kilobytes of ROM/flash memory, it뗩 expected to grow in the future, but always trying to keep at the minimum necessary.</p>
</li>
<li>
<p><strong>Low Power</strong>: In the order of tens of milliamperes.</p>
</li>
<li>
<p><strong>Short Range</strong>: The Personal Operating Space (POS) defined by IEEE 802.15.4 implies a range of 10 meters.  For real implementations it can reach over 100 meters in line-of-sight situations.</p>
</li>
<li>
<p><strong>Low Cost</strong>: This drives some of the other characteristics such as low processing, low memory, etc.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>All this constraints on the nodes are expected to change as technology evolves, but compared to other fields it뗩 expected that the LoWPANs will always try to use very restricted devices to allow for low prices and long life which implies hard restrictions in all other features.</p>
</div>
<div class="paragraph">
<p>A LoWPAN typically includes devices that work together to connect the physical environment to real-world applications, e.g., wireless sensors, although a LoWPAN is not necessarily comprised of sensor nodes only, since it may also contain actuators.</p>
</div>
<div class="paragraph">
<p>It&#8217;s also important to identify the characteristics of LoWPANs, because they will be the constraints guiding all the technical work:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Small packet size:  Given that the maximum physical layer frame is 127 bytes, the resulting maximum frame size at the media access control layer is 102 octets.  Link-layer security imposes further overhead, which leaves a maximum of 81 octets for data packets.</p>
</li>
<li>
<p>IEEE 802.15.4 defines several addressing modes: It allows the use of either IEEE 64-bit extended addresses or (after an association event) 16-bit addresses unique within the PAN (Personal Area Network).</p>
</li>
<li>
<p>Low bandwidth: Data rates of 250 kbps, 40 kbps, and 20 kbps for each of the currently defined physical layers (2.4GHz, 915MHz, and 868MHz, respectively).</p>
</li>
<li>
<p>Topologies include star and mesh.</p>
</li>
<li>
<p>Large number of devices expected to be deployed during the lifetime of the technology.
Location of the devices is typically not predefined, as they tend to be deployed in an ad-hoc fashion. Sometimes the location of these devices may not be easily accessible or they may move to new locations.</p>
</li>
<li>
<p>Devices within LoWPANs tend to be unreliable due to variety of reasons: uncertain radio connectivity, battery drain, device lockups, physical tampering, etc.</p>
</li>
<li>
<p>Sleeping mode: Devices may sleep for long periods of time in order to conserve energy, and are unable to communicate during these sleep periods.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="trueabout-the-use-of-ip-on-lowpans"><a class="anchor" href="#trueabout-the-use-of-ip-on-lowpans"></a>About the use of IP on LoWPANs</h4>
<div class="paragraph">
<p>As said before, it seems that the use of IP, and specifically IPv6, is being widely adopted because it offers several advantages. 6LoWPANs are IPv6-based LoWPAN networks.</p>
</div>
<div class="paragraph">
<p>In this section we will see these advantages as well as some problems raised by the use of IP over LoWPANs.</p>
</div>
<div class="paragraph">
<p>The application of IP technology and, in particular, IPv6 networking is assumed to provide the following benefits to LoWPANs:</p>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>The pervasive nature of IP networks allows leveraging existing infrastructure.</p>
</li>
<li>
<p>IP-based technologies already exist, are well-known, proven to be working and widely available. This allows for an easier and cheaper adoption, good interoperability and easier application layer development.</p>
</li>
<li>
<p>IP networking technology is specified in open and freely available specifications, which is able to be better understood by a wider audience than proprietary solutions.</p>
</li>
<li>
<p>Tools for IP networks already exist.</p>
</li>
<li>
<p>IP-based devices can be connected readily to other IP-based networks, without the need for intermediate entities like protocol translation gateways or proxies.</p>
</li>
<li>
<p>The use of IPv6, specifically, allows for a huge amount of addresses and provides for easy network parameters autoconfiguration (SLAAC). This is paramount for 6LoWPANs where large number of devices should be supported.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>On the counter side using IP communication in LoWPANs raise some issues that should be taken into account:</p>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>IP Connectivity: One of the characteristics of 6LoWPANs is the limited packet size, which implies that headers for IPv6 and layers above must be compressed whenever possible.</p>
</li>
<li>
<p>Topologies: LoWPANs must support various topologies including mesh and star: Mesh topologies imply multi-hop routing to a desired destination. In this case, intermediate devices act as packet forwarders at the link layer. Star topologies include provisioning a subset of devices with packet forwarding functionality. If, in addition to IEEE 802.15.4, these devices use other kinds of network interfaces such as Ethernet or IEEE 802.11, the goal is to seamlessly integrate the networks built over those different technologies. This, of course, is a primary motivation to use IP to begin with.</p>
</li>
<li>
<p>Limited Packet Size: Applications within LoWPANs are expected to originate small packets. Adding all layers for IP connectivity should still allow transmission in one frame, without incurring excessive fragmentation and reassembly.  Furthermore, protocols must be designed or chosen so that the individual "control/protocol packets" fit within a single 802.15.4 frame.</p>
</li>
<li>
<p>Limited Configuration and Management: Devices within LoWPANs are expected to be deployed in exceedingly large numbers. Additionally, they are expected to have limited display and input capabilities. Furthermore, the location of some of these devices may be hard to reach. Accordingly, protocols used in LoWPANs should have minimal configuration, preferably work "out of the box", be easy to bootstrap, and enable the network to self heal given the inherent unreliable characteristic of these devices.</p>
</li>
<li>
<p>Service Discovery: LoWPANs require simple service discovery network protocols to discover, control and maintain services provided by devices.</p>
</li>
<li>
<p>Security: IEEE 802.15.4 mandates link-layer security based on AES, but it omits any details about topics like bootstrapping, key management, and security at higher layers.  Of course, a complete security solution for LoWPAN devices must consider application needs very carefully.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="true6lowpan"><a class="anchor" href="#true6lowpan"></a>6LoWPAN</h4>
<div class="paragraph">
<p>We have seen that there is a lower layer (physical and link layers on TCP/IP stack model) that provide connectivity to devices in what is called a LoWPAN. Also that using IPv6 over this layer would bring several benefits. The main reason for developing the IETF standards mentioned in the introduction is that between the IP (network layer) and the lower layer there are some important issues that need to be solved by means of an adaptation layer, the 6lowpan.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/2/image001.png" alt="image001.png">
</div>
<div class="title">Figure 26. 6LoWPAN in the protocol stack</div>
</div>
<div class="paragraph">
<p>The main goals of 6lowpan are:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Fragmentation and Reassembly layer: IPv6 specification [RFC2460] establishes that the minimum MTU that a link layer should offer to the IPv6 layer is 1280 bytes. The protocol data units may be as small as 81 bytes in IEEE 802.15.4. To solve this difference a fragmentation and reassembly adaptation layer must be provided at the layer below IP.</p>
</li>
<li>
<p>Header Compression: Given that in the worst case the maximum size available for transmitting IP packets over an IEEE 802.15.4 frame is 81 octets, and that the IPv6 header is 40 octets long, (without optional extension headers), this leaves only 41 octets for upper-layer protocols, like UDP and TCP.  UDP uses 8 octets in the header and TCP uses 20 octets.  This leaves 33 octets for data over UDP and 21 octets for data over TCP.  Additionally, as pointed above, there is also a need for a fragmentation and reassembly layer, which will use even more octets leaving very few octets for data.  Thus, if one were to use the protocols as is, it would lead to excessive fragmentation and reassembly, even when data packets are just 10s of octets long.  This points to the need for header compression.</p>
</li>
<li>
<p>Address Autoconfiguration: specifies methods for creating IPv6 stateless address auto configuration (in contrast to stateful) that is attractive for 6LoWPANs, because it reduces the configuration overhead on the hosts.  There is a need for a method to generate the IPv6 IID (Interface Identifier) from the EUI-64 assigned to the IEEE 802.15.4 device.</p>
</li>
<li>
<p>Mesh Routing Protocol: A routing protocol to support a multi-hop mesh network is necessary. Care should be taken when using existing routing protocols (or designing new ones) so that the routing packets fit within a single IEEE 802.15.4 frame.
The mechanisms defined by 6lowpan IETF WG are based on some requirements for the IEEE 802.15.4 layer:</p>
</li>
<li>
<p>IEEE 802.15.4 defines four types of frames: beacon frames, MAC command frames, acknowledgement frames and data frames. IPv6 packets must be carried on data frames.</p>
</li>
<li>
<p>Data frames may optionally request that they be acknowledged.  It is recommended that IPv6 packets be carried in frames for which acknowledgements are requested so as to aid link-layer recovery.</p>
</li>
<li>
<p>The specification allows for frames in which either the source or destination addresses (or both) are elided. Both source and destination addresses are required to be included in the IEEE 802.15.4 frame header.</p>
</li>
<li>
<p>The source or destination PAN ID fields may also be included. 6LoWPAN standard assumes that a PAN maps to a specific IPv6 link.</p>
</li>
<li>
<p>Both 64-bit extended addresses and 16-bit short addresses are supported, although additional constraints are imposed on the format of the 16-bit short addresses.</p>
</li>
<li>
<p>Multicast is not supported natively in IEEE 802.15.4. Hence, IPv6 level multicast packets must be carried as link-layer broadcast frames in IEEE 802.15.4 networks. This must be done such that the broadcast frames are only heeded by devices within the specific PAN of the link in question.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The 6LoWPAN adaptation format was specified to carry IPv6 datagrams over constrained links, taking into account limited bandwidth, memory, or energy resources that are expected in applications such as wireless sensor networks. For each of these goals and requirements there is a solution provided by the 6lowpan specification:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>A Mesh Addressing header to support sub-IP forwarding.</p>
</li>
<li>
<p>A Fragmentation header to support the IPv6 minimum MTU requirement.</p>
</li>
<li>
<p>A Broadcast Header to be used when IPv6 multicast packets must be sent over the IEEE 802.15.4 network.</p>
</li>
<li>
<p>Stateless header compression for IPv6 datagrams to reduce the relatively large IPv6 and UDP headers down to (in the best case) several bytes.
These header are used as the LoWPAN encapsulation, and could be used at the same time forming what is called the header stack. Each header in the header stack contains a header type followed by zero or more header fields. When more than one LoWPAN header is used in the same packet, they must appear in the following order: Mesh Addressing Header, Broadcast Header, and Fragmentation Header.</p>
</li>
</ol>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/2/image002.png" alt="image002.png">
</div>
<div class="title">Figure 27. 6LoWPAN headers</div>
</div>
</div>
<div class="sect3">
<h4 id="trueipv6-interface-identifier-iid"><a class="anchor" href="#trueipv6-interface-identifier-iid"></a>IPv6 Interface Identifier (IID)</h4>
<div class="paragraph">
<p>As already said an IEEE 802.15.4 device could have two types of addresses. For each one there is a different way of generating the IPv6 IID.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>IEEE EUI-64 address: All devices have this one. In this case, the Interface Identifier is formed from the EUI-64, complementing the "Universal/Local" (U/L) bit, which is the next-to-lowest order bit of the first octet of the EUI-64.  Complementing this bit will generally change a 0 value to a 1.</p>
</li>
</ol>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/2/image003.png" alt="image003.png">
</div>
<div class="title">Figure 28. EUI-64 derived IID</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>16-bit short addresses: Possible but not always used. The IPv6 IID is formed using the PAN (or zeroes in case of not knowing the PAN) and the 16 bit short address as in the figure below.</p>
</li>
</ol>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/2/image004.png" alt="image004.png">
</div>
<div class="title">Figure 29. IPv6IID</div>
</div>
</div>
<div class="sect3">
<h4 id="trueheader-compression"><a class="anchor" href="#trueheader-compression"></a>Header Compression</h4>
<div class="paragraph">
<p>Two encoding formats are defined for compression of IPv6 packets: LOWPAN_IPHC and LOWPAN_NHC, an encoding format for arbitrary next headers.</p>
</div>
<div class="paragraph">
<p>To enable effective compression, LOWPAN_IPHC relies on information pertaining to the entire 6LoWPAN. LOWPAN_IPHC assumes the following will be the common case for 6LoWPAN communication:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Version is 6.</p>
</li>
<li>
<p>Traffic Class and Flow Label are both zero.</p>
</li>
<li>
<p>Payload Length can be inferred from lower layers from either the 6LoWPAN Fragmentation header or the IEEE 802.15.4 header.</p>
</li>
<li>
<p>Hop Limit will be set to a well-known value by the source.</p>
</li>
<li>
<p>Addresses assigned to 6LoWPAN interfaces will be formed using the link-local prefix or a small set of routable prefixes assigned to the entire 6LoWPAN.</p>
</li>
<li>
<p>Addresses assigned to 6LoWPAN interfaces are formed with an IID derived directly from either the 64-bit extended or the 16-bit short IEEE 802.15.4 addresses.
Depending on how closely the packet matches this common case, different fields may not be compressible thus needing to be carried "in-line" as well. The base format used in LOWPAN_IPHC encoding is shown in the figure below.</p>
</li>
</ol>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/2/image005.png" alt="image005.png">
</div>
<div class="title">Figure 30. Header compression</div>
</div>
<div class="paragraph">
<p>Where:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>TF: Traffic Class, Flow Label.</p>
</li>
<li>
<p>NH: Next Header.</p>
</li>
<li>
<p>HLIM: Hop Limit.</p>
</li>
<li>
<p>CID: Context Identifier Extension.</p>
</li>
<li>
<p>SAC: Source Address Compression.</p>
</li>
<li>
<p>SAM: Source Address Mode.</p>
</li>
<li>
<p>M: Multicast Compression.</p>
</li>
<li>
<p>DAC: Destination Address Compression.</p>
</li>
<li>
<p>DAM: Destination Address Mode.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Not going into details, it뗩 important to understand how 6LoWPAN compression works.
To this end, let뗩 see two examples:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>HLIM (Hop Limit): Is a two bits field that can have four values, three of them make the hop limit field to be compressed from 8 to 2 bits:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>00:  Hop Limit field carried in-line. There is no compression and the whole field is carried in-line after the LOWPAN_IPHC.</p>
</li>
<li>
<p>01:  Hop Limit field compressed and the hop limit is 1.</p>
</li>
<li>
<p>10:  Hop Limit field compressed and the hop limit is 64.</p>
</li>
<li>
<p>11:  Hop Limit field compressed and the hop limit is 255.</p>
</li>
</ol>
</div>
</li>
<li>
<p>SAC/DAC used for the source IPv6 address compression. SAC indicates which address compression is used, stateless (SAC=0) or stateful context-based (SAC=1). Depending on SAC, DAC is used in the following way:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>If SAC=0, then SAM:</p>
<div class="ulist">
<ul>
<li>
<p>00: 128 bits. Full address is carried in-line. No compression.</p>
</li>
<li>
<p>01: 64 bits. First 64-bits of the address are elided,  the link-local prefix. The remaining 64 bits are carried in-line.</p>
</li>
<li>
<p>10: 16 bits. First 112 bits of the address are elided. First 64 bits is the link-local prefix. The following 64 bits are 0000:00ff:fe00:XXXX, where XXXX are the 16 bits carried in-line.</p>
</li>
<li>
<p>11: 0 bits. Address is fully elided.  First 64 bits of the address are the link-local prefix. The remaining 64 bits are computed from the encapsulating header (e.g., 802.15.4 or IPv6 source address).</p>
</li>
</ul>
</div>
</li>
<li>
<p>If SAC=1, then SAM:</p>
<div class="ulist">
<ul>
<li>
<p>00: 0 bits. The unspecified address (::).</p>
</li>
<li>
<p>01: 64 bits. The address is derived using context information and the 64 bits carried in-line. Bits covered by context information are always used.  Any IID bits not covered by context information are taken directly from the corresponding bits carried in-line.</p>
</li>
<li>
<p>10: 16 bits. The address is derived using context information and the 16 bits carried in-line. Bits covered by context information are always used.  Any IID bits not covered by context information are taken directly from their corresponding bits in the 16-bit to IID mapping given by 0000:00ff:fe00:XXXX, where XXXX are the 16 bits carried in-line.</p>
</li>
<li>
<p>11: 0 bits. The address is fully elided and it is derived using context information and the encapsulating header (e.g., 802.15.4 or IPv6 source address).  Bits covered by context information are always used.  Any IID bits not covered by context information are computed from the encapsulating header.</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>The base format is two bytes (16 bits) long. If the CID (Context Identifier Extension) field has a value of 1, it means that an additional 8-bit Context Identifier Extension field immediately follows the Destination Address Mode (DAM) field. This would make the length be 24 bits or three bytes.</p>
</div>
<div class="paragraph">
<p>This additional octet identifies the pair of contexts to be used when the IPv6 source and/or destination address is compressed. The context identifier is 4 bits for each address, supporting up to 16 contexts. Context 0 is the default context. The two fields on the Context Identifier Extension are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>SCI: Source Context Identifier. Identifies the prefix that is used when the IPv6 source address is statefully compressed.</p>
</li>
<li>
<p>DCI: Destination Context Identifier. Identifies the prefix that is used when the IPv6 destination address is statefully compressed.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The Next Header field in the IPv6 header is treated in two different ways, depending on the values indicated in the NH (Next Header) field of the LOWPAN_IPHC enconding shown above.</p>
</div>
<div class="paragraph">
<p>If NH = 0, then this field is not compressed and all the 8 bits are carried in-line after the LOWPAN_IPHC.</p>
</div>
<div class="paragraph">
<p>If NH = 1, then the Next Header field is compressed and the next header is encoded using LOWPAN_NHC encoding. This results in the structure shown in the figure below.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/2/image006.png" alt="image006.png">
</div>
<div class="title">Figure 31. LoWPAN header</div>
</div>
<div class="paragraph">
<p>For IPv6 Extension headers the LOWPAN_NHC has the format shown in the figure, where:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>EID: IPv6 Extension Header ID:</p>
<div class="ulist">
<ul>
<li>
<p>0: IPv6 Hop-by-Hop Options Header.</p>
</li>
<li>
<p>1: IPv6 Routing Header.</p>
</li>
<li>
<p>2: IPv6 Fragment Header.</p>
</li>
<li>
<p>3: IPv6 Destination Options Header.</p>
</li>
<li>
<p>4: IPv6 Mobility Header.</p>
</li>
<li>
<p>5: Reserved.</p>
</li>
<li>
<p>6: Reserved.</p>
</li>
<li>
<p>7: IPv6 Header.</p>
</li>
</ul>
</div>
</li>
<li>
<p>NH: Next Header</p>
<div class="ulist">
<ul>
<li>
<p>0: Full 8 bits for Next Header are carried in-line.</p>
</li>
<li>
<p>1: Next Header field is elided and is encoded using LOWPAN_NHC.
For the most part, the IPv6 Extension Header is carried unmodified in the bytes immediately following the LOWPAN_NHC octet.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="truendp-optimization"><a class="anchor" href="#truendp-optimization"></a>NDP optimization</h4>
<div class="paragraph">
<p>IEEE 802.15.4 and other similar link technologies have limited or no usage of multicast signalling due to energy conservation. In addition, the wireless network may not strictly follow the traditional concept of IP subnets and IP links. IPv6 Neighbor Discovery was not designed for non-transitive wireless links, since its reliance on the traditional IPv6 link concept and its heavy use of multicast make it inefficient and sometimes impractical in a low-power and lossy network.</p>
</div>
<div class="paragraph">
<p>For this reasons, some simple optimizations have been defined for IPv6 Neighbor Discovery, its addressing mechanisms and duplicate address detection for LoWPANs [RFC6775]:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Host-initiated interactions to allow for sleeping hosts.</p>
</li>
<li>
<p>Elimination of multicast-based address resolution for hosts.</p>
</li>
<li>
<p>A host address registration feature using a new option in unicast Neighbor Solicitation (NS) and Neighbor Advertisement (NA) messages.</p>
</li>
<li>
<p>A new Neighbor Discovery option to distribute 6LoWPAN header compression context to hosts.</p>
</li>
<li>
<p>Multihop distribution of prefix and 6LoWPAN header compression context.</p>
</li>
<li>
<p>Multihop Duplicate Address Detection (DAD), which uses two new ICMPv6 message types.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The two multihop items can be substituted by a routing protocol mechanism if that is desired.</p>
</div>
<div class="paragraph">
<p>Three new ICMPv6 message options are defined:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The Address Registration Option (ARO).</p>
</li>
<li>
<p>The Authoritative Border Router Option (ABRO).</p>
</li>
<li>
<p>The 6LoWPAN Context Option (6CO)</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Also two new ICMPv6 message types are defined:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The Duplicate Address Request (DAR).</p>
</li>
<li>
<p>The Duplicate Address Confirmation (DAC)</p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="trueintroduction-to-contiki"><a class="anchor" href="#trueintroduction-to-contiki"></a>Introduction to Contiki</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Contiki is an open source operating system for the Internet of Things, it connects tiny low-cost, low-power microcontrollers to the Internet.</p>
</div>
<div class="paragraph">
<p>Contiki provides powerful low-consumption Internet communication, it supports fully standard IPv6 and IPv4, along with the recent low-power wireless standards: 6lowpan, RPL, CoAP. With Contiki&#8217;s ContikiMAC and sleepy routers, even wireless routers can be battery-operated.</p>
</div>
<div class="paragraph">
<p>With Contiki, development is easy and fast: Contiki applications are written in standard C, with the Cooja simulator Contiki networks can be emulated before burned into hardware, and Instant Contiki provides an entire development environment in a single download.</p>
</div>
<div class="paragraph">
<p>Visit the <a href="http://contiki-os.org">Contiki OS site</a> for more information.</p>
</div>
<div class="paragraph">
<p>The remainder of the chapter intends to be a thoughtful introduction to Contiki 3.0, its core components and features.  The following references are the must-go places to search for detailed information:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/contiki-os/contiki/wiki">The Contiki wiki page</a></p>
</li>
<li>
<p><a href="http://sourceforge.net/p/contiki/mailman/contiki-developers">The Contiki mailing list</a></p>
</li>
<li>
<p><a href="https://github.com/Zolertia/Resources/wiki">Zolertia Wiki page</a></p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="trueinstall-contiki"><a class="anchor" href="#trueinstall-contiki"></a>Install Contiki</h3>
<div class="paragraph">
<p>There are several ways to install Contiki, from scratch by installing from sources or using virtual environments, depending on the flavour and time availability.</p>
</div>
<div class="paragraph">
<p>To work with Contiki you will need three items:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The Contiki source code.</p>
</li>
<li>
<p>A target platform (virtual platform or a real hardware one).</p>
</li>
<li>
<p>A toolchain to compile the source code for such target platform.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The remainder of the book assumes Contiki will run in an Unix environment, as the virtualized environments run on Ubuntu.</p>
</div>
<div class="sect3">
<h4 id="truefresh-contiki-installation"><a class="anchor" href="#truefresh-contiki-installation"></a>Fresh Contiki Installation</h4>
<div class="paragraph">
<p>The following instructions will guide you to install Contiki on your machine.  These instructions were tested in Ubuntu-like devices (version 12.04 and onwards).  If you are looking for a ready to use setup, skip this section and download one of the Virtual Machines in the next section.</p>
</div>
<div class="paragraph">
<p>This will install support for the ARM Cortex-M3 and MSP430 platforms, as well as support for Cooja, the Contiki&#8217;s emulator to be discussed in the next sections.</p>
</div>
<div class="paragraph">
<p>The "IoT in five days" Virtual Machine has a comprehensive lists of additional tools and libraries installed, check the next section for a complete list.</p>
</div>
<div class="sect4">
<h5 id="trueinstall-the-toolchain-and-required-libraries"><a class="anchor" href="#trueinstall-the-toolchain-and-required-libraries"></a>Install the toolchain and required libraries</h5>
<div class="paragraph">
<p>The following are the minimal recomended libraries to run Contiki.</p>
</div>
<div class="sect5">
<h6 id="trueubuntu-linux-installation"><a class="anchor" href="#trueubuntu-linux-installation"></a>Ubuntu (Linux) installation</h6>
<div class="paragraph">
<p>To install the toolchain and required dependencies, run in a terminal the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">sudo apt-get update
sudo apt-get install gcc-arm-none-eabi gdb-arm-none-eabi
sudo apt-get -y install build-essential automake gettext
sudo apt-get -y install gcc-arm-none-eabi curl graphviz unzip wget
sudo apt-get -y install gcc gcc-msp430
sudo apt-get -y install openjdk-7-jdk openjdk-7-jre ant</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="trueosx-mac-installation-re-mote-only"><a class="anchor" href="#trueosx-mac-installation-re-mote-only"></a>OSX (MAC) installation (RE-Mote only)</h6>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash"># Install Homebrew - http://brew.sh/
brew tap PX4/homebrew-px4
brew update

# Install GCC Arm Toolchain
brew install gcc-arm-none-eabi-49</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="truewindows-installation-re-mote-only"><a class="anchor" href="#truewindows-installation-re-mote-only"></a>Windows installation (RE-Mote only)</h6>
<div class="paragraph">
<p>Download the <a href="https://launchpad.net/gcc-arm-embedded/5.0/5-2016-q1-update/+download/gcc-arm-none-eabi-5_3-2016q1-20160330-win32.exe">GCC ARM toolchain</a> (Windows installer) from:</p>
</div>
<div class="paragraph">
<p><code><a href="https://launchpad.net/gcc-arm-embedded/+download" class="bare">https://launchpad.net/gcc-arm-embedded/+download</a></code></p>
</div>
<div class="paragraph">
<p>Tested with <code>gcc-arm-none-eabi-5_3-2016q1-20160330-win32.exe</code>.</p>
</div>
<div class="paragraph">
<p>Execute and select the <code>add path to environment variable</code> option.</p>
</div>
<div class="paragraph">
<p>Next download <a href="https://sourceforge.net/projects/mingw/files/latest/download">MINGW</a>, install and make sure the following packages are selected: <strong>mingw32-base</strong>, <strong>mingw32-gcc-g++</strong>, <strong>msys-base</strong>.</p>
</div>
<div class="paragraph">
<p>Under "All Packages" select the <strong>msys-mintty</strong> package for terminal support.  This will install <code>MINTTY</code> in the default location <code>C:\MinGW\msys\1.0\bin\mintty.exe</code>.  Create a shortcut and add this to the Shortcut target command:</p>
</div>
<div class="paragraph">
<p><code>C:\MinGW\msys\1.0\bin\mintty.exe /bin/bash -l</code></p>
</div>
<div class="paragraph">
<p>Add the following paths to your <code>$path</code> environment variable:</p>
</div>
<div class="paragraph">
<p><code>C:\MinGW\bin;C:\MinGW\msys\1.0\bin</code></p>
</div>
<div class="paragraph">
<p>Run <code>MINTTY</code> and execute the following commands:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">mingw-get update
mingw-get install msys-wget
mingw-get install msys-zlib
mingw-get install msys-unzip</code></pre>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="trueget-contiki-on-your-machine"><a class="anchor" href="#trueget-contiki-on-your-machine"></a>Get Contiki on your machine</h5>
<div class="paragraph">
<p>Contiki source code is actively supported by contributors from universities, research centers and developers from all over the world.</p>
</div>
<div class="paragraph">
<p>The source code is hosted at <a href="https://github.com/contiki-os/contiki">Contiki GitHub repository</a>:</p>
</div>
<div class="paragraph">
<p>The latest Contiki release is 3.0, the release tag is available at:</p>
</div>
<div class="paragraph">
<p><a href="https://github.com/contiki-os/contiki/tree/release-3-0" class="bare">https://github.com/contiki-os/contiki/tree/release-3-0</a></p>
</div>
<div class="paragraph">
<p>Nevertheless you should use the latest commit available, as Contiki releases are produced on a yearly base.  Many bug fixes, new features and improved support is normally present on the latest <code>master</code> branch.</p>
</div>
<div class="paragraph">
<p>To grab the source code open a terminal and execute the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">sudo apt-get -y install git
git clone --recursive https://github.com/contiki-os/contiki.git</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>At the moment of this release, the current Contiki commit corresponds to the <code>a8989f9f1c9794233a712ef4f689d1ba35a9a405</code> HASH.  You can use the following GIT command to place yourself on this commit:</p>
</div>
<div class="paragraph">
<p><code>git checkout HASH</code></p>
</div>
<div class="paragraph">
<p>Replace <code>HASH</code> with the actual value.</p>
</div>
<div class="paragraph">
<p>As Contiki ensures the platform and application support by using a strict code revision procedure and regression tests, this is a safe point if you encounter any problem.  Be sure to update your Contiki local repository if using <code>Instant Contiki</code>!</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">What is git?</div>
<div class="paragraph">
<p><strong>Git</strong> is a free and open source distributed version control system, designed for speed and efficiency.</p>
</div>
<div class="paragraph">
<p>The main difference with other change control tools is the possibility to work locally since your local copy is a repository, and you can commit to it and get all benefits of source control.</p>
</div>
<div class="paragraph">
<p>There are some great tutorials online to learn more about git:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="http://try.github.io">Code School &amp; GitHub "try Git"</a></p>
</li>
<li>
<p><a href="http://rogerdudler.github.io/git-guide/">Roger Dudler&#8217;s Git simple guide</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>GitHub</strong> is a GIT repository web-based hosting service, which offers all of the distributed revision control and source code management (SCM) functionality of Git as well as adding its own features. GitHub provides a web-based graphical interface and desktop as well as mobile integration. It also provides access control and several collaboration features such as wikis, task management, bug tracking and feature requests for every project.</p>
</div>
<div class="paragraph">
<p>The advantage of using GIT and hosting the code at github is that of allowing people to fork the code, further develop it, and then contribute back to share their improvements.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>Additionally there is a <code>branch</code> available with the <code>IoT in five days</code> content in a workshop-like format.  The branch is available at:</p>
</div>
<div class="paragraph">
<p><a href="https://github.com/alignan/contiki/tree/iot-workshop" class="bare">https://github.com/alignan/contiki/tree/iot-workshop</a></p>
</div>
<div class="paragraph">
<p>It is recomended to add this <code>branch</code> as a <code>remote repository</code> of the already cloned Contiki repository, so you can keep track of the development done in the <code>master</code> branch.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">cd /home/user/contiki
git remote add iot-workshop https://github.com/alignan/contiki
git fetch iot-workshop
git checkout iot-workshop</code></pre>
</div>
</div>
<div class="paragraph">
<p>The above commands will add the <code><a href="https://github.com/alignan/contiki" class="bare">https://github.com/alignan/contiki</a></code> repository to the list of <code>remote</code> repositories, making the <code>iot-workshop</code> branch available in your machine as a <code>working copy</code>.  Now you can track any changes and updates.</p>
</div>
<div class="paragraph">
<p>This branch has ready to use examples and applications to guide you through Contiki and building <em>real</em> IoT applications.  In the next sections this content will be further discussed.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="trueusing-a-virtualized-environment"><a class="anchor" href="#trueusing-a-virtualized-environment"></a>Using a virtualized environment</h4>
<div class="paragraph">
<p>Even if installing Contiki should be straightforward, there are already built Virtual Machines available for you to download and use out of the box.</p>
</div>
<div class="paragraph">
<p>The available Virtual Machines images are available for <a href="http://www.vmware.com/">VMWare</a>.</p>
</div>
<div class="paragraph">
<p>Download <a href="https://my.vmware.com/web/vmware/free#desktop_end_user_computing/vmware_player/6_0">VMWare player for Windowws and Linux</a> to run Contiki&#8217;s virtual machine, it is free and widely used.</p>
</div>
<div class="paragraph">
<p>In OSX you can download <a href="http://www.vmware.com/products/fusion">VMWare Fusion</a></p>
</div>
<div class="sect4">
<h5 id="trueinstant-contiki-virtual-machine"><a class="anchor" href="#trueinstant-contiki-virtual-machine"></a>Instant Contiki Virtual Machine</h5>
<div class="paragraph">
<p>Instant Contiki is an entire Contiki development environment in a single download. It is an Ubuntu Linux virtual machine and has Contiki OS and all the development tools, compilers, and simulators required already pre-installed.</p>
</div>
<div class="paragraph">
<p>Grab Instant Contiki from the Contiki website:</p>
</div>
<div class="paragraph">
<p><a href="http://www.contiki-os.org/start.html" class="bare">http://www.contiki-os.org/start.html</a></p>
</div>
<div class="paragraph">
<p>The latest Instant Contiki release is 3.0, following the Contiki 3.0 source code release.</p>
</div>
<div class="paragraph">
<p>Using VMWare just open the <code>Instant_Contiki_Ubuntu_12.04_32-bit.vmx</code> file, if prompted about the VM source just choose <code>I copied it</code> then wait for the virtual Ubuntu Linux boot up.</p>
</div>
<div class="paragraph">
<p>Log into Instant Contiki. The password and user name is <code>user</code>. Don뗪 upgrade right now.</p>
</div>
<div class="paragraph">
<p>Remember to update the Contiki repository and get the latest upgrades:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">cd /home/user/contiki
git fetch origin
git pull origin master</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice the <code>Instant Contiki</code> does not have the <code>IoT workshop</code> branch with the examples of this book, read the previous section on how to clone.</p>
</div>
</div>
<div class="sect4">
<h5 id="trueofficial-iot-in-five-days-virtual-machine"><a class="anchor" href="#trueofficial-iot-in-five-days-virtual-machine"></a>Official "IoT in five days" Virtual Machine</h5>
<div class="paragraph">
<p>A Virtual Machine with the content of the book is provided as a free download from the following location:</p>
</div>
<div class="paragraph">
<p><a href="https://sourceforge.net/projects/zolertia/files/VM/IoT%20Workshop%20VM.7z">"IoT in five days" VM hosted by Zolertia</a></p>
</div>
<div class="paragraph">
<p>In a nutshell it packs everything the <code>Instant Contiki</code> has, but it has been built using <code>Ubuntu Server 16.04 LTS (Xenial)</code> instead.  Additionally several packages has been installed to make development easier, including a fully-configured <a href="https://eclipse.org/cdt/">Eclipse IDE workspace</a>.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/3/image003.png" alt="image003.png">
</div>
<div class="title">Figure 32. IoT in five Days Virtual Machine</div>
</div>
<div class="paragraph">
<p>The "IoT in five days" book, its source and ready to use Contiki examples are included.</p>
</div>
<div class="paragraph">
<p>Log into the Virtual Machine. The password and user name is <code>user</code>.</p>
</div>
<div class="paragraph">
<p>The "IoT in five days" Virtual Machine has already the <code>iot-workshop</code> branch cloned and available, with the suggested book examples and a ready-to-use Contiki configuration.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="truetest-contiki-installation"><a class="anchor" href="#truetest-contiki-installation"></a>Test Contiki installation</h3>
<div class="paragraph">
<p>Let us first check the toolchain installation.  The MSP430 toolchain can be tested with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">msp430-gcc --version
msp430-gcc (GCC) 4.7.0 20120322 (mspgcc dev 20120716)
Copyright (C) 2012 Free Software Foundation, Inc.
This is free software; see the source for copying conditions.  There is NO
warranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.</code></pre>
</div>
</div>
<div class="paragraph">
<p>And for the ARM Cortex-M3 toolchain:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">arm-none-eabi-gcc --version
arm-none-eabi-gcc (GNU Tools for ARM Embedded Processors) 4.9.3 20150529 (release) [ARM/embedded-4_9-branch revision 224288]
Copyright (C) 2014 Free Software Foundation, Inc.
This is free software; see the source for copying conditions.  There is NO
warranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="truecontiki-structure"><a class="anchor" href="#truecontiki-structure"></a>Contiki structure</h3>
<div class="paragraph">
<p>Contiki has the following file structure:</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 33%;">
<col style="width: 33%;">
<col style="width: 33%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Folder</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Zolertia files</th>
</tr>
</thead>
<tfoot>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">regression-tests</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">nightly regression tests</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
</tr>
</tfoot>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">examples</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Ready to build examples</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">examples/zolertia, examples/cc2538-common</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">app</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Contiki applications</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">cpu</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specific MCU files</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">msp430, cc2538</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">dev</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">External chip and devices</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">cc2420, cc1200</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">platform</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specific files and platform drivers</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">z1, zoul</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">core</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Contiki core files and libraries</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">tools</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Tools for flashing, debuging, simulating, etc.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">zolertia, sky</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">doc</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Self-generated doxygen documentation</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>If you cloned the <code>iot-workshop</code> branch (or if you are using the "IoT in five days" Virtual Machine), you will find also the following folder:</p>
</div>
<div class="paragraph">
<p><code>contiki/examples/zolertia/tutorial</code></p>
</div>
<div class="paragraph">
<p>The content of the <code>tutorial</code> is:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/alignan/contiki/tree/iot-workshop/examples/zolertia/tutorial/01-basics">01-basics</a>: Contiki basics (timers, GPIO, LEDs).</p>
</li>
<li>
<p><a href="https://github.com/alignan/contiki/tree/iot-workshop/examples/zolertia/tutorial/02-ipv6">02-ipv6</a>: Wireless networking, RF basic, IPv6/6LoWPAN implementation (UDP/TCP) and the Border Router</p>
</li>
<li>
<p><a href="https://github.com/alignan/contiki/tree/iot-workshop/examples/zolertia/tutorial/03-coap">03-coap</a>: Example on how to implement a CoAP server</p>
</li>
<li>
<p><a href="https://github.com/alignan/contiki/tree/iot-workshop/examples/zolertia/tutorial/04-mqtt">04-mqtt</a>: Example on how to implement a MQTT client</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The examples work out of the box for both Zolertia <code>Z1</code> and <code>RE-Mote</code> platforms to be shown next.</p>
</div>
<div class="paragraph">
<p>The examples are written to be followed in order, so be sure to start from the very first and make your way to the last in an ordered fashion.</p>
</div>
<div class="paragraph">
<p>In the following sections we will cover the examples and specific platform files for the Zolertia platforms.</p>
</div>
</div>
<div class="sect2">
<h3 id="truerun-contiki-on-real-hardware"><a class="anchor" href="#truerun-contiki-on-real-hardware"></a>Run Contiki on real hardware</h3>
<div class="paragraph">
<p>For the remainder of the book we will use the Zolertia Z1 and RE-Mote hardware development platforms. Other platforms can be used as well, but are out of the scope of this book.</p>
</div>
<div class="paragraph">
<p>Contiki drivers and libraries are (normally) platform independent, most examples can be run in both Z1 and RE-Mote platforms by taking into consideration specific platform settings.</p>
</div>
<div class="paragraph">
<p>There are platform-specific examples for the Z1 platform at <code>examples/zolertia/z1</code>, and at <code>examples/zolertia/zoul</code> for the RE-Mote.  Additionaly <code>CC2538</code> specific examples can be found at <code>examples/cc2538-common</code>.  This folder has CC2538 ARM Cortex-M3 related examples and applications.</p>
</div>
<div class="paragraph">
<p>More information about both platforms and updates guides can be found at:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="http://www.zolertia">Zolertia website</a></p>
</li>
<li>
<p><a href="https://github.com/Zolertia/Resources/wiki/RE-Mote">Zolertia RE-Mote wiki page</a></p>
</li>
<li>
<p><a href="https://github.com/Zolertia/Resources/wiki#the-z1-mote">Zolertia Z1 wiki page</a></p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="truezolertia-zoul-module-and-the-re-mote-development-platform"><a class="anchor" href="#truezolertia-zoul-module-and-the-re-mote-development-platform"></a>Zolertia Zoul module and the RE-Mote development platform</h4>
<div class="paragraph">
<p>The <strong>Zoul</strong> is a module based in the CC2538 ARM Cortex-M3 system on chip (SoC), with an on-board 2.4 GHz IEEE 802.15.4 RF interface, running at up to 32 MHz with 512 kB of programmable flash and 32 kB of RAM, bundled with a CC1200 868/915 MHz RF transceiver to allow dual band operation.</p>
</div>
<div class="paragraph">
<p>The Zoul allows fast reusability on designs and quick scaling from prototyping to production.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/3/image001.jpg" alt="image001.jpg">
</div>
<div class="title">Figure 33. Zolertia Zoul module and the RE-Mote platform</div>
</div>
<div class="paragraph">
<p>The <strong>RE-Mote</strong> (revision A) has a Zoul on board and also packs:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>ISM 2.4-GHz IEEE 802.15.4 &amp; Zigbee compliant radio.</p>
</li>
<li>
<p>ISM 863-950-MHz ISM/SRD band radio.</p>
</li>
<li>
<p>AES-128/256, SHA2 Hardware Encryption Engine.</p>
</li>
<li>
<p>ECC-128/256, RSA Hardware Acceleration Engine for Secure Key Exchange.</p>
</li>
<li>
<p>Consumption down to 150 nA using the shutdown mode.</p>
</li>
<li>
<p>Programming over BSL without requiring to press any button to enter bootloader mode.</p>
</li>
<li>
<p>Built-in battery charger (500 mA), facilitating Energy Harvesting and direct connection to Solar Panels and to standards LiPo batteries.</p>
</li>
<li>
<p>Wide range DC Power input: 2-16 V.</p>
</li>
<li>
<p>Small form-factor.</p>
</li>
<li>
<p>MicroSD over SPI.</p>
</li>
<li>
<p>On board RTC (programmable real time clock) and external watchdog timer (WDT).</p>
</li>
<li>
<p>Programmable RF switch to connect an external antenna either to the 2.4 GHz or to the Sub 1 GHz RF interface through the RP-SMA connector.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The <strong>RE-Mote</strong> has been developed jointly with universities and industrial partners in the frame of the European research project <strong>RERUM</strong>(<strong>RERUM: REliable, Resilient and secUre IoT for sMart city applications</strong>).</p>
</div>
</div>
<div class="sect3">
<h4 id="truezolertia-z1-mote"><a class="anchor" href="#truezolertia-z1-mote"></a>Zolertia Z1 mote</h4>
<div class="paragraph">
<p>The <strong>Z1 mote</strong> features a second generation MSP430F2617 low power 16-bit RISC CPU @ 16 MHz MCU, 8 kB RAM and a 92 kB Flash memory. It includes the well known CC2420 transceiver, IEEE 802.15.4 compliant, which operates at 2.4 GHz with an effective data rate of 250 kbps.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/3/image002.png" alt="image002.png">
</div>
<div class="title">Figure 34. Zolertia Z1 mote</div>
</div>
<div class="paragraph">
<p>The Zolertia Z1 mote can run TinyOS, Contiki OS, OpenWSN and RIOT, and has been used actively for over 5 years in universities, research and development centers and in commercial products in more than 43 countries, being featured in more than 50 scientific publications.</p>
</div>
<div class="paragraph">
<p>The Z1 mote is fully emulated in both MSPSIM and Cooja.</p>
</div>
</div>
<div class="sect3">
<h4 id="truewhat-are-the-differences-between-the-re-mote-and-the-z1-platforms"><a class="anchor" href="#truewhat-are-the-differences-between-the-re-mote-and-the-z1-platforms"></a>What are the differences between the RE-Mote and the Z1 platforms?</h4>
<div class="paragraph">
<p>In a nutshell: power and coolness.</p>
</div>
<div class="paragraph">
<p>The RE-Mote has 4 times more RAM than the Z1 mote, 5 times more flash memory, twice the frequency of operation and 120 times less power consumption in its lowest power mode (shutdown mode).</p>
</div>
<div class="paragraph">
<p>Another major difference is that (at the time of writing this book) the Z1 mote is supported by Cooja, the Contiki emulator, while the RE-Mote is not.  However efforts are on going to provide emulation framework support in the <a href="http://emul8.org/">EMUL8</a> project.</p>
</div>
<div class="paragraph">
<p>To check in depth the differences between the RE-Mote and the Z1 mote, and also obtain guidelines to port applications developed for the Z1 to the RE-Mote, visit the <a href="https://github.com/Zolertia/Resources/wiki/Migrate-From-Z1-to-RE-Mote">"Migrate from Z1 to RE-Mote" wiki page</a>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="truestart-with-contiki"><a class="anchor" href="#truestart-with-contiki"></a>Start with Contiki!</h3>
<div class="paragraph">
<p>Let&#8217;s compile our first Contiki example! Open a terminal and write:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">cd examples/zolertia/tutorial/01-basics
make TARGET=zoul savetarget</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will tell Contiki to compile the hello world example for the RE-Mote platform from now on.  Alternatively, to use the Z1 mote instead, just run:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">make TARGET=z1 savetarget</code></pre>
</div>
</div>
<div class="paragraph">
<p>You need to do this only once per application.  Not let&#8217;s compile the application:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">make 01-hello-world</code></pre>
</div>
</div>
<div class="paragraph">
<p>if everything works OK you should see something like for the <code>Z1</code> mote:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">CC        symbols.c
AR        contiki-z1.a
CC        01-hello-world.c
CC        ../../../../../platform/z1/./contiki-z1-main.c
LD        01-hello-world.z1
rm obj_z1/contiki-z1-main.o 01-hello-world.co</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>01-hello-world.z1</code> file should have been created and we are ready to flash the application to the device.</p>
</div>
<div class="paragraph">
<p>And likewise if we were to compile for the <code>RE-Mote</code> platform:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">make TARGET=zoul 01-hello-world
  CC        01-hello-world.c
  LD        01-hello-world.elf
arm-none-eabi-objcopy -O binary --gap-fill 0xff 01-hello-world.elf 01-hello-world.bin</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If a <code>Makefile.target</code> already exists and you don&#8217;t want to change the current defined <code>TARGET</code>, you can just compile your code specifying a <code>TARGET</code>.  Running <code>make TARGET=zoul</code> for example will ignore the saved <code>Makefile.target</code> file and use the target <code>zoul</code> instead.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In the following sections and chapters the examples can be compiled for both the Z1 and RE-Mote platforms.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The RE-Mote takes two arguments: <code>TARGET</code> and <code>BOARD</code>, while the Z1 mote only uses the first one with the <code>z1</code> string as noted before.  For the RE-Mote, <code>TARGET</code> is always <code>zoul</code> and <code>BOARD</code> is <code>remote</code>, but when compiling, if the <code>BOARD</code> flag is not explicitly defined, it will default to <code>remote</code>.  This approach is because there are other Zoul based platforms which share the same code base and modules, but the <code>RE-Mote</code> has its own specific platform files and definitions.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="truehello-world-explained"><a class="anchor" href="#truehello-world-explained"></a>Hello world explained</h4>
<div class="paragraph">
<p>Let뗩 see the main components of the Hello World example.  Browse the code with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">gedit 01-hello-world.c</code></pre>
</div>
</div>
<div class="paragraph">
<p>Or your preferred text editor (Sublime text, Eclipse, etc).</p>
</div>
<div class="paragraph">
<p>When starting Contiki, you declare processes with a name. In each code you can have several processes.  You declare the process like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">PROCESS(hello_world_process, "Hello world process"); <i class="conum" data-value="1"></i><b>(1)</b>
AUTOSTART_PROCESSES(&amp;hello_world_process); <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>hello_world_process</code> is the name of the process and
<code>"Hello world process"</code> is the readable name of the process when you print it to the terminal.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The <code>AUTOSTART_PROCESSES(&amp;hello_world_process)</code> tells Contiki to start that process when it finishes booting.</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">/*-------------------------------------------------*/
PROCESS(hello_world_process, "Hello world process");
AUTOSTART_PROCESSES(&amp;hello_world_process);
/*-------------------------------------------------*/
PROCESS_THREAD(hello_world_process, ev, data) <i class="conum" data-value="1"></i><b>(1)</b>
{
  PROCESS_BEGIN(); <i class="conum" data-value="2"></i><b>(2)</b>
  printf("Hello, world\n"); <i class="conum" data-value="3"></i><b>(3)</b>
  printf("%s\n", hello);
  printf("This is a value in hex 0x%02X, the same as %u\n", num, num);
  PROCESS_END(); <i class="conum" data-value="4"></i><b>(4)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>You declare the content of the process in the process thread. You have the name of the process and callback functions (event handler and data handler).</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Inside the thread you begin the process,</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>do what you want and</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>finally end the process.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In this concrete example it is shown how to print values of different types: a numeric value (using different format qualifiers) and a string (literal or stored in a variable).</p>
</div>
</div>
<div class="sect3">
<h4 id="truemakefile-explained"><a class="anchor" href="#truemakefile-explained"></a>Makefile explained</h4>
<div class="paragraph">
<p>Applications require a Makefile to compile, let us take a look at the <code>hello-world</code> Makefile:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">CONTIKI_PROJECT = 01-hello-world     <i class="conum" data-value="1"></i><b>(1)</b>
all: $(CONTIKI_PROJECT)              <i class="conum" data-value="2"></i><b>(2)</b>
CONTIKI = ../../../..                <i class="conum" data-value="3"></i><b>(3)</b>
include $(CONTIKI)/Makefile.include  <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Tells the build system which application to compile</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>If using <code>make all</code> it will compile the defined applications</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Specify our indentation level respect to Contiki root folder</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The system-wide Contiki Makefile, also points out to the platform&#8217;s Makefile</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We can define specific compilation flags in the Makefile, although the
recommended way would be to add a <code>project-conf.h</code> header, and define there
any compilation flag or value.  This is done by adding this to the Makefile:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">DEFINES+=PROJECT_CONF_H=\"project-conf.h\"</code></pre>
</div>
</div>
<div class="paragraph">
<p>And then creating a <code>project-conf.h</code> header file in the example location.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Before you embark in Contiki, it is useful to remember that normally the drivers have a switch like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">#define DEBUG 0
#if DEBUG
#define PRINTF(...) printf(__VA_ARGS__)
#else
#define PRINTF(...)
#endif</code></pre>
</div>
</div>
<div class="paragraph">
<p>Enable the <code>DEBUG</code> by changing to <code>1</code> or <code>DEBUG_PRINT</code>, this will print debug information to the console.  Normally you should do it in every driver file you wish to debug.</p>
</div>
<div class="paragraph">
<p>You can use printf to visualize on the console what is happening in your application.  It is really useful to debug your code, as you can print values of variables, when certain block of code is being executed, etc.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="truetest-the-leds-and-button"><a class="anchor" href="#truetest-the-leds-and-button"></a>Test the LEDs and Button</h4>
<div class="paragraph">
<p>This section will show how to use the LED (light emitting diode) to interact with our application.  Also it will be shown how to use the on-board <code>user button</code> to trigger specific events and change the way our application works.</p>
</div>
<div class="paragraph">
<p>You have to add the <code>dev/leds.h</code> which is the library to manage the LEDs.  To check the available functions go to <code>core/dev/leds.h</code>.</p>
</div>
<div class="paragraph">
<p>Available LEDs commands:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">unsigned char leds_get(void);
void leds_set(unsigned char leds);
void leds_on(unsigned char leds);
void leds_off(unsigned char leds);
void leds_toggle(unsigned char leds);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Normally all platforms comply to the following available LEDs:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">LEDS_GREEN
LEDS_RED
LEDS_BLUE
LEDS_ALL</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the <code>Z1</code> mote these LEDs are defined in <code>platform/z1/platform-conf.h</code>, as well as other hardware definitions.</p>
</div>
<div class="paragraph">
<p>The <code>RE-Mote</code> uses an RGB LED, basically 3-channel LEDs in a single device, allowing to show any color by the proper combination of Blue, Red and Green. In <code>platforms/zoul/remote/board.h</code> header the following are defined:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">LEDS_LIGHT_BLUE
LEDS_YELLOW
LEDS_PURPLE
LEDS_WHITE</code></pre>
</div>
</div>
<div class="paragraph">
<p>Accordingly you need to add <code>dev/button-sensor.h</code> to add support for the <code>user button</code>.</p>
</div>
<div class="paragraph">
<p>The <code>02-led-and-button.c</code> example show how the configuration is done.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">#include "contiki.h"
#include "dev/leds.h"
#include "dev/button-sensor.h"
#include &lt;stdio.h&gt;
/*-------------------------------------------------*/
PROCESS(led_button_process, "LEDs and button example process");
AUTOSTART_PROCESSES(&amp;led_button_process);
/*-------------------------------------------------*/
PROCESS_THREAD(led_button_process, ev, data)
{
  PROCESS_BEGIN();
  SENSORS_ACTIVATE(button_sensor);      <i class="conum" data-value="1"></i><b>(1)</b>

  while(1) {                            <i class="conum" data-value="2"></i><b>(2)</b>
    printf("Press the User Button\n");
    PROCESS_WAIT_EVENT_UNTIL(ev == sensors_event &amp;&amp; data == &amp;button_sensor);  <i class="conum" data-value="3"></i><b>(3)</b>
    /* When the user button is pressed, we toggle the LED on/off... */
    leds_toggle(LEDS_GREEN);            <i class="conum" data-value="4"></i><b>(4)</b>

    /*
     * And we print its status: when zero the LED is off, else on.
     * The number printed when the sensor is on is the LED ID, this value is
     * used as a mask, to allow turning on and off multiple LED at the same
     * time (for example using "LEDS_GREEN + LEDS_RED" or "LEDS_ALL"
     */
    printf("The sensor is: %u\n", leds_get());  <i class="conum" data-value="5"></i><b>(5)</b>
  }

  PROCESS_END();
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The LED initialization is done at booting by the platform itself, so there is no need to initialize again.  The <code>user button</code> is required to initialize</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Loop forever: the code inside the while-loop will run always and not reach <code>PROCESS_END()</code> macro.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>To avoid wasting processing cycles, the application is <em>paused</em> until we press the <code>user button</code></td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>When the <code>user button</code> is pressed, alternate between turning the LED on and off</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Prints the current LED mask, that is, which LED channels are on and off</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The <code>RE-Mote</code> platform has extra button functionalities, such as detect long-press sequences, enabling to further expand the events that can be triggered using the button.  Check <code>platform/zoul/dev/button-sensor.c</code> for more details, and <code>examples/zolertia/zoul/zoul-demo.c</code> for an example.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now let뗩 compile and upload the new project with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">make clean &amp;&amp; make 02-led-and-button.upload</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>make clean</code> command is used to erase previously compiled objects.</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you make changes to the source code, you must rebuild the files, otherwise your change might not be pulled in. It is always recommended to do a <code>make clean</code> command before compiling.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <code>RE-Mote</code> user and reset buttons are shown below:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/3/image016.png" alt="image016.png">
</div>
<div class="title">Figure 35. RE-Mote buttons and micro USB ports</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Exercise: try to toggle the other LEDs and write down the LED mask values&#8230;&#8203; Are these the same numbers for the <code>Z1</code> and the <code>RE-Mote</code>?  In case of the <code>RE-Mote</code>, try combining colours to produce new ones (remember is RGB!).
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="truetimers"><a class="anchor" href="#truetimers"></a>Timers</h4>
<div class="paragraph">
<p>Using timers will allow us to trigger events at a given time, speeding up the transition from one state to another and automating a given process or task, for example blinking an LED every 5 seconds, without the user having to press the button each time.</p>
</div>
<div class="paragraph">
<p>Contiki OS provides 4 kind of timers:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Simple timer: A simple ticker, the application should check <em>manually</em> if the timer has expired.  More information at <code>core/sys/timer.h</code>.</p>
</li>
<li>
<p>Callback timer: When a timer expires it can callback a given function. More information at <code>core/sys/ctimer.h</code>.</p>
</li>
<li>
<p>Event timer: Same as above, but instead of calling a function, when the timer expires it posts an event signalling its expiration. More information at <code>core/sys/etimer.h</code>.</p>
</li>
<li>
<p>Real time timer: The real-time module handles the scheduling and execution of real-time tasks, there&#8217;s only 1 timer available at the moment.  More information at <code>core/sys/rtimer.h</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The <code>03-timers.c</code> example implements the aforementioned timers and shows their functionality.</p>
</div>
<div class="paragraph">
<p>First let&#8217;s see how the timer&#8217;s libraries are included:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">/* The event timer library */
#include "sys/etimer.h"

/* The seconds timer library */
#include "sys/stimer.h"

/* The regular timer library */
#include "sys/timer.h"

/* The callback timer library */
#include "sys/ctimer.h"

/* The "real-time" timer library */
#include "sys/rtimer.h"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Next each timer needs to have its corresponding timer structure defined, this will allow the application to store the configuration and operational values of each timer at request.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">/* The following are the structures used when you need to include a timer, it
 * serves to keep the timer information.
 */
static struct timer  nt;
static struct stimer st;
static struct etimer et;
static struct ctimer ct;
static struct rtimer rt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then we need to implement <code>callbacks</code>, generally these are functions called by the application whenever something occurs.  As said before, both <code>ctimer</code> and <code>rtimer</code> are capable of invoking a function whenever an event happens (like a timer expiration).  Below is the format of the <code>callbacks</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">/*---------------------------------------------------------------------------*/
static void
rtimer_callback_example(struct rtimer *timer, void *ptr)
{
  /* Something happens here */
}
/*---------------------------------------------------------------------------*/
static void
ctimer_callback_example(void *ptr)
{
  /* Something happens here */
}
/*---------------------------------------------------------------------------*/</code></pre>
</div>
</div>
<div class="paragraph">
<p>The actual <code>03-timers.c</code> has the missing snippet of code in each callback, we will return later to these.</p>
</div>
<div class="paragraph">
<p>Here&#8217;s what our thread looks like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">/*-------------------------------------------------*/
PROCESS(test_timer_process, "Test timer");
AUTOSTART_PROCESSES(&amp;test_timer_process);
/*-------------------------------------------------*/
PROCESS_THREAD(test_timer_process, ev, data)
{
  PROCESS_BEGIN();
  static uint32_t ticks = 0;
  timer_set(&amp;nt, CLOCK_SECOND);    <i class="conum" data-value="1"></i><b>(1)</b><i class="conum" data-value="2"></i><b>(2)</b>
  while(!timer_expired(&amp;nt)) {     <i class="conum" data-value="3"></i><b>(3)</b>
    ticks++;
  }
  printf("timer, ticks: \t%ld\n", ticks);
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>CLOCK_SECOND</code> is a value related to the number of the microcontroller&#8217;s ticks per second. As Contiki runs on different platforms with different hardware, the value of <code>CLOCK_SECOND</code> also differs.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The most basic timer type is <code>timer</code>, it will keep running up to <code>CLOCK_SECOND</code></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>We need to manually check if the <code>timer</code> has expired</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Exercise: can you print the value of <code>CLOCK_SECOND</code> to count how many ticks you have in one second?
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The remaining of our thread is as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">  ticks = 0;
  stimer_set(&amp;st, 1);               <i class="conum" data-value="1"></i><b>(1)</b>
  while(!stimer_expired(&amp;st)) {     <i class="conum" data-value="2"></i><b>(2)</b>
    ticks++;
  }
  printf("stimer, ticks: \t%ld\n", ticks);</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Same as <code>timer</code>, but its time-base is seconds</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>And we also need to check if the <code>stimer</code> has expired</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Probably now in this point it is clear the disadvantages of using the previous timers: we need to manually check for expiration in a while-loop, which means a lot of wasted CPU cycles.</p>
</div>
<div class="paragraph">
<p>The next timer allow us to yield our application, meaning it will generate an event informing the application about its expiration, thus the system can perform other tasks in the meantime.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">  ticks = 0;
  etimer_set(&amp;et, CLOCK_SECOND * 2);

  ticks++;
  PROCESS_WAIT_EVENT_UNTIL(ev == PROCESS_EVENT_TIMER);
  printf("etimer, now: \t%ld\n", ticks);</code></pre>
</div>
</div>
<div class="paragraph">
<p>When the <code>etimer</code> is scheduled, we <em>yield</em> our application and wait for a <code>PROCESS_EVENT_TIMER</code> event, this is a type of process event sent by the timer to notify applications.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you run the example the first noticeable thing is the <code>ticks</code> value, what do you think this value will be in this case?</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The next timer to test is the <code>ctimer</code>.  Let&#8217;s see how it is implemented in the example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">  ticks++;
  ctimer_set(&amp;ct, CLOCK_SECOND * 2, ctimer_callback_example, &amp;ticks);

  /* And we keep the process halt while we wait for the callback timer to
   * expire.
   */

  while(1) {
    PROCESS_YIELD();
  }</code></pre>
</div>
</div>
<div class="paragraph">
<p>As comented before the <code>ctimer</code> will invoke a function whenever it expires, in this case the <code>ctimer_callback_example</code> function after 2 seconds since triggered.  Notice we are also passing to the <code>ctimer_callback_example</code> the content of the variable <code>ticks</code>, meaning we can pass as argument any type of variable to the callback function, as it defines this parameter as <code>void *ptr</code>.  Let&#8217;s check now the complete callback implementation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">static void
ctimer_callback_example(void *ptr)
{
  uint32_t *ctimer_ticks = ptr;                     <i class="conum" data-value="1"></i><b>(1)</b>
  printf("ctimer, now: \t%ld\n", *ctimer_ticks);

  /* The real timer allows execution of real-time tasks (with predictable
   * execution times).
   * The function RTIMER_NOW() is used to get the current system time in ticks
   * and RTIMER_SECOND specifies the number of ticks per second.
   */

  (*ctimer_ticks)++;                                <i class="conum" data-value="2"></i><b>(2)</b>
  rtimer_set(&amp;rt, RTIMER_NOW() + RTIMER_SECOND, 0,  <i class="conum" data-value="3"></i><b>(3)</b>
             rtimer_callback_example, ctimer_ticks);
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Create a pointer to the variable passed as argument</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Increment the variable <code>ticks</code> using our pointer</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Schedule a <code>rtimer</code> to expire after 1 second and pass as argument our pointer to the <code>ticks</code> variable</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In our example when <code>ctimer</code> expires it will set a real-timer event using the <code>rtimer</code> type of timer.  The <code>RTIMER_NOW()</code> is a macro used to retrieve the current tick value (<code>rtimer</code> is always ticking thus running in the background), we use this as base value then add the number of ticks in which we want our event to be triggered in the future.  The <code>RTIMER_SECOND</code> in the same fashion as <code>CLOCK_SECOND</code> defines the number of ticks in a second.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Print the value of <code>RTIMER_SECOND</code> and compare to the value of <code>CLOCK_SECOND</code>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>When <code>rtimer</code> expires it invokes its corresponding callback function, let&#8217;s check its full implementation in our example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">static void
rtimer_callback_example(struct rtimer *timer, void *ptr)
{
  uint32_t *rtimer_ticks = ptr;
  printf("rtimer, now: \t%ld\n", *rtimer_ticks);

  /* We can restart the ctimer and keep the counting going */
  (*rtimer_ticks)++;
  ctimer_restart(&amp;ct);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>As done in the <code>ctimer</code> callback we also create a pointer to the original <code>ticks</code> variable, print and increment its value.  We restart the <code>ctimer</code> using the initial expiration value configured before.  From now on, <code>ctimer</code> callback will configure a new <code>rtimer</code> timer and viceversa, incrementing the <code>ticks</code> value in a linear way.</p>
</div>
</div>
<div class="sect3">
<h4 id="trueprocesses-in-contiki"><a class="anchor" href="#trueprocesses-in-contiki"></a>Processes in Contiki</h4>
<div class="paragraph">
<p>We learned in previous section how to create a <code>PROCESS</code> and the meaning of the <code>PROCESS_BEGIN()</code> and <code>PROCESS_END()</code> macros.  Let&#8217;s take a closer look at how processes are implemented in Contiki.</p>
</div>
<div class="paragraph">
<p>A process thread contains the code of the process. The process thread is a single <em>protothread</em> that is invoked from the process scheduler.  A <em>protothread</em> is a way to structure code in a way that allows the system to run other activities when the code is waiting for something to happen. The concept of protothreads was developed within the context of Contiki.</p>
</div>
<div class="paragraph">
<p><a href="https://github.com/contiki-os/contiki/wiki/Processes">Protothread</a> provides a way for C functions to work in a way that is similar to threads, without the memory overhead of threads. Reducing the memory overhead is important on the memory-constrained systems on which Contiki runs.</p>
</div>
<div class="paragraph">
<p>The <em>protothreads</em> starts and ends with two special macros, <code>PROCESS_BEGIN</code> and <code>PROCESS_END()</code>. Between these macros, a set of protothread functions can be used.</p>
</div>
<div class="paragraph">
<p>Libraries and applications in Contiki uses processes to run and to communicate with other modules, by creating its own processes or using the already available.  The timers for example use the existing <code>PROCESS_EVENT_TIMER</code>, and applications could also use the <code>PROCESS_EVENT_EXITED</code> process to indicate an early exit.  These are <code>event identifiers</code> reserved by the <a href="https://github.com/alignan/contiki/blob/master/core/sys/process.h">Contiki Kernel</a>.</p>
</div>
<div class="paragraph">
<p>As probably noticed by now, we normally refer to <em>yielding</em> and waiting for a <em>process</em>.  Contiki has two execution contexts: cooperative and preemptive.  Processes are cooperative and sequential, interrupts (button, sensors events) and the real-timer are preemptive.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/3/image004.png" alt="image004.png">
</div>
<div class="title">Figure 36. Execution contexts: processes and interrupts</div>
</div>
<div class="paragraph">
<p>As we have learned before, there are two ways so far to <em>yield</em> a <em>protothread</em>:</p>
</div>
<div class="paragraph">
<p><code>PROCESS_YIELD()</code> will wait for any type of process event to happen, it will not check which process has occured.  Often a check like <code>if(ev == PROCESS_EVENT_NAME){}</code> is used to catch one or more processes.</p>
</div>
<div class="paragraph">
<p>On the other hand the <code>PROCESS_WAIT_EVENT_UNTIL(&#8230;&#8203;)</code> allows to catch a process event direclty, in the case of the <code>etimer</code> as previously shown, we can yield until:</p>
</div>
<div class="paragraph">
<p><code>PROCESS_WAIT_EVENT_UNTIL(ev == PROCESS_EVENT_TIMER)</code></p>
</div>
<div class="paragraph">
<p>Or simply:</p>
</div>
<div class="paragraph">
<p><code>PROCESS_WAIT_EVENT_UNTIL(etimer_expired(&amp;et))</code></p>
</div>
<div class="paragraph">
<p>To catch just an <code>etimer</code> event from timer <code>et</code>.</p>
</div>
<div class="paragraph">
<p>Similar to <code>PROCESS_YIELD()</code>, the <code>PROCESS_PAUSE()</code> macro will pause the thread, but instead of waiting for an event to happen it will temporatily pause the process, by posting an event to itself and yielding.  This allows the system to execute other processes and whenever done then resume our process.</p>
</div>
<div class="paragraph">
<p>The <code>PROCESS_EXIT()</code> macro will allow the application to exit before reaching <code>PROCESS_END()</code>, it will send a <code>PROCESS_EVENT_EXITED</code> process notification whenever that happens.</p>
</div>
<div class="paragraph">
<p>The <code>04-processes.c</code> example shows how to create and terminate process, more importantly how to communicate between process.</p>
</div>
<div class="paragraph">
<p>Processes are useful as they allow to run different parts of our application, in its own semantic context, allowing a cleaner and efficient implementation.  For example imagine a process running all the networking part, while separate processes take readings from individual sensors, each one running on its own context.</p>
</div>
<div class="paragraph">
<p>The example consist of 3 processes, one will spawn another process and receive events about a variable being incremented.  When the variable value reaches a limit, the first process will terminate its child process.  A third process listening in stand-by will receive a notification about the terminated process and restart it again.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">PROCESS(process1, "Main process");
PROCESS(process2, "Auxiliary process");
PROCESS(process3, "Another auxiliary process");

/* But we are only going to automatically start the first two */
AUTOSTART_PROCESSES(&amp;process1, &amp;process2);</code></pre>
</div>
</div>
<div class="paragraph">
<p>We define the three processes to run, but notice we only automatically start the first two.  As opposite to what we have been working with before, after the <code>Z1</code> or <code>RE-Mote</code> platform finishes booting it will only call the processes declared within the <code>AUTOSTART_PROCESSES(&#8230;&#8203;)</code> macro, leaving <code>process3</code> not started for now.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s review how the first process is implemented:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">PROCESS_THREAD(process1, ev, data)
{
  PROCESS_BEGIN();
  static uint8_t counter;
  printf("Process 1 started\n");
  process_start(&amp;process3, "Process 1");      <i class="conum" data-value="1"></i><b>(1)</b>

  while(1) {
    PROCESS_YIELD();                          <i class="conum" data-value="2"></i><b>(2)</b>
    if(ev == event_from_process3) {           <i class="conum" data-value="3"></i><b>(3)</b>
      counter = *((uint8_t *)data);           <i class="conum" data-value="4"></i><b>(4)</b>
      printf("Process 3 has requested shutdown in %u seconds\n", counter);
      etimer_set(&amp;et1, CLOCK_SECOND);
    }

    if(ev == PROCESS_EVENT_TIMER) {           <i class="conum" data-value="5"></i><b>(5)</b>
      if(counter &lt;= 0) {
        process_exit(&amp;process3);              <i class="conum" data-value="6"></i><b>(6)</b>
      } else {
        printf("Process 3 will be terminated in: %u\n", counter);
        counter--;
        leds_toggle(LEDS_RED);
        etimer_reset(&amp;et1);
      }
    }
  }
  PROCESS_END();
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>When <code>process1</code> starts, it will launch <code>process3</code>, when starting a process one can pass variables or data as a argument (in this example a string "Process 1")</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>And then will wait for any event&#8230;&#8203;</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Note the <code>process1</code> has two additional arguments: <code>ev</code> and <code>data</code>, when a process posts information to another process, it uses these arguments to pass information such as a pointer to a variable.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>If we receive an event from <code>process3</code> it will mean that process has requested an early termination, so we start an <code>etimer</code>&#8230;&#8203;</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>And when our <code>etimer</code> expires&#8230;&#8203;</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>We will terminate <code>process3</code></td>
</tr>
</table>
</div>
<div class="paragraph">
<p>As seen above <code>process3</code> is terminated by <code>process1</code> whenever "something" happens at <code>process3</code>, but what about <code>process2</code>?</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">PROCESS_THREAD(process2, ev, data)
{
  PROCESS_BEGIN();
  printf("Process 2 started\n");

  while(1) {
    PROCESS_YIELD();
    if(ev == PROCESS_EVENT_EXITED) {          <i class="conum" data-value="1"></i><b>(1)</b>
      printf("* Process 3 has been stopped by Process 1!\n");
      etimer_set(&amp;et2, CLOCK_SECOND * 5);     <i class="conum" data-value="2"></i><b>(2)</b>
    }

    if(ev == PROCESS_EVENT_TIMER) {           <i class="conum" data-value="3"></i><b>(3)</b>
      printf("Process 2 is restarting Process 3\n");
      process_start(&amp;process3, "Process 2");  <i class="conum" data-value="4"></i><b>(4)</b>
    }
  }

  PROCESS_END();
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>When <code>process3</code> is terminated by <code>process1</code>, we receive a notification</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>And start a 5-second timer&#8230;&#8203;</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>When the <code>etimer</code> expires&#8230;&#8203;</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td><code>process2</code> will launch back again <code>process3</code>, and will send its own name as string</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We have now read the implementation of <code>process1</code> and <code>process2</code> and learned how to start and end processes, and receive data using the <code>data</code> argument.  Let&#8217;s check how <code>process3</code> is implemented:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">PROCESS_THREAD(process3, ev, data)
{
  PROCESS_BEGIN();
  static char *parent;
  parent = (char * )data;                        <i class="conum" data-value="1"></i><b>(1)</b>
  static uint8_t counter;                        <i class="conum" data-value="2"></i><b>(2)</b>

  printf("Process 3 started by %s\n", parent);
  event_from_process3 = process_alloc_event();   <i class="conum" data-value="3"></i><b>(3)</b>
  etimer_set(&amp;et3, CLOCK_SECOND);

  counter = 0;

  while(1) {
    PROCESS_WAIT_EVENT_UNTIL(etimer_expired(&amp;et3));
    counter++;
    leds_toggle(LEDS_GREEN);

    if(counter == 10) {
      process_post(&amp;process1, event_from_process3, &amp;counter);  <i class="conum" data-value="4"></i><b>(4)</b>
    }
    etimer_reset(&amp;et3);                          <i class="conum" data-value="5"></i><b>(5)</b>
  }
  PROCESS_END();
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Create a pointer to read the processes name passed as string argument to us</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Create a variable to increment</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Allocate a process event to use and communicate to other processes</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>When the counter reaches 10, send an <code>event_from_process3</code> event to <code>process1</code> with a pointer to the <code>counter</code> variable</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Reset the <code>etimer</code> using the current expiration value previously configured</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <code>event_from_process3</code> process event was previously declared in our example as:</p>
</div>
<div class="paragraph">
<p><code>process_event_t event_from_process3;</code></p>
</div>
</div>
<div class="sect3">
<h4 id="truesensors"><a class="anchor" href="#truesensors"></a>Sensors</h4>
<div class="paragraph">
<p>A sensor is a transducer whose purpose is to sense or detect a characteristic of its environment, providing a corresponding output, generally as an electrical or optical signal, related to the quantity of the measured variable.</p>
</div>
<div class="paragraph">
<p>Sensors in Contiki are implemented as follow:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">SENSORS_SENSOR (sensor, SENSOR_NAME, value, configure, status);</code></pre>
</div>
</div>
<div class="paragraph">
<p>This means that a method to <code>configure</code> the sensor, poll the sensor <code>status</code> and request a <code>value</code> have to be implemented.  The <code>sensor</code> structure contains pointers to these functions.  The arguments for each function are shown below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">struct sensors_sensor {
   char *       type;
   int          (* value)     (int type);
   int          (* configure) (int type, int value);
   int          (* status)    (int type);
};</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you need to further expand the available functions (change the <code>int</code> return value of the <code>value</code> function to return a pointer instead, etc) or add your own, you can edit this structure, but keep in mind it will probably break other sensors developed based on this.  You can define additional sensor and actuators functions in your header file instead.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To better understand please refer to the <code>platform/zoul/dev/adc-sensors.c</code>, for an example of how analogue external sensors can be implemented (to be further discussed in the next sections).</p>
</div>
<div class="paragraph">
<p>The following functions and macros can be used to work with the sensor:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">SENSORS_ACTIVATE(sensor)    <i class="conum" data-value="1"></i><b>(1)</b>
SENSORS_DEACTIVATE(sensor)  <i class="conum" data-value="2"></i><b>(2)</b>
sensor.value(type);         <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Enable the sensor, typically configures and turns the sensor on</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Disables the sensor, it is useful to save power</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Request a value to the sensor.  As one sensor chip might have different types of readings (temperature, humidity, etc.), this is used to specify which measure to take.</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Although this is the default way to implement sensors in Contiki, there might be alternatives, depending on the sensor and developer.  Always check the specific sensor driver implementation for details.  Normally sensors are provided in the same location as the example, in the <code>dev</code> folder, or in the <code>platform/zoul/dev</code> directory for example.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <code>SENSORS</code> macro provides external linkage to the sensors defined for the platform and application, allowing to iterate between the available sensors. The following are the sensors defined as default for the RE-Mote platform:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">SENSORS (&amp;button_sensor, &amp;vdd3_sensor, &amp;cc2538_temp_sensor, &amp;adc_sensors);</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The button is considered a sensor in Contiki, and it shares the same sensor implementation</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This macro extends to:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">const struct sensors_sensor *sensors[] = {
  &amp;button_sensor,
  &amp;vdd3_sensor,
  &amp;cc2538_temp_sensor,
  &amp;adc_sensors,
  ((void *)0)
};</code></pre>
</div>
</div>
<div class="paragraph">
<p>For the <code>Z1</code> mote the <code>SENSORS</code> macro is defined within the <code>platforms/z1/contiki-z1-main.c</code>:</p>
</div>
<div class="paragraph">
<p><code>SENSORS(&amp;button_sensor);</code></p>
</div>
<div class="paragraph">
<p>The number of sensors can be found with the <code>SENSORS_NUM</code> macro:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">#define SENSORS_NUM (sizeof(sensors) / sizeof(struct sensors_sensor *))</code></pre>
</div>
</div>
<div class="paragraph">
<p>Sensors can be of two types: analogue or digital. In the following sections examples will be shown for both types, detailing how to connect and use both the platform&#8217;s internal sensors as well as the external ones.</p>
</div>
<div class="sect4">
<h5 id="trueanalogue-sensors"><a class="anchor" href="#trueanalogue-sensors"></a>Analogue Sensors</h5>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p>Analogue sensors typically require being connected to an ADC (analogue to digital converter) to translate the analogue (continuous) reading to an equivalent digital value in millivolts. The quality and resolution of the measure depends on both the ADC resolution (up to 12 bits in the Z1 and RE-Mote) and the sampling frequency.</p>
</div>
<div class="paragraph">
<p>As a rule of thumb, the sampling frequency must be at least twice that of the phenomenon you are measuring. As an example, if you want to sample human speech (which may contain frequencies up to 8 kHz) you need to sample at twice that frequency (16 kHz).</p>
</div>
</div>
</div>
<div class="paragraph">
<p>The <code>Z1</code> mote and the <code>RE-Mote</code> have a built-in voltage sensor provided as an ADC input channel, as well as a generic implementation to read external analogue sensors.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Analogue sensors can be connected to both the Z1 and the RE-Mote over  analogue_ ports, which are basically 3-pin connectors (Ground, VCC and signal) with 2.54 mm spacing.  This port is compatible with Phidget sensors. Nowadays there are also sensors from other providers, such as seeedstudio that have the same pin-out but with a different pin spacing (2 mm). This is not a problem, as there are cables to adapt the pin spacing.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/3/image008.jpg" alt="image008.jpg">
</div>
<div class="title">Figure 37. Analogue sensors</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The ADC results in the <code>RE-Mote</code> returns the reading in voltage directly, there&#8217;s no need to further conversion.</p>
</div>
<div class="paragraph">
<p>For the Z1 mote the ADC output must be converted by means of the following formula: We multiply the measured value by the voltage reference and divide the product by the ADC&#8217;s maximum output.  As the resolution of the ADC is 12 bits (2<sup>12</sup> = 4096), we get:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>Voltage, mV = (units * Vref) / 4096;</pre>
</div>
</div>
<div class="paragraph">
<p>The voltage reference limits the range of our measure, meaning if we use a <code>Vref</code> of 2.5 V, the sensor will saturate when reading a higher voltage.  The reference can be chosen while configuring the ADC, for both the <code>Z1</code> and <code>RE-Mote</code> normally 3.3 V is used.</p>
</div>
<div class="paragraph">
<p>Both the <code>Z1</code> and the <code>RE-Mote</code> allow up to 6 analogue sensors to be connected, but only two <em>analogue</em> connectors can be soldered at the same time.</p>
</div>
<div class="paragraph">
<p>For the <code>RE-Mote</code> it is possible to have one <em>analogue</em> connector for a 3.3 V analogue sensor (ADC1) and another for 5 V sensors (ADC3).</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/3/image011.png" alt="image011.png">
</div>
<div class="title">Figure 38. RE-Mote ADC pin-out</div>
</div>
<div class="paragraph">
<p>Note the location of the <em>analogue</em> connectors in the image below.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/3/image010.png" alt="image010.png">
</div>
<div class="title">Figure 39. Available connectors in the RE-Mote</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The <code>RE-Mote</code> is based on an ARM Cortex-M3, this allows to map any given pin to a controller (as opposite to the MSP430, for which a pin has predefined functions other than GPIO), but only pins in the PA port can be used as ADC.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For the <code>Z1</code> mote is possible to have the following combinations (see Figure below):</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Two phidget connectors for 3.3 V sensors.</p>
</li>
<li>
<p>Two phidget connectors for 5 V sensors.</p>
</li>
<li>
<p>Two phidget connectors, one for 3.3 V and one for 5 V sensors.</p>
</li>
</ul>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/3/image005.png" alt="image005.png">
</div>
<div class="title">Figure 40. Pin assignment</div>
</div>
<div class="paragraph">
<p>In the snippet below the ADC channels ADC0 (5V1), ADC3 (5V2), ADC1 (3V1) and ADC7 (3V2) are mapped by default to be used as input for external analogue sensors.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">/* MemReg6 == P6.0/A0 == 5V 1 */
ADC12MCTL0 = (INCH_0 + SREF_0);
/* MemReg7 == P6.3/A3 == 5V 2 */
ADC12MCTL1 = (INCH_3 + SREF_0);
/* MemReg8 == P6.1/A1 == 3V 1 */
ADC12MCTL2 = (INCH_1 + SREF_0);
/* MemReg9 == P6.7/A7 == 3V_2 */
ADC12MCTL3 = (INCH_7 + SREF_0);</code></pre>
</div>
</div>
<div class="paragraph">
<p>To read from a sensor connected to the ADC7 channel of the <code>Z1</code> mote, in my code I would need to make the following steps:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">#include "dev/z1-phidgets.h"                                <i class="conum" data-value="1"></i><b>(1)</b>
SENSORS_ACTIVATE(phidgets);                                 <i class="conum" data-value="2"></i><b>(2)</b>
printf("Phidget 5V 1:%d\n", phidgets.value(PHIDGET3V_2));   <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Include the driver header</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Enable the ADC sensors, as default all 4 ADC channels are enabled</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Request a reading</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <code>Z1</code> is powered at 3.3 V, but when connected over the USB (standard voltage 5 V) it allows to connect 5 V sensors to the phidget ports, namely 5V1 (ADC3) and 5V2 (ADC0) as there is a voltage divider in the input to adapt the reading from 5 V to 3.3V.</p>
</div>
<div class="paragraph">
<p>Details about the <code>Z1</code> implementation of the analogue sensors driver are available at <code>platform/z1/dev/z1-phidgets.c</code>.</p>
</div>
<div class="paragraph">
<p>There is also a driver for the MSP430 internal voltage sensor at <code>platform/z1/dev/battery-sensor.c</code>, with an example at <code>examples/zolertia/z1/test-battery.c</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">#include "dev/battery-sensor.h"
/*---------------------------------------------------------------------------*/
PROCESS(test_battery_process, "Battery Sensor Test");
AUTOSTART_PROCESSES(&amp;test_battery_process);
/*---------------------------------------------------------------------------*/
PROCESS_THREAD(test_battery_process, ev, data)
{
  static uint32_t battery;
  PROCESS_BEGIN();
  SENSORS_ACTIVATE(battery_sensor);

  while(1) {
    battery = battery_sensor.value(0);
    battery *= 5000;
    battery /= 4096;
    printf("Battery: %u.%02uV\n", (uint16_t)battery / 1000, (uint16_t)battery % 1000);
  }
  PROCESS_END();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>When the USB is connected or the battery is full, the result is similar to:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">Battery: 3.21V
Battery: 3.18V
Battery: 3.20V
Battery: 3.18V
Battery: 3.20V
Battery: 3.20V
Battery: 3.18V
Battery: 3.20V
Battery: 3.18V</code></pre>
</div>
</div>
<div class="paragraph">
<p>It is possible also to connect an external analogue sensor, like the <a href="http://www.phidgets.com/products.php?product_id=1142_0">Phidget 1142 precision Light Sensor</a> or the <a href="http://www.seeedstudio.com/item_detail.html?p_id=1253">Grove/Seeedstudio Light Sensor (P)</a>.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/3/image006.png" alt="image006.png">
</div>
<div class="title">Figure 41. Phidget 1142 Light sensor</div>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/3/image012.jpg" alt="image012.jpg">
</div>
<div class="title">Figure 42. Seeedstudio (Grove) Light sensor</div>
</div>
<div class="paragraph">
<p>The example called <code>test-phidgets.c</code> in <code>examples/zolertia/z1</code> will read values from an analog sensor and print them to the terminal.</p>
</div>
<div class="paragraph">
<p>Connect the light sensor to the 3V2 Phidget connector and compile the example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">make clean &amp;&amp; make test-phidgets.upload &amp;&amp; make z1-reset &amp;&amp; make login</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>You can pipeline commands to be executed one after another, in this case the <code>make z1-reset</code> restarts the mote after flashed, then <code>make login</code> prints to console the output of any <code>printf</code> command in our code.  You may need to use the argument <code>MOTES=/dev/ttyUSB[0&#8230;&#8203;9]</code> to specify a mote over a particular USB port.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This is the result:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">Starting 'Test Button &amp; Phidgets'
Please press the User Button
Phidget 5V 1:123
Phidget 5V 2:301
Phidget 3V 1:1710
Phidget 3V 2:2202</code></pre>
</div>
</div>
<div class="paragraph">
<p>The light sensor is connected to the 3V2 connector, so the raw value is 2202. Try to illuminate the sensor with a flashlight (from your mobile phone, for example) and then cover it with your hand so that no light can reach it.</p>
</div>
<div class="paragraph">
<p>From the Phidget website we have the following information about the sensor:</p>
</div>
<table class="tableblock frame-topbot grid-all" style="width: 90%;">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Parameter</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tfoot>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Light level max (5 V)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1000 lux</p></td>
</tr>
</tfoot>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sensor type</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Light</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Light level min</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1 lux</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Supply Voltage Min</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2.4 V</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Supply Voltage Max</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5.5 V</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Max current consumption</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5mA</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Light level max (3.3 V)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">660 lux</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>As you can see, the light sensor can be connected to either the 5 V or the 3.3 V <em>analogue</em> connector. The max measurable value depends on where you connect it.</p>
</div>
<div class="paragraph">
<p>The formula to translate SensorValue into luminosity is:
<code>Luminosity(lux)=SensorValue</code></p>
</div>
<div class="paragraph">
<p>The <strong>RE-Mote platform</strong> also allows to connect 5 V sensors to the ADC3 port, using the same voltage divider as the Z1 mote.  As seen in the next snippet, the ADC3 port is mapped to the PA2 pin.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">/*
 * This driver supports analogue sensors connected to ADC1, ADC2 and AND3 inputs
 * This is controlled by the type argument of the value() function. Possible
 * choices are:
 * - REMOTE_SENSORS_ADC1 (channel 5)
 * - REMOTE_SENSORS_ADC2 (channel 4)
 * - REMOTE_SENSORS_ADC3 (channel 2)
 */</code></pre>
</div>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/3/image009.png" alt="image009.png">
</div>
<div class="title">Figure 43. RE-Mote ADC3 voltage divider for 5V analogue sensors</div>
</div>
<div class="paragraph">
<p>Then to read data from an attached sensor (as we did in the previous example):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">#include "dev/zoul-sensors.h"                                               <i class="conum" data-value="1"></i><b>(1)</b>
adc_sensors.configure(SENSORS_HW_INIT, REMOTE_SENSORS_ADC_ALL);             <i class="conum" data-value="2"></i><b>(2)</b>
printf("ADC1 = %d raw\n", adc_sensors.value(REMOTE_SENSORS_ADC1));          <i class="conum" data-value="3"></i><b>(3)</b>
printf("ADC3 = %d raw\n", adc_sensors.value(REMOTE_SENSORS_ADC3));</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Include the ADC driver header</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Enable and configure the ADC channels (can selectively choose which to enable)</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Request a reading</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Note the ADC3 voltage reading has to be multiplied by 3/2 to get the actual 0-5V range value, as there is a voltage divider with a 500K/200K relationship.</p>
</div>
<div class="paragraph">
<p>Now let&#8217;s connect a <code>Grove Light Sensor</code> to the <code>RE-Mote</code>:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/3/image013.jpg" alt="image013.jpg">
</div>
<div class="title">Figure 44. RE-Mote and Grove light sensor</div>
</div>
<div class="paragraph">
<p>Compile and program the RE-Mote example at <code>example/zolertia/zoul/zoul-demo.c</code>, the output should be similar to:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">connecting to /dev/ttyUSB0 (115200) [OK]
-----------------------------------------
Counter = 0x00000000
VDD = 3299 mV
Temperature = 33333 mC
ADC1 = 112 raw
ADC3 = 1516 raw</code></pre>
</div>
</div>
<div class="paragraph">
<p>The above result was taken with the light sensor covered, so aproximately with no light the voltage value is 0.112V.  This light sensor has a light-dependent resistor (LDR), the output in voltage units correlates to the equivalent LDR.  The <a href="http://www.seeedstudio.com/wiki/Grove_-_Light_Sensor">Grove wiki page</a> shows how the resistance/luxes graphs to obtain proper lux values, but probably a better option is to calibrate by using a known lux source, or just knowing the smaller the value the darkest the ambient is.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Exercise: make the sensor take readings as fast as possible. Print to the screen the ADC raw values and the millivolts (as this sensor is linear, the voltage corresponds to the luxes). What are the max and min values you can get? What is the average light value of the room? Create an application that turns the red LED on when it is dark and the green LED on when the room is bright. In between, all the LEDs should be off. Add a timer and measure the light every 10 seconds.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Note the <code>RE-Mote</code> has built-in voltage and core temperature sensors.  The voltage sensor provides the voltage level of the <code>CC2538</code> system on chip, whereas the core temperature gives the operation temperature.  As shown in the previous code snippet, the <code>zoul-demo.c</code> example also shows how to use both sensors:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">  printf("VDD = %d mV\n",
         vdd3_sensor.value(CC2538_SENSORS_VALUE_TYPE_CONVERTED));

  printf("Temperature = %d mC\n",
          cc2538_temp_sensor.value(CC2538_SENSORS_VALUE_TYPE_CONVERTED));</code></pre>
</div>
</div>
<div class="paragraph">
<p>Both sensors are initialized at booting by the <code>RE-Mote</code>.</p>
</div>
</div>
<div class="sect4">
<h5 id="truedigital-sensors"><a class="anchor" href="#truedigital-sensors"></a>Digital Sensors</h5>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p>Digital sensors are normally interfaced over a digital communication protocol such as I2C, SPI, 1-Wire, Serial or depending on the manufacturer, a proprietary protocol normally on a ticking clock.</p>
</div>
<div class="paragraph">
<p>Digital sensors allow a more extended set of commands (turn on, turn off, configure interrupts). With a digital light sensor for example, you could set a threshold value and let the sensor send an interrupt when reached, without the need for continuous polling.</p>
</div>
<div class="paragraph">
<p>Remember to check the specific sensor information and data sheet for more information.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>The <strong>Z1 mote</strong> has <strong>two built in digital sensors</strong>: temperature and 3-axis accelerometer.  The <code>ADXL345</code> accelerometer has an example named <code>test-adxl345.c</code> in <code>examples/zolertia/z1</code> showing how the sensor works.</p>
</div>
<div class="paragraph">
<p>The <code>ADXL345</code> is an I2C ultra-low power sensor able to read up to 16g, well suited for mobile device applications.  It measures the static acceleration of gravity in tilt-sensing applications, as well as dynamic acceleration resulting from motion or shock. Its high resolution (3.9mg/LSB) enables measurement of inclination changes smaller than 1.0춿.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">[37] DoubleTap detected! (0xE3) -- DoubleTap Tap
x: -1 y: 12 z: 223
[38] Tap detected! (0xC3) -- Tap
x: -2 y: 8 z: 220
x: 2 y: 4 z: 221
x: 3 y: 5 z: 221
x: 4 y: 5 z: 222</code></pre>
</div>
</div>
<div class="paragraph">
<p>The accelerometer can read data in the x, y and z axis and has three types of interrupts: a single tap, a double tap and a free-fall (be careful to not damage the mote!).</p>
</div>
<div class="paragraph">
<p>Having an accelerometer on-board is quite useful: you can detect if anyone is tampering with the device, or detect if someone falls, monitor vibration and generate an alarm if exceeds a given threshold (causing a component to break), etc.</p>
</div>
<div class="paragraph">
<p>The code has two threads, one for the interruptions and the other for the LEDs. When Contiki starts, it triggers both processes.</p>
</div>
<div class="paragraph">
<p>The <code>led_process</code> thread triggers a timer that waits before turning off the LEDs. This is mostly done to filter the rapid signal coming from the accelerometer. The other process is the acceleration. It assigns the callback for the <code>led_off</code> event.
Interrupts can happen at any given time, are non periodic and totally asynchronous.</p>
</div>
<div class="paragraph">
<p>Interrupts can be triggered by external sources (sensors, GPIOs, <em>Watchdog Timer</em>, etc) and should be cleared as soon as possible. When an interrupts happens, the interrupt handler (which is a process that checks the interrupt registers to find out which is the interrupt source) manages it and forwards it to the subscribed callback.</p>
</div>
<div class="paragraph">
<p>In this example, the accelerometer is initialized and then the interrupts are mapped to a specific callback functions. Interrupt source 1 is mapped to the <em>free fall</em> callback handler and the tap interrupts are mapped to the interrupt source 2.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">/*
 * Start and setup the accelerometer with default
 * values, _i.e_ no interrupts enabled.
 */
SENSORS_ACTIVATE(adxl345);
/* Register the callback functions */
ACCM_REGISTER_INT1_CB(accm_ff_cb);
ACCM_REGISTER_INT2_CB(accm_tap_cb);</code></pre>
</div>
</div>
<div class="paragraph">
<p>We then need to enable the interrupts like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">accm_set_irq(ADXL345_INT_FREEFALL,
             ADXL345_INT_TAP +
             ADXL345_INT_DOUBLETAP);</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the <em>while</em> loop we read the values from each axis every second.  If there are no interrupts, this will be the only thing shown in the terminal.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Exercise: put the mote in different positions and check the values of the accelerometer. Try to understand which is x, y and z. Measure the maximum acceleration by shaking the mote. Turn on and off the LED according to the acceleration on one axis.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <code>TMP102</code> digital temperature sensor on-board the <code>Z1</code> platform has a +/-5췈C accuracy and can measure temperatures from -25췈C to 85췈C.  There is an example ready to use at <code>examples/zolertia/z1/test-tmp102.c</code> showing how the sensor works.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">PROCESS_THREAD(temp_process, ev, data)
{
  PROCESS_BEGIN();
  int16_t temp;
  SENSORS_ACTIVATE(tmp102);
  while(1) {
    etimer_set(&amp;et, TMP102_READ_INTERVAL);
    PROCESS_WAIT_EVENT_UNTIL(etimer_expired(&amp;et));
    temp = tmp102.value(TMP102_READ);
    printf("Temp = %d.%02d\n", temp / 100, temp % 100);
  }
  PROCESS_END();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The output is similar to below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">Temp = 27.75
Temp = 28.12
Temp = 28.31
Temp = 28.18
Temp = 28.12
Temp = 28.06</code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The TMP102 is placed close to the CP2102 Serial to USB converter of the <code>Z1</code> mote, thus when powered over USB it will overheat and increase the temperature nearby the sensor.  Consider substracting 4-5췈C to the actual readings when powered over USB.  If the <code>Z1</code> is powered over battery the measurements will be OK.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>External digital sensors can be connected to the <code>Z1</code> and <code>RE-Mote</code> platforms.</p>
</div>
<div class="paragraph">
<p>As shown in Figure 8, the <code>RE-Mote</code> and the <code>Z1</code> allows I2C and SPI sensors to be connected to the <code>Ziglet</code> port: a 5-pin connector with 2.54mm pitch spacing as follows:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/3/image014.png" alt="image014.png">
</div>
<div class="title">Figure 45. RE-Mote 5-pin digital port (I2C and/or SPI)</div>
</div>
<div class="paragraph">
<p>For the next example we will use the <a href="http://zolertia.io/product/sensors/temp-humidity-sensor-sht21">SHT25</a>, an I2C digital temperature and humidity sensor from Sensirion.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/3/image007.png" alt="image007.png">
</div>
<div class="title">Figure 46. SHT25 Temperature and humidity sensor</div>
</div>
<table class="tableblock frame-topbot grid-all" style="width: 90%;">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Parameter</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tfoot>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Max current consumption</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">300 uA</p></td>
</tr>
</tfoot>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sensor type</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Temperature and Humidity</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Supply Voltage [V]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2.1 - 3.6</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Energy Consumption</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3.2 uW (at 8 bit, 1 measurement / s)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Data range</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0-100 % RH (humidity), -40-125췈C (temperature)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Max resolution</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">14 bits (temperature), 12 bits (humidity)</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>As usual you can check the driver implementation at the <code>platform/z1/dev</code> and <code>platform/zoul/dev</code> directories.  Check out these locations for other sensors and examples to guide you to implement your own.</p>
</div>
<div class="paragraph">
<p>When adding an external sensor to your application, you will need to tell the compiler to include the sensor libraries.  In the previous examples this was not required as the platforms include its on-board sensor automatically.  Adding the external sensor libraries to the application is done in the <code>Makefile</code>.  This is how the <code>RE-Mote</code> Makefile looks like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">DEFINES+=PROJECT_CONF_H=\"project-conf.h\"                                 <i class="conum" data-value="1"></i><b>(1)</b>

CONTIKI_PROJECT = zoul-demo test-tsl2563 test-sht25 test-power-mgmt        <i class="conum" data-value="2"></i><b>(2)</b>
CONTIKI_PROJECT += test-bmp085-bmp180 test-motion test-rotation-sensor
CONTIKI_PROJECT += test-grove-light-sensor test-grove-loudness-sensor
CONTIKI_PROJECT += test-weather-meter test-grove-gyro test-lcd test-iaq
CONTIKI_PROJECT += test-pm10-sensor test-vac-sensor test-aac-sensor
CONTIKI_PROJECT += test-zonik

CONTIKI_TARGET_SOURCEFILES += tsl2563.c sht25.c bmpx8x.c motion-sensor.c    <i class="conum" data-value="3"></i><b>(3)</b>
CONTIKI_TARGET_SOURCEFILES += adc-sensors.c weather-meter.c grove-gyro.c
CONTIKI_TARGET_SOURCEFILES += rgb-bl-lcd.c pm10-sensor.c iaq.c zonik.c

all: $(CONTIKI_PROJECT)

CONTIKI = ../../..
include $(CONTIKI)/Makefile.include</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The location of the <code>project-conf.h</code> file for specific application configuration.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The test examples to compile automatically if no application is defined.  If you run <code>make</code> it will compile all of them at once!</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The name of the libraries to include.  As default it will search the <code>platform/dev</code> folder</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <code>sht25.c</code> is the library of the SHT25 sensor.</p>
</div>
<div class="paragraph">
<p>The SHT25 sensor example is available in both <code>examples/zolertia/zoul/test-sht25.c</code> and <code>examples/zolertia/z1/test-sht25.c</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">/*---------------------------------------------------------------------------*/
#include "dev/sht25.h"
/*---------------------------------------------------------------------------*/
PROCESS(remote_sht25_process, "SHT25 test");
AUTOSTART_PROCESSES(&amp;remote_sht25_process);
/*---------------------------------------------------------------------------*/
static struct etimer et;
/*---------------------------------------------------------------------------*/
PROCESS_THREAD(remote_sht25_process, ev, data)
{
  int16_t temperature, humidity;

  PROCESS_BEGIN();
  SENSORS_ACTIVATE(sht25);                                                  <i class="conum" data-value="1"></i><b>(1)</b>

  /* Check if the sensor voltage operation is over 2.25V */
  if(sht25.value(SHT25_VOLTAGE_ALARM)) {                                    <i class="conum" data-value="2"></i><b>(2)</b>
    printf("Voltage is lower than recommended for the sensor operation\n");
    PROCESS_EXIT();
  }

  /* Configure the sensor for maximum resolution (14-bit temperature, 12-bit
   * relative humidity), this will require up to 85ms for the temperature
   * integration, and 29ms for the relative humidity (this is the default
   * setting at power on).  To achieve a faster integration time at the cost
   * of a lower resolution, change the value below accordingly, see sht25.h.
   */
  sht25.configure(SHT25_RESOLUTION, SHT2X_RES_14T_12RH);                    <i class="conum" data-value="3"></i><b>(3)</b>

  /* Let it spin and read sensor data */

  while(1) {
    etimer_set(&amp;et, CLOCK_SECOND);
    PROCESS_WAIT_EVENT_UNTIL(etimer_expired(&amp;et));
    temperature = sht25.value(SHT25_VAL_TEMP);                              <i class="conum" data-value="4"></i><b>(4)</b>
    printf("Temperature %02d.%02d 췈C, ", temperature / 100, temperature % 100);
    humidity = sht25.value(SHT25_VAL_HUM);                                  <i class="conum" data-value="5"></i><b>(5)</b>
    printf("Humidity %02d.%02d RH\n", humidity / 100, humidity % 100);
  }
  PROCESS_END();
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Enable the sensor</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Check if the sensor powering voltage is below 2.25V.  The sensor requires at least 2.25V to work properly, else it might yield unreliable measures</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Configure the sensor resolution</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Retrieve a temperature reading</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Retrieve a humidity reading</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>An output example is given below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">Starting 'SHT25 test'
Temperature 23.71 췈C
Humidity 42.95 % RH
Temperature 23.71 췈C
Humidity 42.95 % RH
Temperature 23.71 췈C
Humidity 42.95 % RH
Temperature 23.71 췈C
Humidity 42.98  %RH</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Exercise: convert the temperature to Fahrenheit. Try to get the temperature and humidity as high as possible (without damaging the mote!). Try to print only 랋ossible values (if you disconnect the sensor, you should not print anything, or print an error message!).</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The next section will continue with the walkthrough on how to work with the on-board sensors, shown in the analogue and digital sensors section.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Normally when working with sensors it is often recommeded to operate as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">SENSOR_ACTIVATE(...)
/* configure, retrieve readings, etc */
SENSOR_DEACTIVATE();</code></pre>
</div>
</div>
<div class="paragraph">
<p>This ensures the sensor is configured as expected.  It is quite common to have more than one digital sensor sharing the same communication bus (I2C/SPI), or having a driver configuring the ADC ports with a general configuration thus overriding the expected one.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="trueon-board-sensors-and-adc"><a class="anchor" href="#trueon-board-sensors-and-adc"></a>On-board sensors and ADC</h5>
<div class="paragraph">
<p>The <code>05-onboard-sensors.c</code> example shows a mixture of the on-board sensors of each platforms shown in the section before.  This example is compatible with both the <code>Z1</code> and the <code>RE-Mote</code> platform, so it can be compiler for both.</p>
</div>
<div class="paragraph">
<p>The following snippet shows how is this done:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">#if CONTIKI_TARGET_ZOUL
    batt = vdd3_sensor.value(CC2538_SENSORS_VALUE_TYPE_CONVERTED);
    printf("VDD = %u mV\n", (uint16_t)batt);

    temp = cc2538_temp_sensor.value(CC2538_SENSORS_VALUE_TYPE_CONVERTED);
    printf("Core temperature = %d.%u C\n", temp / 1000, temp % 1000);

#else /* Assumes Z1 mote */
    x_axis = adxl345.value(X_AXIS);
    y_axis = adxl345.value(Y_AXIS);
    z_axis = adxl345.value(Z_AXIS);
    temp   = tmp102.value(TMP102_READ);
    batt   = battery_sensor.value(1);

    /* Print the readings */
    printf("Acceleration: X %d Y %d Z %d\n", x_axis, y_axis, z_axis);
    printf("Temperature: %d.%u C\n", temp / 100, temp % 100);

    /* Convert the ADC readings to mV */
    batt *= 5000;
    batt /= 4095;
    printf("Battery: %u\n\n", (uint16_t)batt);
#endif</code></pre>
</div>
</div>
<div class="paragraph">
<p>The key is the <code>CONTIKI_TARGET_ZOUL</code> preprocesor value.</p>
</div>
<div class="paragraph">
<p>Whenever we compile using <code>TARGET=zoul</code> the <code>CONTIKI_TARGET_ZOUL</code> is defined, thus allowing us to differentiate at compilation time which block of code will be included in our application.</p>
</div>
<div class="paragraph">
<p>For the <code>Z1</code> mote the output is similar to:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">Acceleration: X -13 Y -73 Z -38
Temperature: 28.50 C
Battery: 3018

Acceleration: X -14 Y -75 Z -39
Temperature: 28.43 C
Battery: 3020</code></pre>
</div>
</div>
<div class="paragraph">
<p>And for the <code>RE-Mote</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">VDD = 3300 mV
Core temperature = 33.571 C
VDD = 3297 mV
Core temperature = 33.809 C</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>06-adc.c</code> example also summarizes the analogue sensors into a single test application compatible for both platforms: The <code>Z1</code> and the <code>RE-Mote</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">#if CONTIKI_TARGET_ZOUL
    printf("ADC1 = %u mV\n", adc_zoul.value(ZOUL_SENSORS_ADC1));
    printf("ADC3 = %u mV\n", adc_zoul.value(ZOUL_SENSORS_ADC3));
#else
    printf("Phidget 5V 1:%d\n", phidgets.value(PHIDGET5V_1));
    printf("Phidget 5V 2:%d\n", phidgets.value(PHIDGET5V_2));
    printf("Phidget 3V 1:%d\n", phidgets.value(PHIDGET3V_1));
    printf("Phidget 3V 2:%d\n\n", phidgets.value(PHIDGET3V_2));
#endif</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="truegeneral-input-output-pins-gpio"><a class="anchor" href="#truegeneral-input-output-pins-gpio"></a>General input/output pins (GPIO)</h4>
<div class="paragraph">
<p>The General input/output pins are generic pins used either as input or output (0-3.3V), useful in case you need to actuate on something, or read the digital voltage level as high/low (3.3V or 0V).</p>
</div>
<div class="paragraph">
<p>Some examples are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Turn a lamp on and off by controlling a <a href="https://en.wikipedia.org/wiki/Relay">relay</a></p>
</li>
<li>
<p>Check if a window is open or close using a <a href="https://en.wikipedia.org/wiki/Reed_switch">reed switch</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The way the <code>LEDs</code> works is setting a given pin as output, and setting its value high or low (depending on the actual pin logic and pull-up or pull-down resistors it might have).</p>
</div>
<div class="paragraph">
<p>The <code>user button</code> is actually a GPIO configured as input, and then detecting whenever the value transitions from one level to another (high to low or viceversa), thus generating an interrupt event.</p>
</div>
<div class="paragraph">
<p>The <code>Z1</code> and the <code>RE-Mote</code> have a very different way to configure and work with GPIO, as currently Contiki lacks an unified GPIO API.  The <code>07-gpio.c</code> example covers both cases.</p>
</div>
<div class="paragraph">
<p>The <code>RE-Mote</code> and the <code>CC2538</code> library implements macros to directly configure and set the pins/ports registers.  The <code>CC2538</code> has four ports (namely A, B, C, D) each one with a numeric value from zero to three:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">/** \name Numeric representation of the four GPIO ports
 * @{
 */
#define GPIO_A_NUM              0 /**&lt; GPIO_A: 0 */
#define GPIO_B_NUM              1 /**&lt; GPIO_B: 1 */
#define GPIO_C_NUM              2 /**&lt; GPIO_C: 2 */
#define GPIO_D_NUM              3 /**&lt; GPIO_D: 3 */
/** @} */</code></pre>
</div>
</div>
<div class="paragraph">
<p>Subsequently each port has up to eight pins, numbered from zero to seven.  The pins then are normally referred to <code>PA0</code> and alike, indicating is the pin zero at the port A.  The image below shows the pin-out of the <code>RE-Mote</code>:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/3/image015.png" alt="image015.png">
</div>
<div class="title">Figure 47. RE-Mote pin-out</div>
</div>
<div class="paragraph">
<p>It is possible to configure and use one or more pins at the same time, this is done using masks.  As we have 8 pins per port, we treat the pin relative position in a mask fashion.  For example if we want to enable pins 2 and 4 of the port A at the same time:</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 1. Pin mask example</caption>
<colgroup>
<col style="width: 12%;">
<col style="width: 12%;">
<col style="width: 12%;">
<col style="width: 12%;">
<col style="width: 12%;">
<col style="width: 12%;">
<col style="width: 12%;">
<col style="width: 12%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">bit 7</th>
<th class="tableblock halign-left valign-top">bit 6</th>
<th class="tableblock halign-left valign-top">bit 5</th>
<th class="tableblock halign-left valign-top">bit 4</th>
<th class="tableblock halign-left valign-top">bit 3</th>
<th class="tableblock halign-left valign-top">bit 2</th>
<th class="tableblock halign-left valign-top">bit 1</th>
<th class="tableblock halign-left valign-top">bit 0</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>So the value we would need to use is 0x14 in hexadecimal or 20 in decimal base.</p>
</div>
<div class="paragraph">
<p>The conversion of a single pin number to the required pin mask can be done using the following macro:</p>
</div>
<div class="paragraph">
<p><code>GPIO_PIN_MASK(pin number)</code></p>
</div>
<div class="paragraph">
<p>Also the actual port register address can be obtained from the port number by using the following macro:</p>
</div>
<div class="paragraph">
<p><code>GPIO_PORT_TO_BASE(port number)</code></p>
</div>
<div class="paragraph">
<p>In the <code>07-gpio.c</code> example this is how a pin is configured as an output pin (<code>PA5</code>).</p>
</div>
<div class="paragraph">
<p>The <code>GPIO_SOFTWARE_CONTROL(&#8230;&#8203;)</code> macro configures the pin to be controlled by the user, instead of being driven by the hardware as other function (I2C, SPI, etc).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">  /* The masks below converts the Port number and Pin number to base and mask values */
  #define EXAMPLE_PORT_BASE  GPIO_PORT_TO_BASE(GPIO_A_NUM)
  #define EXAMPLE_PIN_MASK   GPIO_PIN_MASK(5)

  /* We tell the system the application will drive the pin */
  GPIO_SOFTWARE_CONTROL(EXAMPLE_PORT_BASE, EXAMPLE_PIN_MASK);

  /* And set as output, starting as high */
  GPIO_SET_OUTPUT(EXAMPLE_PORT_BASE, EXAMPLE_PIN_MASK);
  GPIO_SET_PIN(EXAMPLE_PORT_BASE, EXAMPLE_PIN_MASK);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then in a loop we read the pin status (if it is high or low), and toggle its state.  Notice the <code>GPIO_READ_PIN(&#8230;&#8203;)</code>  macro also uses a pin mask as argument, meaning you can read in a single instruction the status of all the pins of the port.  The return of this macro will give a mask of pins, in which all pins set as high will have a value of one, and zero otherwise.</p>
</div>
<div class="paragraph">
<p>In this example if pin <code>PA5</code> is active, the <code>GPIO_READ_PIN(&#8230;&#8203;)</code> will return a value of 0x20 in hexadecimal, or 20 in decimal base, as this is the pin 5 mask value (1 &lt;&lt; 5).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">while(1) {
    PROCESS_WAIT_EVENT_UNTIL(etimer_expired(&amp;et));

    if(GPIO_READ_PIN(EXAMPLE_PORT_BASE, EXAMPLE_PIN_MASK)) {
      GPIO_CLR_PIN(EXAMPLE_PORT_BASE, EXAMPLE_PIN_MASK);
    } else {
      GPIO_SET_PIN(EXAMPLE_PORT_BASE, EXAMPLE_PIN_MASK);
    }

    leds_toggle(LEDS_GREEN);
    etimer_reset(&amp;et);
  }</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>Z1</code> mote on the other hand uses directly the register values to configure and actuate on the pins:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">  #define EXAMPLE_PIN_MASK  (1&lt;&lt;2)

  /* The MSP430 MCU names the pins as a tupple of PORT + PIN, thus P6.1 refers
   * to the Pin number 1 of the Port 6.
   * We need first to select the operation mode of the Pin, as a Pin can have
   * a special function (UART, ADC, I2C) also.  The GPIO operation is selected
   * by writting the pin's bit as zero to the PxSEL register.  The below snippet
   * changes 00010000 to 11101111, so when writting to the register we only
   * clear our pin, leaving the others untouched (as it is an AND operation)
   */
  P4SEL &amp;= ~EXAMPLE_PIN_MASK;

  /* Next we set the direction of the pin.  Output means the pin can be high
   * (3.3V) or low (0V), while being as Input will allow us to read the digital
   * value the pin has.  To enable the pin as Output, write an 1.
   */
  P4DIR |= EXAMPLE_PIN_MASK;</code></pre>
</div>
</div>
<div class="paragraph">
<p>We need to configure first the pin function (we select the pin as GPIO by setting the pin mas value on the <code>PxSEL</code> register to zero).  The <code>PxDIR</code> configures the direction of the pin, if writting a zero to the pin mask value it will be configured as input, otherwise if set to one it will be configured as output.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">    /* This toggles the pin, if low then sets the pin high, and viceversa.
     * Alternatively to set the pin high, use P4OUT |= EXAMPLE_PIN_MASK, and to
     * drive low use P4OUT &amp;= ~EXAMPLE_PIN_MASK
     */
    P4OUT ^= EXAMPLE_PIN_MASK;</code></pre>
</div>
</div>
<div class="paragraph">
<p>And then to set the pin high or low we use the <code>PxOUT</code> register (it assumes the pin is configured as output, its value is ignored otherwise).  Writting a one to the pin mask value on the register will set the pin as high, and low otherwise is writting a zero.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="truewireless-with-contiki"><a class="anchor" href="#truewireless-with-contiki"></a>Wireless with Contiki</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In the previous section we covered some of the core features of Contiki, basics of sensors and a general overview of how the applications are built, programmed and simulated in Contiki. This section introduces the wireless communication, details about radios, and in general how to configure our platforms.</p>
</div>
<div class="sect2">
<h3 id="trueaddressing-and-radio-frequency-basics"><a class="anchor" href="#trueaddressing-and-radio-frequency-basics"></a>Addressing and Radio Frequency basics</h3>
<div class="paragraph">
<p>The very first step is understanding how our platform is configured.</p>
</div>
<div class="paragraph">
<p>Each platform implements its own set of default values and configurations, to be used by underlying modules like the radio, the serial port, etc.</p>
</div>
<div class="paragraph">
<p>The places to visit for the Zolertia platform are the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Specific hardware settings: parameters such as the default I2C pins, ADC channels, module-specific pin assignment and platform information can be found at <code>platform/zoul/remote/dev/board.h</code> and <code>platform/z1/platform-conf.h</code>.</p>
</li>
<li>
<p>Specific Contiki settings: UART settings, MAC driver, radio channel, IPv6, RIME and network buffer configuration, among others, can be found at <code>platform/zoul/contiki-conf.h</code> and <code>platform/z1/contiki-conf.h</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>As a general good practice, user configurable parameters are normally allowed to be overridden by the applications, this also serves as a guideline to discern which values can be changed by the casual user, from those meant to be changed only if you really know what you are doing.  Below is an example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">#ifndef UART0_CONF_BAUD_RATE
#define UART0_CONF_BAUD_RATE 115200
#endif</code></pre>
</div>
</div>
<div class="paragraph">
<p>By defining <code>UART0_CONF_BAUD_RATE</code> in our application&#8217;s <code>project-conf.h</code>, we can change the default 115200 baud rate.  Notice that generally it is a  good practice to add <code>CONF</code> to the user configurable parameters.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>One of the most used tools is probably <code>grep</code>, a handy command to search for a text string in any document or location.  One way to run this command is <code>grep -lr "alinan" .</code>, if executed at the root of our Contiki installation, it will list recursively all the files authored by Antonio Linan.  This is a good way to check the location of a specific definition, if you are not using an IDE like Eclipse.
Check <code>man grep</code> for more information.</p>
</div>
<div class="paragraph">
<p>For windows <a href="http://astrogrep.sourceforge.net/">Astrogrep</a> is a good option.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In the next section we will review the most notable parameters to configure, but as usual depending on your application and setup, the best way to ensure everything is properly set is by reviewing the specific platform configuration files, and modify or redefine accordingly.</p>
</div>
<div class="sect3">
<h4 id="truedevice-addressing"><a class="anchor" href="#truedevice-addressing"></a>Device addressing</h4>
<div class="paragraph">
<p>To start working you must first define the Node ID of each node, this will be used to generate the mote&#8217;s MAC address and the IPv6 addresses (link-local and global).</p>
</div>
<div class="sect4">
<h5 id="truere-mote-addresses"><a class="anchor" href="#truere-mote-addresses"></a>RE-Mote addresses</h5>
<div class="paragraph">
<p>The <code>RE-Mote</code> platform comes with two pre-saved MAC addresses stored in its internal flash memory, but the user can instead choose a hardcoded one. The following switches at <code>platform/zoul/contiki-conf.h</code> selects the chosen one.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">/**
  * \name IEEE address configuration
  *
  * Used to generate our RIME &amp; IPv6 address
  * @{
  */
/**
  * \brief Location of the IEEE address
  * 0 =&gt; Read from InfoPage,
  * 1 =&gt; Use a hardcoded address, configured by IEEE_ADDR_CONF_ADDRESS
  */
#ifndef IEEE_ADDR_CONF_HARDCODED
#define IEEE_ADDR_CONF_HARDCODED             0
#endif

/**
 * \brief Location of the IEEE address in the InfoPage when
 * IEEE_ADDR_CONF_HARDCODED is defined as 0
 * 0 =&gt; Use the primary address location
 * 1 =&gt; Use the secondary address location
 */
#ifndef IEEE_ADDR_CONF_USE_SECONDARY_LOCATION
#define IEEE_ADDR_CONF_USE_SECONDARY_LOCATION 0
#endif</code></pre>
</div>
</div>
<div class="paragraph">
<p>If using your own hardcoded address, the following define can be overridden by the application:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">#ifndef IEEE_ADDR_CONF_ADDRESS
#define IEEE_ADDR_CONF_ADDRESS { 0x00, 0x12, 0x4B, 0x00, 0x89, 0xAB, 0xCD, 0xEF }
#endif</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="truez1-mote-addresses"><a class="anchor" href="#truez1-mote-addresses"></a>Z1 mote addresses</h5>
<div class="paragraph">
<p>Let&#8217;s use the ID from the mote list:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">Reference  Device       Description
--------------------------------------------------
Z1RC3301   /dev/ttyUSB0 Silicon Labs Zolertia Z1</code></pre>
</div>
</div>
<div class="paragraph">
<p>The node ID should be <code>3301</code> (decimal) if no previously saved node ID is found in the flash memory.</p>
</div>
<div class="paragraph">
<p>Let뗩 see how Contiki uses this to derive a full IPv6 and MAC address.  At <code>platforms/z1/contiki-z1-main.c</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">#ifdef SERIALNUM
  if(!node_id) {
    PRINTF("Node id is not set, using Z1 product ID\n");
    node_id = SERIALNUM;
  }
#endif
node_mac[0] = 0xc1; /* Hardcoded for Z1 */
node_mac[1] = 0x0c; /* Hardcoded for Revision C */
node_mac[2] = 0x00; /* Hardcoded to arbitrary even number so that the 802.15.4 MAC address is compatible with an Ethernet MAC address - byte 0 (byte 2 in the DS ID) */
node_mac[3] = 0x00; /* Hardcoded */
node_mac[4] = 0x00; /* Hardcoded */
node_mac[5] = 0x00; /* Hardcoded */
node_mac[6] = node_id &gt;&gt; 8;
node_mac[7] = node_id &amp; 0xff;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>So the mote should have the following addresses:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">MAC c1:0c:00:00:00:00:0c:e5
Node id is set to 3301.
Tentative link-local IPv6 address fe80:0000:0000:0000:c30c:0000:0000:0ce5</code></pre>
</div>
</div>
<div class="paragraph">
<p>Where <code>0xce5</code> is the hex value corresponding to <code>3301</code>.  The global address is only set when an IPv6 prefix is assigned (by now you should know this from earlier sections).</p>
</div>
<div class="paragraph">
<p>If instead you wish to have your own addressing scheme, you can edit the node_mac values at <code>contiki-z1-main.c</code> file.  If you wish to replace the node id value obtained from the product id, you need to store a new one in the flash memory, luckily there is already an application to do so:</p>
</div>
<div class="paragraph">
<p>Go to <code>examples/zolertia/z1</code> location and replace the <code>158</code> for your own required value:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>make clean &amp;&amp; make burn-nodeid.upload nodeid=158 nodemac=158 &amp;&amp; make z1-reset &amp;&amp; make login</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should see the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">MAC c1:0c:00:00:00:00:0c:e5 Ref ID: 3301
Contiki-2.6-1803-g03f57ae started. Node id is set to 3301.
CSMA ContikiMAC, channel check rate 8 Hz, radio channel 26
Tentative link-local IPv6 address fe80:0000:0000:0000:c30c:0000:0000:0ce5
Starting 'Burn node id'
Burning node id 158
Restored node id 158</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see, now the node ID has been changed to 158, when you restart the mote you should see that the changes have been applied:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">MAC c1:0c:00:00:00:00:00:9e Ref ID: 3301
Contiki-2.6-1803-g03f57ae started. Node id is set to 158.
CSMA ContikiMAC, channel check rate 8 Hz, radio channel 26
Tentative link-local IPv6 address fe80:0000:0000:0000:c30c:0000:0000:009e</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="trueset-the-bandwidth-and-channel"><a class="anchor" href="#trueset-the-bandwidth-and-channel"></a>Set the bandwidth and channel</h4>
<div class="paragraph">
<p>The bandwidth and allowed channels depend on the operating frequency band.  They will be determined by the spectrum regulation agency of the country, along with maximum transmitted power allowable.
.<strong>The IEEE 802.15.4 standard</strong></p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p>The IEEE 802.15.4 is a standard for wireless communication, it specifies the physical and media access control layers for low-rate wireless personal area networks (LR-WPANs).</p>
</div>
<div class="paragraph">
<p>The standard specifies the use of the 868-868.8 MHz (in Europe and many other countries), the 902-928 MHz (in United States, Canada, and some Latin America countries), or the world-wide 2.400-2.4835 GHz band part of the Industrial Scientific and Medical applications (ISM).</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/4/image013.gif" alt="image013.gif">
</div>
<div class="title">Figure 48. IEEE 802.15.4 2.4 GHz regulation requirements (<a href="http://electronicdesign.com/what-s-difference-between/what-s-difference-between-ieee-802154-and-zigbee-wireless">electronicdesign.com, 2013</a>)</div>
</div>
<div class="paragraph">
<p>In practice the 2.4 GHz band is being heavily used due to its world-wide availability. The ZigBee proprietary protocol by the ZigBee alliance was one of the early adopters of IEEE 802.15.4. It did so leveraging the physical and MAC layer of IEEE 802.15.4, specifying on top additional routing and networking functionality to build mesh networks.</p>
</div>
<div class="paragraph">
<p>Quite recently the <a href="http://threadgroup.org/">Thread Group</a>
has proposed its own simplified IPv6-based mesh networking protocol for connecting products around the home to each other, to the Internet and to the cloud.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/4/image014.gif" alt="image014.gif">
</div>
<div class="title">Figure 49. Thread layers and standards (<a href="http://threadgroup.org/">Thread group, 2015</a>)</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="trueworking-at-2-4-ghz"><a class="anchor" href="#trueworking-at-2-4-ghz"></a>Working at 2.4 GHz</h5>
<div class="paragraph">
<p>As the 2.4 GHz band is also used by other technologies like WiFi and Bluetooth, this spectrum is shared and overlaps might occur. The Figure below shows the channel allocation of the 2.4 GHz IEEE 802.15.4, and the recommended channels to avoid interferences with other co-located devices.  With the rise of the Bluetooth Low Energy, and the ubiquitous WiFi present in our lives, the selection of a proper operating channel is crucial in any deployment.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/4/image001.png" alt="image001.png">
</div>
<div class="title">Figure 50. Channel assignment</div>
</div>
<div class="paragraph">
<p>The default channel of the <strong>RE-Mote</strong> is defined as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">#ifndef CC2538_RF_CONF_CHANNEL
#define CC2538_RF_CONF_CHANNEL              26
#endif /* CC2538_RF_CONF_CHANNEL */</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <strong>Z1 mote</strong> defines its default channel as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">#ifdef RF_CHANNEL
#define CC2420_CONF_CHANNEL RF_CHANNEL
#endif

#ifndef CC2420_CONF_CHANNEL
#define CC2420_CONF_CHANNEL                 26
#endif /* CC2420_CONF_CHANNEL */</code></pre>
</div>
</div>
<div class="paragraph">
<p>The radio channel can be defined from the application&#8217;s <code>project-conf.h</code> or the <code>Makefile</code>.</p>
</div>
<div class="paragraph">
<p>The radio drivers in Contiki are implemented to comply with the <code>struct radio_driver</code> in <code>core/dev/radio.h</code>. This abstraction allows to interact with the radio using a standardized API, independently of the radio hardware. The functions to set and read radio parameters are explained below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">/** Get a radio parameter value. */
radio_result_t (* get_value)(radio_param_t param, radio_value_t *value);

/** Set a radio parameter value. */
radio_result_t (* set_value)(radio_param_t param, radio_value_t value);</code></pre>
</div>
</div>
<div class="paragraph">
<p>To change the channel from the application use <code>RADIO_PARAM_CHANNEL</code> as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">rd = NETSTACK_RADIO.set_value(RADIO_PARAM_CHANNEL, value);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Where <code>value</code> can be any value from 11 to 26, and rd will be either <code>RADIO_RESULT_INVALID_VALUE</code> or <code>RADIO_RESULT_OK</code>.</p>
</div>
</div>
<div class="sect4">
<h5 id="trueworking-at-863-950-mhz"><a class="anchor" href="#trueworking-at-863-950-mhz"></a>Working at 863-950 MHz</h5>
<div class="paragraph">
<p>The <strong>RE-Mote</strong> has a dual 2.4 GHz and 863-950 MHz RF interface, which can be selected alternatively, or used simultaneously (the latter currently not supported in Contiki at the moment).</p>
</div>
<div class="paragraph">
<p>As default the RE-Mote uses the IEEE 802.15.4g mandatory mode for the 868 MHz band, configured for 2-GFSK modulation, 50 kbps data rate and with 33 channels available.</p>
</div>
<div class="paragraph">
<p>The RE-Mote uses the Texas Instruments CC1200 RF transceiver, referred to in Contiki as <code>dev/cc1200</code>.  The default configuration file is located in <code>dev/cc1200/cc1200-802154g-863-870-fsk-50kbps.c</code>.</p>
</div>
<div class="paragraph">
<p>To change channels from the application we use the RF API:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">rd = NETSTACK_RADIO.set_value(RADIO_PARAM_CHANNEL, value);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Where <code>value</code> can be any value from 11 to 26, and rd it will be either <code>RADIO_RESULT_INVALID_VALUE</code> or <code>RADIO_RESULT_OK</code>.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="trueset-the-transmission-power"><a class="anchor" href="#trueset-the-transmission-power"></a>Set the transmission power</h4>
<div class="paragraph">
<p>The radio frequency power transmission is that at the output of the transmitter before reaching the antenna.  The higher the transmission power the higher the wireless range, but the power consumption usually increases as well. The range is heavily dependent on the frequency, the antenna used and its height above the ground.</p>
</div>
<div class="sect4">
<h5 id="truechanging-the-transmission-power-for-the-z1-cc2420-and-the-re-mote-cc2538"><a class="anchor" href="#truechanging-the-transmission-power-for-the-z1-cc2420-and-the-re-mote-cc2538"></a>Changing the transmission power for the Z1 (CC2420) and the RE-Mote (CC2538)</h5>
<div class="paragraph">
<p>The <strong>RE-Mote</strong> platform uses the CC2538 built-in 2.4 GHz radio.  As default the transmission power is set to 3 dBm (2 mW) in the <code>cpu/cc2538/cc2538-rf.h</code> header as shown below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">CC2538_RF_TX_POWER_RECOMMENDED 0xD5</code></pre>
</div>
</div>
<div class="paragraph">
<p>This recommended value is taken from the <a href="http://www.ti.com/tool/smartrftm-studio&amp;DCMP=hpa_rf_general&amp;HQS=Other+OT+smartrfstudio">SmartRF Studio</a>.</p>
</div>
<div class="paragraph">
<p>Other values and its corresponding output power levels are shown in the next table.</p>
</div>
<table class="tableblock frame-all grid-all" style="width: 60%;">
<caption class="title">Table 2. CC2538 Transmission power recommended values (<a href="http://www.ti.com/tool/smartrftm-studio&amp;DCMP=hpa_rf_general&amp;HQS=Other+OT+smartrfstudio">from SmartRF Studio</a>)</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">TX Power (dBm)</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tfoot>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">-24</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x00</p></td>
</tr>
</tfoot>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">+7</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0xFF</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">+5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0xED</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">+3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0xD5</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">+1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0xC5</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0xB6</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">-1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0xB0</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">-3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0xA1</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">-5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x91</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">-7</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x88</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">-9</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x72</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">-11</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x62</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">-13</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x58</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">-15</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x42</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>As illogical as it may sound, there might be some reasons to reduce transmission power:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>To reduce the power consumption.</p>
</li>
<li>
<p>To test a multi-hop network without placing the nodes too far (too much power can saturate the receiver).</p>
</li>
<li>
<p>To avoid interference among co-located networks in the same area.</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The current consumption can go from 24 mA to 34 mA when changing the transmission power from 0 dBm to 7 dBm (<a href="http://www.ti.com/lit/an/swra437/swra437.pdf">AN125</a>).</p>
</div>
<div class="paragraph">
<p>The <strong>Z1 mote</strong> uses the Texas Instrument CC2420 RF transceiver.  As default the transmission power is set to 0 dBm (1 mW), which is the maximum allowed by the radio.</p>
</div>
<div class="paragraph">
<p>The available output power and its corresponding configuration values are listed in the table below, as well as the current consumption at each level.</p>
</div>
<table class="tableblock frame-all grid-all" style="width: 60%;">
<caption class="title">Table 3. CC2420 Transmission power  (<a href="http://www.ti.com/lit/ds/symlink/cc2420.pdf">CC2420 datasheet, page 51</a>)</caption>
<colgroup>
<col style="width: 33%;">
<col style="width: 33%;">
<col style="width: 33%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">TX Power (dBm)</th>
<th class="tableblock halign-left valign-top">Value</th>
<th class="tableblock halign-left valign-top">mA</th>
</tr>
</thead>
<tfoot>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">-25</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">8.5</p></td>
</tr>
</tfoot>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">31</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">17.4</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">-1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">27</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">16.5</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">-3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">23</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">15.2</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">-5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">19</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">13.9</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">-7</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">15</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">12.5</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">-10</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">11</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">11.2</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">-15</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">7</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">9.9</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>For both platforms the transmission power can be changed with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">rd = NETSTACK_RADIO.set_value(RADIO_PARAM_TXPOWER, value);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Where <code>value</code> can be any value from the above table, and rd it will be either <code>RADIO_RESULT_INVALID_VALUE</code> or <code>RADIO_RESULT_OK</code>.</p>
</div>
</div>
<div class="sect4">
<h5 id="truechanging-the-transmission-power-for-the-re-mote-cc1200"><a class="anchor" href="#truechanging-the-transmission-power-for-the-re-mote-cc1200"></a>Changing the transmission power for the RE-Mote (CC1200)</h5>
<div class="paragraph">
<p>As mentioned earlier, the <strong>RE-Mote</strong> has an on-board sub-1 GHz interface based on the CC1120 radio transceiver, configured to operate in the 863-950 MHz bands. The maximum transmission power allowed depends on the specific band and regulations in place, which can also impose limits on the maximum antenna gain, be sure to check the local regulations before changing the output power.</p>
</div>
<div class="paragraph">
<p>The regulations are country specific and out of the scope of this section.</p>
</div>
<div class="paragraph">
<p>The following values are taken from the <a href="http://www.ti.com/tool/smartrftm-studio&amp;DCMP=hpa_rf_general&amp;HQS=Other+OT+smartrfstudio">SmartRF Studio</a>, using default IEEE 802.15.4g ETSI compliant configuration.</p>
</div>
<table class="tableblock frame-all grid-all" style="width: 60%;">
<caption class="title">Table 4. CC1200 Transmission power recommended values (<a href="http://www.ti.com/tool/smartrftm-studio&amp;DCMP=hpa_rf_general&amp;HQS=Other+OT+smartrfstudio">from SmartRF Studio</a>)</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">TX Power (dBm)</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tfoot>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">-40</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x41</p></td>
</tr>
</tfoot>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">+14</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x7F</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">+13</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x7C</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">+12</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x7A</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">+11</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x78</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">+8</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x71</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">+6</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x6C</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">+4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x68</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">+3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x66</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">+2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x63</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">+1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x61</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x5F</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">-3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x58</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">-6</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x51</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">-11</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x46</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">-24</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x42</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>These values correspond to the <code>CC1200_PA_CFG1</code> register.</p>
</div>
<div class="paragraph">
<p>As default the <a href="https://github.com/contiki-os/contiki/blob/master/dev/cc1200/cc1200.c">CC1200 driver</a> in Contiki starts with the maximum transmission power, defined as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">/* The maximum output power in dBm */
#define RF_CFG_MAX_TXPOWER              CC1200_CONST_TX_POWER_MAX</code></pre>
</div>
</div>
<div class="paragraph">
<p>The minimum and maximum allowed values are set in <code>dev/cc1200/cc1200-const.h</code> as shown below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>/* Output power in dBm */
/* Up to now we don't handle the special power levels PA_POWER_RAMP &lt; 3, hence
 * the minimum tx power is -16. See update_txpower().
 */
#define CC1200_CONST_TX_POWER_MIN       (-16)
/*
 * Maximum output power will probably depend on the band we use due to
 * regulation issues
 */
#define CC1200_CONST_TX_POWER_MAX       14</code></pre>
</div>
</div>
<div class="paragraph">
<p>The CC1200 driver calculates the proper <code>CC1200_PA_CFG1</code> register value, so we need to pass as <code>value</code> argument the required transmission power.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">rd = NETSTACK_RADIO.set_value(RADIO_PARAM_TXPOWER, value);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Where <code>value</code> can be any value from -14 to 16, and rd will be either <code>RADIO_RESULT_INVALID_VALUE</code> or <code>RADIO_RESULT_OK</code>.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="truechecking-the-wireless-link"><a class="anchor" href="#truechecking-the-wireless-link"></a>Checking the wireless link</h4>
<div class="paragraph">
<p>Due to the changing environment conditions that normally affect the wireless systems, such as rain, interferences, obstacles, reflections, etc., measuring the wireless medium and links quality is important.</p>
</div>
<div class="paragraph">
<p>Checking the wireless medium should be done in three stages: before deploying your network, at deployment phase and later at network runtime, to ensure that the nodes create and select the best available routes.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Link Quality Estimation</div>
<div class="paragraph">
<p>Link Quality Estimation is an integral part of assuring reliability in wireless networks. Various link estimation metrics have been proposed to effectively measure the quality of wireless links.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/4/image002.png" alt="image002.png">
</div>
<div class="title">Figure 51. Link quality estimation process</div>
</div>
<div class="paragraph">
<p>The ETX metric, or expected transmission count, is a measure of the quality of a path between two nodes in a wireless packet data network. ETX is the number of expected transmissions of a packet necessary for it to be received without error at its destination. This number varies from one to infinity. An ETX of one indicates a perfect transmission medium, where an ETX of infinity represents a completely non-functional link. Note that ETX is an expected transmission count for a future event, as opposed to an actual count of a past events. It is hence a real number, generally not an integer.</p>
</div>
<div class="paragraph">
<p>ETX can be used as the routing metric. Routes with a lower metric are preferred. In a route that includes multiple hops, the metric is the sum of the ETX of the individual hops.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>Below we describe how to read the LQI and RSSI to have a first approximation of the link conditions.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">What is RSSI?</div>
<div class="paragraph">
<p>RSSI (Received Signal Strenght Indicator) is a generic radio receiver technology metric used internally in a wireless networking device to determine the amount of radio energy received in a given channel. The end-user will likely observe an RSSI value when measuring the signal strength of a wireless network through the use of a wireless network monitoring tool like Wireshark, Kismet or Inssider.</p>
</div>
<div class="paragraph">
<p>The image below shows how the Packet Reception Rate (PRR) dramatically decreases as the CC2420 RSSI values worsen.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/4/image003.png" alt="image003.png">
</div>
<div class="title">Figure 52. Packet reception rate vs RSSI</div>
</div>
<div class="paragraph">
<p>There is no standardized relationship of any particular physical parameter to the RSSI reading, Vendors and chipset makers provide their own accuracy, granularity, and range for the actual power (measured in mW or dBm) and the corresponding RSSI values.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>There are 2 different types of RSSI readings available:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The first one is an indication of the amount of power present in the wireless medium at the given frequency and at given time. In the absence of any packet in the air, this will be the noise floor. This measurement is also used to decide if the medium is free, and available to send a packet. A high value could be due to interference or to the presence of a packet in the air.</p>
</li>
<li>
<p>The second measurement is performed only after a packet has been correctly decoded, and gives the strength of the packet received from a specific node.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The first measurement can be read using the radio API as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">rd = NETSTACK_RADIO.get_value(RADIO_PARAM_RSSI, value);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Where <code>value</code> is a variable passed as a pointer to store the RSSI value, and rd it will be either <code>RADIO_RESULT_INVALID_VALUE</code> or <code>RADIO_RESULT_OK</code>.</p>
</div>
<div class="paragraph">
<p>To read the RSSI value of a correctly decoded received packet, at the <code>receive</code> callback:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">packetbuf_attr(PACKETBUF_ATTR_RSSI);</code></pre>
</div>
</div>
<div class="paragraph">
<p>More information about the <code>packetbuf</code> attributes is available in <code>core/net/packetbuf.h</code>.</p>
</div>
<div class="paragraph">
<p>For the CC2420 radio frequency transceiver on the <strong>Z1 mote</strong>, the RSSI can range from 0 to -100, values close to 0 mean good links while values close to -100 are indicators of a bad link, which could be due to multiple factors such as distance, environment, obstacles, interferences, etc.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">What is LQI?</div>
<div class="paragraph">
<p>LQI (Link Quality Indicator) is a digital value often provide by Chipset vendors as an indicator of how well a signal is demodulated, in terms of the strength and quality of the received packet, thus indicating a good or bad wireless medium.</p>
</div>
<div class="paragraph">
<p>The example below shows how the Packet Reception Rate decreases as the LQI decreases.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/4/image004.png" alt="image004.png">
</div>
<div class="title">Figure 53. Packet reception rate vs LQI</div>
</div>
</div>
</div>
<div class="paragraph">
<p>To read the LQI value we use the Radio API:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">rd = NETSTACK_RADIO.get_value(PACKETBUF_ATTR_LINK_QUALITY, value);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Where <code>value</code> is a variable passed as a pointer to store the LQI value, and rd it will be either <code>RADIO_RESULT_INVALID_VALUE</code> or <code>RADIO_RESULT_OK</code>.</p>
</div>
<div class="paragraph">
<p>The CC2420 radio used by the Z1 mote typically ranges from 110 (indicates a maximum quality frame) to 50 (typically the lowest quality frames detectable by the transceiver).</p>
</div>
<div class="paragraph">
<p>Detailed information about the CC2538 LQI calculation is found in the <a href="http://www.ti.com/lit/ug/swru319c/swru319c.pdf">CC2538 user guide</a>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="trueconfigure-the-mac-layer"><a class="anchor" href="#trueconfigure-the-mac-layer"></a>Configure the MAC layer</h3>
<div class="sidebarblock">
<div class="content">
<div class="title">MAC protocols</div>
<div class="paragraph">
<p>Medium Access Control (MAC) protocols describe the medium access adopted in a network, by establishing the rules that specify when a given node is allowed to transmit packets.</p>
</div>
<div class="paragraph">
<p>Protocols can be classified as contention-based or reservation-based protocols.</p>
</div>
<div class="paragraph">
<p>The first are based on Carrier Sensing for detecting medium activity and are prone to collisions and lower efficiency at heavy loads, but are easy to implement. The second group is efficient in terms of throughput and energy, but require precise synchronization and is less adaptable to dynamic traffic.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>The medium access implementation in Contiki has 3 different layers: Framer, Radio Duty-Cycle (RDC) and Medium Access Control (MAC).</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/4/image015.jpg" alt="image015.jpg">
</div>
<div class="title">Figure 54. <a href="http://anrg.usc.edu/contiki/index.php/MAC_protocols_in_ContikiOS">Contiki MAC stack</a></div>
</div>
<div class="paragraph">
<p>The network layer can be accessed through the global variables <code>NETSTACK_FRAMER</code>, <code>NETSTACK_RDC</code> and <code>NETSTACK_MAC</code>, which are defined at compilation time.</p>
</div>
<div class="paragraph">
<p>The variables are located in <code>core/net/netstack.h</code>, and can be defined by each platform as default and overridden by applications.</p>
</div>
<div class="sect3">
<h4 id="truemac-driver"><a class="anchor" href="#truemac-driver"></a>MAC driver</h4>
<div class="paragraph">
<p>Contiki provides two MAC drivers: CSMA and NullMAC</p>
</div>
<div class="paragraph">
<p>CSMA (Carrier-Sense Multiple Access) receives incoming packets from the RDC layer and uses the RDC layer to transmit packets. If the RDC layer or the radio layer detects that the medium is busy, the MAC layer may retransmit the packet at a later point in time. CSMA protocol keeps a list of packets sent to each of the neighbors and calculate statistics such as number of retransmissions, collisions, deferrals, etc.  The medium access check is performed by the RDC driver.</p>
</div>
<div class="paragraph">
<p>NullMAC is a simple pass-through protocol.  It calls the appropriate RDC functions.</p>
</div>
<div class="paragraph">
<p>As default both <strong>Z1 mote</strong> and <strong>RE-Mote</strong> uses the CSMA driver.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">#ifndef NETSTACK_CONF_MAC
#define NETSTACK_CONF_MAC     csma_driver
#endif</code></pre>
</div>
</div>
<div class="paragraph">
<p>Alternatively, a user can choose NullMAC as follow:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>#define NETSTACK_CONF_MAC nullmac_driver</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="truerdc-driver"><a class="anchor" href="#truerdc-driver"></a>RDC driver</h4>
<div class="paragraph">
<p>Radio Duty-Cycle (RDC) layer handles the sleep period of nodes.  This layer decides when packets will be transmitted and ensures that nodes are awake when packets are to be received.</p>
</div>
<div class="paragraph">
<p>The implementation of Contiki&#8217;s RDC protocols are available in <code>core/net/mac</code>. The following RDC drivers are implemented: <code>contikimac</code>, <code>xmac</code>, <code>lpp</code>, <code>nullrdc</code> and <code>sicslowmac</code>.  The implementation and details of the aforementioned RDC drivers are out of the scope of this chapter.  The most commonly used is ContikiMAC.  NullRDC is a pass-through layer that never switches the radio off.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">#ifndef NETSTACK_CONF_RDC
#define NETSTACK_CONF_RDC contikimac_driver
#endif</code></pre>
</div>
</div>
<div class="paragraph">
<p>RDC drivers try to keep the radio off as much as possible, periodically checking the wireless medium for radio activity. When activity is detected, the radio is kept on to check if it has to receive the packet, or it can go back to sleep.</p>
</div>
<div class="paragraph">
<p>The channel check rate is given in Hz, specifying the number of times the channel is checked per second, and the default channel check rate is 8 Hz. Channel check rates are given in powers of two and typical settings are 2, 4, 8, and 16 Hz.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">#ifndef NETSTACK_CONF_RDC_CHANNEL_CHECK_RATE
#define NETSTACK_CONF_RDC_CHANNEL_CHECK_RATE 8
#endif</code></pre>
</div>
</div>
<div class="paragraph">
<p>A packet must generally be retransmitted or "strobed" until the receiver is on and receives it.  This increments the power consumption of the transmitter and increases the radio traffic, but the power savings at the receiver compensates for this and there is a net overall power saving.</p>
</div>
<div class="paragraph">
<p>One alternative to optimize the RDC is to enable "phase optimization", which delays strobing until just before the receiver is expected to be awake.  This however requires a good time synchronization between the transmitter and the receiver (more details in <a href="https://github.com/contiki-os/contiki/wiki/RDC-Phase-optimization">RDC Phase Optimization</a>).  To enable phase optimization change the 0 below to one.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">#define CONTIKIMAC_CONF_WITH_PHASE_OPTIMIZATION 0
#define WITH_FAST_SLEEP 1</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="trueframer-driver"><a class="anchor" href="#trueframer-driver"></a>Framer driver</h4>
<div class="paragraph">
<p>The Framer driver is actually a set of functions to frame the data to be transmitted, and to parse the received data.  The Framer implementations are located in <code>core/net/mac</code>, of which the most noticeable ones are <code>framer-802154</code> and <code>framer-nullmac</code>.</p>
</div>
<div class="paragraph">
<p>In the <strong>RE-Mote</strong> platform the following configuration is the default:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">#ifndef NETSTACK_CONF_FRAMER
#if NETSTACK_CONF_WITH_IPV6
#define NETSTACK_CONF_FRAMER  framer_802154
#else /* NETSTACK_CONF_WITH_IPV6 */
#define NETSTACK_CONF_FRAMER  contikimac_framer
#endif /* NETSTACK_CONF_WITH_IPV6 */
#endif /* NETSTACK_CONF_FRAMER */</code></pre>
</div>
</div>
<div class="paragraph">
<p>Meaning that when IPv6 is used, the <code>framer-802154</code> is selected, else the <code>contikimac_framer</code> is used (default one for the <code>contikimac_driver</code>).</p>
</div>
<div class="paragraph">
<p>The <code>framer-nullmac</code> framer should be used together with <code>nullmac_driver</code> (MAC layer). This simply fills in the 2 fields of <code>nullmac_hdr</code>, which are: receiver address and sender address.</p>
</div>
<div class="paragraph">
<p>The <code>framer-802154</code> is implemented in <code>core/net/mac/framer-802154.c</code>. The driver frames the data in compliance to the IEEE 802.15.4 (2003) standard.  The framer insert and extracts the data to the <code>packetbuf</code> structure.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="trueipv6-and-routing"><a class="anchor" href="#trueipv6-and-routing"></a>IPv6 and Routing</h3>
<div class="paragraph">
<p>One of Contiki&#8217;s most prominent feature is the support of IP protocols, being one of the first embedded operating systems to provide IPv6 support.</p>
</div>
<div class="paragraph">
<p>Alternatively Contiki also supports IPv4 and non-IP communication <a href="https://github.com/alignan/contiki/tree/master/core/net/rime">(Rime)</a>, however the remainder of this book will focus in IPv6.  There is a good set of rime examples available at <code>examples/rime</code>.  The <strong>RE-Mote</strong> <code>zoul-demo.c</code> most basic example at <code>examples/zolertia/zoul</code> uses rime as well.</p>
</div>
<div class="sect3">
<h4 id="trueipv6"><a class="anchor" href="#trueipv6"></a>IPv6</h4>
<div class="paragraph">
<p>The <strong>uIP</strong> is an Open Source TCP/IP stack designed to be used even with tiny 8 and 16 bit microcontrollers. It was initially developed by <a href="http://dunkels.com/adam/">Adam Dunkels</a> while at the <a href="https://en.wikipedia.org/wiki/Swedish_Institute_of_Computer_Science">Swedish Institute of Computer Science (SICS)</a>, licensed under a BSD style license, and further developed by a wide group of developers.</p>
</div>
<div class="paragraph">
<p>The implementation details of the uIP/uIPv6 is out of the scope of this section.  The remainder of this section explains the basic configurations at the platform and application level.</p>
</div>
<div class="paragraph">
<p>To enable IPv6 the following has to be defined, either in the application&#8217;s <code>Makefile</code> or in its <code>project-conf.h</code> file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">#define UIP_CONF_IPV6  1</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">#ifndef NBR_TABLE_CONF_MAX_NEIGHBORS
#define NBR_TABLE_CONF_MAX_NEIGHBORS        20
#endif
#ifndef UIP_CONF_MAX_ROUTES
#define UIP_CONF_MAX_ROUTES                 20
#endif

/* uIP */
#ifndef UIP_CONF_BUFFER_SIZE
#define UIP_CONF_BUFFER_SIZE              1300
#endif

#define UIP_CONF_IPV6_QUEUE_PKT              0
#define UIP_CONF_IPV6_CHECKS                 1
#define UIP_CONF_IPV6_REASSEMBLY             0
#define UIP_CONF_MAX_LISTENPORTS             8</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Depending on your application and your platform you might eventually ran out of RAM memory, specially true for platforms with 8-10KB RAM.  A good way to save RAM is to reduce the <code>UIP_CONF_MAX_ROUTES</code> and <code>NBR_TABLE_CONF_MAX_NEIGHBORS</code> number in your <code>project-conf.h</code>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="truerpl"><a class="anchor" href="#truerpl"></a>RPL</h4>
<div class="paragraph">
<p>There are several routing flavors to chose, but ultimately all do the same thing: ensure that packets arrive at the right destination. This is done in different ways depending on factors such as the routing metric (how a route is qualified as better than others), whether the routing is done dynamically or statically, etc.</p>
</div>
<div class="paragraph">
<p>In Contiki the default routing protocol is RPL.  Other protocols such as Ad hoc On-Demand Distance Vector (AODV) are out of the scope of this section.</p>
</div>
<div class="paragraph">
<p>The specifics of the RPL implementation are out of the scope of this section, we merely describe the common configurations and provide a brief introduction to RPL.  For more details, check the RPL implementation at <code>core/net/rpl</code>.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">What is RPL?</div>
<div class="paragraph">
<p>RPL is an IPv6 routing protocol for low power and lossy networks designed by the IETF Routing Over Low power and Lossy network (ROLL) group, used as the de facto routing protocol in Contiki.  RPL is a proactive distance vector protocol, it starts finding the routes as soon as the RPL network is initialized.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/4/image005.jpg" alt="image005.jpg">
</div>
<div class="title">Figure 55. RPL in the protocol stack</div>
</div>
<div class="paragraph">
<p>It supports three traffic patterns:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Multipoint-to-point (MP2P)</p>
</li>
<li>
<p>Point-to-multipoint (P2MP)</p>
</li>
<li>
<p>Point-to-point (P2P)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>RPL builds Destination Oriented DAGs (DODAGs) rooted towards one sink (DAG ROOT) identified by a unique identifier DODAGID.  The DODAGs are optimized using an Objective Function (OF) metric identified by an Objective Code Point (OCP), which indicates the dynamic constraints and the metrics such as hop count, latency, expected transmission count, parents selection, energy consumption, etc.  A rank number is assigned to each node which can be used to determine its relative position and distance to the root in the DODAG.</p>
</div>
<div class="paragraph">
<p>Within a given network, there may be multiple, logically independent RPL instances.  An RPL node may belong to multiple RPL instances, and may act as a router in some and as a leaf in others.  A set of multiple DODAGs can be in an RPL INSTANCE and a node can be a member of multiple RPL INSTANCEs, but can belong to at most one DODAG per DAG INSTANCE.</p>
</div>
<div class="paragraph">
<p>A trickle timer mechanism regulates DODAG Information Object (DIO) message transmissions, which are used to build and maintain upwards routes of the DODAG, advertising its RPL instance, DODAG ID, RANK and DODAG version number.</p>
</div>
<div class="paragraph">
<p>A node can request DODAG information by sending DODAG Information Solicitation messages (DIS), soliciting DIO messages from its neighborhoods to update its routing information and join an instance.</p>
</div>
<div class="paragraph">
<p>Nodes have to monitor DIO messages before joining a DODAG, and then join a DODAG by selecting a parent Node from its neighbors using its advertised latency, OF and RANK.  Destination Advertisement Object (DAO) messages are used to maintain downward routes by selecting the preferred parent with lower rank and sending a packet to the DAG ROOT through each of the intermediate Nodes.</p>
</div>
<div class="paragraph">
<p>RPL has two mechanisms to repair the topology of the DODAG, one to avoid looping and allow nodes to join/rejoin, and other called global repair. Global repair is initiated at the DODAG ROOT by incrementing the DODAG Version Number to create a new DODAG Version.</p>
</div>
<div class="paragraph">
<p>More information about RPL can be found in <a href="https://tools.ietf.org/html/rfc6550">RFC6550</a>.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>Routing support is enabled as default in the <strong>Z1 mote</strong> and  <strong>RE-Mote</strong> platform.  To enable routing the following has to be enabled:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">#ifndef UIP_CONF_ROUTER
#define UIP_CONF_ROUTER  1
#endif</code></pre>
</div>
</div>
<div class="paragraph">
<p>To enable RPL add the following to your application&#8217;s <code>Makefile</code> or its <code>project-conf.h</code> file.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">#define UIP_CONF_IPV6_RPL  1</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following is the default configuration done in the <strong>RE-Mote</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">/* ND and Routing */
#define UIP_CONF_ND6_SEND_RA        0  <i class="conum" data-value="1"></i><b>(1)</b>
#define UIP_CONF_IP_FORWARD         0  <i class="conum" data-value="2"></i><b>(2)</b>
#define RPL_CONF_STATS              0  <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Disable sending routing advertisements</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Disable IP forwarding</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>RPL Configuration statistics are disabled</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <code>RPL_CONF_OF</code> parameter configures the RPL objective function.  The Minimum Rank with Hysteresis Objective Function (MRHOF) uses ETX as routing metric and it also has stubs for energy metric.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">#ifndef RPL_CONF_OF
#define RPL_CONF_OF rpl_mrhof
#endif</code></pre>
</div>
</div>
<div class="paragraph">
<p>The Expected Transmissions metric (ETX) measure how many tries it takes to receive an acknowledgment (ACK) of a sent packet, keeping a moving average for each neighbor, computing the sum of all ETXs to build the routes.</p>
</div>
<div class="paragraph">
<p>As default Contiki uses <code>storing mode</code> for RPL downward routes.  Basically all nodes store in a routing table the addresses of their child nodes.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="trueset-up-a-wireless-sniffer"><a class="anchor" href="#trueset-up-a-wireless-sniffer"></a>Set up a wireless sniffer</h3>
<div class="paragraph">
<p>A packet sniffer is a must-have tool for any wireless network application, it allows to see what you are  transmitting over the air, verifying both that the transmissions are taking place, the frames/packets are properly formatted, and that the communication is happening on a given channel.</p>
</div>
<div class="paragraph">
<p>There are commercial options available, such as the Texas Instruments <a href="http://www.ti.com/tool/packet-sniffer">SmartRF packet Sniffer</a>, which can be used with a <a href="http://www.ti.com/tool/CC2531EMK">CC2531 USB dongle</a> to capture packets like the one below.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/4/image006.png" alt="image006.png">
</div>
<div class="title">Figure 56. Sniffer packet capture</div>
</div>
<div class="paragraph">
<p>We will use for this exercise the <a href="https://github.com/g-oikonomou/sensniff">SenSniff</a> application, paired with a <strong>RE-Mote</strong> and Wireshark (already installed in instant Contiki).  This setup will allow us to understand how the wireless communication is done in Contiki.</p>
</div>
<div class="paragraph">
<p>To program the <strong>RE-Mote</strong> or a <strong>Z1</strong> as a packet Sniffer:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">cd examples/zolertia/tutorial/02-ipv6/06-sniffer</code></pre>
</div>
</div>
<div class="paragraph">
<p>Compile and program:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">make TARGET=zoul sniffer.upload</code></pre>
</div>
</div>
<div class="paragraph">
<p>Or</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">make TARGET=z1 sniffer.upload</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note this application has its own <code>project-conf.h</code>, not shared with the other applications in the same <code>02-ipv6</code> folder.</p>
</div>
<div class="paragraph">
<p>The <code>project-conf.h</code> has specific platform settings to make the sniffer work (don&#8217;t change those unless you know what you are doing), only change the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">#undef IEEE802154_CONF_PANID
#define IEEE802154_CONF_PANID      0xABCD

#if CONTIKI_TARGET_ZOUL
/* The following are Zoul (RE-Mote, etc) specific */
#undef CC2538_RF_CONF_CHANNEL
#define CC2538_RF_CONF_CHANNEL     26

#else /* Default is Z1 */

/* The following are Z1 specific */
#undef RF_CHANNEL
#define RF_CHANNEL                 26

#undef CC2420_CONF_CHANNEL
#define CC2420_CONF_CHANNEL        26</code></pre>
</div>
</div>
<div class="paragraph">
<p>For the <strong>Z1</strong> mote launch the sensniff application with the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">python sensniff.py --non-interactive -d /dev/ttyUSB0 -b 115200</code></pre>
</div>
</div>
<div class="paragraph">
<p>For the <strong>RE-Mote</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">python sensniff.py --non-interactive -d /dev/ttyUSB0 -b 460800</code></pre>
</div>
</div>
<div class="paragraph">
<p>Sensniff will read data from the mote over the serial port, dissect the frames and pipe to <code>/tmp/sensniff</code> by default, now we need to connect the other extreme of the pipe to wireshark, else you will get the following warning:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash"> "Remote end not reading"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Which is not worrisome, it only means that the other pipe endpoint is not connected.  You can also save the sniffed frames for later opening with wireshark, adding the following argument to the above command <code>-p name.pcap</code>, which will save the session output in a <code>name.pcap</code> file. Change the naming and location for storing the file accordingly.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>At the moment of writing this tutorial changing channels from the Sensniff application was not implemented but proposed as a feature.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Open another terminal and launch wireshark with the following command, which will add the pipe as a capture interface:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">sudo wireshark -i /tmp/sensniff</code></pre>
</div>
</div>
<div class="paragraph">
<p>Select the <code>/tmp/sensniff</code> interface from the droplist and click <code>Start</code> just above.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/4/image007.png" alt="image007.png">
</div>
<div class="title">Figure 57. Capture options</div>
</div>
<div class="paragraph">
<p>Make sure that the pipe is configured to capture packets in promiscuous mode, if needed you can increase the buffer size, but 1 MB is normally enough.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/4/image008.png" alt="image008.png">
</div>
<div class="title">Figure 58. Interface settings</div>
</div>
<div class="paragraph">
<p>Now the captured frames should start to appear on screen.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/4/image009.png" alt="image009.png">
</div>
<div class="title">Figure 59. Captured frames</div>
</div>
<div class="paragraph">
<p>You can add specific filters to limit the frames being shown on screen, for this example click at the <code>Expression</code> button and a list of available attributes per protocol are listed, scroll down to IEEE 802.15.4 and check the available filters.  You can also chain different filter arguments using the <code>Filter</code> box, in this case we only wanted to check the frames belonging to the <code>PAN 0xABCD</code> and coming from node <code>c1:0c::0309</code>, so we used the <code>wpan.dst_pan</code> and  <code>wpan.src64</code> attributes.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/4/image010.png" alt="image010.png">
</div>
<div class="title">Figure 60. Wireshark filters</div>
</div>
<div class="paragraph">
<p>When closing the Sensniff python application, a session information is provided reporting the following statistics:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">Frame Stats:
         Non-Frame: 6
         Not Piped: 377
    Dumped to PCAP: 8086
             Piped: 7709
          Captured: 8086</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now that we have a sniffer configured and ready to use, let&#8217;s create a first wireless application and start sniffing packets!</p>
</div>
</div>
<div class="sect2">
<h3 id="trueudp-on-ipv6-and-the-border-router"><a class="anchor" href="#trueudp-on-ipv6-and-the-border-router"></a>UDP on IPv6 and the Border Router</h3>
<div class="paragraph">
<p>Now that we have covered the mote configurations and the MAC and routing layers, let us set up a UDP network.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">What is UDP?</div>
<div class="paragraph">
<p>UDP (User Datagram Protocol) is a communications protocol that offers a limited amount of services for messages exchanged among devices in a network that uses the Internet Protocol (IP).</p>
</div>
<div class="paragraph">
<p>UDP is an alternative to the Transmission Control Protocol (TCP) and, together with IP, is sometimes referred to as UDP/IP. Like the Transmission Control Protocol, UDP uses the Internet Protocol to actually get a data unit (called a datagram) from one computer to another.</p>
</div>
<div class="paragraph">
<p>Unlike TCP, UDP does not provide message fragmentation and reassembling at the other end, this means that the application must be able to make sure that the entire message has arrived and is in the right order.</p>
</div>
<div class="paragraph">
<p>Network applications that want to save processing time because they have very small data units to exchange (and therefore very little message reassembling to do) may prefer UDP to TCP</p>
</div>
</div>
</div>
<div class="paragraph">
<p>The UDP implementation is Contiki resides in <code>core/net/ip</code>.  The remainder of the section will focus on describing the UDP available functions.</p>
</div>
<div class="sect3">
<h4 id="truethe-udp-api"><a class="anchor" href="#truethe-udp-api"></a>The UDP API</h4>
<div class="paragraph">
<p>We need to create a socket for the connection, this is done using the <code>udp_socket</code> structure, which has the following elements:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">struct udp_socket {
  udp_socket_input_callback_t input_callback;
  void *ptr;
  struct process *p;
  struct uip_udp_conn *udp_conn;
};</code></pre>
</div>
</div>
<div class="paragraph">
<p>After creating the UDP socket structure, we need to register the UDP socket.  This is done with the <code>udp_socket_register</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">/**
 * \brief      Register a UDP socket
 * \param c    A pointer to the struct udp_socket that should be registered
 * \param ptr  An opaque pointer that will be passed to callbacks
 * \param receive_callback A function pointer to the callback function that will be called when data arrives
 * \retval -1  The registration failed
 * \retval 1   The registration succeeded
 */
int udp_socket_register(struct udp_socket *c,
                        void *ptr,
                        udp_socket_input_callback_t receive_callback);</code></pre>
</div>
</div>
<div class="paragraph">
<p>As the UDP socket has been created and registered, let us listen on a given port.  The <code>udp_socket_bind</code> function binds the UDP socket to a local port so it will begin to receive data that arrives on the specified port. A UDP socket will receive data addressed to the specified port number on any IP address of the host.  A UDP socket bound to a local port will use this port number as source port for outgoing UDP messages.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">/*
 * \brief      Bind a UDP socket to a local port
 * \param c    A pointer to the struct udp_socket that should be bound to a local port
 * \param local_port The UDP port number, in host byte order, to bind the UDP socket to
 * \retval -1  Binding the UDP socket to the local port failed
 * \retval 1   Binding the UDP socket to the local port succeeded
 */
int udp_socket_bind(struct udp_socket *c,
                    uint16_t local_port);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>udp_socket_connect</code> function connects the UDP socket to a specific remote port and optional remote IP address. When a UDP socket is connected to a remote port and address, it will only receive packets that are sent from that remote port and address. When sending data over a connected UDP socket, the data will be sent to the connected remote address.</p>
</div>
<div class="paragraph">
<p>A UDP socket can be connected to a remote port, but not to a remote IP address, by providing a <code>NULL</code> parameter as the remote_addr parameter.  This lets the UDP socket receive data from any IP address on the specified port.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">/**
 * \brief      Bind a UDP socket to a remote address and port
 * \param c    A pointer to the struct udp_socket that should be connected
 * \param remote_addr The IP address of the remote host, or NULL if the UDP socket should only be connected to a specific port
 * \param remote_port The UDP port number, in host byte order, to which the UDP socket should be connected
 * \retval -1  Connecting the UDP socket failed
 * \retval 1   Connecting the UDP socket succeeded
 */
int udp_socket_connect(struct udp_socket *c,
                       uip_ipaddr_t *remote_addr,
                       uint16_t remote_port);</code></pre>
</div>
</div>
<div class="paragraph">
<p>To send data over a connected UDP socket it must have been connected to a remote address and port with <code>udp_socket_connect</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">/**
 * \brief      Send data on a UDP socket
 * \param c    A pointer to the struct udp_socket on which the data should be sent
 * \param data A pointer to the data that should be sent
 * \param datalen The length of the data to be sent
 * \return     The number of bytes sent, or -1 if an error occurred
 */
int udp_socket_send(struct udp_socket *c,
                    const void *data, uint16_t datalen);</code></pre>
</div>
</div>
<div class="paragraph">
<p>To send data over a UDP socket without being connected we use the function <code>udp_socket_sendto</code> instead.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">/**
 * \brief      Send data on a UDP socket to a specific address and port
 * \param c    A pointer to the struct udp_socket on which the data should be sent
 * \param data A pointer to the data that should be sent
 * \param datalen The length of the data to be sent
 * \param addr The IP address to which the data should be sent
 * \param port The UDP port number, in host byte order, to which the data should be sent
 * \return     The number of bytes sent, or -1 if an error occurred
 */
int udp_socket_sendto(struct udp_socket *c,
                      const void *data, uint16_t datalen,
                      const uip_ipaddr_t *addr, uint16_t port);</code></pre>
</div>
</div>
<div class="paragraph">
<p>To close a UDP socket previously registered with <code>udp_socket_register</code> the function below is used.  All registered UDP sockets must be closed before exiting the process that registered them, or undefined behavior may occur.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">/**
 * \brief      Close a UDP socket
 * \param c    A pointer to the struct udp_socket to be closed
 * \retval -1  If closing the UDP socket failed
 * \retval 1   If closing the UDP socket succeeded
 */
int udp_socket_close(struct udp_socket *c);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Each UDP socket has a callback function that is registered as part of the call to <code>udp_socket_register</code>. The callback function gets called every time a UDP packet is received.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">/**
 * \brief      A UDP socket callback function
 * \param c    A pointer to the struct udp_socket that received the data
 * \param ptr  An opaque pointer that was specified when the UDP socket was registered with udp_socket_register()
 * \param source_addr The IP address from which the datagram was sent
 * \param source_port The UDP port number, in host byte order, from which the datagram was sent
 * \param dest_addr The IP address that this datagram was sent to
 * \param dest_port The UDP port number, in host byte order, that the datagram was sent to
 * \param data A pointer to the data contents of the UDP datagram
 * \param datalen The length of the data being pointed to by the data pointer
 */
typedef void (* udp_socket_input_callback_t)(struct udp_socket *c,
                                             void *ptr,
                                             const uip_ipaddr_t *source_addr,
                                             uint16_t source_port,
                                             const uip_ipaddr_t *dest_addr,
                                             uint16_t dest_port,
                                             const uint8_t *data,
                                             uint16_t datalen);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Alternatively there is another UDP library called <code>simple-udp</code>, which simplifies the UDP API to fewer functions.  The library is located in <code>core/net/ip/simple-udp.c</code>.  For the next example we are going to use the <code>simple-udp</code> library, to show how to create a very first wireless example.  In a later example we will come back to the full-fledged UDP API.</p>
</div>
</div>
<div class="sect3">
<h4 id="trueudp-link-local-multicast-example"><a class="anchor" href="#trueudp-link-local-multicast-example"></a>UDP Link-Local multicast example</h4>
<div class="paragraph">
<p>This is the first example of the <code>02-ipv6</code> folder.</p>
</div>
<div class="paragraph">
<p>The <code>01-udp-local-multicast</code> summarizes how to read and set radio parameters, such as:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>RSSI (Received signal strength indication) and LQI (Link quality indicator)</p>
</li>
<li>
<p>Radio channel</p>
</li>
<li>
<p>PAN ID (network identifier)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>We will also learn how to use the <code>Simple-UDP</code> library, which allows to create wireless applications on top of IPv6/UDP, and transmit data such as sensor readings and system information.</p>
</div>
<div class="paragraph">
<p>You will need at least two Zolertia motes, the <code>RE-Mote</code> and <code>Z1</code> can be used together in the same network as the network implementation is platform-independent.</p>
</div>
<div class="paragraph">
<p>Flash the two Zolertia devices as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">make 01-udp-local-multicast.upload</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Remember to use the <code>PORT</code> argument to specify the USB port in which a given Zolertia platform is connected.  If you have a <code>RE-Mote</code> connected in <code>/dev/ttyUSB0</code> port and another one in <code>/dev/ttyUSB1</code> but you only want to flash the first one, then:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">make TARGET=zoul 01-udp-local-multicast.upload PORT=/dev/ttyUSB1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Likewise to open a serial console over USB to see the debug output:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">make TARGET=zoul login PORT=/dev/ttyUSB0</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <code>RE-Mote</code> platform will show something similar to:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">Contiki-3.x-2576-g4499d80
Zolertia RE-Mote platform
Rime configured with address 00:12:4b:00:06:15:ab:25  <i class="conum" data-value="1"></i><b>(1)</b>
 Net: sicslowpan                                      <i class="conum" data-value="2"></i><b>(2)</b>
 MAC: CSMA                                            <i class="conum" data-value="3"></i><b>(3)</b>
 RDC: nullrdc                                         <i class="conum" data-value="4"></i><b>(4)</b>

* Radio parameters:
   Channel 15 (Min: 11, Max: 26)                      <i class="conum" data-value="5"></i><b>(5)</b>
   Tx Power   3 dBm (Min: -24 dBm, Max:   7 dBm)      <i class="conum" data-value="6"></i><b>(6)</b>
   PAN ID: 0xBEEF

***
Sending packet to multicast adddress ff02::1          <i class="conum" data-value="7"></i><b>(7)</b>
ID: 171, core temp: 37.619, ADC1: 2332, ADC2: 0, ADC3: 1496, batt: 3300, counter: 1</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>MAC address of the <code>RE-Mote</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>6LoWPAN implementation in Contiki</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Carrier Sense Multiple Access Medium Access Control <a href="https://en.wikipedia.org/wiki/Carrier_sense_multiple_access">CSMA</a></td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Radio Duty cycling disabled (NullRDC)</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>2.4GHz RF channel (11-26 available)</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Transmission power (-24dBm to 7dBm)</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>As probably noticed, the default values for the 2.4GHz band channel is 26, not 15&#8230;&#8203; why is now different? let&#8217;s take a closer look at the code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">PROCESS_THREAD(mcast_example_process, ev, data)
{
  static struct etimer periodic_timer;

  /* Data container used to store the IPv6 addresses */
  uip_ipaddr_t addr;

  PROCESS_BEGIN();

  set_radio_default_parameters();
  print_radio_values();

  (...)
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>set_radio_default_parameters()</code> configures the radio values to be used by the application:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">static void
set_radio_default_parameters(void)
{
  NETSTACK_RADIO.set_value(RADIO_PARAM_TXPOWER, EXAMPLE_TX_POWER);
  NETSTACK_RADIO.set_value(RADIO_PARAM_PAN_ID, EXAMPLE_PANID);
  NETSTACK_RADIO.set_value(RADIO_PARAM_CHANNEL, EXAMPLE_CHANNEL);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>But where are the <code>EXAMPLE_CHANNEL</code>, <code>EXAMPLE_TX_POWER</code> and <code>EXAMPLE_PANID</code> values defined?</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Try to do the following before reading further:
<code>grep -lr "EXAMPLE_CHANNEL" /home/user/contiki</code></p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <code>Makefile</code> shows the location of the <code>project-conf.h</code> configuration file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c"># Includes the project-conf configuration file
CFLAGS += -DPROJECT_CONF_H=\"../project-conf.h\"

# This flag includes the IPv6 libraries
CONTIKI_WITH_IPV6 = 1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice the <code>CONTIKI_WITH_IPV6</code> flag, this effectively enabled IPv6 support in our application.</p>
</div>
<div class="paragraph">
<p>The <code>project-conf-h</code> file is in <code>02-ipv6</code>, and configures the following relevant values:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">/* Comment this out to use Radio Duty Cycle (RDC) and save energy */
#undef NETSTACK_CONF_RDC
#define NETSTACK_CONF_RDC          nullrdc_driver

#undef IEEE802154_CONF_PANID
#define IEEE802154_CONF_PANID      0xABCD

/* The following are Z1 specific */
#undef RF_CHANNEL
#define RF_CHANNEL	               26

#undef CC2420_CONF_CHANNEL
#define CC2420_CONF_CHANNEL        26

/* The following are Zoul (RE-Mote, etc) specific */
#undef CC2538_RF_CONF_CHANNEL
#define CC2538_RF_CONF_CHANNEL     26</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we know we are disabling Radio-Duty cycling and using <code>NullRDC</code> and keeping the radio on, but the channel value default value is 26, not 15.</p>
</div>
<div class="paragraph">
<p>In the same <code>02-ipv6</code> folder there is a header file named <code>example.h</code> which defines:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">/* This is the UDP port used to send and receive data */
#define UDP_CLIENT_PORT   8765       <i class="conum" data-value="1"></i><b>(1)</b>
#define UDP_SERVER_PORT   5678       <i class="conum" data-value="2"></i><b>(2)</b>

/* Radio values to be configured for the 01-udp-local-multicast example */
#define EXAMPLE_TX_POWER  31         <i class="conum" data-value="3"></i><b>(3)</b>
#define EXAMPLE_CHANNEL   15         <i class="conum" data-value="4"></i><b>(4)</b>
#define EXAMPLE_PANID     0xBEEF     <i class="conum" data-value="5"></i><b>(5)</b>

/* This data structure is used to store the packet content (payload) */
struct my_msg_t {                    <i class="conum" data-value="6"></i><b>(6)</b>
  uint8_t  id;
  uint16_t counter;
  uint16_t value1;
  uint16_t value2;
  uint16_t value3;
  uint16_t value4;
  uint16_t battery;
};</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The UDP port opened by the device itself</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The UDP port to send data to (opened by the server)</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The new transmission power set in the example</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The new channel set in the example</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>The new PAN ID configured in the example</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>The structure in which we are to store the data to be sent wirelessly</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Let&#8217;s go back to the <code>01-udp-local-multicast.c</code> example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">/* The structure used in the Simple UDP library to create an UDP connection */
static struct simple_udp_connection mcast_connection;

/* Create the UDP connection.  This function registers a UDP connection and
 * attaches a callback function to it. The callback function will be
 * called for incoming packets. The local UDP port can be set to 0 to indicate  * that an ephemeral UDP port should be allocated. The remote IP address can
 * be NULL, to indicate that packets from any IP address should be accepted.
 */
simple_udp_register(&amp;mcast_connection, UDP_CLIENT_PORT, NULL, UDP_CLIENT_PORT, receiver);</code></pre>
</div>
</div>
<div class="paragraph">
<p>First we have configured an UDP connection, passing as an argument the <code>mcast_connection</code> structure to be used by the <code>simple-udp</code> library.  As the remote IP address is set to <code>NULL</code> any incoming packet will be accepted, invoking the <code>receiver</code> callback handler whenever that happens:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">static void
receiver(struct simple_udp_connection *c,
         const uip_ipaddr_t *sender_addr,
         uint16_t sender_port,
         const uip_ipaddr_t *receiver_addr,
         uint16_t receiver_port,
         const uint8_t *data,
         uint16_t datalen)
{
  radio_value_t aux;
  struct my_msg_t *msgPtr = (struct my_msg_t *) data;   <i class="conum" data-value="1"></i><b>(1)</b>
  leds_toggle(LEDS_GREEN);
  uip_debug_ipaddr_print(sender_addr);                  <i class="conum" data-value="2"></i><b>(2)</b>

  printf("\nData received on port %d from port %d with  <i class="conum" data-value="3"></i><b>(3)</b>
         length %d\n", receiver_port, sender_port, datalen);

  NETSTACK_RADIO.get_value(RADIO_PARAM_CHANNEL, &amp;aux);  <i class="conum" data-value="4"></i><b>(4)</b>
  printf("CH: %u ", (unsigned int) aux);

  aux = packetbuf_attr(PACKETBUF_ATTR_RSSI);            <i class="conum" data-value="5"></i><b>(5)</b>
  printf("RSSI: %ddBm ", aux);

  aux = packetbuf_attr(PACKETBUF_ATTR_LINK_QUALITY);    <i class="conum" data-value="6"></i><b>(6)</b>
  printf("LQI: %u\n", aux);

  /* Print the received data */                         <i class="conum" data-value="7"></i><b>(7)</b>
  printf("ID: %u, core temp: %u, ADC1: %d, ADC2: %d, ADC3: %d",
          msgPtr-&gt;id, msgPtr-&gt;value1, msgPtr-&gt;value2, msgPtr-&gt;value3,
          msgPtr-&gt;value4);
  printf("batt: %u, counter: %u\n", msgPtr-&gt;battery,
          msgPtr-&gt;counter);
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Creates a pointer to dereference the message payload into the <code>my_msg_t</code> structure defined in <code>example.h</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>A helper function used to print an IPv6 address in a readable form</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Prints the UDP origin and destination port, and the message length</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Retrieve the current RF channel number</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Retrieve the RSSI level of the received message (on a 1-hop basis)</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Retrieve the LQI value of the received message</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Prints the payload content</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>As probably you have already noticed, we are sending the on-board sensor readings via wireless to the <a href="http://www.iana.org/assignments/ipv6-multicast-addresses/ipv6-multicast-addresses.xhtml#link-local">all-nodes multicast address</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">  etimer_set(&amp;periodic_timer, SEND_INTERVAL);

  while(1) {
    PROCESS_WAIT_EVENT_UNTIL(etimer_expired(&amp;periodic_timer));
    /* Create a link-local multicast address to all nodes */
    uip_create_linklocal_allnodes_mcast(&amp;addr);
    uip_debug_ipaddr_print(&amp;addr);
    printf("\n");

    /* Take sensor readings and store into the message structure */
    take_readings();

    /* Send the multicast packet to all devices */
    simple_udp_sendto(&amp;mcast_connection, msgPtr, sizeof(msg), &amp;addr);

    etimer_reset(&amp;periodic_timer);
  }</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>take_readings()</code> function reads the sensors values and then stores it into <code>msg</code>, a <code>my_msg_t</code> structure.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">/* Create a structure and pointer to store the data to be sent as payload */
static struct my_msg_t msg;
static struct my_msg_t *msgPtr = &amp;msg;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice the <code>simple_udp_sendto</code> accepts any type of data as payload, we use the <code>msgPtr</code> pointer which points to <code>msg</code> and the <code>sizeof(msg)</code> function to inform  <code>simple-udp</code> how large is our payload.</p>
</div>
<div class="paragraph">
<p>Program at least two <code>Z1</code> or <code>RE-Mote</code> with the <code>01-udp-local-multicast.c</code> application, and open a console connection using <code>make login</code> for each connected device.</p>
</div>
<div class="paragraph">
<p>You should be receiving messages from the other devices! Write down the node ID of other motes. This will be useful later.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Experiment with the channel, transmission power, RSSI and LQI levels:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>How does the RSSI/LQI change when moving the devices apart?</p>
</li>
<li>
<p>What happens if you put an obstacle between both devices? a metallic obstacle would yield the same effect as a wooden one?</p>
</li>
<li>
<p>Rotate the <code>RE-Mote</code> or the <code>Z1</code> so the antenna position is not the same in all cases, what do you think it will happen?</p>
</li>
<li>
<p>Decrease the transmission power close to the minimum and try to move the devices away from each other until you cannot receive any more packets, note the distance and the RSSI/LQI values.</p>
</li>
<li>
<p>What is the maximum range you get using the maximum transmission power between two devices with line of sight? what will happen if you increase the height of one of the devices by a metre?</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To change the sending interval you can also modify the values at:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">#define SEND_INTERVAL	(15 * CLOCK_SECOND)</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Program at least one <code>Z1</code> or <code>RE-Mote</code> with the <code>01-udp-local-multicast</code> example and another device with the <code>sniffer</code> application and sniff the traffic! try to filter outgoing and incoming data packets using your own rules.</p>
</div>
<div class="paragraph">
<p>Remember you are using the <code>01-udp-local-multicast</code> application with the channel 15 and PAN ID 0xBEEF, you must change your sniffer settings also in its <code>project-conf.h</code> file.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="truethe-border-router"><a class="anchor" href="#truethe-border-router"></a>The Border Router</h4>
<div class="paragraph">
<p>The border router or edge router is typically a device sitting at the edge of our network, which allow us to talk to outside networks using its built-in network interfaces, such as WiFi, Ethernet, Serial, etc.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/4/image011.jpg" alt="image011.jpg">
</div>
<div class="title">Figure 61. The border router</div>
</div>
<div class="paragraph">
<p>In Contiki the current and most used border router application implements a serial-based interface called SLIP, it allows to connect a given mote to a host using scripts like <code>tunslip6</code> in <code>tools/tunslip6</code> over the serial port, creating a tunnelled network interface, which can be given an IPv6 prefix to set the network global IPv6 addresses.</p>
</div>
<div class="paragraph">
<p>A simplification of <code>tunslip6</code> and the Border Router is: IPv6 packets received by the host are forwarded over the USB connection to the Border Router via <code>tunslip6</code>, and subsequently all 6LoWPAN wireless packets are forwarded by the Border Router to the host as IPv6 packets via the USB connection through <code>tunslip6</code>.</p>
</div>
<div class="paragraph">
<p>The border router application is located at <code>examples/ipv6/rpl-border-router</code>, the following code snippets are the most relevant:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">/* Request prefix until it has been received */
while(!prefix_set) {
   etimer_set(&amp;et, CLOCK_SECOND);
   request_prefix();
   PROCESS_WAIT_EVENT_UNTIL(etimer_expired(&amp;et));
}

dag = rpl_set_root(RPL_DEFAULT_INSTANCE,(uip_ip6addr_t *)dag_id);
if(dag != NULL) {
   rpl_set_prefix(dag, &amp;prefix, 64);
   PRINTF("created a new RPL dag\n");
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The snippet above bootstraps until a valid prefix has been given.  Once the prefix has been assigned, the node will set the prefix and convert itself in the root node (DODAG).</p>
</div>
<div class="paragraph">
<p>Normally it is preferable to configure the border router as a non-sleeping device, so that the radio receiver is always on (no radio duty cycling).</p>
</div>
<div class="paragraph">
<p>By default the border-router applications includes a built-in web server, displaying information about the network, such as the immediate neighbors (1-hop away) and the known routes to nodes in their networks.  To enable the web server, the <code>WITH_WEBSERVER</code> flag should be enabled, and by default it will add the <code>httpd-simple.c</code> application.</p>
</div>
<div class="paragraph">
<p>The following assumes to use a <strong>RE-Mote</strong> platform, but the <strong>Z1 mote</strong> can be used as well.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">make TARGET=zoul savetarget</code></pre>
</div>
</div>
<div class="paragraph">
<p>To compile, flash the mote and connect the border router to your host; run:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">cd /home/user/contiki/examples/zolertia/tutorial/02-ipv6/02-border-router
make border-router.upload &amp;&amp; make connect-router</code></pre>
</div>
</div>
<div class="paragraph">
<p>By default it will try to connect to a mote at port <code>/dev/ttyUSB0</code> using the following serial settings:  115200 baud rate, 8 bits, No parity and 1 bit stop.  If you do not state an IPv6 prefix it will use the default <code>aaaa::1/64</code>, to specify a different one run the tunslip tool instead using the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">make connect-router PREFIX="2001:abcd:dead:beef::1/64"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Or if you want to specify a different USB port:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">make connect-router PREFIX="-s /dev/ttyUSB1 fd00::1/64"</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also compile and run the <code>tunslip6</code> tool directly from the tools location, to compile just type:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">cd tools
cc tunslip6.c -o tunslip6</code></pre>
</div>
</div>
<div class="paragraph">
<p>And to run with specific arguments, i.e. connect to a specific serial port, name your tunnel connection with a specific name, or proxify to a given address and port, use the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">./tunslip -s /dev/ttyUSB0 -t tun0 2001:abcd:dead:beef::1/64</code></pre>
</div>
</div>
<div class="paragraph">
<p>Run <code>tunslip -H</code> for more information.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>To enable IPv6 forwarding you need to run:</p>
</div>
<div class="paragraph">
<p><code>sudo sysctl -w net.ipv6.conf.all.forwarding=1</code></p>
</div>
<div class="paragraph">
<p>To make this change permanent, edit the <code>/etc/sysctl.conf</code> file and uncomment the following line:</p>
</div>
<div class="paragraph">
<p><code>net.ipv6.conf.default.forwarding=1</code></p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The output of the <code>tunslip6</code> script is:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">using saved target 'z1'
sudo ../../../../../tools/tunslip6 fd00::1/64
[sudo] password for zolertia:
********SLIP started on ``/dev/ttyUSB0''
opened tun device ``/dev/tun0''
ifconfig tun0 inet `hostname` mtu 1500 up
ifconfig tun0 add fd00::1/64
ifconfig tun0 add fe80::0:0:0:1/64
ifconfig tun0

tun0      Link encap:UNSPEC  HWaddr 00-00-00-00-00-00-00-00-00-00-00-00-00-00-00-00
          inet addr:127.0.1.1  P-t-P:127.0.1.1  Mask:255.255.255.255
          inet6 addr: fe80::1/64 Scope:Link
          inet6 addr: fd00::1/64 Scope:Global
          UP POINTOPOINT RUNNING NOARP MULTICAST  MTU:1500  Metric:1
          RX packets:0 errors:0 dropped:0 overruns:0 frame:0
          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:500
          RX bytes:0 (0.0 B)  TX bytes:0 (0.0 B)

*** Address:fd00::1 =&gt; fd00:0000:0000:0000
Got configuration message of type P
Setting prefix fd00::
Server IPv6 addresses:
 fd00::c30c:0:0:13c2
 fe80::c30c:0:0:13c2</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will create a <code>tun0</code> interface in our host, try running the <code>ifconfig</code> command in a terminal.</p>
</div>
<div class="paragraph">
<p>Note the Border Router uses Stateless Auto Configuration <a href="http://ipv6.com/articles/general/Stateless-Auto-Configuration.htm">SLAC</a> to create its IPv6 address, by using the IPv6 prefix given to the <code>tunslip6</code> script and its own MAC address.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Contiki has changed the default prefix from <code>aaaa::/64</code> to <code>fd00::/64</code> recently to the date of this book, so there might be example images and documentation still using the old prefix.  You can use any of them, but it is preferred the later.  Add the following to your <code>project-conf.h</code> file and change the value accordingly to be consistent to the chosen prefix:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">#define UIP_CONF_DS6_DEFAULT_PREFIX 0xaaaa</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We can make a <code>ping6</code> request to both the <code>tun0</code> interface and to the <code>Border Router</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ ping6 fd00::c30c:0:0:13c2
PING fd00::c30c:0:0:13c2(fd00::c30c:0:0:13c2) 56 data bytes
64 bytes from fd00::c30c:0:0:13c2: icmp_seq=1 ttl=64 time=19.8 ms
64 bytes from fd00::c30c:0:0:13c2: icmp_seq=2 ttl=64 time=20.3 ms
64 bytes from fd00::c30c:0:0:13c2: icmp_seq=3 ttl=64 time=20.5 ms
64 bytes from fd00::c30c:0:0:13c2: icmp_seq=4 ttl=64 time=20.8 ms
64 bytes from fd00::c30c:0:0:13c2: icmp_seq=5 ttl=64 time=20.6 ms
64 bytes from fd00::c30c:0:0:13c2: icmp_seq=6 ttl=64 time=20.6 ms</code></pre>
</div>
</div>
<div class="paragraph">
<p>Furthermore, we can open a web browser and enter the Border Router&#8217;s IPv6 address, in this example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">http://[fd00::c30c:0:0:13c2]</code></pre>
</div>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/4/image016.png" alt="image016.png">
</div>
<div class="title">Figure 62. Border Router web service</div>
</div>
<div class="paragraph">
<p>The built-in web service will show the Border Router&#8217;s neighbors list and its routes.  This is quite handy to check if the devices in our deployment have joined our Border Router&#8217;s network, retrieve their IPv6 addresses and even make a <code>ping6</code> request.</p>
</div>
<div class="paragraph">
<p>Note we have been used a local IPv6 prefix, routable only in our network for testing purposes.  It is also possible to assign the <code>tunslip6</code> a globally routable IPv6 prefix, thus connecting our Border Router to Internet.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/4/image017.png" alt="image017.png">
</div>
<div class="title">Figure 63. Border Router web service with IPv6 global address</div>
</div>
<div class="paragraph">
<p>Using a public and globally reachable IPv6 prefix will make our Border Router, and subsequently all devices inside our IPv6/6LoWPAN network accessible over Internet:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/4/image018.png" alt="image018.png">
</div>
<div class="title">Figure 64. IPv6 online ping6</div>
</div>
<div class="paragraph">
<p>This means our 6LoWPAN network of constrained devices is reachable from anywhere in the world, and viceversa.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p><a href="http://cetic.github.io/6lbr/">6lbr</a> is a deployment-ready 6LoWPAN border router solution based on Contiki, it has support for the <strong>Z1 mote</strong> and the <strong>RE-Mote</strong> platform.  To take your border router to the next level, this is the tool you have been looking for.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If you launch the sniffer you will be able to see how the Border Router starts sending the RPL control messages, such as <code>DIO</code> (DAG Information Object) messages.  If you flash another device with the previously used <code>01-udp-multicast.c</code> example, you would be able to also see how a device joins the RPL network by exchanging <code>DIO</code>, <code>DAO</code> (Destination Advertisement Object) and <code>DIS</code> (DAG Information Solicitation) messages.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Remember the <code>01-udp-multicast</code> and the <code>02-border-router</code> examples uses a different channel and PAN ID! don&#8217;t forget to change accordingly: probably the best place is to edit the <code>example.h</code> header file.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/4/image025.png" alt="image025.png">
</div>
<div class="title">Figure 65. Wireshark capture of a node joining a RPL network</div>
</div>
</div>
<div class="sect3">
<h4 id="truehands-on-connecting-an-ipv6-udp-network-to-our-host"><a class="anchor" href="#truehands-on-connecting-an-ipv6-udp-network-to-our-host"></a>Hands on: connecting an IPv6 UDP network to our host</h4>
<div class="paragraph">
<p>In the <code>02-ipv6</code> folder open the <code>03-udp-client-and-server</code> example.</p>
</div>
<div class="paragraph">
<p>The example shows how to send sensor information to an UDP server running on the host network, even on a different network over Internet.</p>
</div>
<div class="paragraph">
<p>The UDP server is implemented in a python script, it allows to forward data also to other services.</p>
</div>
<div class="paragraph">
<p>The UDP server will send data to the MQTT broker of the Eclipse IoT foundation (at <code>iot.eclipse.org</code>), or to <a href="http://ifttt.com">IFTTT</a> to easily configure different types of events using a HTTP message as trigger.</p>
</div>
<div class="paragraph">
<p>Depending on the device the UDP client runs (<code>Z1</code> or <code>RE-Mote</code>), you need to adjust in the <code>UDP-MQTT-server.py</code> or <code>UDP-IFTTT-server.py</code> the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">EXAMPLE_WITH_Z1 = 1</code></pre>
</div>
</div>
<div class="paragraph">
<p>This example is the easiest way if you want to send data to a service or server outside your network, and you don&#8217;t have an IPv6 network on your own.  The Border Router as seen before can use a local <code>IPv6 prefix</code> and then the UDP server running on the host can forward to anywhere and anyone.</p>
</div>
<div class="paragraph">
<p>This example requires at least two Zolertia devices: A Border Router and an UDP client.  You can use alternatively <code>Z1</code> and <code>RE-Motes</code> as both can interoperate with each other.</p>
</div>
<div class="paragraph">
<p>You will also need to install the following python library if using the MQTT forwarder:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">pip install paho-mqtt</code></pre>
</div>
</div>
<div class="paragraph">
<p>You will need at least two Zolertia motes, the <code>RE-Mote</code> and <code>Z1</code> can be used together in the same network.</p>
</div>
<div class="paragraph">
<p>The application (on the networking perspective) will be similar to:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/4/image019.png" alt="image019.png">
</div>
<div class="title">Figure 66. UDP client and server network architecture</div>
</div>
<div class="paragraph">
<p>And from the application service perspective the MQTT forwarder application will look like:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/4/image020.png" alt="image020.png">
</div>
<div class="title">Figure 67. UDP client and server MQTT application</div>
</div>
<div class="paragraph">
<p>And for the IFTTT example, we can implement a simple use case related to preventive maintenance: if the battery is close to deplete, or the device has been tampered (sensed by the accelerometer), or the radio link is close to fade (due to an unexpected obstacle), then schedule a calendar task to the maintenance crew.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/4/image021.png" alt="image021.png">
</div>
<div class="title">Figure 68. UDP client and server IFTTT application</div>
</div>
<div class="paragraph">
<p>Let&#8217;s start!</p>
</div>
<div class="paragraph">
<p>In the <code>03-udp-client.c</code> example first note the server address:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">/* Set the server address here */
uip_ip6addr(&amp;server_ipaddr, 0xfd00, 0, 0, 0, 0, 0, 0, 1);</code></pre>
</div>
</div>
<div class="paragraph">
<p>As we are assuming we are going to use the <code>fd00::1/64</code> IPv6 address for the <code>tunslip6</code> virtual interface, this will be the address of the host running the <code>UDP-MQTT-server.py</code> python script, if not change accordingly.</p>
</div>
<div class="paragraph">
<p>To verify that we have set the address correctly:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">printf("Server address: ");
PRINT6ADDR(&amp;server_ipaddr);
printf("\n");</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>print_local_addresses(&#8230;&#8203;)</code> function will print the device configured addresses:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">static void
print_local_addresses(void)
{
  int i;
  uint8_t state;

  PRINTF("Client IPv6 addresses:\n");
  for(i = 0; i &lt; UIP_DS6_ADDR_NB; i++) {
    state = uip_ds6_if.addr_list[i].state;
    if(uip_ds6_if.addr_list[i].isused &amp;&amp;
       (state == ADDR_TENTATIVE || state == ADDR_PREFERRED)) {
      PRINT6ADDR(&amp;uip_ds6_if.addr_list[i].ipaddr);
      PRINTF("\n");
      /* hack to make address "final" */
      if (state == ADDR_TENTATIVE) {
        uip_ds6_if.addr_list[i].state = ADDR_PREFERRED;
      }
    }
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Printing at boot something similar to:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">Server address: fd00::1
Client IPv6 addresses:
fe80::c30c:0:0:13c8</code></pre>
</div>
</div>
<div class="paragraph">
<p>Remember addresses starting with <code>fe80</code> are link-local, this means the device has not joined the RPL network, as it has not received an IPv6 prefix from the Border Router (the DODAG) to create its own IPv6 global address using SLAC.</p>
</div>
<div class="paragraph">
<p>As we know the prefix given to the Border Router is <code>fd00::/64</code>, we know the device in this example will have the <code>fd00::c30c:0:0:13c8</code> IPv6 global address.</p>
</div>
<div class="paragraph">
<p>You can verify this later by checking the Border Router&#8217;s web service as done in the previous section.</p>
</div>
<div class="paragraph">
<p>The UDP connection is created in the following block:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">  /* Create a new connection with remote host.  When a connection is created
   * with udp_new(), it gets a local port number assigned automatically.
   * The "UIP_HTONS()" macro converts to network byte order.
   * The IP address of the remote host and the pointer to the data are not used
   * so those are set to NULL
   */
  client_conn = udp_new(NULL, UIP_HTONS(UDP_SERVER_PORT), NULL);

  if(client_conn == NULL) {
    PRINTF("No UDP connection available, exiting the process!\n");
    PROCESS_EXIT();
  }

  /* This function binds a UDP connection to a specified local por */
  udp_bind(client_conn, UIP_HTONS(UDP_CLIENT_PORT));

  PRINTF("Created a connection with the server ");
  PRINT6ADDR(&amp;client_conn-&gt;ripaddr);
  PRINTF(" local/remote port %u/%u\n", UIP_HTONS(client_conn-&gt;lport),
                                       UIP_HTONS(client_conn-&gt;rport));</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you have probably noticed, we are using the same <code>project-conf.h</code> and the <code>example.h</code> headers from the previous <code>01-udp-multicast.c</code> example.  In this case we are using both UDP client and server port, opening the first to receive data from the UDP server running in the python script, and the second value to send data to the UDP server.</p>
</div>
<div class="paragraph">
<p>Upon receiving a message (from the UDP server for example) the <code>tcpip_handler</code> is called to process the incoming data:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">static void
tcpip_handler(void)
{
  char *str;

  if(uip_newdata()) {
    str = uip_appdata;
    str[uip_datalen()] = '\0';
    printf("Received from the server: '%s'\n", str);
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>And as done in the previous example the devices will send data from its on-board sensors using the <code>my_msg_t</code> structure to store the data as payload.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">  while(1) {
    PROCESS_YIELD();

    /* Incoming events from the TCP/IP module */
    if(ev == tcpip_event) {
      tcpip_handler();
    }

    /* Send data to the server */
    if((ev == sensors_event &amp;&amp; data == &amp;button_sensor) ||
       (ev == PROCESS_EVENT_TIMER)) {

      send_packet();

      if(etimer_expired(&amp;periodic)) {
        etimer_reset(&amp;periodic);
      }
    }
  }</code></pre>
</div>
</div>
<div class="paragraph">
<p>The sensors information is sent periodically as configured by the <code>SEND_INTERVAL</code> value (default is every minute, change as you wish), or by pressing the <code>user button</code> to request an immediate packet to be sent to the UDP server.</p>
</div>
<div class="paragraph">
<p>The code snippet related to the payload sent to the UDP server address is shown next:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">PRINTF("Send readings to %u'\n",
        server_ipaddr.u8[sizeof(server_ipaddr.u8) - 1]);

uip_udp_packet_sendto(client_conn, msgPtr, sizeof(msg),
                        &amp;server_ipaddr, UIP_HTONS(UDP_SERVER_PORT));</code></pre>
</div>
</div>
<div class="paragraph">
<p>Compile and program the mote:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">make TARGET=zoul savetarget
make 03-udp-client.upload &amp;&amp; make login</code></pre>
</div>
</div>
<div class="paragraph">
<p>The output should be something similar to:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">Contiki-3.x-2611-g61576c3
Zolertia RE-Mote platform
CC2538: ID: 0xb964, rev.: PG2.0, Flash: 512 KiB, SRAM: 32 KiB, AES/SHA: 1, ECC/RSA: 1
System clock: 16000000 Hz
I/O clock: 16000000 Hz
Reset cause: External reset
Rime configured with address 00:12:4b:00:06:15:ab:25
 Net: sicslowpan
 MAC: CSMA
 RDC: nullrdc
UDP client process started
Server address: fd00::1
Client IPv6 addresses:
fe80::212:4b00:615:ab25
Created a connection with the server :: local/remote port 8765/5678

ID: 171, core temp: 34.47, ADC1: 2332, ADC2: 0, ADC3: 1500, batt: 3300, counter: 1
Send readings to 1'</code></pre>
</div>
</div>
<div class="paragraph">
<p>Remember that you can also compile for the <strong>Z1</strong> platform.</p>
</div>
<div class="paragraph">
<p>Remember to check the network and connection by using <code>ping6</code>, like you normally would test a wireless device.  Open the Border Router&#8217;s web service and see if you can find the node in your neighbor list!</p>
</div>
<div class="paragraph">
<p>Once you found the node&#8217;s global IPv6 assigned address, make a <code>ping6</code> request and check the <code>ICMPv6</code> response.  Don&#8217;t forget to use the wireless Sniffer and see how these ICMP packets looks like:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/4/image026.png" alt="image026.png">
</div>
<div class="title">Figure 69. ICMPv6 ping messages</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>With the Sniffer you are able to see the wireless messages within the 6LoWPAN network, but you can also capture in Wireshark the network traffic through the <code>tunslip6</code> virtual interface (normally <code>tun</code> depending on the parameters you have used to create it).</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>There is a Wireshark capture saved as an example for you to take a look in <code>wireshark-ipv6-6lowpan.pcap</code>.</p>
</div>
<div class="sect4">
<h5 id="truerunning-the-udp-server-mqtt-forwarder"><a class="anchor" href="#truerunning-the-udp-server-mqtt-forwarder"></a>Running the UDP server MQTT forwarder</h5>
<div class="paragraph">
<p>To execute the <code>UDP-MQTT-server.py</code> script just run:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">python UDP-MQTT-server.py</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is the expected output when running and receiving a UDP packet from a <code>Z1</code> node:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">UDP6 server side application V0.1
Started 2016-02-26 09:23:49.673940
UDP server ready: 5678
msg structure size:  13

MQTT: Connected (0)
2016-02-26 09:23:58 -&gt; fd00::c30c:0:0:13c8:8765 14
{
  "values": [
    {
      "value": 171,
      "key": "id"
    },
    {
      "value": 0,
      "key": "counter"
    },
    {
      "value": 2320,
      "key": "temperature"
    },
    {
      "value": -135,
      "key": "x_axis"
    },
    {
      "value": 40,
      "key": "y_axis"
    },
    {
      "value": -120,
      "key": "z_axis"
    },
    {
      "value": 2981,
      "key": "battery"
    }
  ]
}
MQTT: Publishing to {0}... 0 (171)
Sending reply to fd00::c30c:0:0:13c8
MQTT: Published 2</code></pre>
</div>
</div>
<div class="paragraph">
<p>If we run the <code>mqtt-client.py</code> python script in a separate terminal we will receive a notification each time the UDP server publishes new data to the <code>v2/zolertia/tutorialthings/#</code> topic:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">python mqtt-client.py
connecting to iot.eclipse.org
Connected with result code 0
Subscribed to v2/zolertia/tutorialthings/#
v2/zolertia/tutorialthings/171 {"values":[{"key": "id", "value": 171},{"key": "counter", "value": 0},{"key": "temperature", "value": 2326},{"key": "x_axis", "value": -129},{"key": "y_axis", "value": 38},{"key": "z_axis", "value": -122},{"key": "battery", "value": 2987}]}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The <code>udp-client</code> devices publish to the following MQTT topic:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">v2/zolertia/tutorialthings/{{ID}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Where <code>{{ID}}</code> corresponds to:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">msg.id = 0xAB;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Thus the default topic will be <code>v2/zolertia/tutorialthings/171</code> as shown in the previous snippet.  To change the topic&#8217;s <code>{{ID}}</code> just change the <code>msg.id</code> value in <code>03-udp-client.c</code>.</p>
</div>
<div class="paragraph">
<p>The pound sign in <code>v2/zolertia/tutorialthings/#</code> is a wildcard value, it will subscribe to any topic starting with <code>v2/zolertia/tutorialthings/</code>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If you want to change the default MQTT topic, change the following in <code>UDP-MQTT-server.py</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-python" data-lang="python">MQTT_URL_PUB = "v2/zolertia/tutorialthings/"</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you have an android mobile phone you can download the <code>MyMQTT</code> application and receive the notifications in your phone:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/4/image012.png" alt="image012.png">
</div>
<div class="title">Figure 70. MyMQTT android app</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">Server : "iot.eclipse.org"
Port   : 1883
Username/password not required
Topic: v2/zolertia/tutorialthings/#</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="truerunning-the-udp-server-ifttt-forwarder"><a class="anchor" href="#truerunning-the-udp-server-ifttt-forwarder"></a>Running the UDP server IFTTT forwarder</h5>
<div class="paragraph">
<p>Create an IFTTT account and subscribe to the <a href="https://ifttt.com/maker">Maker Channel</a>:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/4/image022.png" alt="image022.png">
</div>
<div class="title">Figure 71. IFTTT Maker channel</div>
</div>
<div class="paragraph">
<p>And copy your <code>Key</code> as shown below:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/4/image023.png" alt="image023.png">
</div>
<div class="title">Figure 72. IFTTT Maker channel configuration values</div>
</div>
<div class="paragraph">
<p>Then create the <a href="https://ifttt.com/myrecipes/personal">Recipe</a> you want, for example to automatically create a calendar entry to the maintenance crew if the battery level is critical or the temperature of the room is too high, send an email whenever someones pushes the button, etc&#8230;&#8203; you have plenty of channels to choose!</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/4/image024.png" alt="image024.png">
</div>
<div class="title">Figure 73. IFTTT example recipe</div>
</div>
<div class="paragraph">
<p>In the <code>UDP-IFTTT-server.py</code> just add the <code>event</code> and <code>key</code> values:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-python" data-lang="python">IFTTT_EVENT = "test"
IFTTT_KEY   = ""</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="truetcp-on-ipv6"><a class="anchor" href="#truetcp-on-ipv6"></a>TCP on IPv6</h3>
<div class="sidebarblock">
<div class="content">
<div class="title">What is TCP?</div>
<div class="paragraph">
<p>The Transmission Control Protocol (TCP) is a core protocol of the Internet Protocol (IP).</p>
</div>
<div class="paragraph">
<p>TCP is a reliable stream delivery service that ensures that all bytes received will be in the correct order. It uses a technique known as positive acknowledgment with retransmission to guarantee reliability of packet transfer.  TCP handles the received fragments and reorders the data.</p>
</div>
<div class="paragraph">
<p>Applications that do not require reliable data stream service may use the User Datagram Protocol (UDP), which provides a connectionless datagram service that emphasizes reduced latency over reliability.</p>
</div>
<div class="paragraph">
<p>TCP is commonly used by HTTP, FTP, email and any connection-oriented service.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>The TCP implementation is Contiki resides in <code>core/net/ip</code>.  The remainder of the section will focus on describing the TCP available functions.</p>
</div>
<div class="sect3">
<h4 id="truethe-tcp-api"><a class="anchor" href="#truethe-tcp-api"></a>The TCP API</h4>
<div class="paragraph">
<p>We need to create a socket for the connection, this is done using the <code>tcp_socket</code> structure, which has the following elements:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">struct tcp_socket {
  struct tcp_socket *next;

  tcp_socket_data_callback_t input_callback;
  tcp_socket_event_callback_t event_callback;
  void *ptr;

  struct process *p;

  uint8_t *input_data_ptr;
  uint8_t *output_data_ptr;

  uint16_t input_data_maxlen;
  uint16_t input_data_len;
  uint16_t output_data_maxlen;
  uint16_t output_data_len;
  uint16_t output_data_send_nxt;
  uint16_t output_senddata_len;
  uint16_t output_data_max_seg;

  uint8_t flags;
  uint16_t listen_port;
  struct uip_conn *c;
};</code></pre>
</div>
</div>
<div class="paragraph">
<p>Socket status:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">enum {
  TCP_SOCKET_FLAGS_NONE      = 0x00,
  TCP_SOCKET_FLAGS_LISTENING = 0x01,
  TCP_SOCKET_FLAGS_CLOSING   = 0x02,
};</code></pre>
</div>
</div>
<div class="paragraph">
<p>After creating the TCP socket structure, we need to register the TCP socket.  This is done with the <code>tcp_socket_register</code>, which takes as arguments the TCP socket, and input/output buffers to use for sending and receiving data. Be sure to dimension these buffers according to the expected amount of data to be sent and received.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">/**
 * \brief      Register a TCP socket
 * \param s    A pointer to a TCP socket
 * \param ptr  A user-defined pointer that will be sent to callbacks for this socket
 * \param input_databuf A pointer to a memory area this socket will use for input data
 * \param input_databuf_len The size of the input data buffer
 * \param output_databuf A pointer to a memory area this socket will use for outgoing data
 * \param output_databuf_len The size of the output data buffer
 * \param data_callback A pointer to the data callback function for this socket
 * \param event_callback A pointer to the event callback function for this socket
 * \retval -1  If an error occurs
 * \retval 1   If the operation succeeds.
 */
int tcp_socket_register(struct tcp_socket *s, void *ptr,
                         uint8_t *input_databuf, int input_databuf_len,
                         uint8_t *output_databuf, int output_databuf_len,
                         tcp_socket_data_callback_t data_callback,
                         tcp_socket_event_callback_t event_callback);</code></pre>
</div>
</div>
<div class="paragraph">
<p>As the TCP socket has been created and registered, let us listen on a given port.  When a remote host connects to the port, the event callback will be called with the <code>TCP_SOCKET_CONNECTED</code> event.  When the connection closes, the socket will go back to listening.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">/**
 * \brief      Start listening on a specific port
 * \param s    A pointer to a TCP socket that must have been previously registered with tcp_socket_register()
 * \param port The TCP port number, in host byte order, of the remote host
 * \retval -1  If an error occurs
 * \retval 1   If the operation succeeds.
 */
int tcp_socket_listen(struct tcp_socket *s,
                      uint16_t port);</code></pre>
</div>
</div>
<div class="paragraph">
<p>To stop listening on a given TCP port, just call the following function:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">/**
 * \brief      Stop listening for new connections
 * \param s    A pointer to a TCP socket that must have been previously registered with tcp_socket_register()
 * \retval -1  If an error occurs
 * \retval 1   If the operation succeeds.
 */
int tcp_socket_unlisten(struct tcp_socket *s);</code></pre>
</div>
</div>
<div class="paragraph">
<p>We can connect the TCP socket to a remote host.  When the socket has connected, the event callback will get called with the <code>TCP_SOCKET_CONNECTED</code> event. If the remote host does not accept the connection, the <code>TCP_SOCKET_ABORTED</code> will be sent to the callback. If the connection times out before conecting to the remote host, the <code>TCP_SOCKET_TIMEDOUT</code> event is sent to the callback.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">/**
 * \brief      Connect a TCP socket to a remote host
 * \param s    A pointer to a TCP socket that must have been previously registered with tcp_socket_register()
 * \param ipaddr The IP address of the remote host
 * \param port The TCP port number, in host byte order, of the remote host
 * \retval -1  If an error occurs
 * \retval 1   If the operation succeeds.
 */
int tcp_socket_connect(struct tcp_socket *s,
                       const uip_ipaddr_t *ipaddr,
                       uint16_t port);</code></pre>
</div>
</div>
<div class="paragraph">
<p>As we are using an output buffer to send data over the TCP socket, a good practice is to query the TCP socket and check the number of bytes available.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">/**
 * \brief      The maximum amount of data that could currently be sent
 * \param s    A pointer to a TCP socket
 * \return     The number of bytes available in the output buffer
 */
int tcp_socket_max_sendlen(struct tcp_socket *s);</code></pre>
</div>
</div>
<div class="paragraph">
<p>To send data over a connected TCP socket the data is placed in the output buffer.  When the data has been acknowledged by the remote host, the event callback is sent with the <code>TCP_SOCKET_DATA_SENT</code> event.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">/**
 * \brief      Send data on a connected TCP socket
 * \param s    A pointer to a TCP socket that must have been previously registered with tcp_socket_register()
 * \param dataptr A pointer to the data to be sent
 * \param datalen The length of the data to be sent
 * \retval -1  If an error occurs
 * \return     The number of bytes that were successfully sent
 */
int tcp_socket_send(struct tcp_socket *s,
                    const uint8_t *dataptr,
                    int datalen);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Alternatively we can send a string over a TCP socket as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">/**
 * \brief      Send a string on a connected TCP socket
 * \param s    A pointer to a TCP socket that must have been previously registered with tcp_socket_register()
 * \param strptr A pointer to the string to be sent
 * \retval -1  If an error occurs
 * \return     The number of bytes that were successfully sent
 */
int tcp_socket_send_str(struct tcp_socket *s,
                        const char *strptr);</code></pre>
</div>
</div>
<div class="paragraph">
<p>To close a connected TCP socket the function below is used.  The event callback is called with the <code>TCP_SOCKET_CLOSED</code> event.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">/**
 * \brief      Close a connected TCP socket
 * \param s    A pointer to a TCP socket that must have been previously registered with tcp_socket_register()
 * \retval -1  If an error occurs
 * \retval 1   If the operation succeeds.
 */
int tcp_socket_close(struct tcp_socket *s);</code></pre>
</div>
</div>
<div class="paragraph">
<p>And to unregister a TCP socket the <code>tpc_socket_unregister</code> function is used.  This function can also be used to reset a connected TCP socket.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">/**
 * \brief      Unregister a registered socket
 * \param s    A pointer to a TCP socket that must have been previously registered with tcp_socket_register()
 * \retval -1  If an error occurs
 * \retval 1   If the operation succeeds.
 *
 *             This function unregisters a previously registered
 *             socket. This must be done if the process will be
 *             unloaded from memory. If the TCP socket is connected,
 *             the connection will be reset.
 *
 */
int tcp_socket_unregister(struct tcp_socket *s);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The TCP socket event callback function gets called whenever there is an event on a socket, such as the socket getting connected or closed.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">/**
 * \brief      TCP event callback function
 * \param s    A pointer to a TCP socket
 * \param ptr  A user-defined pointer
 * \param event The event number
 */
typedef void (* tcp_socket_event_callback_t)(struct tcp_socket *s,
                                             void *ptr,
                                             tcp_socket_event_t event);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The TCP data callback function has to be added to the application, it will get called whenever there is new data on the socket:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">/**
 * \brief      TCP data callback function
 * \param s    A pointer to a TCP socket
 * \param ptr  A user-defined pointer
 * \param input_data_ptr A pointer to the incoming data
 * \param input_data_len The length of the incoming data
 * \return     The function should return the number of bytes to leave in the input buffer
 */
typedef int (* tcp_socket_data_callback_t)(struct tcp_socket *s,
                                           void *ptr,
                                           const uint8_t *input_data_ptr,
                                           int input_data_len);</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="truehands-on-tcp-example"><a class="anchor" href="#truehands-on-tcp-example"></a>Hands on: TCP example</h4>
<div class="paragraph">
<p>Now let us put to practice the TCP API described before and browse a TCP application.  The <code>05-tpc-socket</code> example simply echoes back the request done on port 80.</p>
</div>
<div class="paragraph">
<p>Then let us open the <code>tcp-server.c</code> example and browse the implementation.</p>
</div>
<div class="paragraph">
<p>The port 80 will be used for the TCP server to receive remote connections.  As shown earlier we need to create a <code>tcp_socket</code> structure, and use two separate input/output buffers to send and receive data.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">#define SERVER_PORT 80

static struct tcp_socket socket;

#define INPUTBUFSIZE 400
static uint8_t inputbuf[INPUTBUFSIZE];

#define OUTPUTBUFSIZE 400
static uint8_t outputbuf[OUTPUTBUFSIZE];</code></pre>
</div>
</div>
<div class="paragraph">
<p>These two variables will be used to count the number of bytes received, and the bytes to be sent.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">static uint8_t get_received;
static int bytes_to_send;</code></pre>
</div>
</div>
<div class="paragraph">
<p>As commented earlier, we need to include a <code>tcp_socket_event_callback_t</code> to handle events.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">static void
event(struct tcp_socket *s, void *ptr,
      tcp_socket_event_t ev)
{
  printf("event %d\n", ev);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>We register the TCP socket and pass as a pointer the <code>tcp_socket</code> structure, the data buffers and our callback handlers.  Next we start listening for connections on port 80.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">tcp_socket_register(&amp;socket, NULL,
               inputbuf, sizeof(inputbuf),
               outputbuf, sizeof(outputbuf),
               input, event);

tcp_socket_listen(&amp;socket, SERVER_PORT);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>input</code> callback handler receives the data, prints the string and its length, then if the received string is a complete request we save the number of bytes received into <code>bytes_to_send</code> (the <code>atoi</code> function converts string numbers into integers).  If the received string is not complete, we return the number of bytes received to the driver to keep the data in the input buffer.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">static int
input(struct tcp_socket *s, void *ptr,
      const uint8_t *inputptr, int inputdatalen)
{
  printf("input %d bytes '%s'\n", inputdatalen, inputptr);
  if(!get_received) {
    /* See if we have a full GET request in the buffer. */
    if(strncmp((char *)inputptr, "GET /", 5) == 0 &amp;&amp;
       atoi((char *)&amp;inputptr[5]) != 0) {
      bytes_to_send = atoi((char *)&amp;inputptr[5]);
      printf("bytes_to_send %d\n", bytes_to_send);
      return 0;
    }
    printf("inputptr '%.*s'\n", inputdatalen, inputptr);
    /* Return the number of data bytes we received, to keep them all
       in the buffer. */
    return inputdatalen;
  } else {
    /* Discard everything */
    return 0; /* all data consumed */
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The application will wait for an event to happen, in this case the incoming connection from above. After the event is handled, the code inside the <code>while()</code> loop and after the <code>PROCESS_PAUSE()</code> will be executed.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">while(1) {
  PROCESS_PAUSE();</code></pre>
</div>
</div>
<div class="paragraph">
<p>If we have previously received a complete request, we echo it back over the TCP socket.  We use the <code>tcp_socket_send_str</code> function to send the header of the response as a string. The remainder of the data is sent until the <code>bytes_to_send</code> counter is empty.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">    if(bytes_to_send &gt; 0) {
      /* Send header */
      printf("sending header\n");
      tcp_socket_send_str(&amp;socket, "HTTP/1.0 200 ok\r\nServer: Contiki tcp-socket example\r\n\r\n");

      /* Send data */
      printf("sending data\n");
      while(bytes_to_send &gt; 0) {
        PROCESS_PAUSE();
        int len, tosend;
        tosend = MIN(bytes_to_send, sizeof(outputbuf));
        len = tcp_socket_send(&amp;socket, (uint8_t *)"", tosend);
        bytes_to_send -= len;
      }
      tcp_socket_close(&amp;socket);
    }
  }
  PROCESS_END();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>When all the data is echoed back, the TCP socket is closed.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="truecoap-mqtt-and-http"><a class="anchor" href="#truecoap-mqtt-and-http"></a>CoAP, MQTT and HTTP</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In the previous section we covered some of the wireless basic, we should now have a good idea about working with Contiki.  This section introduces two widely used protocols for the IoT: CoAP and MQTT.  We will explain the basics and wrap up with ready to use examples.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/5/image006.png" alt="image006.png">
</div>
<div class="title">Figure 74. MQTT and CoAP architectures</div>
</div>
<div class="sect2">
<h3 id="truecoap-example"><a class="anchor" href="#truecoap-example"></a>CoAP example</h3>
<div class="paragraph">
<p>The CoAP implementation in Contiki is based on Erbium (Er), a low-power REST Engine for Contiki. The REST Engine includes a comprehensive embedded CoAP implementation, which became the official one in Contiki.</p>
</div>
<div class="paragraph">
<p>More information about its implementation and author is available in the <a href="http://people.inf.ethz.ch/mkovatsc/erbium.php">Erbium site</a>.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/5/image001.png" alt="image001.png">
</div>
<div class="title">Figure 75. CoAP: Constrained Application Protocol</div>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">What are REST and CoAP?</div>
<div class="paragraph">
<p>The <strong>Representational State Transfer (REST)</strong> relies on a stateless, client-server, cacheable communications protocol - and in virtually all cases, the HTTP protocol can be used.</p>
</div>
<div class="paragraph">
<p>The key abstraction of a RESTful web service is the resource, not a service. Sensors, actuators and control systems in general can be elegantly represented as resources and their service exposed through a RESTful web service.</p>
</div>
<div class="paragraph">
<p>RESTful applications use HTTP-like requests to post data (create and/or update), read data (e.g., make queries), and delete data. Thus, REST uses HTTP for all four CRUD (Create/Read/Update/Delete) operations.</p>
</div>
<div class="paragraph">
<p>Despite being simple, REST is fully-featured; there&#8217;s basically nothing you can do in web services that can&#8217;t be done with a RESTful architecture. REST is not a standard.</p>
</div>
<div class="paragraph">
<p>The <strong>Constrained Application Protocol (CoAP)</strong> is a software intended to be used in very simple electronics devices that allows them to communicate interactively over the Internet. It is particularly targeted for small, low power sensors, switches, valves and similar components that need to be controlled or supervised remotely, through standard Internet networks. CoAP is an application layer protocol that is intended for use in resource-constrained internet devices, such as WSN nodes. CoAP is designed to easily translate to HTTP for simplified integration with the web, while also meeting specialized requirements such as multicast support, very low overhead and simplicity.</p>
</div>
<div class="paragraph">
<p>CoAP can run on most devices that support UDP. CoAP makes use of two message types, requests and responses, using a simple binary base header format. The base header may be followed by options in an optimized Type-Length-Value format. CoAP is by default bound to UDP and optionally to DTLS (Datagram Transport Layer Security), providing a high level of communications security.</p>
</div>
<div class="paragraph">
<p>Any bytes after the headers in the packet are considered the message body (if any is present). The length of the message body is implied by the datagram length. When bound to UDP the entire message MUST fit within a single datagram. When used with 6LoWPAN as defined in RFC 4944, messages should fit into a single IEEE 802.15.4 frame to minimize fragmentation.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="truecoap-api"><a class="anchor" href="#truecoap-api"></a>CoAP API</h4>
<div class="paragraph">
<p>The CoAP implementation in Contiki is located in <code>apps/er-coap</code>.  The Erbium REST engine is implemented in <code>apps/rest-engine</code>.</p>
</div>
<div class="paragraph">
<p>The coap engine (currently the CoAP-18 version) is implemented in <code>er-coap-engine.c</code>.  The engine interface is provided by the following structure:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">const struct rest_implementation coap_rest_implementation = {
  coap_init_engine,
  coap_set_service_callback,
  coap_get_header_uri_path,
(...)
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>It is possible then to invoke the CoAP engine as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">REST.get_query_variable();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Web services are viewed as resources, and can be uniquely identified by their URLs. The basic REST design uses the HTTP or COAP protocol methods for typical <code>CRUD</code> operations (create, read, update, delete):</p>
</div>
<div class="ulist">
<ul>
<li>
<p>POST: Create a resource</p>
</li>
<li>
<p>GET: Retrieve a resource</p>
</li>
<li>
<p>PUT: Update a resource</p>
</li>
<li>
<p>DELETE: Delete a resource</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>There are various resources that are available at the server. Each resource at the server has a handler function which the REST layer calls to serve the client&#8217;s request. The REST server sends the response back to the client with the contents of the resource requested.</p>
</div>
<div class="paragraph">
<p>The following macros are available in <code>apps/rest-engine</code>, recommended when creating a new CoAP resource.</p>
</div>
<div class="paragraph">
<p>A <strong>normal resource</strong> is defined by a static Uri-Path that is associated with a resource handler function.  This is the basis for all other resource types.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">#define RESOURCE(name, attributes, get_handler, post_handler, put_handler, delete_handler) \
  resource_t name = { NULL, NULL, NO_FLAGS, attributes, get_handler, post_handler, put_handler, delete_handler, { NULL } }</code></pre>
</div>
</div>
<div class="paragraph">
<p>A <strong>parent resource</strong> manages several sub-resources by evaluating the Uri-Path, which may be longer than the parent resource.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">#define PARENT_RESOURCE(name, attributes, get_handler, post_handler, put_handler, delete_handler) \
  resource_t name = { NULL, NULL, HAS_SUB_RESOURCES, attributes, get_handler, post_handler, put_handler, delete_handler, { NULL } }</code></pre>
</div>
</div>
<div class="paragraph">
<p>If the server is not able to respond immediately to a <code>CON</code> request, it simply responds with an empty ACK message so that the client can stop re-transmitting the request. After a while, when the server is ready with the response, it sends the response as a <code>CON</code> message. The following macro allows to create a CoAP resource with <strong>separate response</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">#define SEPARATE_RESOURCE(name, attributes, get_handler, post_handler, put_handler, delete_handler, resume_handler) \
  resource_t name = { NULL, NULL, IS_SEPARATE, attributes, get_handler, post_handler, put_handler, delete_handler, { .resume = resume_handler } }</code></pre>
</div>
</div>
<div class="paragraph">
<p>An <strong>event resource</strong> is similar to a periodic resource, but the second handler is called by a non periodic event such as the pressing of a button.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">#define EVENT_RESOURCE(name, attributes, get_handler, post_handler, put_handler, delete_handler, event_handler) \
  resource_t name = { NULL, NULL, IS_OBSERVABLE, attributes, get_handler, post_handler, put_handler, delete_handler, { .trigger = event_handler } }</code></pre>
</div>
</div>
<div class="paragraph">
<p>If we need to declare a <strong>periodic resource</strong>, for example to poll a sensor and publish a changed value to subscribed clients, then we should use:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">#define PERIODIC_RESOURCE(name, attributes, get_handler, post_handler, put_handler, delete_handler, period, periodic_handler) \
  periodic_resource_t periodic_##name; \
  resource_t name = { NULL, NULL, IS_OBSERVABLE | IS_PERIODIC, attributes, get_handler, post_handler, put_handler, delete_handler, { .periodic = &amp;periodic_##name } }; \
  periodic_resource_t periodic_##name = { NULL, &amp;name, period, { { 0 } }, periodic_handler };</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice that the <code>PERIODIC_RESOURCE</code> and <code>EVENT_RESOURCE</code> can be observable, meaning a client can be notified of any change in a given resource.</p>
</div>
<div class="paragraph">
<p>Once we declare and implement the resources (we will get to that in the Hands On section), we need to initialize the REST framework and start the HTTP or CoAP process.  This is done using:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">void rest_init_engine(void);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then for each declared resource we want to be accessible, we need to call:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">void rest_activate_resource(resource_t *resource, char *path);</code></pre>
</div>
</div>
<div class="paragraph">
<p>So assume we have created a <code>hello-world</code> resource in <code>res-hello.c</code>, declared as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">RESOURCE(res_hello,
         "title=\"Hello world: ?len=0..\";rt=\"Text\"",
         res_get_handler,
         NULL,
         NULL,
         NULL);</code></pre>
</div>
</div>
<div class="paragraph">
<p>To enable the resource we would do:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">rest_activate_resource(&amp;res_hello, "test/hello");</code></pre>
</div>
</div>
<div class="paragraph">
<p>Which means the resource would be available at <code>test/hello</code> uri-Path.</p>
</div>
<div class="paragraph">
<p>The function above stores the resources into a list. To list the available resources, the <code>rest_get_resources</code> function is used. This will return a list with the resources with the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">rest_get_resources();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Remember that the mandatory CoAP port is <code>5683</code>.</p>
</div>
<div class="paragraph">
<p>Now let us put the above to work in the following hands-on example.</p>
</div>
</div>
<div class="sect3">
<h4 id="truehands-on-coap-server-and-copper"><a class="anchor" href="#truehands-on-coap-server-and-copper"></a>Hands on: CoAP server and Copper</h4>
<div class="paragraph">
<p>The objective of the lesson are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Learn how to create a CoAP resource and build a CoAP server</p>
</li>
<li>
<p>Show how to use the Copper client plugin to interact with our CoAP server</p>
</li>
<li>
<p>Learn how to discover the resources our CoAP server exposes</p>
</li>
<li>
<p>Learn how to use the <code>GET</code> method to retrieve sensor data from the CoAP server</p>
</li>
<li>
<p>Subscribe to events (be notified each time the user button is pushed)</p>
</li>
<li>
<p>Request sensor readings in different formatting (application/json, text/plain, etc)</p>
</li>
<li>
<p>Control the on-board LEDs remotely using <code>PUT/POST</code> requests</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You will need two Zolertia devices: a Border Router and a node acting as a CoAP server.</p>
</div>
<div class="paragraph">
<p>This example works for both <code>Z1</code> nodes and <code>zoul</code> platforms like the <code>RE-Mote</code>, each one will expose its on-board sensors as a <code>resource</code>.</p>
</div>
<div class="paragraph">
<p>Keep in mind the <code>Z1</code> has lesser number of <code>resources</code> enabled due to RAM constrains.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you are using the <strong>Z1 motes</strong>, ensure that  the  motes you will be using to test this (border router,  server, client) have been flashed with a node ID to generate the MAC/IPv6 addresses as done in previous sessions, be sure to write down the addresses!  Another thing, if you get an error like the following, go to <code>platform/z1/contiki-conf.h</code> and change <code>UIP_CONF_BUFFER_SIZE</code> to 240:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">#error "UIP_CONF_BUFFER_SIZE too small for REST_MAX_CHUNK_SIZE"
make: *** [obj_z1/er-coap-07-engine.o] Error 1</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Get the <a href="https://addons.mozilla.org/en-US/firefox/addon/copper-270430/">Copper (Cu) CoAP user-agent</a>.</p>
</div>
<div class="paragraph">
<p>Copper is a generic browser for the Internet of Things based on the Constrained Application Protocol (CoAP), a user-friendly management tool for networked embedded devices. As it is integrated into web browsers, it allows an intuitive interaction at the presentation layer making it easier to debug existing CoAP devices.</p>
</div>
<div class="paragraph">
<p>More information available at <a href="http://people.inf.ethz.ch/mkovatsc/copper.php">Copper page</a></p>
</div>
<div class="paragraph">
<p>The CoAP example is located in <code>03-coap</code>, the objective is to show a CoAP server exposing its resources (on-board sensors, LEDs, button) to a CoAP client, in this case our Firefox browser using Copper.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/5/image007.png" alt="image007.png">
</div>
<div class="title">Figure 76. CoAP example</div>
</div>
<div class="paragraph">
<p>In the <code>Makefile</code> we can notice two things: the <code>resources</code> folder is included as a project directory, and all the resources files are added in the compilation.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">REST_RESOURCES_DIR = ./resources
REST_RESOURCES_FILES = $(notdir $(shell find $(REST_RESOURCES_DIR) -name '*.c' ! -name 'res-plugtest*'))
PROJECTDIRS += $(REST_RESOURCES_DIR)
PROJECT_SOURCEFILES += $(REST_RESOURCES_FILES)</code></pre>
</div>
</div>
<div class="paragraph">
<p>We are including the <code>er-coap</code> and <code>rest-engine</code> applications.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c"># REST Engine shall use Erbium CoAP implementation
APPS += er-coap
APPS += rest-engine</code></pre>
</div>
</div>
<div class="paragraph">
<p>Next, let us check the <code>project-conf.h</code> relevant configuration.  First we make sure TCP is disabled, as CoAP is based on UDP.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">/* Disabling TCP on CoAP nodes. */
#undef UIP_CONF_TCP
#define UIP_CONF_TCP                   0</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>REST_MAX_CHUNK_SIZE</code> is the maximum buffer size that is provided for resource responses.  Larger data should be handled by the resource and be sent in CoAP blocks.  For the <strong>Z1</strong> mote we reduce this number and also other configuration values to save RAM.</p>
</div>
<div class="paragraph">
<p>The <code>COAP_MAX_OPEN_TRANSACTIONS</code> is the number of maximum open transactions the node is able to handle.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">#if CONTIKI_TARGET_ZOUL

#define REST_MAX_CHUNK_SIZE            96

#else /* Default is Z1 */

/* Override this due to RAM overflow */
#undef NBR_TABLE_CONF_MAX_NEIGHBORS
#define NBR_TABLE_CONF_MAX_NEIGHBORS   5
#undef UIP_CONF_MAX_ROUTES
#define UIP_CONF_MAX_ROUTES            5
#undef COAP_MAX_OBSERVERS
#define COAP_MAX_OBSERVERS             3

#define REST_MAX_CHUNK_SIZE            48
#endif

/* Multiplies with chunk size, be aware of memory constraints. */
#undef COAP_MAX_OPEN_TRANSACTIONS
#define COAP_MAX_OPEN_TRANSACTIONS     4

/* Enable client-side support for COAP observe */
#define COAP_OBSERVE_CLIENT 1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let us walk through the <code>er-example-server.c</code> example and understand its implementation.  The first thing we notice is the presence of a folder called <code>resources</code>. To facilitate debugging and maintenance the resources are implemented in a different file.</p>
</div>
<div class="paragraph">
<p>The resources to be included in the CoAP server are defined in the following declaration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">/*
 * Resources to be activated need to be imported through the extern keyword.
 * The build system automatically compiles the resources in the corresponding
 * sub-directory.
 */
extern resource_t
  res_hello,
  res_leds,
  res_toggle,
#if CONTIKI_TARGET_ZOUL
  res_mirror,
  res_push,
  res_sub,
  res_sht25,
  res_zoul,
#else /* Default is Z1 */
  res_adxl345,
#endif
  res_event,
  res_separate;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then the REST engine is initialized by calling the <code>rest_init_engine()</code>, and the enabled resources are bound:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">  /* Initialize the REST engine. */
  rest_init_engine();

  /* Enable the sensors and devices */
  SENSORS_ACTIVATE(button_sensor);

  /*
   * Bind the resources to their Uri-Path.
   * WARNING: Activating twice only means alternate path, not two instances!
   * All static variables are the same for each URI path.
   */
  rest_activate_resource(&amp;res_hello, "test/hello");
  rest_activate_resource(&amp;res_leds, "actuators/leds");
  rest_activate_resource(&amp;res_toggle, "actuators/toggle");
  rest_activate_resource(&amp;res_event, "sensors/button");
  rest_activate_resource(&amp;res_separate, "test/separate");

#if CONTIKI_TARGET_ZOUL
  rest_activate_resource(&amp;res_push, "test/push");
  rest_activate_resource(&amp;res_sub, "test/sub");
  rest_activate_resource(&amp;res_sht25, "sensors/sht25");
  rest_activate_resource(&amp;res_zoul, "sensors/zoul");
#else
  rest_activate_resource(&amp;res_adxl345, "sensors/adxl345");
#endif</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice there are fewer resources enabled for the <strong>Z1</strong> mote, as it has less RAM than the <strong>RE-Mote</strong>.</p>
</div>
<div class="paragraph">
<p>The <code>RE-Mote</code> as a <code>res_zoul</code> resource exposing the on-board sensors as shown in the next snippet.  The three ADC channels and the core temperature sensor values are available in <code>text/plain</code>, <code>application/xml</code> and <code>aplication/json</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">  if(accept == -1 || accept == REST.type.TEXT_PLAIN) {
    REST.set_header_content_type(response, REST.type.TEXT_PLAIN);
    snprintf((char *)buffer, REST_MAX_CHUNK_SIZE, "Temp %d.%u; ADC1 %u ADC2 %u ADC3 %u",
             temp / 1000, temp % 1000, adc1, adc2, adc3);
    REST.set_response_payload(response, (uint8_t *)buffer, strlen((char *)buffer));

  } else if(accept == REST.type.APPLICATION_XML) {
    REST.set_header_content_type(response, REST.type.APPLICATION_XML);
    snprintf((char *)buffer, REST_MAX_CHUNK_SIZE,
             "&lt;zoul&gt;&lt;Temp&gt;\"%d.%u\"&lt;/Temp&gt;&lt;ADC1&gt;\"%u\"&lt;/ADC1&gt;&lt;ADC2&gt;\"%u\"&lt;/ADC2&gt;&lt;ADC3&gt;\"%u\"&lt;/ADC3&gt;&lt;/zoul&gt;",
             temp / 1000, temp % 1000, adc1, adc2, adc3);

    REST.set_response_payload(response, buffer, strlen((char *)buffer));
  } else if(accept == REST.type.APPLICATION_JSON) {
    REST.set_header_content_type(response, REST.type.APPLICATION_JSON);
    snprintf((char *)buffer, REST_MAX_CHUNK_SIZE, "{'Zoul':{'Temp':%d.%u,'ADC1':%u,'ADC2':%u,'ADC3':%u}}",
             temp / 1000, temp % 1000, adc1, adc2, adc3);

    REST.set_response_payload(response, buffer, strlen((char *)buffer));
  } else {
    REST.set_response_status(response, REST.status.NOT_ACCEPTABLE);
    const char *msg = "Supporting content-types text/plain, application/xml, and application/json";
    REST.set_response_payload(response, msg, strlen(msg));
  }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now let us take a look at the <code>res-hello.c</code> resource, which implements a "hello world" for testing.</p>
</div>
<div class="paragraph">
<p>As shown before resources are defined using the <code>RESOURCE</code> macro, for this particular implementation we specify the resource name as <code>res_hello</code>, the link-formatted attributes and the <code>GET</code> callback handler.  The <code>POST</code>, <code>PUT</code>, and <code>DELETE</code> methods are not supported by this resource, so a <code>NULL</code> parameter is used as argument.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">RESOURCE(res_hello,
         "title=\"Hello world: ?len=0..\";rt=\"Text\"",
         res_get_handler,
         NULL,
         NULL,
         NULL);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>res_get_handler</code> is the event callback for <code>GET</code> requests:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">static void
res_get_handler(void *request, void *response, uint8_t *buffer, uint16_t preferred_size, int32_t *offset)
{
  const char *len = NULL;
  /* Some data that has the length up to REST_MAX_CHUNK_SIZE. For more, see the chunk resource. */
  char const *const message = "Hello World! ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxy";
  int length = 12;                                                        <i class="conum" data-value="1"></i><b>(1)</b>

  /* The query string can be retrieved by rest_get_query() or parsed for its key-value pairs. */
  if(REST.get_query_variable(request, "len", &amp;len)) {                     <i class="conum" data-value="2"></i><b>(2)</b>
    length = atoi(len);
    if(length &lt; 0) {                                                      <i class="conum" data-value="3"></i><b>(3)</b>
      length = 0;
    }
    if(length &gt; REST_MAX_CHUNK_SIZE) {                                    <i class="conum" data-value="4"></i><b>(4)</b>
      length = REST_MAX_CHUNK_SIZE;
    }
    memcpy(buffer, message, length);
  } else {
    memcpy(buffer, message, length);                                      <i class="conum" data-value="5"></i><b>(5)</b>

    /* text/plain is the default, hence this option could be omitted. */
  } REST.set_header_content_type(response, REST.type.TEXT_PLAIN);         <i class="conum" data-value="6"></i><b>(6)</b>

  REST.set_header_etag(response, (uint8_t *)&amp;length, 1);                  <i class="conum" data-value="7"></i><b>(7)</b>
  REST.set_response_payload(response, buffer, length);                    <i class="conum" data-value="8"></i><b>(8)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The default lenght of the reply, in this case from the complete string, only <code>Hello World!</code> will be sent</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>If the <code>len</code> option is specified, then a number of <code>len</code> bytes of the <code>message</code> string will be sent</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>If the value is a negative one, send an empty string</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>If <code>len</code> is higher than the maximum allowed, then we only send the maximum lenght value</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Copy the default</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Set the response content type as <code>Content-Type:text/plain</code></td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Attach the header to the response, set the payload lenght field</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>Attach the payload to the response</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now compile and upload the example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">make er-example-server.upload</code></pre>
</div>
</div>
<div class="paragraph">
<p>Compile and program a Border Router device as shown in the previous chapter.  Verify the Border Router is online by making a <code>ping6</code> request to it, then browse the Border Router&#8217;s web service and also <code>ping6</code> the CoAP server device.</p>
</div>
<div class="paragraph">
<p>If everything works then we can start discovering the server resources, open Firefox and type the server address:</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The next screenshoots shows images of both <strong>Z1</strong> and <strong>RE-Mote</strong> CoAP servers, images are shown indistinctively.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">coap://[aaaa::c30c:0000:0000:0001]:5683/</code></pre>
</div>
</div>
<div class="paragraph">
<p>Send a ping to the CoAP server by pressing the <code>Ping</code> button:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/5/image008.png" alt="image008.png">
</div>
<div class="title">Figure 77. CoAP ping/pong</div>
</div>
<div class="paragraph">
<p>Start discovering the available resources, press <code>Discover</code> and the page will be populated in the left side</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/5/image009.png" alt="image009.png">
</div>
<div class="title">Figure 78. CoAP server resource discovery</div>
</div>
<div class="paragraph">
<p>A well-known relative URI <code>/.well-known/core</code> is defined as a default entry point for requesting the list of links about resources hosted by a server and thus performing CoRE Resource Discovery.  This is quite useful as it makes easy to provision of a network by just "asking" the devices on the Border Router neighbor list information about their available resources, and the application-specific semantic type of a resource.</p>
</div>
<div class="paragraph">
<p>The <code>SHT25</code> temperature and humidity sensor shown in previous sections can also be used, when connected it can provide readings in different formats, depending on the <code>Accept</code> request field: <code>text/plain</code>, <code>application/xml</code> and <code>application/json</code>.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/5/image010.png" alt="image010.png">
</div>
<div class="title">Figure 79. SHT25 CoAP resource</div>
</div>
<div class="paragraph">
<p>The <code>ADXL345</code> on-board the <strong>Z1</strong> mote is also shown:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/5/image011.png" alt="image011.png">
</div>
<div class="title">Figure 80. CoAP server resource discovery</div>
</div>
<div class="paragraph">
<p>If you select the <code>toggle</code> resource and use <code>POST</code> you can see how the red LED of the CoAP server mote will toggle</p>
</div>
<div class="paragraph">
<p>To drive a specific LED (red, green or blue) on and off, in the URL type:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">coap://[aaaa::c30c:0000:0000:0001]:5683/actuators/leds?color=g</code></pre>
</div>
</div>
<div class="paragraph">
<p>Where <code>g</code> corresponds to the green LED, <code>b</code> and <code>r</code> to the blue and red one respectively.</p>
</div>
<div class="paragraph">
<p>And then in the payload (the ongoing tab) write:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">mode="on"</code></pre>
</div>
</div>
<div class="paragraph">
<p>And press <code>POST</code> or <code>PUT</code> (hover with the mouse over the actuators/leds to see the description and methods allowed).  Subsequently using <code>off</code> will turn the LEDs off.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/5/image012.png" alt="image012.png">
</div>
<div class="title">Figure 81. Control the LEDs on the CoAP server</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If click on the <code>Hello</code> resource and pressing <code>GET</code>, the server will answer you back with a neighbourly well-known message</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>CLicking on the <code>button</code> resource and pressing <code>OBSERVE</code> will enable the client to receive notifications each time you press the <code>user button</code>.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/5/image013.png" alt="image013.png">
</div>
<div class="title">Figure 82. Observe a CoAP resource</div>
</div>
<div class="paragraph">
<p>Launch the Sniffer and see the packets.  A previously saved wireshark capture is available for study in the <code>wireshark-coap-server-example.pcap</code> file.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/5/image014.png" alt="image014.png">
</div>
<div class="title">Figure 83. Wireshark capture of CoAP message traffic</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="truemqtt-example"><a class="anchor" href="#truemqtt-example"></a>MQTT example</h3>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/5/image015.png" alt="image015.png">
</div>
<div class="title">Figure 84. MQTT (MQ Telemetry Transport)</div>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">What is MQTT?</div>
<div class="paragraph">
<p>MQTT (formerly MQ Telemetry Transport) is a publish-subscribe based messaging protocol on top of the TCP/IP protocol. It is designed for connections with remote locations where a "small code footprint" is required or where the network bandwidth is limited.</p>
</div>
<div class="paragraph">
<p>The publish-subscribe messaging pattern requires a message broker. The broker is responsible for distributing messages to interested clients based on the topic of a message.  MQTT defines a set of Quality of Services (QoS) options.</p>
</div>
<div class="paragraph">
<p>Other features of MQTT are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Keep-Alive message (PINGREQ, PINGRESP).</p>
</li>
<li>
<p>A broker can detect client disconnection, even without an explicit <code>DISCONNECT</code> message.</p>
</li>
<li>
<p>Last Will and Testament message: specified in <code>CONNECT</code> message with topic, QoS and retain. On unexpected client disconnection,  the Last Will and Testament message is sent to subscribed clients.</p>
</li>
<li>
<p>Retain message: a <code>PUBLISH</code> message on a topic is kept on the broker which allows a new connected subscriber on the same topic to receive this message (last known good message).</p>
</li>
<li>
<p>Durable subscription: on client disconnection, all subscriptions are kept on the broker and recovered on client reconnection.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>MQTT reserves TCP/IP port 1883 and 8883, the later for using MQTT over SSL.</p>
</div>
<div class="paragraph">
<p>For more complete information visit <a href="http://mqtt.org/">the MQTT page</a>.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>A basic data exchange between clients (a publisher and a subscriber) over the MQTT broker is shown next.  Whenever the Publisher (the source of the message) publishes data to a topic at the MQTT broker, all subscribers to the topic will receive the publication.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/5/image002.png" alt="image002.png">
</div>
<div class="title">Figure 85. MQTT publish/suscribe</div>
</div>
<div class="paragraph">
<p>MQTT has defined three levels of Quality of Service (QoS):</p>
</div>
<div class="ulist">
<ul>
<li>
<p>QoS 0: The broker/client will deliver the message once, with no confirmation (fire and forget)</p>
</li>
<li>
<p>QoS 1: The broker/client will deliver the message at least once, with confirmation required.</p>
</li>
<li>
<p>QoS 3: The broker/client will deliver the message exactly once by using a four-step handshake.</p>
</li>
</ul>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/5/image016.png" alt="image016.png">
</div>
<div class="title">Figure 86. MQTT Quality of Services, taken from <a href="http://www.slideshare.net/paolopat/mqtt-iot-protocols-comparison">Slideshare</a></div>
</div>
<div class="paragraph">
<p>A topic is a <code>UTF-8</code> string case-sensitive, used by the broker to filter messages.  A topic has one or more topic levels, separated by a forward slash (topic level separator).  Topics starting with <code>$</code> or <code>$SYS</code> are treated specially as those are reserved by the MQTT broker internal statistics, and therefore not recommended for users to use to name their own topics.  Publishing to MQTT broker reserved topics is forbidden.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/5/image017.png" alt="image017.png">
</div>
<div class="title">Figure 87. Topics in MQTT, taken from <a href="http://www.hivemq.com/blog/mqtt-essentials-part-5-mqtt-topics-best-practices">HiveMQ</a></div>
</div>
<div class="sect3">
<h4 id="truemqtt-api"><a class="anchor" href="#truemqtt-api"></a>MQTT API</h4>
<div class="paragraph">
<p>MQTT is implemented in Contiki in <code>apps/mqtt</code>.  It makes use of the <code>tcp-socket</code> library discussed in an earlier section.</p>
</div>
<div class="paragraph">
<p>The current MQTT version implemented in Contiki supports QoS levels 0 and 1.</p>
</div>
<div class="paragraph">
<p>The MQTT available functions are described next.  A hands on example in the next section will help to clarify its use and suggest a state-machine approach to maintain the connection state and device operation.</p>
</div>
<div class="paragraph">
<p>This function initializes the MQTT engine and shall be called before any other MQTT function.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">/**
 * \brief Initializes the MQTT engine.
 * \param conn A pointer to the MQTT connection.
 * \param app_process A pointer to the application process handling the MQTT
 *        connection.
 * \param client_id A pointer to the MQTT client ID.
 * \param event_callback Callback function responsible for handling the
 *        callback from MQTT engine.
 * \param max_segment_size The TCP segment size to use for this MQTT/TCP
 *        connection.
 * \return MQTT_STATUS_OK or MQTT_STATUS_INVALID_ARGS_ERROR
 */
mqtt_status_t mqtt_register(struct mqtt_connection *conn,
                            struct process *app_process,
                            char *client_id,
                            mqtt_event_callback_t event_callback,
                            uint16_t max_segment_size);</code></pre>
</div>
</div>
<div class="paragraph">
<p>This function connects to an MQTT broker.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">/**
 * \brief Connects to a MQTT broker.
 * \param conn A pointer to the MQTT connection.
 * \param host IP address of the broker to connect to.
 * \param port Port of the broker to connect to, default is MQTT port is 1883.
 * \param keep_alive Keep alive timer in seconds. Used by broker to handle
 *        client disc. Defines the maximum time interval between two messages
 *        from the client. Shall be min 1.5 x report interval.
 * \return MQTT_STATUS_OK or an error status
 */
mqtt_status_t mqtt_connect(struct mqtt_connection *conn,
                           char *host,
                           uint16_t port,
                           uint16_t keep_alive);</code></pre>
</div>
</div>
<div class="paragraph">
<p>This function disconnects from an MQTT broker.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">/**
 * \brief Disconnects from a MQTT broker.
 * \param conn A pointer to the MQTT connection.
 */
void mqtt_disconnect(struct mqtt_connection *conn);</code></pre>
</div>
</div>
<div class="paragraph">
<p>This function subscribes to a topic on an MQTT broker.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>At the time of writting, the MQTT driver only supported subscribing to one topic.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">/**
 * \brief Subscribes to a MQTT topic.
 * \param conn A pointer to the MQTT connection.
 * \param mid A pointer to message ID.
 * \param topic A pointer to the topic to subscribe to.
 * \param qos_level Quality Of Service level to use. Currently supports 0, 1.
 * \return MQTT_STATUS_OK or some error status
 */
mqtt_status_t mqtt_subscribe(struct mqtt_connection *conn,
                             uint16_t *mid,
                             char *topic,
                             mqtt_qos_level_t qos_level);</code></pre>
</div>
</div>
<div class="paragraph">
<p>This function unsubscribes from a topic on an MQTT broker.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">/**
 * \brief Unsubscribes from a MQTT topic.
 * \param conn A pointer to the MQTT connection.
 * \param mid A pointer to message ID.
 * \param topic A pointer to the topic to unsubscribe from.
 * \return MQTT_STATUS_OK or some error status
 */
mqtt_status_t mqtt_unsubscribe(struct mqtt_connection *conn,
                               uint16_t *mid,
                               char *topic);</code></pre>
</div>
</div>
<div class="paragraph">
<p>This function publishes to a topic on an MQTT broker.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">/**
 * \brief Publish to a MQTT topic.
 * \param conn A pointer to the MQTT connection.
 * \param mid A pointer to message ID.
 * \param topic A pointer to the topic to subscribe to.
 * \param payload A pointer to the topic payload.
 * \param payload_size Payload size.
 * \param qos_level Quality Of Service level to use. Currently supports 0, 1.
 * \param retain If the RETAIN flag is set to 1, in a PUBLISH Packet sent by a
 *        Client to a Server, the Server MUST store the Application Message
 *        and its QoS, so that it can be delivered to future subscribers whose
 *        subscriptions match its topic name
 * \return MQTT_STATUS_OK or some error status
 */
mqtt_status_t mqtt_publish(struct mqtt_connection *conn,
                           uint16_t *mid,
                           char *topic,
                           uint8_t *payload,
                           uint32_t payload_size,
                           mqtt_qos_level_t qos_level,
                           mqtt_retain_t retain);</code></pre>
</div>
</div>
<div class="paragraph">
<p>This function sets clients user name and password to use when connecting to an MQTT broker.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">/**
 * \brief Set the user name and password for a MQTT client.
 * \param conn A pointer to the MQTT connection.
 * \param username A pointer to the user name.
 * \param password A pointer to the password.
 */
void mqtt_set_username_password(struct mqtt_connection *conn,
                                char *username,
                                char *password);</code></pre>
</div>
</div>
<div class="paragraph">
<p>This function sets clients Last Will topic and message (payload).
If the Will Flag is set to 1 (using the function) this indicates that, if the Connect request is accepted, a Will Message MUST be stored on the server and associated with the Network Connection. The Will Message MUST be published when the Network Connection is subsequently closed</p>
</div>
<div class="paragraph">
<p>This functionality can be used to get notified that a device has disconnected from the broker.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">/**
 * \brief Set the last will topic and message for a MQTT client.
 * \param conn A pointer to the MQTT connection.
 * \param topic A pointer to the Last Will topic.
 * \param message A pointer to the Last Will message (payload).
 * \param qos The desired QoS level.
 */
void mqtt_set_last_will(struct mqtt_connection *conn,
                        char *topic,
                        char *message,
                        mqtt_qos_level_t qos);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following helper functions can be ussed to assert the MQTT connection status, to check if the mote is connected to the broker with <code>mqtt_connected</code>, and with <code>mqtt_ready</code> if the connection is estabished and there is space in the buffer to publish.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">#define mqtt_connected(conn) \
  ((conn)-&gt;state == MQTT_CONN_STATE_CONNECTED_TO_BROKER ? 1 : 0)

#define mqtt_ready(conn) \
  (!(conn)-&gt;out_queue_full &amp;&amp; mqtt_connected((conn)))</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="truehands-on-mqtt-example"><a class="anchor" href="#truehands-on-mqtt-example"></a>Hands on: MQTT example</h4>
<div class="paragraph">
<p>The objective of the lessons are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Familiarize with the MQTT API</p>
</li>
<li>
<p>Publish sensor data and node statistics to a MQTT broker</p>
</li>
<li>
<p>Control the on-board LEDs remotely by publishing to the MQTT broker and receiving the command notification</p>
</li>
<li>
<p>Implement a local MQTT broker (mosquitto), or publish to one on Internet</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You will need a minimum of two Zolertia devices: a Border Router and a node acting as the MQTT client.</p>
</div>
<div class="paragraph">
<p>This example works for both <code>Z1</code> nodes and <code>zoul</code> platforms like the <code>RE-Mote</code>, each one will publish its on-board sensors data.</p>
</div>
<div class="paragraph">
<p>Keep in mind the <code>Z1</code> has lesser number of <code>resources</code> enabled due to RAM constrains.</p>
</div>
<div class="paragraph">
<p>It is advisable to install <a href="http://mosquitto.org/">mosquitto</a>, on Ubuntu:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">sudo apt-add-repository ppa:mosquitto-dev/mosquitto-ppa
sudo apt-get update
sudo apt-get install mosquitto mosquitto-clients</code></pre>
</div>
</div>
<div class="paragraph">
<p>In case you don&#8217;t have an IPv6 connection, you can run a mosquitto MQTT broker in your host.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/5/image018.png" alt="image018.png">
</div>
<div class="title">Figure 88. MQTT example</div>
</div>
<div class="paragraph">
<p>The <code>04-mqtt</code> folder contains the MQTT example.</p>
</div>
<div class="paragraph">
<p>The message content format is based on the IBM quickstart format.  For more information about this check out the <code>README</code> file, or read the <a href="https://docs.internetofthings.ibmcloud.com/messaging/applications.html">IBM MQTT doc</a>.</p>
</div>
<div class="paragraph">
<p>In the <code>project-conf.h</code> file the IPv6 broker address is defined as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">/*
 * If you have an IPv6 network or a NAT64-capable border-router:
 * test.mosquitto.org
 * IPv6 "2001:41d0:a:3a10::1"
 * NAT64 address "::ffff:5577:53c2" (85.119.83.194)
 *
 * To test locally you can use a mosquitto local broker in your host and use
 * i.e the fd00::1/64 address the Border router defaults to
 */
#define MQTT_DEMO_BROKER_IP_ADDR  "fd00::1"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice there are three options:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Use the IPv6 address of the Mosquitto MQTT broker</p>
</li>
<li>
<p>Use the IPv4 address of the Mosquitto MQTT broker, if we have a NAT64-capable Border Router, or a NAT64 software like <a href="http://www.wrapsix.org">wrapsix</a> (out of the scope of this book).</p>
</li>
<li>
<p>Use a mosquitto broker running in your host, in this case use the virtual interface address created with <code>tunslip6</code>, as shown in previous chapters.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">/* Default configuration values */
#define DEFAULT_EVENT_TYPE_ID        "status"
#define DEFAULT_SUBSCRIBE_CMD_TYPE   "leds"
#define DEFAULT_BROKER_PORT          1883
#define DEFAULT_PUBLISH_INTERVAL     (45 * CLOCK_SECOND)
#define DEFAULT_KEEP_ALIVE_TIMER     60</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>DEFAULT_EVENT_TYPE_ID</code> allows to change the default <code>zolertia/evt/status</code> last level.  Likewise, the <code>DEFAULT_SUBSCRIBE_CMD_TYPE</code> permits to change the default subscribe string topic.</p>
</div>
<div class="paragraph">
<p>The publication period (how often the sensor data is published) is given by <code>DEFAULT_PUBLISH_INTERVAL</code>.  Note the <code>DEFAULT_KEEP_ALIVE_TIMER</code> should be always larger than <code>DEFAULT_KEEP_ALIVE_TIMER</code>, at least 1.5 times.</p>
</div>
<div class="paragraph">
<p>The <strong>RE-Mote</strong> platform has a larger buffer to create topics and messages compared to the <strong>Z1</strong>, as the later has fewer RAM available and otherwise it would overflow when compiling.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">/* Specific platform values */
#if CONTIKI_TARGET_ZOUL
#define BUFFER_SIZE                  64
#define APP_BUFFER_SIZE              512

#else /* Default is Z1 */
#define BUFFER_SIZE                  48
#define APP_BUFFER_SIZE              256
#define BOARD_STRING                 "Zolertia Z1 Node"
#undef NBR_TABLE_CONF_MAX_NEIGHBORS
#define NBR_TABLE_CONF_MAX_NEIGHBORS 3
#undef UIP_CONF_MAX_ROUTES
#define UIP_CONF_MAX_ROUTES          3
#endif</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the <code>Makefile</code> the <code>mqtt</code> driver is added:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">APPS += mqtt
CONTIKI_WITH_IPV6 = 1</code></pre>
</div>
</div>
<div class="paragraph">
<p>The data structure for the MQTT client configuration is declared as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">/**
 * \brief Data structure declaration for the MQTT client configuration
 */
typedef struct mqtt_client_config {
  char event_type_id[CONFIG_EVENT_TYPE_ID_LEN];   <i class="conum" data-value="1"></i><b>(1)</b>
  char broker_ip[CONFIG_IP_ADDR_STR_LEN];         <i class="conum" data-value="2"></i><b>(2)</b>
  char cmd_type[CONFIG_CMD_TYPE_LEN];             <i class="conum" data-value="3"></i><b>(3)</b>
  clock_time_t pub_interval;                      <i class="conum" data-value="4"></i><b>(4)</b>
  uint16_t broker_port;                           <i class="conum" data-value="5"></i><b>(5)</b>
} mqtt_client_config_t;</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Default event type</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Broker IPv6 address</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Default command type</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Publish interval period</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Broker default port, default is <code>1883</code></td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Later defined and populate as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">static mqtt_client_config_t conf;

static int
init_config()
{
  /* Populate configuration with default values */
  memset(&amp;conf, 0, sizeof(mqtt_client_config_t));
  memcpy(conf.event_type_id, DEFAULT_EVENT_TYPE_ID,
         strlen(DEFAULT_EVENT_TYPE_ID));
  memcpy(conf.broker_ip, broker_ip, strlen(broker_ip));
  memcpy(conf.cmd_type, DEFAULT_SUBSCRIBE_CMD_TYPE, 4);

  conf.broker_port = DEFAULT_BROKER_PORT;
  conf.pub_interval = DEFAULT_PUBLISH_INTERVAL;

  return 1;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The default values are set and now the topics and ID strings are going to be constructed by the <code>update_config(&#8230;&#8203;)</code> function.  This function sequentially calls other helpers functions, such as <code>construct_client_id(&#8230;&#8203;)</code> and <code>construct_pub_topic(&#8230;&#8203;)</code> and create the corresponding strings, stored in the following buffers:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">/*
 * Buffers for Client ID and Topic.
 * Make sure they are large enough to hold the entire respective string
 */
static char client_id[BUFFER_SIZE];
static char pub_topic[BUFFER_SIZE];
static char sub_topic[BUFFER_SIZE];</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>mqtt_demo_process</code> starts as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">PROCESS_THREAD(mqtt_demo_process, ev, data)
{
  PROCESS_BEGIN();
  if(init_config() != 1) {                                          <i class="conum" data-value="1"></i><b>(1)</b>
    PROCESS_EXIT();
  }
  update_config();                                                  <i class="conum" data-value="2"></i><b>(2)</b>
  while(1) {
    PROCESS_YIELD();
    if((ev == PROCESS_EVENT_TIMER &amp;&amp; data == &amp;publish_periodic_timer) ||
       ev == PROCESS_EVENT_POLL) {                                  <i class="conum" data-value="3"></i><b>(3)</b>
      state_machine();
    }
  }
  PROCESS_END();
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Initial configuration values, as described earlier</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Creates the client ID, publish and subscribe topics.  The initial state <code>STATE_INIT</code> is set and the <code>publish_periodic_timer</code> event is scheduled</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Handles the <code>publish_periodic_timer</code>, this is where the application actually starts</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The application example itself can be understood as a finite state machine, although it seems complicated it is actually very straightforward.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/5/image019.png" alt="image019.png">
</div>
<div class="title">Figure 89. MQTT example state machine</div>
</div>
<div class="paragraph">
<p>Basically the <code>state_machine(&#8230;&#8203;)</code> function sequentially handles the mqtt registration, configuration and connection to the Broker, then subscribe to the required topic.  The code snippet below simplifies the state machine implementation to the basic taks done in each state:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">static void
state_machine(void)
{
  switch(state) {
  case STATE_INIT:                      <i class="conum" data-value="1"></i><b>(1)</b>
    mqtt_register(&amp;conn, &amp;mqtt_demo_process, client_id, mqtt_event,
                  MAX_TCP_SEGMENT_SIZE);
    state = STATE_REGISTERED;

  case STATE_REGISTERED:                <i class="conum" data-value="2"></i><b>(2)</b>
    if(uip_ds6_get_global(ADDR_PREFERRED) != NULL) {
      /* Registered and with a public IP. Connect */
      connect_to_broker();
    }
    etimer_set(&amp;publish_periodic_timer, NET_CONNECT_PERIODIC);
    return;
    break;

  case STATE_CONNECTING:                <i class="conum" data-value="3"></i><b>(3)</b>
    break;

  case STATE_CONNECTED:                 <i class="conum" data-value="4"></i><b>(4)</b>
    /* Notice there's no "break" here, it will continue to subscribe */

  case STATE_PUBLISHING:                <i class="conum" data-value="5"></i><b>(5)</b>
    if(mqtt_ready(&amp;conn) &amp;&amp; conn.out_buffer_sent) {
      /* Connected. Publish */
      if(state == STATE_CONNECTED) {
        subscribe();
        state = STATE_PUBLISHING;
      } else {
        publish();
      }
      etimer_set(&amp;publish_periodic_timer, conf.pub_interval);
      return;
    }
    break;

  case STATE_DISCONNECTED:              <i class="conum" data-value="6"></i><b>(6)</b>
    if(connect_attempt &lt; RECONNECT_ATTEMPTS ||
       RECONNECT_ATTEMPTS == RETRY_FOREVER) {
      mqtt_disconnect(&amp;conn);
      etimer_set(&amp;publish_periodic_timer, interval);
      state = STATE_REGISTERED;
      return;
    }
    break;
  }

  /* If we didn't return so far, reschedule ourselves */
  etimer_set(&amp;publish_periodic_timer, STATE_MACHINE_PERIODIC);
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Entry point, register the mqtt connection and move to the <code>STATE_REGISTERED</code> event</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Attempts to connect to the broker.  If the node has not joined the network (doesn&#8217;t have a valid IPv6 global address) it retries later.  If the node has a valid address, then calls the <code>mqtt_connect</code> function and sets the state to <code>STATE_CONNECTING</code>, then sets the <code>publish_periodic_timer</code> with a faster pace</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>This event just informs the user about the connection attempts.  When the MQTT connection to the broker has been made, the <code>MQTT_EVENT_CONNECTED</code> is triggered at the <code>mqtt_event</code> callback handler</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>As we are connected now, proceed and publish.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Checks if the MQTT connection is OK in <code>mqtt_ready</code>, then subscribe and publish</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Handles any disconnection event triggered from <code>MQTT_EVENT_DISCONNECTED</code></td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <code>mqtt_event</code> function is a callback handler in which we a notification from the mqtt library whenever an event happens.  The <code>mqtt_event</code> updates the status of the application so the <code>state_machine</code> know what to do next.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">static void
mqtt_event(struct mqtt_connection *m, mqtt_event_t event, void *data)
{
  switch(event) {
  case MQTT_EVENT_CONNECTED: {          <i class="conum" data-value="1"></i><b>(1)</b>
    state = STATE_CONNECTED;
    break;
  }
  case MQTT_EVENT_DISCONNECTED: {       <i class="conum" data-value="2"></i><b>(2)</b>
    state = STATE_DISCONNECTED;
    process_poll(&amp;mqtt_demo_process);
    break;
  }
  case MQTT_EVENT_PUBLISH: {            <i class="conum" data-value="3"></i><b>(3)</b>
    pub_handler(msg_ptr-&gt;topic, strlen(msg_ptr-&gt;topic), msg_ptr-&gt;payload_chunk,
                msg_ptr-&gt;payload_length);
    break;
  }
  case MQTT_EVENT_SUBACK: {            <i class="conum" data-value="4"></i><b>(4)</b>
    break;
  }
  case MQTT_EVENT_UNSUBACK: {          <i class="conum" data-value="5"></i><b>(5)</b>
    break;
  }
  case MQTT_EVENT_PUBACK: {            <i class="conum" data-value="6"></i><b>(6)</b>
    break;
  }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Event notification of a successful connection to the Broker</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Disconnection from the Broker event, immediately polls the <code>mqtt_demo_process</code> process and the <code>state_machine</code> function is invoked.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>A publication from a topic we are subscribed has been received</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Successful subscription to a topic</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Successful un-subscription to a topic</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Sucessful publication to a topic</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>When receiving an event from a topic we are subscribed to, the <code>MQTT_EVENT_PUBLISH</code> event is triggered and the <code>pub_handler</code> is called.  The example allows to turn the red LED on and off alternatively.</p>
</div>
<div class="paragraph">
<p>The default topic the example subscribe to is <code>zolertia/cmd/leds</code>, specifically to change the LED status we would need to publish to the <code>zolertia/cmd/leds</code> topic with value <code>1</code> to turn the LED on, and <code>0</code> otherwise.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">static void
pub_handler(const char *topic, uint16_t topic_len, const uint8_t *chunk,
            uint16_t chunk_len)
{
  /* If we don't like the length, ignore */
  if(topic_len != 17 || chunk_len != 1) {
    printf("Incorrect topic or chunk len. Ignored\n");
    return;
  }

  if(strncmp(&amp;topic[13], "leds", 4) == 0) {
    if(chunk[0] == '1') {
      leds_on(LEDS_RED);
      printf("Turning LED RED on!\n");
    } else if(chunk[0] == '0') {
      leds_off(LEDS_RED);
      printf("Turning LED RED off!\n");
    }
    return;
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Alternatively we could subscribe to a topic <code>zolertia/cmd/#</code> and handle different types of commands, we would need to parse the <code>topic</code> string and handle the topic and payload (<code>chunk</code> string).</p>
</div>
<div class="paragraph">
<p>The <code>publish</code> function create the string data to be published.  Below is a snippet of the function highlighting only the most relevant parts.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">static void
publish(void)
{
  int len;
  uint16_t aux;
  int remaining = APP_BUFFER_SIZE;          <i class="conum" data-value="1"></i><b>(1)</b>
  buf_ptr = app_buffer;                     <i class="conum" data-value="2"></i><b>(2)</b>

  len = snprintf(buf_ptr, remaining,        <i class="conum" data-value="3"></i><b>(3)</b>
                 "{"
                 "\"d\":{"
                 "\"myName\":\"%s\","
                 "\"Seq no\":%d,"
                 "\"Uptime (sec)\":%lu",
                 BOARD_STRING, seq_nr_value, clock_seconds());

  if(len &lt; 0 || len &gt;= remaining) {         <i class="conum" data-value="4"></i><b>(4)</b>
    printf("Buffer too short. Have %d, need %d + \\0\n", remaining, len);
    return;
  }

  remaining -= len;                         <i class="conum" data-value="5"></i><b>(5)</b>
  buf_ptr += len;                           <i class="conum" data-value="6"></i><b>(6)</b>

  /* Put our Default route's string representation in a buffer */
  char def_rt_str[64];
  memset(def_rt_str, 0, sizeof(def_rt_str));
  ipaddr_sprintf(def_rt_str, sizeof(def_rt_str), uip_ds6_defrt_choose());
  len = snprintf(buf_ptr, remaining, ",\"Def Route\":\"%s\"",
                def_rt_str);                <i class="conum" data-value="7"></i><b>(7)</b>

  aux = cc2538_temp_sensor.value(CC2538_SENSORS_VALUE_TYPE_CONVERTED);
  len = snprintf(buf_ptr, remaining, ",\"Core Temp\":\"%u.%02u\"",
                 aux / 1000, aux % 1000);   <i class="conum" data-value="8"></i><b>(8)</b>

  aux = adc_zoul.value(ZOUL_SENSORS_ADC1);
  len = snprintf(buf_ptr, remaining, ",\"ADC1\":\"%u\"", aux);

  aux = adc_zoul.value(ZOUL_SENSORS_ADC3);
  len = snprintf(buf_ptr, remaining, ",\"ADC3\":\"%u\"", aux);

  len = snprintf(buf_ptr, remaining, "}}"); <i class="conum" data-value="9"></i><b>(9)</b>

  mqtt_publish(&amp;conn, NULL, pub_topic, (uint8_t *)app_buffer,
               strlen(app_buffer), MQTT_QOS_LEVEL_0, MQTT_RETAIN_OFF);

  printf("APP - Publish to %s: %s\n", pub_topic, app_buffer);
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We use the <code>remaining</code> variable to store the remaining bytes in the buffer in which we are storing the string to be published</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Use a pointer to the buffer address, so we move the pointer position each time we add a new sensor value thus appending a new string</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The <code>snprintf</code> creates a formatted string at the position pointed by the <code>buf_otr</code> pointer.  The JSON string follows IBMM quickstart format.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>If the return value of <code>snprintf</code> is negative, or exceeds the remaining bytes in our buffer, it means the buffer is full.  If this is the case for you, either increase the <code>APPP_BUFFER_SIZE</code> value, or decrease the string content and lenght</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Update the available bytes counter</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>And move the <code>buf_ptr</code> pointer to the end of the newly created string, so the next string to be written starts at the end of the previous one.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Store the IPv6 address of our next-hop neighbor.  Steps 4-6 are omitted.</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>On-board sensors values are stored as string, only the <code>RE-Mote</code> sensors are shown but for the <code>Z1</code> mote is also done in the application</td>
</tr>
<tr>
<td><i class="conum" data-value="9"></i><b>9</b></td>
<td>Close the JSON string</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <code>mqtt_publish</code> updates the MQTT broker with the new values, publishing to the specified <code>pub_topic</code>.  The default topic is <code>zolertia/evt/status</code> as done in the <code>construct_pub_topic</code> function.</p>
</div>
<div class="paragraph">
<p>Now compile and upload the example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">make mqtt-example.upload</code></pre>
</div>
</div>
<div class="paragraph">
<p>Compile and program a Border Router device as shown in the previous chapter.  Verify the Border Router is online by making a <code>ping6</code> request to it, then browse the Border Router&#8217;s web service and also <code>ping6</code> the MQTT node.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The next screenshoots shows images of both <strong>Z1</strong> and <strong>RE-Mote</strong> MQTT nodes, images and snippets are shown indistinctively.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The green LED will blink at a faster pace while the MQTT node is trying to connect to the MQTT broker, then when connected it will stop blinking.</p>
</div>
<div class="paragraph">
<p>Whenever the node publishes to the MQTT broker it will turn on the green LED, and off when it finishes publishing.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">Rime started with address 193.12.0.0.0.0.19.208
MAC c1:0c:00:00:00:00:13:d0 Ref ID: 43981
Contiki-3.x-2577-gea0738b started. Node id is set to 5072.
CSMA nullrdc, channel check rate 128 Hz, radio channel 26
Tentative link-local IPv6 address fe80:0000:0000:0000:c30c:0000:0000:13d0
Starting 'MQTT Demo'
MQTT Demo Process
Subscription topic zolertia/cmd/leds
Init
Registered. Connect attempt 1
APP - MQTT Disconnect. Reason 3
Disconnected
Disconnected. Attempt 2 in 1024 ticks
Registered. Connect attempt 2
Connecting (2)
APP - Application has a MQTT connection
APP - Subscribing to zolertia/cmd/leds
APP - Application is subscribed to topic successfully
Publishing
APP - Publish to zolertia/evt/status: {"d":{"myName":"Zolertia Z1 Node","Seq no":1,"Uptime (sec)":63,"Def Route":"fe80::212:4b00:615:ab25","Temp":"2.768","X axis":"86"}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>There is a python script named <code>mqtt-client.py</code> you could use to subscribe to the MQTT broker and topic, and receive notifications whenever the MQTT node publishes.</p>
</div>
<div class="paragraph">
<p>In case of a <strong>Z1</strong> node publishing to mosquitto&#8217;s MQTT broker:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ python mqtt-client.py
connecting to fd00::1
Connected with result code 0
Subscribed to zolertia/evt/status
Subscribed to zolertia/cmd/leds
zolertia/evt/status {"d":{"myName":"Zolertia Z1 Node","Seq no":1,"Uptime (sec)":63,"Def Route":"fe80::212:4b00:615:ab25","Temp":"27.68","X axis":"86"}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>For the <strong>RE-Mote</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ python mqtt-client.py
connecting to fd00::1
Connected with result code 0
Subscribed to zolertia/evt/status
Subscribed to zolertia/cmd/leds
zolertia/evt/status {"d":{"myName":"Zolertia RE-Mote platform","Seq #":5,"Uptime (sec)":239,"Def Route":"fe80::212:4b00:615:ab25","Core Temp":"34.523","ADC1":"2280","ADC3":"1452"}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>As explained before, the MQTT node subscribes to the following topic:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">zolertia/cmd/led</code></pre>
</div>
</div>
<div class="paragraph">
<p>Sending as payload <code>1</code> will turn on the red LED, and a <code>0</code> off.</p>
</div>
<div class="paragraph">
<p>Execute this from the command line:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">mosquitto_pub -h "test.mosquitto.org"  -t "zolertia/cmd/led" -m "1" -q 0</code></pre>
</div>
</div>
<div class="paragraph">
<p>The above command will publish to the <code>cmd</code> topic, all nodes subscribed to it will turn its red LED on.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">APP - Application received a publish on topic 'zolertia/cmd/leds'. Payload size is 1 bytes. Content:
Pub Handler: topic='zolertia/cmd/leds' (len=17), chunk_len=1
Turning LED RED on!

APP - Application received a publish on topic 'zolertia/cmd/leds'. Payload size is 1 bytes. Content:
Pub Handler: topic='zolertia/cmd/leds' (len=17), chunk_len=1
Turning LED RED off!</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Remember in Chapter 4 a MQTT Android application was shown, try to configure and command your <code>RE-Mote</code> or <code>Z1</code> from your mobile!</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="truehands-on-connecting-to-a-real-world-iot-platform-http-based"><a class="anchor" href="#truehands-on-connecting-to-a-real-world-iot-platform-http-based"></a>Hands on: connecting to a real world IoT platform (HTTP-based)</h3>
<div class="paragraph">
<p><a href="http://www.ubidots.com">Ubidots</a> is an IoT cloud platform that helps you create applications that capture real-world data and turn it into meaningful actions and insights.</p>
</div>
</div>
<div class="sect2">
<h3 id="trueubidots-ipv6-example-in-native-contiki"><a class="anchor" href="#trueubidots-ipv6-example-in-native-contiki"></a>Ubidots IPv6 example in native Contiki</h3>
<div class="paragraph">
<p>The example will demonstrate the basic functionality of Contiki&#8217;s Ubidots library:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>How to use the library to POST to a variable.</p>
</li>
<li>
<p>How to use the library to POST to a collection.</p>
</li>
<li>
<p>How to receive (parts of) the HTTP reply.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The original example and libraries were developed by George Oikonomou, available from <a href="https://github.com/g-oikonomou/contiki/tree/ubidots-demo">George Oikonomou repository</a>.  At the time of writting it is not merged to Contiki, but available in the <code>iot-workshop</code> branch we are currently using in the book.</p>
</div>
<div class="paragraph">
<p>The Ubidots example is located at:
<code>examples/zolertia/tutorial/99-apps/ubidots-example</code>.</p>
</div>
<div class="paragraph">
<p>Ubidots application is implemented at <code>apps/ubidots</code>.</p>
</div>
<div class="paragraph">
<p>You will need a minimum of two Zolertia devices: a Border Router and a node acting as the Ubidots client.</p>
</div>
<div class="paragraph">
<p>This example works for both <code>Z1</code> nodes and <code>zoul</code> platforms like the <code>RE-Mote</code>, each one will publish data from an attached <a href="http://zolertia.io/product/sensors/temp-humidity-sensor-sht21">SHT21</a> temperature and humidity sensor, shown in previous sections.</p>
</div>
<div class="paragraph">
<p>Ubidots application uses TCP sockets to connect to the host <code>things.ubidots.com</code>, which has the following IPv4 and IPv6 endpoints:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/5/image004.png" alt="image004.png">
</div>
<div class="title">Figure 90. Ubidots endpoint IPv4/IPv6 addresses</div>
</div>
<div class="paragraph">
<p>To check what&#8217;s going on enable the debug print statements in the <code>ubidots.c</code> file, search for <code>#define DEBUG DEBUG_NONE</code> and replace with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">#define DEBUG DEBUG_PRINT</code></pre>
</div>
</div>
<div class="paragraph">
<p>First, you will have to register an account with Ubidots, create your data
source and variables and request an authentication token.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Create an account with Ubidots and log in</p>
</li>
<li>
<p>Create a single data source</p>
</li>
<li>
<p>Under this data source, create two variables: One for the uptime and another for the sequence number.</p>
</li>
<li>
<p>Go to your account and request a short API token.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>There are three things to configure in the example:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The choice between IP and IPv6. If you are planning to connect to Ubidots over NAT64, you will also want to configure the Ubidots server&#8217;s IP address in a NAT64 format.</p>
</li>
<li>
<p>The authentication token</p>
</li>
<li>
<p>The variable IDs</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The example will build for IPv6 by default. If you have a NAT64 enabled Border Router or a similar software, open the example&#8217;s <code>Makefile</code>. Change <code>CONTIKI_WITH_IPV6=1</code> to <code>WITH_IP64=1</code>.</p>
</div>
<div class="paragraph">
<p>In the <code>project-conf.h</code> file configure the host address.  If you don&#8217;t specify one, the Ubidots library will try to resolve the host name.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">/* IPv6 address of things.ubidots.com is "2607:f0d0:2101:39::2", leave
 * commented to resolve the host name.  The NAT64 address is "::ffff:3217:7c44"
 */
#define UBIDOTS_CONF_REMOTE_HOST         "2607:f0d0:2101:39::2"</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you don&#8217;t have a local IPv6 connection, services like <a href="http://www.gogo6.com/">gogo6</a> and <a href="https://ipv6.he.net/">hurricane electric</a> provides IPv6 tunnels over IPv4 connections.  Other options like <a href="http://www.wrapsix.org/">wrapsix</a> use NAT64 to translate IPv6/IPv4 addresses.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Next get the API key from Ubidots:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/5/image020.png" alt="image020.png">
</div>
<div class="title">Figure 91. Ubidots API key</div>
</div>
<div class="paragraph">
<p>This will be the value to be defined in <code>UBIDOTS_CONF_AUTH_TOKEN</code>.</p>
</div>
<div class="paragraph">
<p>As we are to post temperature and humidity values to Ubidots, create the variables and copy their <code>Variable ID</code>.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/5/image021.png" alt="image021.png">
</div>
<div class="title">Figure 92. Ubidots Temperature and humidity variables</div>
</div>
<div class="paragraph">
<p>Next in the <code>project-conf.h</code> file replace accordingly:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c" data-lang="c">/* User configuration */
#define POST_PERIOD                      (CLOCK_SECOND * 40)
#define VARIABLE_BUF_LEN                 16
#define UBIDOTS_CONF_AUTH_TOKEN          ""
#define VARKEY_TEMPERATURE               ""
#define VARKEY_HUMIDITY                  ""
#define UBIDOTS_CONF_IN_BUFFER_SIZE      64</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now compile and program:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">make ubidots-client.upload</code></pre>
</div>
</div>
<div class="paragraph">
<p>Compile and program a Border Router device as shown in the previous chapter.  Verify the Border Router is online by making a <code>ping6</code> request to it, then browse the Border Router&#8217;s web service and also <code>ping6</code> the <code>ubidots-client</code> node.</p>
</div>
<div class="paragraph">
<p>You should see the following output:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">connecting to /dev/ttyUSB0 (115200) [OK]
Rime started with address 193.12.0.0.0.0.0.158
MAC c1:0c:00:00:00:00:00:9e Ref ID: 158
Contiki-d368451 started. Node id is set to 158.
nullmac nullrdc, channel check rate 128 Hz, radio channel 26
Tentative link-local IPv6 address fe80:0000:0000:0000:c30c:0000:0000:009e
Starting 'Ubidots demo process'
Ubidots client: STATE_ERROR_NO_NET
Ubidots client: STATE_ERROR_NO_NET
Ubidots client: STATE_ERROR_NO_NET
Ubidots client: STATE_STARTING
Ubidots client: Checking 64:ff9b::3217:7c44
Ubidots client: 'Host: [64:ff9b::3217:7c44]' (remaining 44)
Ubidots client: STATE_TCP_CONNECT (1)
Ubidots client: Connect 64:ff9b::3217:7c44 port 80
event_callback: connected
Ubidots client: STATE_TCP_CONNECTED
Ubidots client: Prepare POST: Buffer at 199
Ubidots client: Enqueue value: Buffer at 210
Ubidots client: POST: Buffer at 211, content-length 13 (2), at 143
Ubidots client: POST: Buffer at 208
Ubidots client: STATE_POSTING (176)
Ubidots client: STATE_POSTING (176)
Ubidots client: STATE_POSTING (144)
Ubidots client: STATE_POSTING (112)
Ubidots client: STATE_POSTING (80)
Ubidots client: STATE_POSTING (48)
Ubidots client: STATE_POSTING (16)
Ubidots client: STATE_POSTING (0)
Ubidots client: HTTP Reply 200
HTTP Status: 200
Ubidots client: New header: &lt;Server: nginx&gt;
Ubidots client: New header: &lt;Date: Fri, 13 Mar 2015 09:35:08 GMT&gt;
Ubidots client: New header: &lt;Content-Type: application/json&gt;
Ubidots client: New header: &lt;Transfer-Encoding: chunked&gt;
Ubidots client: New header: &lt;Connection: keep-alive&gt;
Ubidots client: New header: &lt;Vary: Accept-Encoding&gt;
Ubidots client: Client wants header 'Vary'
H: 'Vary: Accept-Encoding'
Ubidots client: New header: &lt;Vary: Accept&gt;
Ubidots client: Client wants header 'Vary'
H: 'Vary: Accept'
Ubidots client: New header: &lt;Allow: GET, POST, HEAD, OPTIONS&gt;
Ubidots client: Chunk, len 22: &lt;[{"status_code": 201}]&gt; (counter = 22)
Ubidots client: Chunk, len 0: &lt;(End of Reply)&gt; (Payload Length 22 bytes)
P: '[{"status_code": 201}]'</code></pre>
</div>
</div>
<div class="paragraph">
<p>The above shows how the <code>ubidots-client</code> node connects to the Ubidots server, and publishes data.</p>
</div>
<div class="paragraph">
<p>To visualize the data in a friendlier way, Ubidots provides ready to use dashboards with different visualization options (linear plot, scatter, tables, etc).</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/5/image022.png" alt="image022.png">
</div>
<div class="title">Figure 93. Ubidots dashboard</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="trueacronyms"><a class="anchor" href="#trueacronyms"></a>ACRONYMS</h2>
<div class="sectionbody">
<div class="dlist">
<dl>
<dt class="hdlist1">CoAP</dt>
<dd>
<p>Constrained Application Protocol</p>
</dd>
<dt class="hdlist1">DHCPv6</dt>
<dd>
<p>Dynamic Host Configuration Protocol for IPv6</p>
</dd>
<dt class="hdlist1">IANA</dt>
<dd>
<p>Internet Assigned Numbers Authority</p>
</dd>
<dt class="hdlist1">IETF</dt>
<dd>
<p>Internet Engineering Task Force</p>
</dd>
<dt class="hdlist1">IID</dt>
<dd>
<p>Interface Identifier (in an IPv6 address)</p>
</dd>
<dt class="hdlist1">IP</dt>
<dd>
<p>Internet Protocol</p>
</dd>
<dt class="hdlist1">IPv4</dt>
<dd>
<p>Internet Protocol version 4</p>
</dd>
<dt class="hdlist1">IPv6</dt>
<dd>
<p>Internet Protocol version 6</p>
</dd>
<dt class="hdlist1">LAN</dt>
<dd>
<p>Local Area Network</p>
</dd>
<dt class="hdlist1">MAC</dt>
<dd>
<p>Medium Access Control</p>
</dd>
<dt class="hdlist1">MQTT</dt>
<dd>
<p>Message Queuing Telemetry Transport</p>
</dd>
<dt class="hdlist1">NAT</dt>
<dd>
<p>Network Address Translation</p>
</dd>
<dt class="hdlist1">SLAAC</dt>
<dd>
<p>Stateless Address Autoconfiguration</p>
</dd>
<dt class="hdlist1">TCP</dt>
<dd>
<p>Transmission Control Protocol</p>
</dd>
<dt class="hdlist1">UDP</dt>
<dd>
<p>User Datagram Protocol</p>
</dd>
<dt class="hdlist1">WSN</dt>
<dd>
<p>Wireless Sensor Network</p>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect1">
<h2 id="truebibliography"><a class="anchor" href="#truebibliography"></a>Bibliography</h2>
<div class="sectionbody">
<div class="ulist bibliography">
<div class="title">References</div>
<ul class="bibliography">
<li>
<p><a id="IoT"></a>[IoT] Ovidiu Vermesan &amp; Peter Fress, Internet of Things 뉹rom Research and Innovation to Market Deployment, River Publishers Series in Communication, ISBN: 87-93102-94-1, 2014.</p>
</li>
<li>
<p><a id="SusAgri"></a>[SusAgri] Rodriguez de la Concepcion, A.; Stefanelli, R.; Trinchero, D.
"Adaptive wireless sensor networks for high-definition monitoring in sustainable agriculture", Wireless Sensors and Sensor Networks (WiSNet), 2014</p>
</li>
<li>
<p><a id="sixlo"></a>[sixlo] IETF WG 6Lo: <a href="http://datatracker.ietf.org/wg/6lo/charter/" class="bare">http://datatracker.ietf.org/wg/6lo/charter/</a></p>
</li>
<li>
<p><a id="sixlowpan"></a>[sixlowpan] IETF WG 6LoWPAN: <a href="http://datatracker.ietf.org/wg/6lowpan/charter/" class="bare">http://datatracker.ietf.org/wg/6lowpan/charter/</a></p>
</li>
<li>
<p><a id="IANA-IPV6-SPEC"></a>[IANA-IPV6-SPEC] IANA IPv6 Special-Purpose Address Registry: <a href="http://www.iana.org/assignments/iana-ipv6-special-registry/" class="bare">http://www.iana.org/assignments/iana-ipv6-special-registry/</a></p>
</li>
<li>
<p><a id="IEEE802.15.4"></a>[IEEE802.15.4] IEEE Computer Society, "IEEE Std. 802.15.4-2003", October 2003</p>
</li>
<li>
<p><a id="RFC2460"></a>[RFC2460] S. Deering, R. Hinden, Internet Protocol, Version 6 (IPv6) Specification, December 1998, RFC 2460, Draft Standard</p>
</li>
<li>
<p><a id="RFC3315"></a>[RFC3315] Droms, R., Bound, J., Volz, B., Lemon, T., Perkins, C., and M. Carney, "Dynamic
Host Configuration Protocol for IPv6 (DHCPv6)", July 2003</p>
</li>
<li>
<p><a id="RFC4193"></a>[RFC4193] R. Hinden, B. Haberman, "Unique Local IPv6 Unicast Addresses", RFC4193, October 2005</p>
</li>
<li>
<p><a id="RFC4291"></a>[RFC4291] R. Hinden, S. Deering, IP Version 6 Addressing Architecture, RFC 4291, February 2006</p>
</li>
<li>
<p><a id="RFC4862"></a>[RFC4862] S. Thomson, T. Narten, T. Jinmei, "IPv6 Stateless Address Autoconfiguration", September 2007</p>
</li>
<li>
<p><a id="RFC6775"></a>[RFC6775] Z. Shelby, Ed., S. Chakrabarti, E. Nordmark, C. Bormann, Neighbor Discovery Optimization for IPv6 over Low-Power Wireless Personal Area Networks (6LoWPANs), November 2012, RFC 6775, Proposed Standard</p>
</li>
<li>
<p><a id="RFC6890"></a>[RFC6890] M. Cotton, L. Vegoda, R. Bonica, Ed., B. Haberman, "Special-Purpose IP
Address Registries", RFC 6890 / BCP 153, April 2013</p>
</li>
<li>
<p><a id="roll"></a>[roll] roll IETF WG: <a href="http://datatracker.ietf.org/wg/roll/charter" class="bare">http://datatracker.ietf.org/wg/roll/charter</a></p>
</li>
<li>
<p><a id="I802154r"></a>[I802154r] L. Frenzel, "What뗩 The Difference Between IEEE 802.15.4 And ZigBee Wireless?" [Online] Available: <a href="http://electronicdesign.com/what-s-difference-between/what-s-difference-between-ieee-802154-and-zigbee-wireless" class="bare">http://electronicdesign.com/what-s-difference-between/what-s-difference-between-ieee-802154-and-zigbee-wireless</a>.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Version 1.0<br>
Last updated 2016-06-27 12:29:27 RDT
</div>
</div>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.9.1/styles/github.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.9.1/highlight.min.js"></script>
<script>hljs.initHighlighting()</script>
</body>
</html>